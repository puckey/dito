"use strict";

exports.__esModule = true;
exports.default = void 0;

var _utils = require("@ditojs/utils");

const TYPE_STATIC = 0;
const TYPE_PARAM = 1;
const TYPE_MATCH_ANY = 2;
const CHAR_PARAM = ':'.charCodeAt(0);
const CHAR_MATCH_ANY = '*'.charCodeAt(0);
const CHAR_SLASH = '/'.charCodeAt(0);

class Node {
  constructor(...args) {
    this.initialize(...args);
  }

  initialize(prefix = '/', type = TYPE_STATIC, children = [], handler = null, paramNames = null) {
    this.label = prefix.charCodeAt(0);
    this.prefix = prefix;
    this.type = type;
    this.children = children;
    this.handler = handler;
    this.paramNames = paramNames;
    this.paramName = null;
  }

  addChild(child) {
    this.children.push(child);
  }

  findChild(label, type) {
    for (const child of this.children) {
      if (child.label === label && child.type === type) {
        return child;
      }
    }
  }

  findChildWithLabel(label) {
    for (const child of this.children) {
      if (child.label === label) {
        return child;
      }
    }
  }

  findChildWithType(type) {
    for (const child of this.children) {
      if (child.type === type) {
        return child;
      }
    }
  }

  add(path, handler) {
    const paramNames = [];

    for (let pos = 0, length = path.length; pos < length; pos++) {
      const ch = path.charCodeAt(pos);

      if (ch === CHAR_PARAM) {
        this.insert(path.slice(0, pos), TYPE_STATIC);
        pos++;
        const start = pos;
        pos += path.slice(pos).match(/^([^/]*)/)[1].length;
        paramNames.push(path.slice(start, pos));
        path = path.slice(0, start) + path.slice(pos);
        length = path.length;

        if (start === length) {
          return this.insert(path, TYPE_PARAM, paramNames, handler);
        }

        pos = start;
        this.insert(path.slice(0, pos), TYPE_PARAM, paramNames);
      } else if (ch === CHAR_MATCH_ANY) {
        this.insert(path.slice(0, pos), TYPE_STATIC);
        paramNames.push('*');
        return this.insert(path, TYPE_MATCH_ANY, paramNames, handler);
      }
    }

    this.insert(path, TYPE_STATIC, paramNames, handler);
  }

  insert(path, type, paramNames, handler) {
    let current = this;

    while (true) {
      const pos = (0, _utils.getCommonOffset)(current.prefix, path);
      const {
        prefix
      } = current;

      if (pos < prefix.length) {
        const node = new Node(prefix.slice(pos), current.type, current.children, current.handler, current.paramNames);
        current.initialize(prefix.slice(0, pos));
        current.addChild(node);

        if (pos < path.length) {
          const node = new Node(path.slice(pos), type);
          current.addChild(node);
          current = node;
        }
      } else if (pos < path.length) {
        path = path.slice(pos);
        const child = current.findChildWithLabel(path.charCodeAt(0));

        if (child !== undefined) {
          current = child;
          continue;
        }

        const node = new Node(path, type);
        current.addChild(node);
        current = node;
      }

      if (handler) {
        current.handler = handler;
        current.paramNames = paramNames;
      }

      if (paramNames) {
        current.paramName = paramNames[paramNames.length - 1];
      }

      break;
    }
  }

  find(path, paramValues = []) {
    const {
      prefix
    } = this;

    if (!path || path === prefix) {
      const {
        handler
      } = this;

      if (handler) {
        const params = {};
        let i = 0;

        for (const name of this.paramNames) {
          params[name] = paramValues[i++];
        }

        return {
          handler,
          params,
          status: 200
        };
      }

      return null;
    }

    const pos = (0, _utils.getCommonOffset)(this.prefix, path);
    const prefixLength = prefix.length;
    const fullMatch = pos === prefixLength;

    if (fullMatch) {
      path = path.slice(prefixLength);
    } else if (this.type !== TYPE_PARAM) {
      return null;
    }

    const staticChild = this.findChild(path.charCodeAt(0), TYPE_STATIC);

    if (staticChild) {
      const result = staticChild.find(path, paramValues);

      if (result) {
        return result;
      }
    }

    if (!fullMatch) {
      return null;
    }

    const paramChild = this.findChildWithType(TYPE_PARAM);

    if (paramChild) {
      let pos = 0;
      const max = path.length;

      while (pos < max && path.charCodeAt(pos) !== CHAR_SLASH) {
        pos++;
      }

      paramValues.push(path.slice(0, pos));
      const result = paramChild.find(path.slice(pos), paramValues);

      if (result) {
        return result;
      }

      paramValues.pop();
    }

    const matchAnyChild = this.findChildWithType(TYPE_MATCH_ANY);

    if (matchAnyChild) {
      paramValues.push(path);
      return matchAnyChild.find('', paramValues);
    }

    return null;
  }

  toString(prefix = '', tail = true, root = true) {
    const handler = this.handler && `${this.handler.name || 'ƒ'}()`;

    const format = (prefix, tail, on, off) => root ? '' : `${prefix}${tail ? on : off}`;

    const {
      children
    } = this;
    const lines = [`${format(prefix, tail, '└── ', '├── ')}${this.type === TYPE_PARAM ? `${this.prefix}${this.paramName}` : this.prefix}${handler ? ` ${handler}` : ''} children=${children.length}`];
    const str = format(prefix, tail, '    ', '│   ');

    for (let i = 0, l = children.length - 1; i <= l; i++) {
      lines.push(children[i].toString(str, i === l, false));
    }

    return lines.join('\n');
  }

}

exports.default = Node;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Ob2RlLmpzIl0sIm5hbWVzIjpbIlRZUEVfU1RBVElDIiwiVFlQRV9QQVJBTSIsIlRZUEVfTUFUQ0hfQU5ZIiwiQ0hBUl9QQVJBTSIsImNoYXJDb2RlQXQiLCJDSEFSX01BVENIX0FOWSIsIkNIQVJfU0xBU0giLCJOb2RlIiwiY29uc3RydWN0b3IiLCJhcmdzIiwiaW5pdGlhbGl6ZSIsInByZWZpeCIsInR5cGUiLCJjaGlsZHJlbiIsImhhbmRsZXIiLCJwYXJhbU5hbWVzIiwibGFiZWwiLCJwYXJhbU5hbWUiLCJhZGRDaGlsZCIsImNoaWxkIiwicHVzaCIsImZpbmRDaGlsZCIsImZpbmRDaGlsZFdpdGhMYWJlbCIsImZpbmRDaGlsZFdpdGhUeXBlIiwiYWRkIiwicGF0aCIsInBvcyIsImxlbmd0aCIsImNoIiwiaW5zZXJ0Iiwic2xpY2UiLCJzdGFydCIsIm1hdGNoIiwiY3VycmVudCIsIm5vZGUiLCJ1bmRlZmluZWQiLCJmaW5kIiwicGFyYW1WYWx1ZXMiLCJwYXJhbXMiLCJpIiwibmFtZSIsInN0YXR1cyIsInByZWZpeExlbmd0aCIsImZ1bGxNYXRjaCIsInN0YXRpY0NoaWxkIiwicmVzdWx0IiwicGFyYW1DaGlsZCIsIm1heCIsInBvcCIsIm1hdGNoQW55Q2hpbGQiLCJ0b1N0cmluZyIsInRhaWwiLCJyb290IiwiZm9ybWF0Iiwib24iLCJvZmYiLCJsaW5lcyIsInN0ciIsImwiLCJqb2luIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBOztBQUdBLE1BQU1BLFdBQVcsR0FBRyxDQUFwQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyxDQUFuQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUF2QjtBQUdBLE1BQU1DLFVBQVUsR0FBRyxJQUFJQyxVQUFKLENBQWUsQ0FBZixDQUFuQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxJQUFJRCxVQUFKLENBQWUsQ0FBZixDQUF2QjtBQUNBLE1BQU1FLFVBQVUsR0FBRyxJQUFJRixVQUFKLENBQWUsQ0FBZixDQUFuQjs7QUFF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LENBQUMsR0FBRzdDLFFBQVEsQ0FBQ2MsTUFBVCxHQUFrQixDQUF0QyxFQUF5Q1ksQ0FBQyxJQUFJbUIsQ0FBOUMsRUFBaURuQixDQUFDLEVBQWxELEVBQXNEO0FBQ3BEaUIsTUFBQUEsS0FBSyxDQUFDcEMsSUFBTixDQUFXUCxRQUFRLENBQUMwQixDQUFELENBQVIsQ0FBWVcsUUFBWixDQUFxQk8sR0FBckIsRUFBMEJsQixDQUFDLEtBQUttQixDQUFoQyxFQUFtQyxLQUFuQyxDQUFYO0FBQ0Q7O0FBQ0QsV0FBT0YsS0FBSyxDQUFDRyxJQUFOLENBQVcsSUFBWCxDQUFQO0FBQ0Q7O0FBL051QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldENvbW1vbk9mZnNldCB9IGZyb20gJ0BkaXRvanMvdXRpbHMnXG5cbi8vIE5vZGUgVHlwZXM6XG5jb25zdCBUWVBFX1NUQVRJQyA9IDBcbmNvbnN0IFRZUEVfUEFSQU0gPSAxXG5jb25zdCBUWVBFX01BVENIX0FOWSA9IDJcblxuLy8gQ2hhciBDb2Rlc1xuY29uc3QgQ0hBUl9QQVJBTSA9ICc6Jy5jaGFyQ29kZUF0KDApXG5jb25zdCBDSEFSX01BVENIX0FOWSA9ICcqJy5jaGFyQ29kZUF0KDApXG5jb25zdCBDSEFSX1NMQVNIID0gJy8nLmNoYXJDb2RlQXQoMClcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTm9kZSB7XG4gIGNvbnN0cnVjdG9yKC4uLmFyZ3MpIHtcbiAgICB0aGlzLmluaXRpYWxpemUoLi4uYXJncylcbiAgfVxuXG4gIGluaXRpYWxpemUoXG4gICAgcHJlZml4ID0gJy8nLFxuICAgIHR5cGUgPSBUWVBFX1NUQVRJQyxcbiAgICBjaGlsZHJlbiA9IFtdLFxuICAgIGhhbmRsZXIgPSBudWxsLFxuICAgIHBhcmFtTmFtZXMgPSBudWxsXG4gICkge1xuICAgIHRoaXMubGFiZWwgPSBwcmVmaXguY2hhckNvZGVBdCgwKVxuICAgIHRoaXMucHJlZml4ID0gcHJlZml4XG4gICAgdGhpcy50eXBlID0gdHlwZVxuICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlblxuICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXJcbiAgICB0aGlzLnBhcmFtTmFtZXMgPSBwYXJhbU5hbWVzXG4gICAgdGhpcy5wYXJhbU5hbWUgPSBudWxsXG4gIH1cblxuICBhZGRDaGlsZChjaGlsZCkge1xuICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZClcbiAgfVxuXG4gIGZpbmRDaGlsZChsYWJlbCwgdHlwZSkge1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikge1xuICAgICAgaWYgKGNoaWxkLmxhYmVsID09PSBsYWJlbCAmJiBjaGlsZC50eXBlID09PSB0eXBlKSB7XG4gICAgICAgIHJldHVybiBjaGlsZFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZpbmRDaGlsZFdpdGhMYWJlbChsYWJlbCkge1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikge1xuICAgICAgaWYgKGNoaWxkLmxhYmVsID09PSBsYWJlbCkge1xuICAgICAgICByZXR1cm4gY2hpbGRcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmaW5kQ2hpbGRXaXRoVHlwZSh0eXBlKSB7XG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmNoaWxkcmVuKSB7XG4gICAgICBpZiAoY2hpbGQudHlwZSA9PT0gdHlwZSkge1xuICAgICAgICByZXR1cm4gY2hpbGRcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhZGQocGF0aCwgaGFuZGxlcikge1xuICAgIGNvbnN0IHBhcmFtTmFtZXMgPSBbXVxuICAgIGZvciAobGV0IHBvcyA9IDAsIGxlbmd0aCA9IHBhdGgubGVuZ3RoOyBwb3MgPCBsZW5ndGg7IHBvcysrKSB7XG4gICAgICBjb25zdCBjaCA9IHBhdGguY2hhckNvZGVBdChwb3MpXG4gICAgICBpZiAoY2ggPT09IENIQVJfUEFSQU0pIHtcbiAgICAgICAgdGhpcy5pbnNlcnQocGF0aC5zbGljZSgwLCBwb3MpLCBUWVBFX1NUQVRJQylcbiAgICAgICAgcG9zKysgLy8gU2tpcCBjb2xvbi5cbiAgICAgICAgY29uc3Qgc3RhcnQgPSBwb3NcbiAgICAgICAgLy8gTW92ZSBwb3MgdG8gdGhlIG5leHQgb2NjdXJyZW5jZSBvZiB0aGUgc2xhc2ggb3IgdGhlIGVuZDpcbiAgICAgICAgcG9zICs9IHBhdGguc2xpY2UocG9zKS5tYXRjaCgvXihbXi9dKikvKVsxXS5sZW5ndGhcblxuICAgICAgICBwYXJhbU5hbWVzLnB1c2gocGF0aC5zbGljZShzdGFydCwgcG9zKSlcbiAgICAgICAgLy8gQ2hvcCBvdXQgcGFyYW0gbmFtZSBmcm9tIHBhdGgsIGJ1dCBrZWVwIGNvbG9uLlxuICAgICAgICBwYXRoID0gcGF0aC5zbGljZSgwLCBzdGFydCkgKyBwYXRoLnNsaWNlKHBvcylcbiAgICAgICAgbGVuZ3RoID0gcGF0aC5sZW5ndGggLy8gVXBkYXRlIGxlbmd0aCBhZnRlciBjaGFuZ2luZyBwYXRoLlxuXG4gICAgICAgIGlmIChzdGFydCA9PT0gbGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0KHBhdGgsIFRZUEVfUEFSQU0sIHBhcmFtTmFtZXMsIGhhbmRsZXIpXG4gICAgICAgIH1cbiAgICAgICAgcG9zID0gc3RhcnRcbiAgICAgICAgdGhpcy5pbnNlcnQocGF0aC5zbGljZSgwLCBwb3MpLCBUWVBFX1BBUkFNLCBwYXJhbU5hbWVzKVxuICAgICAgfSBlbHNlIGlmIChjaCA9PT0gQ0hBUl9NQVRDSF9BTlkpIHtcbiAgICAgICAgdGhpcy5pbnNlcnQocGF0aC5zbGljZSgwLCBwb3MpLCBUWVBFX1NUQVRJQylcbiAgICAgICAgcGFyYW1OYW1lcy5wdXNoKCcqJylcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0KHBhdGgsIFRZUEVfTUFUQ0hfQU5ZLCBwYXJhbU5hbWVzLCBoYW5kbGVyKVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmluc2VydChwYXRoLCBUWVBFX1NUQVRJQywgcGFyYW1OYW1lcywgaGFuZGxlcilcbiAgfVxuXG4gIGluc2VydChwYXRoLCB0eXBlLCBwYXJhbU5hbWVzLCBoYW5kbGVyKSB7XG4gICAgbGV0IGN1cnJlbnQgPSB0aGlzXG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIC8vIEZpbmQgdGhlIHBvc2l0aW9uIHdoZXJlIHRoZSBwYXRoIGFuZCB0aGUgbm9kZSdzIHByZWZpeCBzdGFydCBkaXZlcmdpbmcuXG4gICAgICBjb25zdCBwb3MgPSBnZXRDb21tb25PZmZzZXQoY3VycmVudC5wcmVmaXgsIHBhdGgpXG4gICAgICBjb25zdCB7IHByZWZpeCB9ID0gY3VycmVudFxuICAgICAgaWYgKHBvcyA8IHByZWZpeC5sZW5ndGgpIHtcbiAgICAgICAgLy8gU3BsaXQgbm9kZVxuICAgICAgICBjb25zdCBub2RlID0gbmV3IE5vZGUoXG4gICAgICAgICAgcHJlZml4LnNsaWNlKHBvcyksXG4gICAgICAgICAgY3VycmVudC50eXBlLFxuICAgICAgICAgIGN1cnJlbnQuY2hpbGRyZW4sXG4gICAgICAgICAgY3VycmVudC5oYW5kbGVyLFxuICAgICAgICAgIGN1cnJlbnQucGFyYW1OYW1lc1xuICAgICAgICApXG4gICAgICAgIC8vIFJlc2V0IHBhcmVudCBub2RlIGFuZCBhZGQgbmV3IG5vZGUgYXMgY2hpbGQgdG8gaXQ6XG4gICAgICAgIGN1cnJlbnQuaW5pdGlhbGl6ZShwcmVmaXguc2xpY2UoMCwgcG9zKSlcbiAgICAgICAgY3VycmVudC5hZGRDaGlsZChub2RlKVxuICAgICAgICBpZiAocG9zIDwgcGF0aC5sZW5ndGgpIHtcbiAgICAgICAgICAvLyBDcmVhdGUgY2hpbGQgbm9kZVxuICAgICAgICAgIGNvbnN0IG5vZGUgPSBuZXcgTm9kZShwYXRoLnNsaWNlKHBvcyksIHR5cGUpXG4gICAgICAgICAgY3VycmVudC5hZGRDaGlsZChub2RlKVxuICAgICAgICAgIGN1cnJlbnQgPSBub2RlIC8vIFN3aXRjaCB0byBjaGlsZCB0byBzZXQgaGFuZGxlciBhbmQgcGFyYW1OYW1lc1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHBvcyA8IHBhdGgubGVuZ3RoKSB7XG4gICAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHBvcylcbiAgICAgICAgY29uc3QgY2hpbGQgPSBjdXJyZW50LmZpbmRDaGlsZFdpdGhMYWJlbChwYXRoLmNoYXJDb2RlQXQoMCkpXG4gICAgICAgIGlmIChjaGlsZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgLy8gR28gZGVlcGVyXG4gICAgICAgICAgY3VycmVudCA9IGNoaWxkXG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgfVxuICAgICAgICAvLyBDcmVhdGUgY2hpbGQgbm9kZVxuICAgICAgICBjb25zdCBub2RlID0gbmV3IE5vZGUocGF0aCwgdHlwZSlcbiAgICAgICAgY3VycmVudC5hZGRDaGlsZChub2RlKVxuICAgICAgICBjdXJyZW50ID0gbm9kZSAvLyBTd2l0Y2ggdG8gY2hpbGQgdG8gc2V0IGhhbmRsZXIgYW5kIHBhcmFtTmFtZXNcbiAgICAgIH1cbiAgICAgIGlmIChoYW5kbGVyKSB7XG4gICAgICAgIGN1cnJlbnQuaGFuZGxlciA9IGhhbmRsZXJcbiAgICAgICAgY3VycmVudC5wYXJhbU5hbWVzID0gcGFyYW1OYW1lc1xuICAgICAgfVxuICAgICAgaWYgKHBhcmFtTmFtZXMpIHtcbiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIGxhc3QgZW50cnkgZnJvbSB0aGUgbGlzdCBvZiBwYXJhbSBuYW1lcyB0aGF0IGtlZXBzXG4gICAgICAgIC8vIGdyb3dpbmcgZHVyaW5nIHBhcnNpbmcgYXMgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgbm9kZS5cbiAgICAgICAgY3VycmVudC5wYXJhbU5hbWUgPSBwYXJhbU5hbWVzW3BhcmFtTmFtZXMubGVuZ3RoIC0gMV1cbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgZmluZChwYXRoLCBwYXJhbVZhbHVlcyA9IFtdKSB7XG4gICAgY29uc3QgeyBwcmVmaXggfSA9IHRoaXNcbiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gcHJlZml4KSB7XG4gICAgICAvLyBJdCdzIGEgbWF0Y2ghXG4gICAgICBjb25zdCB7IGhhbmRsZXIgfSA9IHRoaXNcbiAgICAgIGlmIChoYW5kbGVyKSB7XG4gICAgICAgIC8vIENvbnZlcnQgcGFyYW1OYW1lcyBhbmQgdmFsdWVzIHRvIHBhcmFtcy5cbiAgICAgICAgY29uc3QgcGFyYW1zID0ge31cbiAgICAgICAgbGV0IGkgPSAwXG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiB0aGlzLnBhcmFtTmFtZXMpIHtcbiAgICAgICAgICBwYXJhbXNbbmFtZV0gPSBwYXJhbVZhbHVlc1tpKytdXG4gICAgICAgIH1cbiAgICAgICAgLy8gU3VwcG9ydCBIVFRQIHN0YXR1cyBvbiBmb3VuZCBlbnRyaWVzLlxuICAgICAgICByZXR1cm4geyBoYW5kbGVyLCBwYXJhbXMsIHN0YXR1czogMjAwIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgY29uc3QgcG9zID0gZ2V0Q29tbW9uT2Zmc2V0KHRoaXMucHJlZml4LCBwYXRoKVxuICAgIGNvbnN0IHByZWZpeExlbmd0aCA9IHByZWZpeC5sZW5ndGhcbiAgICBjb25zdCBmdWxsTWF0Y2ggPSBwb3MgPT09IHByZWZpeExlbmd0aFxuICAgIGlmIChmdWxsTWF0Y2gpIHtcbiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHByZWZpeExlbmd0aClcbiAgICB9IGVsc2UgaWYgKHRoaXMudHlwZSAhPT0gVFlQRV9QQVJBTSkge1xuICAgICAgLy8gSWYgdGhlIHBhdGggZG9lc24ndCBmdWxseSBtYXRjaCB0aGUgcHJlZml4LCB3ZSBvbmx5IG5lZWQgdG8gbG9va1xuICAgICAgLy8gZnVydGhlciBvbiBwYXJhbSBub2Rlcywgd2hpY2ggY2FuIGhhdmUgb3ZlcmxhcHBpbmcgc3RhdGljIGNoaWxkcmVuLlxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICAvLyBTZWFyY2ggb3JkZXI6IFN0YXRpYyA+IFBhcmFtID4gTWF0Y2gtYW55XG5cbiAgICAvLyBTdGF0aWMgbm9kZVxuICAgIGNvbnN0IHN0YXRpY0NoaWxkID0gdGhpcy5maW5kQ2hpbGQocGF0aC5jaGFyQ29kZUF0KDApLCBUWVBFX1NUQVRJQylcbiAgICBpZiAoc3RhdGljQ2hpbGQpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHN0YXRpY0NoaWxkLmZpbmQocGF0aCwgcGFyYW1WYWx1ZXMpXG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBOb2RlIG5vdCBmb3VuZFxuICAgIGlmICghZnVsbE1hdGNoKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIC8vIFBhcmFtIG5vZGVcbiAgICBjb25zdCBwYXJhbUNoaWxkID0gdGhpcy5maW5kQ2hpbGRXaXRoVHlwZShUWVBFX1BBUkFNKVxuICAgIGlmIChwYXJhbUNoaWxkKSB7XG4gICAgICAvLyBGaW5kIHRoZSBwb3NpdGlvbiBvZiB0aGUgbmV4dCBzbGFzaDpcbiAgICAgIGxldCBwb3MgPSAwXG4gICAgICBjb25zdCBtYXggPSBwYXRoLmxlbmd0aFxuICAgICAgd2hpbGUgKHBvcyA8IG1heCAmJiBwYXRoLmNoYXJDb2RlQXQocG9zKSAhPT0gQ0hBUl9TTEFTSCkge1xuICAgICAgICBwb3MrK1xuICAgICAgfVxuICAgICAgcGFyYW1WYWx1ZXMucHVzaChwYXRoLnNsaWNlKDAsIHBvcykpXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXJhbUNoaWxkLmZpbmQocGF0aC5zbGljZShwb3MpLCBwYXJhbVZhbHVlcylcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgfVxuICAgICAgcGFyYW1WYWx1ZXMucG9wKClcbiAgICB9XG5cbiAgICAvLyBNYXRjaC1hbnkgbm9kZVxuICAgIGNvbnN0IG1hdGNoQW55Q2hpbGQgPSB0aGlzLmZpbmRDaGlsZFdpdGhUeXBlKFRZUEVfTUFUQ0hfQU5ZKVxuICAgIGlmIChtYXRjaEFueUNoaWxkKSB7XG4gICAgICBwYXJhbVZhbHVlcy5wdXNoKHBhdGgpXG4gICAgICByZXR1cm4gbWF0Y2hBbnlDaGlsZC5maW5kKCcnLCBwYXJhbVZhbHVlcykgLy8gJycgPT0gRW5kXG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIHRvU3RyaW5nKHByZWZpeCA9ICcnLCB0YWlsID0gdHJ1ZSwgcm9vdCA9IHRydWUpIHtcbiAgICBjb25zdCBoYW5kbGVyID0gdGhpcy5oYW5kbGVyICYmIGAke3RoaXMuaGFuZGxlci5uYW1lIHx8ICfGkid9KClgXG4gICAgY29uc3QgZm9ybWF0ID0gKHByZWZpeCwgdGFpbCwgb24sIG9mZikgPT5cbiAgICAgIHJvb3QgPyAnJyA6IGAke3ByZWZpeH0ke3RhaWwgPyBvbiA6IG9mZn1gXG4gICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gdGhpc1xuICAgIGNvbnN0IGxpbmVzID0gW1xuICAgICAgYCR7Zm9ybWF0KHByZWZpeCwgdGFpbCwgJ+KUlOKUgOKUgCAnLCAn4pSc4pSA4pSAICcpfSR7XG4gICAgICAgIHRoaXMudHlwZSA9PT0gVFlQRV9QQVJBTVxuICAgICAgICAgID8gYCR7dGhpcy5wcmVmaXh9JHt0aGlzLnBhcmFtTmFtZX1gXG4gICAgICAgICAgOiB0aGlzLnByZWZpeFxuICAgICAgfSR7XG4gICAgICAgIGhhbmRsZXIgPyBgICR7aGFuZGxlcn1gIDogJydcbiAgICAgIH0gY2hpbGRyZW49JHtcbiAgICAgICAgY2hpbGRyZW4ubGVuZ3RoXG4gICAgICB9YFxuICAgIF1cblxuICAgIGNvbnN0IHN0ciA9IGZvcm1hdChwcmVmaXgsIHRhaWwsICcgICAgJywgJ+KUgiAgICcpXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGggLSAxOyBpIDw9IGw7IGkrKykge1xuICAgICAgbGluZXMucHVzaChjaGlsZHJlbltpXS50b1N0cmluZyhzdHIsIGkgPT09IGwsIGZhbHNlKSlcbiAgICB9XG4gICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcbicpXG4gIH1cbn1cbiJdfQ==