"use strict";

require("core-js/modules/esnext.weak-map.delete-all.js");

exports.__esModule = true;
exports.Validator = void 0;

var _objection = _interopRequireDefault(require("objection"));

var _ajv = _interopRequireDefault(require("ajv"));

var _ajvFormats = _interopRequireDefault(require("ajv-formats"));

var _utils = require("@ditojs/utils");

var _utils2 = require("../utils");

var schema = _interopRequireWildcard(require("../schema"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Validator extends _objection.default.Validator {
  constructor({
    options,
    keywords,
    formats
  } = {}) {
    super();
    this.options = { ...defaultOptions,
      ...options
    };
    this.keywords = { ...schema.keywords,
      ...keywords
    };
    this.formats = { ...schema.formats,
      ...formats
    };
    this.schemas = [];
    this.ajvCache = Object.create(null);
  }

  createAjv(options) {
    const {
      async,
      patch,
      ...opts
    } = options;
    const ajv = new _ajv.default({ ...this.options,
      ...opts,
      ...(patch && {
        useDefaults: false
      })
    });
    (0, _ajvFormats.default)(ajv, {
      mode: 'full'
    });

    const addSchemas = (schemas, callback) => {
      for (const [name, schema] of Object.entries(schemas)) {
        if (schema) {
          callback(name.replace(/^_/, ''), schema);
        }
      }
    };

    addSchemas(this.keywords, (keyword, schema) => ajv.addKeyword({
      keyword,
      ...schema
    }));
    addSchemas(this.formats, (format, schema) => ajv.addFormat(format, { ...schema
    }));

    for (const schema of this.schemas) {
      ajv.addSchema(this.processSchema(schema, options));
    }

    return ajv;
  }

  getAjv(options = {}) {
    const opts = Object.entries(options).reduce((opts, [key, value]) => {
      if (key in validatorOptions && value !== validatorOptions[key]) {
        opts[key] = value;
      }

      return opts;
    }, {});
    const cacheKey = (0, _utils2.formatJson)(opts, false);
    const {
      ajv
    } = this.ajvCache[cacheKey] || (this.ajvCache[cacheKey] = {
      ajv: this.createAjv(opts),
      options
    });
    return ajv;
  }

  compile(jsonSchema, options = {}) {
    const ajv = this.getAjv(options);
    const validator = ajv.compile(this.processSchema(jsonSchema, options));
    const dontThrow = options.throw === false;
    return options.async ? dontThrow ? async function validate(data) {
      let result;

      try {
        result = await validator.call(this, data);
      } catch (error) {
        if (error.errors) {
          validate.errors = error.errors;
          result = false;
        } else {
          throw error;
        }
      }

      return result;
    } : validator : dontThrow ? validator : function (data) {
      const result = validator.call(this, data);

      if (!result) {
        throw new _ajv.default.ValidationError(validator.errors);
      }

      return result;
    };
  }

  getKeyword(keyword) {
    return this.keywords[keyword];
  }

  getFormat(format) {
    return this.formats[format];
  }

  addSchema(jsonSchema) {
    this.schemas.push(jsonSchema);

    for (const {
      ajv,
      options
    } of Object.values(this.ajvCache)) {
      ajv.addSchema(this.processSchema(jsonSchema, options));
    }
  }

  processSchema(jsonSchema, options = {}) {
    const {
      patch,
      async
    } = options;
    const schema = (0, _utils.clone)(jsonSchema, value => {
      if ((0, _utils.isObject)(value)) {
        if (patch) {
          delete value.required;

          if (value.format === 'required') {
            delete value.format;
          }
        }

        if ((0, _utils.isAsync)(value.validate)) {
          value.validateAsync = value.validate;
          delete value.validate;
        }

        if (!async) {
          for (const key in value) {
            const keyword = this.getKeyword(key);

            if (keyword != null && keyword.async) {
              delete value[key];
            }
          }
        }
      }
    });

    if (async) {
      schema.$async = true;
    }

    return schema;
  }

  parseErrors(errors, options = {}) {
    const errorHash = {};
    const duplicates = {};

    for (const error of errors) {
      const dataPath = `${(options == null ? void 0 : options.dataPath) || ''}${error.dataPath}`;
      const key = dataPath.replace(/\['([^']*)'\]/g, '.$1').slice(1);
      const {
        message,
        keyword,
        params
      } = error;
      const definition = keyword === 'format' ? this.getFormat(params.format) : this.getKeyword(keyword);
      const identifier = `${key}_${keyword}`;

      if (!duplicates[identifier] && !/^\$/.test(keyword) && !(definition != null && definition.macro) && !(definition != null && definition.silent)) {
        const array = errorHash[key] || (errorHash[key] = []);
        array.push({
          message: (definition == null ? void 0 : definition.message) || message,
          keyword,
          params
        });
        duplicates[identifier] = true;
      }
    }

    for (const [dataPath, errors] of Object.entries(errorHash)) {
      if (errors.length === 2) {
        const [error1, error2] = errors;

        if (error1.keyword === 'type' && error1.params.type === 'null' && error2.keyword === 'oneOf') {
          delete errorHash[dataPath];
        }
      }
    }

    return errorHash;
  }

  prefixDataPaths(errors, dataPathPrefix) {
    return errors.map(error => ({ ...error,
      dataPath: error.dataPath ? `${dataPathPrefix}${error.dataPath}` : dataPathPrefix
    }));
  }

  beforeValidate({
    json,
    model,
    ctx,
    options
  }) {
    ctx.validator = this;
    ctx.app = this.app;
    ctx.options = options;
    ctx.jsonSchema = model.constructor.getJsonSchema();
    const {
      $beforeValidate
    } = model;

    if ($beforeValidate !== _objection.default.Model.prototype.$beforeValidate) {
      if ($beforeValidate.length > 0) {
        ctx.jsonSchema = (0, _utils.clone)(ctx.jsonSchema);
      }

      const ret = model.$beforeValidate(ctx.jsonSchema, json, options);

      if (ret !== undefined) {
        ctx.jsonSchema = ret;
      }
    }
  }

  validate({
    json,
    model,
    ctx,
    options
  }) {
    const {
      jsonSchema
    } = ctx;

    if (jsonSchema) {
      if (!options.mutable && !options.patch && hasDefaults(jsonSchema.properties)) {
        json = (0, _utils.clone)(json);
      }

      const validate = this.getAjv(options).getSchema(jsonSchema.$id);
      const res = validate.call(ctx, json);

      const handleErrors = errors => {
        if (errors) {
          throw model.constructor.createValidationError({
            type: 'ModelValidation',
            errors,
            options,
            json
          });
        }
      };

      if ((0, _utils.isPromise)(res)) {
        return res.catch(error => handleErrors(error.errors)).then(() => json);
      } else {
        handleErrors(validate.errors);
        return json;
      }
    }
  }

}

exports.Validator = Validator;

function hasDefaults(obj) {
  if ((0, _utils.isArray)(obj)) {
    for (const val of obj) {
      if (val && hasDefaults(val)) {
        return true;
      }
    }
  } else if ((0, _utils.isObject)(obj)) {
    for (const [key, val] of Object.entries(obj)) {
      if (key === 'default' || val && hasDefaults(val)) {
        return true;
      }
    }
  }

  return false;
}

const defaultOptions = {
  strict: false,
  allErrors: true,
  ownProperties: true,
  passContext: true,
  useDefaults: true,
  validateSchema: true
};
const validatorOptions = {
  async: false,
  patch: false,
  $data: false,
  $comment: false,
  coerceTypes: false,
  multipleOfPrecision: false,
  ownProperties: true,
  removeAdditional: false,
  uniqueItems: true,
  useDefaults: true,
  verbose: false
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHAvVmFsaWRhdG9yLmpzIl0sIm5hbWVzIjpbIlZhbGlkYXRvciIsIm9iamVjdGlvbiIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImtleXdvcmRzIiwiZm9ybWF0cyIsImRlZmF1bHRPcHRpb25zIiwic2NoZW1hIiwic2NoZW1hcyIsImFqdkNhY2hlIiwiT2JqZWN0IiwiY3JlYXRlIiwiY3JlYXRlQWp2IiwiYXN5bmMiLCJwYXRjaCIsIm9wdHMiLCJhanYiLCJBanYiLCJ1c2VEZWZhdWx0cyIsIm1vZGUiLCJhZGRTY2hlbWFzIiwiY2FsbGJhY2siLCJuYW1lIiwiZW50cmllcyIsInJlcGxhY2UiLCJrZXl3b3JkIiwiYWRkS2V5d29yZCIsImZvcm1hdCIsImFkZEZvcm1hdCIsImFkZFNjaGVtYSIsInByb2Nlc3NTY2hlbWEiLCJnZXRBanYiLCJyZWR1Y2UiLCJrZXkiLCJ2YWx1ZSIsInZhbGlkYXRvck9wdGlvbnMiLCJjYWNoZUtleSIsImNvbXBpbGUiLCJqc29uU2NoZW1hIiwidmFsaWRhdG9yIiwiZG9udFRocm93IiwidGhyb3ciLCJ2YWxpZGF0ZSIsImRhdGEiLCJyZXN1bHQiLCJjYWxsIiwiZXJyb3IiLCJlcnJvcnMiLCJWYWxpZGF0aW9uRXJyb3IiLCJnZXRLZXl3b3JkIiwiZ2V0Rm9ybWF0IiwicHVzaCIsInZhbHVlcyIsInJlcXVpcmVkIiwidmFsaWRhdGVBc3luYyIsIiRhc3luYyIsInBhcnNlRXJyb3JzIiwiZXJyb3JIYXNoIiwiZHVwbGljYXRlcyIsImRhdGFQYXRoIiwic2xpY2UiLCJtZXNzYWdlIiwicGFyYW1zIiwiZGVmaW5pdGlvbiIsImlkZW50aWZpZXIiLCJ0ZXN0IiwibWFjcm8iLCJzaWxlbnQiLCJhcnJheSIsImxlbmd0aCIsImVycm9yMSIsImVycm9yMiIsInR5cGUiLCJwcmVmaXhEYXRhUGF0aHMiLCJkYXRhUGF0aFByZWZpeCIsIm1hcCIsImJlZm9yZVZhbGlkYXRlIiwianNvbiIsIm1vZGVsIiwiY3R4IiwiYXBwIiwiZ2V0SnNvblNjaGVtYSIsIiRiZWZvcmVWYWxpZGF0ZSIsIk1vZGVsIiwicHJvdG90eXBlIiwicmV0IiwidW5kZWZpbmVkIiwibXV0YWJsZSIsImhhc0RlZmF1bHRzIiwicHJvcGVydGllcyIsImdldFNjaGVtYSIsIiRpZCIsInJlcyIsImhhbmRsZUVycm9ycyIsImNyZWF0ZVZhbGlkYXRpb25FcnJvciIsImNhdGNoIiwidGhlbiIsIm9iaiIsInZhbCIsInN0cmljdCIsImFsbEVycm9ycyIsIm93blByb3BlcnRpZXMiLCJwYXNzQ29udGV4dCIsInZhbGlkYXRlU2NoZW1hIiwiJGRhdGEiLCIkY29tbWVudCIsImNvZXJjZVR5cGVzIiwibXVsdGlwbGVPZlByZWNpc2lvbiIsInJlbW92ZUFkZGl0aW9uYWwiLCJ1bmlxdWVJdGVtcyIsInZlcmJvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFVTyxNQUFNQSxTQUFOLFNBQXdCQyxtQkFBVUQsU0FBbEMsQ0FBNEM7QUFDakRFLEVBQUFBLFdBQVcsQ0FBQztBQUFFQyxJQUFBQSxPQUFGO0FBQVdDLElBQUFBLFFBQVg7QUFBcUJDLElBQUFBO0FBQXJCLE1BQWlDLEVBQWxDLEVBQXNDO0FBQy9DO0FBRUEsU0FBS0YsT0FBTCxHQUFlLEVBQ2IsR0FBR0csY0FEVTtBQUViLFNBQUdIO0FBRlUsS0FBZjtBQUtBLFNBQUtDLFFBQUwsR0FBZ0IsRUFDZCxHQUFHRyxNQUFNLENBQUNILFFBREk7QUFFZCxTQUFHQTtBQUZXLEtBQWhCO0FBS0EsU0FBS0MsT0FBTCxHQUFlLEVBQ2IsR0FBR0UsTUFBTSxDQUFDRixPQURHO0FBRWIsU0FBR0E7QUFGVSxLQUFmO0FBS0EsU0FBS0csT0FBTCxHQUFlLEVBQWY7QUFJQSxTQUFLQyxRQUFMLEdBQWdCQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxJQUFkLENBQWhCO0FBQ0Q7O0FBRURDLEVBQUFBLFNBQVMsQ0FBQ1QsT0FBRCxFQUFVO0FBRWpCLFVB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aW1wb3J0IG9iamVjdGlvbiBmcm9tICdvYmplY3Rpb24nXG5pbXBvcnQgQWp2IGZyb20gJ2FqdidcbmltcG9ydCBhZGRGb3JtYXRzIGZyb20gJ2Fqdi1mb3JtYXRzJ1xuaW1wb3J0IHsgaXNBcnJheSwgaXNPYmplY3QsIGNsb25lLCBpc0FzeW5jLCBpc1Byb21pc2UgfSBmcm9tICdAZGl0b2pzL3V0aWxzJ1xuaW1wb3J0IHsgZm9ybWF0SnNvbiB9IGZyb20gJ0AvdXRpbHMnXG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnQC9zY2hlbWEnXG5cbi8vIERpdG8gZG9lcyBub3QgcmVseSBvbiBvYmplY3Rpb24uQWp2VmFsaWRhdG9yIGJ1dCBpbnN0ZWFkIGltcGxlbWVudHMgaXRzIG93blxuLy8gdmFsaWRhdG9yIGluc3RhbmNlIHRoYXQgaXMgc2hhcmVkIGFjcm9zcyB0aGUgd2hvbGUgYXBwIGFuZCBoYW5kbGVzIHNjaGVtYVxuLy8gY29tcGlsYXRpb24gYW5kIGNhY2hpbmcgZGlmZmVyZW50bHk6XG4vLyBJdCByZWxpZXMgb24gQWp2J3MgYWRkU2NoZW1hKCkgLyBnZXRTY2hlbWEoKSBwYXR0ZXJuIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlXG4vLyBgc2NoZW1hSWQ6ICckaWQnYCBvcHRpb24sIGFuZCBlYWNoIHNjaGVtYSBpcyBhc3NpZ25lZCBhbiAkaWQgYmFzZWQgb24gdGhlXG4vLyBtb2RlbCBjbGFzcyBuYW1lLiBUaGF0IHdheSwgc2NoZW1hcyBjYW4gcmVmZXJlbmNlIGVhY2ggb3RoZXIsIGFuZCB0aGV5IGNhblxuLy8gZWFzaWx5IHZhbGlkYXRlIG5lc3RlZCBzdHJ1Y3R1cmVzLlxuXG5leHBvcnQgY2xhc3MgVmFsaWRhdG9yIGV4dGVuZHMgb2JqZWN0aW9uLlZhbGlkYXRvciB7XG4gIGNvbnN0cnVjdG9yKHsgb3B0aW9ucywga2V5d29yZHMsIGZvcm1hdHMgfSA9IHt9KSB7XG4gICAgc3VwZXIoKVxuXG4gICAgdGhpcy5vcHRpb25zID0ge1xuICAgICAgLi4uZGVmYXVsdE9wdGlvbnMsXG4gICAgICAuLi5vcHRpb25zXG4gICAgfVxuXG4gICAgdGhpcy5rZXl3b3JkcyA9IHtcbiAgICAgIC4uLnNjaGVtYS5rZXl3b3JkcyxcbiAgICAgIC4uLmtleXdvcmRzXG4gICAgfVxuXG4gICAgdGhpcy5mb3JtYXRzID0ge1xuICAgICAgLi4uc2NoZW1hLmZvcm1hdHMsXG4gICAgICAuLi5mb3JtYXRzXG4gICAgfVxuXG4gICAgdGhpcy5zY2hlbWFzID0gW11cblxuICAgIC8vIERpY3Rpb25hcnkgdG8gaG9sZCBhbGwgY3JlYXRlZCBBanYgaW5zdGFuY2VzLCB1c2luZyB0aGUgc3RyaW5naWZpZWRcbiAgICAvLyBvcHRpb25zIHdpdGggd2hpY2ggdGhleSB3ZXJlIGNyZWF0ZWQgYXMgdGhlaXIga2V5cy5cbiAgICB0aGlzLmFqdkNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKVxuICB9XG5cbiAgY3JlYXRlQWp2KG9wdGlvbnMpIHtcbiAgICAvLyBTcGxpdCBvcHRpb25zIGludG8gbmF0aXZlIEFqdiBvcHRpb25zIGFuZCBvdXIgYWRkaXRpb25zIChhc3luYywgcGF0Y2gpOlxuICAgIGNvbnN0IHsgYXN5bmMsIHBhdGNoLCAuLi5vcHRzIH0gPSBvcHRpb25zXG4gICAgY29uc3QgYWp2ID0gbmV3IEFqdih7XG4gICAgICAuLi50aGlzLm9wdGlvbnMsXG4gICAgICAuLi5vcHRzLFxuICAgICAgLy8gUGF0Y2gtdmFsaWRhdG9ycyBkb24ndCB1c2UgZGVmYXVsdCB2YWx1ZXM6XG4gICAgICAuLi4ocGF0Y2ggJiYgeyB1c2VEZWZhdWx0czogZmFsc2UgfSlcbiAgICB9KVxuICAgIGFkZEZvcm1hdHMoYWp2LCB7IG1vZGU6ICdmdWxsJyB9KVxuXG4gICAgY29uc3QgYWRkU2NoZW1hcyA9IChzY2hlbWFzLCBjYWxsYmFjaykgPT4ge1xuICAgICAgZm9yIChjb25zdCBbbmFtZSwgc2NoZW1hXSBvZiBPYmplY3QuZW50cmllcyhzY2hlbWFzKSkge1xuICAgICAgICBpZiAoc2NoZW1hKSB7XG4gICAgICAgICAgLy8gUmVtb3ZlIGxlYWRpbmcgJ18nIHRvIHNpbXBsaWZ5IHNwZWNpYWwga2V5d29yZHMgKGUuZy4gaW5zdGFuY2VvZilcbiAgICAgICAgICBjYWxsYmFjayhuYW1lLnJlcGxhY2UoL15fLywgJycpLCBzY2hlbWEpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRTY2hlbWFzKHRoaXMua2V5d29yZHMsIChrZXl3b3JkLCBzY2hlbWEpID0+IGFqdi5hZGRLZXl3b3JkKHtcbiAgICAgIGtleXdvcmQsXG4gICAgICAuLi5zY2hlbWFcbiAgICB9KSlcbiAgICBhZGRTY2hlbWFzKHRoaXMuZm9ybWF0cywgKGZvcm1hdCwgc2NoZW1hKSA9PiBhanYuYWRkRm9ybWF0KGZvcm1hdCwge1xuICAgICAgLi4uc2NoZW1hXG4gICAgfSkpXG5cbiAgICAvLyBBbHNvIGFkZCBhbGwgbW9kZWwgc2NoZW1hcyB0aGF0IHdlcmUgYWxyZWFkeSBjb21waWxlZCBzbyBmYXIuXG4gICAgZm9yIChjb25zdCBzY2hlbWEgb2YgdGhpcy5zY2hlbWFzKSB7XG4gICAgICBhanYuYWRkU2NoZW1hKHRoaXMucHJvY2Vzc1NjaGVtYShzY2hlbWEsIG9wdGlvbnMpKVxuICAgIH1cblxuICAgIHJldHVybiBhanZcbiAgfVxuXG4gIGdldEFqdihvcHRpb25zID0ge30pIHtcbiAgICAvLyBDYWNoZSBBanYgaW5zdGFuY2VzIGJ5IGtleXMgdGhhdCByZXByZXNlbnQgdGhlaXIgb3B0aW9ucy4gRm9yIGltcHJvdmVkXG4gICAgLy8gbWF0Y2hpbmcsIGNvbnZlcnQgb3B0aW9ucyB0byBhIHZlcnNpb24gd2l0aCBhbGwgZGVmYXVsdCB2YWx1ZXMgbWlzc2luZzpcbiAgICBjb25zdCBvcHRzID0gT2JqZWN0LmVudHJpZXMob3B0aW9ucykucmVkdWNlKChvcHRzLCBba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGlmIChrZXkgaW4gdmFsaWRhdG9yT3B0aW9ucyAmJiB2YWx1ZSAhPT0gdmFsaWRhdG9yT3B0aW9uc1trZXldKSB7XG4gICAgICAgIG9wdHNba2V5XSA9IHZhbHVlXG4gICAgICB9XG4gICAgICByZXR1cm4gb3B0c1xuICAgIH0sIHt9KVxuICAgIGNvbnN0IGNhY2hlS2V5ID0gZm9ybWF0SnNvbihvcHRzLCBmYWxzZSlcbiAgICBjb25zdCB7IGFqdiB9ID0gdGhpcy5hanZDYWNoZVtjYWNoZUtleV0gfHwgKHRoaXMuYWp2Q2FjaGVbY2FjaGVLZXldID0ge1xuICAgICAgYWp2OiB0aGlzLmNyZWF0ZUFqdihvcHRzKSxcbiAgICAgIG9wdGlvbnNcbiAgICB9KVxuICAgIHJldHVybiBhanZcbiAgfVxuXG4gIGNvbXBpbGUoanNvblNjaGVtYSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgY29uc3QgYWp2ID0gdGhpcy5nZXRBanYob3B0aW9ucylcbiAgICBjb25zdCB2YWxpZGF0b3IgPSBhanYuY29tcGlsZSh0aGlzLnByb2Nlc3NTY2hlbWEoanNvblNjaGVtYSwgb3B0aW9ucykpXG4gICAgLy8gQXNzdW1lIGBvcHRpb25zLnRocm93ID0gdHJ1ZWAgYXMgdGhlIGRlZmF1bHQuXG4gICAgY29uc3QgZG9udFRocm93ID0gb3B0aW9ucy50aHJvdyA9PT0gZmFsc2VcbiAgICByZXR1cm4gb3B0aW9ucy5hc3luY1xuICAgICAgLy8gRm9yIGFzeW5jOlxuICAgICAgPyBkb250VGhyb3dcbiAgICAgICAgPyBhc3luYyBmdW5jdGlvbiB2YWxpZGF0ZShkYXRhKSB7XG4gICAgICAgICAgLy8gRW11bGF0ZSBgb3B0aW9ucy50aHJvdyA9PSBmYWxzZWAgYmVoYXZpb3IgZm9yIGFzeW5jIHZhbGlkYXRpb246XG4gICAgICAgICAgLy8gUmV0dXJuIGB0cnVlYCBvciBgZmFsc2VgLCBhbmQgc3RvcmUgZXJyb3JzIG9uIGB2YWxpZGF0ZS5lcnJvcnNgXG4gICAgICAgICAgLy8gaWYgdmFsaWRhdGlvbiBmYWlsZWQuXG4gICAgICAgICAgbGV0IHJlc3VsdFxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBVc2UgYGNhbGwoKWAgdG8gcGFzcyBgdGhpc2AgYXMgY29udGV4dCB0byBBanYsIHNlZSBwYXNzQ29udGV4dDpcbiAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHZhbGlkYXRvci5jYWxsKHRoaXMsIGRhdGEpXG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvci5lcnJvcnMpIHtcbiAgICAgICAgICAgICAgdmFsaWRhdGUuZXJyb3JzID0gZXJyb3IuZXJyb3JzXG4gICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aHJvdyBlcnJvclxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgIH1cbiAgICAgICAgOiB2YWxpZGF0b3IgLy8gVGhlIGRlZmF1bHQgZm9yIGFzeW5jIGlzIHRvIHRocm93LlxuICAgICAgLy8gRm9yIHN5bmM6XG4gICAgICA6IGRvbnRUaHJvd1xuICAgICAgICA/IHZhbGlkYXRvciAvLyBUaGUgZGVmYXVsdCBmb3Igc3luYyBpcyB0byBub3QgdGhyb3cuXG4gICAgICAgIDogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgIC8vIEVtdWxhdGUgYG9wdGlvbnMudGhyb3cgPT0gdHJ1ZWAgYmVoYXZpb3IgZm9yIHN5bmMgdmFsaWRhdGlvbjpcbiAgICAgICAgICAvLyBSZXR1cm4gYHRydWVgIGlmIHN1Y2Nlc3NmdWwsIHRocm93IGBBanYuVmFsaWRhdGlvbkVycm9yYCBvdGhlcndpc2UuXG4gICAgICAgICAgLy8gVXNlIGBjYWxsKClgIHRvIHBhc3MgYHRoaXNgIGFzIGNvbnRleHQgdG8gQWp2LCBzZWUgcGFzc0NvbnRleHQ6XG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLmNhbGwodGhpcywgZGF0YSlcbiAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEFqdi5WYWxpZGF0aW9uRXJyb3IodmFsaWRhdG9yLmVycm9ycylcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICB9XG4gIH1cblxuICBnZXRLZXl3b3JkKGtleXdvcmQpIHtcbiAgICByZXR1cm4gdGhpcy5rZXl3b3Jkc1trZXl3b3JkXVxuICB9XG5cbiAgZ2V0Rm9ybWF0KGZvcm1hdCkge1xuICAgIHJldHVybiB0aGlzLmZvcm1hdHNbZm9ybWF0XVxuICB9XG5cbiAgYWRkU2NoZW1hKGpzb25TY2hlbWEpIHtcbiAgICB0aGlzLnNjaGVtYXMucHVzaChqc29uU2NoZW1hKVxuICAgIC8vIEFkZCBzY2hlbWEgdG8gYWxsIHByZXZpb3VzbHkgY3JlYXRlZCBBanYgaW5zdGFuY2VzLCBzbyB0aGV5IGNhbiByZWZlcmVuY2VcbiAgICAvLyB0aGUgbW9kZWxzLlxuICAgIGZvciAoY29uc3QgeyBhanYsIG9wdGlvbnMgfSBvZiBPYmplY3QudmFsdWVzKHRoaXMuYWp2Q2FjaGUpKSB7XG4gICAgICBhanYuYWRkU2NoZW1hKHRoaXMucHJvY2Vzc1NjaGVtYShqc29uU2NoZW1hLCBvcHRpb25zKSlcbiAgICB9XG4gIH1cblxuICBwcm9jZXNzU2NoZW1hKGpzb25TY2hlbWEsIG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHsgcGF0Y2gsIGFzeW5jIH0gPSBvcHRpb25zXG4gICAgY29uc3Qgc2NoZW1hID0gY2xvbmUoanNvblNjaGVtYSwgdmFsdWUgPT4ge1xuICAgICAgaWYgKGlzT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICBpZiAocGF0Y2gpIHtcbiAgICAgICAgICAvLyBSZW1vdmUgYWxsIHJlcXVpcmVkIGtleXdvcmRzIGFuZCBmb3JtYXRzIGZyb20gc2NoZW1hIGZvciBwYXRjaFxuICAgICAgICAgIC8vIHZhbGlkYXRpb24uXG4gICAgICAgICAgZGVsZXRlIHZhbHVlLnJlcXVpcmVkXG4gICAgICAgICAgaWYgKHZhbHVlLmZvcm1hdCA9PT0gJ3JlcXVpcmVkJykge1xuICAgICAgICAgICAgZGVsZXRlIHZhbHVlLmZvcm1hdFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBDb252ZXJ0IGFzeW5jIGB2YWxpZGF0ZSgpYCBrZXl3b3JkcyB0byBgdmFsaWRhdGVBc3luYygpYDpcbiAgICAgICAgaWYgKGlzQXN5bmModmFsdWUudmFsaWRhdGUpKSB7XG4gICAgICAgICAgdmFsdWUudmFsaWRhdGVBc3luYyA9IHZhbHVlLnZhbGlkYXRlXG4gICAgICAgICAgZGVsZXRlIHZhbHVlLnZhbGlkYXRlXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFhc3luYykge1xuICAgICAgICAgIC8vIFJlbW92ZSBhbGwgYXN5bmMga2V5d29yZHMgZm9yIHN5bmNocm9ub3VzIHZhbGlkYXRpb24uXG4gICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGtleXdvcmQgPSB0aGlzLmdldEtleXdvcmQoa2V5KVxuICAgICAgICAgICAgaWYgKGtleXdvcmQ/LmFzeW5jKSB7XG4gICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtrZXldXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgICBpZiAoYXN5bmMpIHtcbiAgICAgIHNjaGVtYS4kYXN5bmMgPSB0cnVlXG4gICAgfVxuICAgIHJldHVybiBzY2hlbWFcbiAgfVxuXG4gIHBhcnNlRXJyb3JzKGVycm9ycywgb3B0aW9ucyA9IHt9KSB7XG4gICAgLy8gQ29udmVydCBmcm9tIEFqdiBlcnJvcnMgYXJyYXkgdG8gT2JqZWN0aW9uLXN0eWxlIGVycm9ySGFzaCxcbiAgICAvLyB3aXRoIGFkZGl0aW9uYWwgcGFyc2luZyBhbmQgcHJvY2Vzc2luZy5cbiAgICBjb25zdCBlcnJvckhhc2ggPSB7fVxuICAgIGNvbnN0IGR1cGxpY2F0ZXMgPSB7fVxuICAgIGZvciAoY29uc3QgZXJyb3Igb2YgZXJyb3JzKSB7XG4gICAgICAvLyBBZGp1c3QgZGF0YVBhdGhzIHRvIHJlZmxlY3QgbmVzdGVkIHZhbGlkYXRpb24gaW4gT2JqZWN0aW9uLlxuICAgICAgY29uc3QgZGF0YVBhdGggPSBgJHtvcHRpb25zPy5kYXRhUGF0aCB8fCAnJ30ke2Vycm9yLmRhdGFQYXRofWBcbiAgICAgIC8vIFVua25vd24gcHJvcGVydGllcyBhcmUgcmVwb3J0ZWQgaW4gYFsncHJvcGVydHlOYW1lJ11gIG5vdGF0aW9uLFxuICAgICAgLy8gc28gcmVwbGFjZSB0aG9zZSB3aXRoIGRvdC1ub3RhdGlvbiwgc2VlOlxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2Vwb2JlcmV6a2luL2Fqdi9pc3N1ZXMvNjcxXG4gICAgICBjb25zdCBrZXkgPSBkYXRhUGF0aC5yZXBsYWNlKC9cXFsnKFteJ10qKSdcXF0vZywgJy4kMScpLnNsaWNlKDEpXG4gICAgICBjb25zdCB7IG1lc3NhZ2UsIGtleXdvcmQsIHBhcmFtcyB9ID0gZXJyb3JcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBrZXl3b3JkID09PSAnZm9ybWF0J1xuICAgICAgICA/IHRoaXMuZ2V0Rm9ybWF0KHBhcmFtcy5mb3JtYXQpXG4gICAgICAgIDogdGhpcy5nZXRLZXl3b3JkKGtleXdvcmQpXG4gICAgICBjb25zdCBpZGVudGlmaWVyID0gYCR7a2V5fV8ke2tleXdvcmR9YFxuICAgICAgaWYgKFxuICAgICAgICAvLyBBanYgcHJvZHVjZXMgZHVwbGljYXRlIHZhbGlkYXRpb24gZXJyb3JzIHNvbWV0aW1lcywgZmlsdGVyIHRoZW0gb3V0LlxuICAgICAgICAhZHVwbGljYXRlc1tpZGVudGlmaWVyXSAmJlxuICAgICAgICAvLyBTa2lwIGtleXdvcmRzIHRoYXQgc3RhcnQgd2l0aCAkIHN1Y2ggYXMgJG1lcmdlIGFuZCAkcGF0Y2guXG4gICAgICAgICEvXlxcJC8udGVzdChrZXl3b3JkKSAmJlxuICAgICAgICAvLyBTa2lwIG1hY3JvIGtleXdvcmRzIHRoYXQgYXJlIG9ubHkgZGVsZWdhdGluZyB0byBvdGhlciBrZXl3b3Jkcy5cbiAgICAgICAgIWRlZmluaXRpb24/Lm1hY3JvICYmXG4gICAgICAgIC8vIEZpbHRlciBvdXQgYWxsIGN1c3RvbSBrZXl3b3JkcyBhbmQgZm9ybWF0cyB0aGF0IHdhbnQgdG8gYmUgc2lsZW50LlxuICAgICAgICAhZGVmaW5pdGlvbj8uc2lsZW50XG4gICAgICApIHtcbiAgICAgICAgY29uc3QgYXJyYXkgPSBlcnJvckhhc2hba2V5XSB8fCAoZXJyb3JIYXNoW2tleV0gPSBbXSlcbiAgICAgICAgYXJyYXkucHVzaCh7XG4gICAgICAgICAgLy8gQWxsb3cgY3VzdG9tIGZvcm1hdHMgYW5kIGtleXdvcmRzIHRvIG92ZXJyaWRlIGVycm9yIG1lc3NhZ2VzLlxuICAgICAgICAgIG1lc3NhZ2U6IGRlZmluaXRpb24/Lm1lc3NhZ2UgfHwgbWVzc2FnZSxcbiAgICAgICAgICBrZXl3b3JkLFxuICAgICAgICAgIHBhcmFtc1xuICAgICAgICB9KVxuICAgICAgICBkdXBsaWNhdGVzW2lkZW50aWZpZXJdID0gdHJ1ZVxuICAgICAgfVxuICAgIH1cbiAgICAvLyBOb3cgZmlsdGVyIHRocm91Z2ggdGhlIHJlc3VsdGluZyBlcnJvcnMgYW5kIHBlcmZvcm0gc29tZSBwb3N0LXByb2Nlc3Npbmc6XG4gICAgZm9yIChjb25zdCBbZGF0YVBhdGgsIGVycm9yc10gb2YgT2JqZWN0LmVudHJpZXMoZXJyb3JIYXNoKSkge1xuICAgICAgLy8gV2hlbiB3ZSBnZXQgdGhlc2UgZXJyb3JzIChjYXVzZWQgYnkgYG51bGxhYmxlOiB0cnVlYCksIGl0IG1lYW5zIHRoYXQgd2VcbiAgICAgIC8vIGhhdmUgZGF0YSB0aGF0IGlzbid0IG51bGwgYW5kIGlzIGNhdXNpbmcgb3RoZXIgZXJyb3JzLCBhbmQgd2Ugc2hvdWxkbid0XG4gICAgICAvLyBkaXNwbGF5IHRoZSAnbnVsbCcgcGF0aDpcbiAgICAgIC8vIFtkYXRhUGF0aF06IFtcbiAgICAgIC8vICAge1xuICAgICAgLy8gICAgIG1lc3NhZ2U6ICdzaG91bGQgYmUgbnVsbCcsXG4gICAgICAvLyAgICAga2V5d29yZDogJ3R5cGUnLFxuICAgICAgLy8gICAgIHBhcmFtczogeyB0eXBlOiAnbnVsbCcgfVxuICAgICAgLy8gICB9LFxuICAgICAgLy8gICB7XG4gICAgICAvLyAgICAgbWVzc2FnZTogJ3Nob3VsZCBtYXRjaCBleGFjdGx5IG9uZSBzY2hlbWEgaW4gb25lT2YnLFxuICAgICAgLy8gICAgIGtleXdvcmQ6ICdvbmVPZidcbiAgICAgIC8vICAgfVxuICAgICAgLy8gXVxuICAgICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgY29uc3QgW2Vycm9yMSwgZXJyb3IyXSA9IGVycm9yc1xuICAgICAgICBpZiAoXG4gICAgICAgICAgZXJyb3IxLmtleXdvcmQgPT09ICd0eXBlJyAmJiBlcnJvcjEucGFyYW1zLnR5cGUgPT09ICdudWxsJyAmJlxuICAgICAgICAgIGVycm9yMi5rZXl3b3JkID09PSAnb25lT2YnXG4gICAgICAgICkge1xuICAgICAgICAgIGRlbGV0ZSBlcnJvckhhc2hbZGF0YVBhdGhdXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGVycm9ySGFzaFxuICB9XG5cbiAgcHJlZml4RGF0YVBhdGhzKGVycm9ycywgZGF0YVBhdGhQcmVmaXgpIHtcbiAgICByZXR1cm4gZXJyb3JzLm1hcChlcnJvciA9PiAoe1xuICAgICAgLi4uZXJyb3IsXG4gICAgICBkYXRhUGF0aDogZXJyb3IuZGF0YVBhdGhcbiAgICAgICAgPyBgJHtkYXRhUGF0aFByZWZpeH0ke2Vycm9yLmRhdGFQYXRofWBcbiAgICAgICAgOiBkYXRhUGF0aFByZWZpeFxuICAgIH0pKVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIGJlZm9yZVZhbGlkYXRlKHsganNvbiwgbW9kZWwsIGN0eCwgb3B0aW9ucyB9KSB7XG4gICAgLy8gQWRkIHZhbGlkYXRvciBpbnN0YW5jZSwgYXBwIGFuZCBvcHRpb25zIHRvIGNvbnRleHRcbiAgICBjdHgudmFsaWRhdG9yID0gdGhpc1xuICAgIGN0eC5hcHAgPSB0aGlzLmFwcFxuICAgIGN0eC5vcHRpb25zID0gb3B0aW9uc1xuICAgIGN0eC5qc29uU2NoZW1hID0gbW9kZWwuY29uc3RydWN0b3IuZ2V0SnNvblNjaGVtYSgpXG4gICAgY29uc3QgeyAkYmVmb3JlVmFsaWRhdGUgfSA9IG1vZGVsXG4gICAgaWYgKCRiZWZvcmVWYWxpZGF0ZSAhPT0gb2JqZWN0aW9uLk1vZGVsLnByb3RvdHlwZS4kYmVmb3JlVmFsaWRhdGUpIHtcbiAgICAgIC8vIFRPRE86IENvbnNpZGVyIGFkZGluZyBob29rcyBmb3IgJ2JlZm9yZTp2YWxpZGF0ZScgYW5kICdhZnRlcjp2YWxpZGF0ZScsXG4gICAgICAvLyBhbmQgaWYgc28sIGRlY2lkZSB3aGF0IHRvIGRvIGFib3V0IG1vZGlmeWluZyAvIHJldHVybmluZyBqc29uLXNjaGVtYS5cbiAgICAgIC8vIFByb2JhYmx5IHdlIHNob3VsZG4ndCBhbGxvdyBpdCB0aGVyZS5cblxuICAgICAgLy8gT25seSBjbG9uZSBqc29uU2NoZW1hIGlmIHRoZSBoYW5kbGVyIGFjdHVhbGx5IHJlY2VpdmVzIGl0LlxuICAgICAgaWYgKCRiZWZvcmVWYWxpZGF0ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGN0eC5qc29uU2NoZW1hID0gY2xvbmUoY3R4Lmpzb25TY2hlbWEpXG4gICAgICB9XG4gICAgICBjb25zdCByZXQgPSBtb2RlbC4kYmVmb3JlVmFsaWRhdGUoY3R4Lmpzb25TY2hlbWEsIGpzb24sIG9wdGlvbnMpXG4gICAgICBpZiAocmV0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY3R4Lmpzb25TY2hlbWEgPSByZXRcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBAb3ZlcnJpZGVcbiAgdmFsaWRhdGUoeyBqc29uLCBtb2RlbCwgY3R4LCBvcHRpb25zIH0pIHtcbiAgICBjb25zdCB7IGpzb25TY2hlbWEgfSA9IGN0eFxuICAgIGlmIChqc29uU2NoZW1hKSB7XG4gICAgICAvLyBXZSBuZWVkIHRvIGNsb25lIHRoZSBpbnB1dCBqc29uIGlmIHdlIGFyZSBhYm91dCB0byBzZXQgZGVmYXVsdCB2YWx1ZXMuXG4gICAgICBpZiAoXG4gICAgICAgICFvcHRpb25zLm11dGFibGUgJiZcbiAgICAgICAgIW9wdGlvbnMucGF0Y2ggJiZcbiAgICAgICAgaGFzRGVmYXVsdHMoanNvblNjaGVtYS5wcm9wZXJ0aWVzKVxuICAgICAgKSB7XG4gICAgICAgIGpzb24gPSBjbG9uZShqc29uKVxuICAgICAgfVxuICAgICAgLy8gR2V0IHRoZSByaWdodCBBanYgaW5zdGFuY2UgZm9yIHRoZSBnaXZlbiBwYXRjaCBhbmQgYXN5bmMgb3B0aW9uc1xuICAgICAgY29uc3QgdmFsaWRhdGUgPSB0aGlzLmdldEFqdihvcHRpb25zKS5nZXRTY2hlbWEoanNvblNjaGVtYS4kaWQpXG4gICAgICAvLyBVc2UgYGNhbGwoKWAgdG8gcGFzcyBjdHggYXMgY29udGV4dCB0byBBanYsIHNlZSBwYXNzQ29udGV4dDpcbiAgICAgIGNvbnN0IHJlcyA9IHZhbGlkYXRlLmNhbGwoY3R4LCBqc29uKVxuICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gZXJyb3JzID0+IHtcbiAgICAgICAgaWYgKGVycm9ycykge1xuICAgICAgICAgIC8vIE5PVEU6IFRoZSBjb252ZXJzaW9uIGZyb20gQWp2IGVycm9ycyB0byBPYmplY3Rpb24gZXJyb3JzIGhhcHBlbiBpblxuICAgICAgICAgIC8vIE1vZGVsLmNyZWF0ZVZhbGlkYXRpb25FcnJvcigpLCB3aGljaCBjYWxscyBWYWxpZGF0b3IucGFyc2VFcnJvcigpXG4gICAgICAgICAgdGhyb3cgbW9kZWwuY29uc3RydWN0b3IuY3JlYXRlVmFsaWRhdGlvbkVycm9yKHtcbiAgICAgICAgICAgIHR5cGU6ICdNb2RlbFZhbGlkYXRpb24nLFxuICAgICAgICAgICAgZXJyb3JzLFxuICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgIGpzb25cbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBIYW5kbGUgYm90aCBhc3luYyBhbmQgc3luYyB2YWxpZGF0aW9uIGhlcmU6XG4gICAgICBpZiAoaXNQcm9taXNlKHJlcykpIHtcbiAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgIC5jYXRjaChlcnJvciA9PiBoYW5kbGVFcnJvcnMoZXJyb3IuZXJyb3JzKSlcbiAgICAgICAgICAudGhlbigoKSA9PiBqc29uKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGFuZGxlRXJyb3JzKHZhbGlkYXRlLmVycm9ycylcbiAgICAgICAgcmV0dXJuIGpzb25cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaGFzRGVmYXVsdHMob2JqKSB7XG4gIGlmIChpc0FycmF5KG9iaikpIHtcbiAgICBmb3IgKGNvbnN0IHZhbCBvZiBvYmopIHtcbiAgICAgIGlmICh2YWwgJiYgaGFzRGVmYXVsdHModmFsKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICAgIGlmIChrZXkgPT09ICdkZWZhdWx0JyB8fCB2YWwgJiYgaGFzRGVmYXVsdHModmFsKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIHN0cmljdDogZmFsc2UsXG4gIGFsbEVycm9yczogdHJ1ZSxcbiAgb3duUHJvcGVydGllczogdHJ1ZSxcbiAgcGFzc0NvbnRleHQ6IHRydWUsXG4gIHVzZURlZmF1bHRzOiB0cnVlLFxuICB2YWxpZGF0ZVNjaGVtYTogdHJ1ZVxufVxuXG4vLyBPcHRpb25zIHRoYXQgYXJlIGFsbG93ZWQgdG8gYmUgcGFzc2VkIG9uIHRvIHRoZSBjcmVhdGVkIEFqdiBpbnN0YW5jZXMsIHdpdGhcbi8vIHRoZWlyIGRlZmF1bHQgc2V0dGluZ3MgKHNvbWUgZGVmYXVsdHMgYXJlIGZyb20gQWp2LCBzb21lIGZyb20gZGVmYXVsdE9wdGlvbnMpXG5jb25zdCB2YWxpZGF0b3JPcHRpb25zID0ge1xuICAvLyBPdXIgZXh0ZW5zaW9uczpcbiAgYXN5bmM6IGZhbHNlLFxuICBwYXRjaDogZmFsc2UsXG4gIC8vIEFqdiBPcHRpb25zOlxuICAkZGF0YTogZmFsc2UsXG4gICRjb21tZW50OiBmYWxzZSxcbiAgY29lcmNlVHlwZXM6IGZhbHNlLFxuICBtdWx0aXBsZU9mUHJlY2lzaW9uOiBmYWxzZSxcbiAgb3duUHJvcGVydGllczogdHJ1ZSxcbiAgcmVtb3ZlQWRkaXRpb25hbDogZmFsc2UsXG4gIHVuaXF1ZUl0ZW1zOiB0cnVlLFxuICB1c2VEZWZhdWx0czogdHJ1ZSxcbiAgdmVyYm9zZTogZmFsc2Vcbn1cbiJdfQ==