"use strict";

exports.__esModule = true;
exports.default = startConsole;

var _repl = _interopRequireDefault(require("repl"));

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _chalk = _interopRequireDefault(require("chalk"));

var _objection = _interopRequireDefault(require("objection"));

var _utils = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let started = false;
let server = null;

async function startConsole(app, config) {
  config = {
    quiet: false,
    prompt: 'dito > ',
    useColors: true,
    ignoreUndefined: true,
    ...config
  };

  if (started) {
    return server;
  }

  started = true;
  server = _repl.default.start({ ...config,
    prompt: ''
  });
  server.pause();
  Object.assign(server.context, {
    app,
    objection: _objection.default,
    ...app.models
  });
  server.eval = wrapEval(server);
  server.defineCommand('usage', {
    help: 'Detailed Dito Console usage information',

    action() {
      displayUsage(app, config, true);
      this.displayPrompt();
    }

  });
  server.defineCommand('models', {
    help: 'Display available Dito models',

    action() {
      console.info(Object.keys(app.models).join(', '));
      this.displayPrompt();
    }

  });

  const historyFile = _path.default.join(process.cwd(), '.console_history');

  try {
    await _fsExtra.default.stat(historyFile);
    const lines = await _fsExtra.default.readFile(historyFile);
    lines.toString().split('\n').reverse().slice(0, config.historySize).filter(line => line.trim()).map(line => server.history.push(line));
  } catch (e) {
    console.info((0, _utils.deindent)`
      Unable to REPL history file at ${historyFile}.
      A history file will be created on shutdown
    `);
  }

  await app.start();

  if (!config.quiet) {
    displayUsage(app, config);
  }

  server.setPrompt(config.prompt);
  server.resume();
  server.write('', {
    name: 'return'
  });
  return new Promise(resolve => {
    server.once('exit', async () => {
      try {
        await app.stop();
      } catch (err) {
        logError(err);
      }

      try {
        const lines = (server.history || []).reverse().filter(line => line.trim()).join('\n');
        await _fsExtra.default.writeFile(historyFile, lines);
      } catch (err) {
        logError(err);
      }

      resolve(true);
    });
  });
}

function displayUsage(app, config, details) {
  const modelHandleNames = Object.keys(app.models);
  console.info((0, _utils.deindent)`

    ------------------------------------------------------------
    Dito Console

    Available references:
     - Dito app: ${_chalk.default.cyan('app')}
    ${modelHandleNames.length > 0 ? ` - Dito models: ${modelHandleNames.map(m => _chalk.default.cyan(m)).join(', ')}` : ''}
  `);

  if (details) {
    console.info((0, _utils.deindent)`
      Examples:

      ${config.prompt} user = User.where({ lastName: 'Doe' }).first()
      ${config.prompt} user.$patch({ firstName: 'Joe' })
      ${config.prompt} user.$comments.insert({ ... })
    `);
  }

  console.info('------------------------------------------------------------');
}

function wrapEval({
  eval: defaultEval
}) {
  return async function (code, context, file, cb) {
    return defaultEval.call(this, code, context, file, async (err, result) => {
      if (err || !(result && (0, _utils.isFunction)(result.then))) {
        return cb(err, result);
      }

      try {
        const resolved = await result;

        for (const key in context) {
          if (context[key] === result) {
            context[key] = resolved;
          }
        }

        cb(null, resolved);
      } catch (error) {
        logError(error);
        cb();
      }
    });
  };
}

function logError(error) {
  console.info(`\x1b[31m${error}\x1b[0m`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY29uc29sZS5qcyJdLCJuYW1lcyI6WyJzdGFydGVkIiwic2VydmVyIiwic3RhcnRDb25zb2xlIiwiYXBwIiwiY29uZmlnIiwicXVpZXQiLCJwcm9tcHQiLCJ1c2VDb2xvcnMiLCJpZ25vcmVVbmRlZmluZWQiLCJyZXBsIiwic3RhcnQiLCJwYXVzZSIsIk9iamVjdCIsImFzc2lnbiIsImNvbnRleHQiLCJvYmplY3Rpb24iLCJtb2RlbHMiLCJldmFsIiwid3JhcEV2YWwiLCJkZWZpbmVDb21tYW5kIiwiaGVscCIsImFjdGlvbiIsImRpc3BsYXlVc2FnZSIsImRpc3BsYXlQcm9tcHQiLCJjb25zb2xlIiwiaW5mbyIsImtleXMiLCJqb2luIiwiaGlzdG9yeUZpbGUiLCJwYXRoIiwicHJvY2VzcyIsImN3ZCIsImZzIiwic3RhdCIsImxpbmVzIiwicmVhZEZpbGUiLCJ0b1N0cmluZyIsInNwbGl0IiwicmV2ZXJzZSIsInNsaWNlIiwiaGlzdG9yeVNpemUiLCJmaWx0ZXIiLCJsaW5lIiwidHJpbSIsIm1hcCIsImhpc3RvcnkiLCJwdXNoIiwiZSIsInNldFByb21wdCIsInJlc3VtZSIsIndyaXRlIiwibmFtZSIsIlByb21pc2UiLCJyZXNvbHZlIiwib25jZSIsInN0b3AiLCJlcnIiLCJsb2dFcnJvciIsIndyaXRlRmlsZSIsImRldGFpbHMiLCJtb2RlbEhhbmRsZU5hbWVzIiwiY2hhbGsiLCJjeWFuIiwibGVuZ3RoIiwibSIsImRlZmF1bHRFdmFsIiwiY29kZSIsImZpbGUiLCJjYiIsImNhbGwiLCJyZXN1bHQiLCJ0aGVuIiwicmVzb2x2ZWQiLCJrZXkiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLElBQUlBLE9BQU8sR0FBRyxLQUFkO0FBQ0EsSUFBSUMsTUFBTSxHQUFHLElBQWI7O0FBRWUsZUFBZUMsWUFBZixDQUE0QkMsR0FBNUIsRUFBaUNDLE1BQWpDLEVB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LENBQUY7QUFDRCxPQVRELENBU0UsT0FBT0UsS0FBUCxFQUFjO0FBQ2RqQixRQUFBQSxRQUFRLENBQUNpQixLQUFELENBQVI7QUFDQU4sUUFBQUEsRUFBRTtBQUNIO0FBQ0YsS0FqQk0sQ0FBUDtBQWtCRCxHQW5CRDtBQW9CRDs7QUFFRCxTQUFTWCxRQUFULENBQWtCaUIsS0FBbEIsRUFBeUI7QUFDdkJsRCxFQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYyxXQUFVaUQsS0FBTSxTQUE5QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcGwgZnJvbSAncmVwbCdcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5pbXBvcnQgb2JqZWN0aW9uIGZyb20gJ29iamVjdGlvbidcbmltcG9ydCB7IGlzRnVuY3Rpb24sIGRlaW5kZW50IH0gZnJvbSAnQGRpdG9qcy91dGlscydcblxubGV0IHN0YXJ0ZWQgPSBmYWxzZVxubGV0IHNlcnZlciA9IG51bGxcblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gc3RhcnRDb25zb2xlKGFwcCwgY29uZmlnKSB7XG4gIGNvbmZpZyA9IHtcbiAgICBxdWlldDogZmFsc2UsXG4gICAgcHJvbXB0OiAnZGl0byA+ICcsXG4gICAgdXNlQ29sb3JzOiB0cnVlLFxuICAgIGlnbm9yZVVuZGVmaW5lZDogdHJ1ZSxcbiAgICAuLi5jb25maWdcbiAgfVxuXG4gIGlmIChzdGFydGVkKSB7XG4gICAgcmV0dXJuIHNlcnZlclxuICB9XG4gIHN0YXJ0ZWQgPSB0cnVlXG5cbiAgc2VydmVyID0gcmVwbC5zdGFydCh7IC4uLmNvbmZpZywgcHJvbXB0OiAnJyB9KVxuICBzZXJ2ZXIucGF1c2UoKVxuICBPYmplY3QuYXNzaWduKHNlcnZlci5jb250ZXh0LCB7XG4gICAgYXBwLFxuICAgIG9iamVjdGlvbixcbiAgICAuLi5hcHAubW9kZWxzXG4gIH0pXG4gIHNlcnZlci5ldmFsID0gd3JhcEV2YWwoc2VydmVyKVxuXG4gIHNlcnZlci5kZWZpbmVDb21tYW5kKCd1c2FnZScsIHtcbiAgICBoZWxwOiAnRGV0YWlsZWQgRGl0byBDb25zb2xlIHVzYWdlIGluZm9ybWF0aW9uJyxcbiAgICBhY3Rpb24oKSB7XG4gICAgICBkaXNwbGF5VXNhZ2UoYXBwLCBjb25maWcsIHRydWUpXG4gICAgICB0aGlzLmRpc3BsYXlQcm9tcHQoKVxuICAgIH1cbiAgfSlcblxuICBzZXJ2ZXIuZGVmaW5lQ29tbWFuZCgnbW9kZWxzJywge1xuICAgIGhlbHA6ICdEaXNwbGF5IGF2YWlsYWJsZSBEaXRvIG1vZGVscycsXG4gICAgYWN0aW9uKCkge1xuICAgICAgY29uc29sZS5pbmZvKE9iamVjdC5rZXlzKGFwcC5tb2RlbHMpLmpvaW4oJywgJykpXG4gICAgICB0aGlzLmRpc3BsYXlQcm9tcHQoKVxuICAgIH1cbiAgfSlcblxuICAvLyBTZXQgdXAgaGlzdG9yeSBmaWxlXG4gIGNvbnN0IGhpc3RvcnlGaWxlID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICcuY29uc29sZV9oaXN0b3J5JylcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5zdGF0KGhpc3RvcnlGaWxlKVxuICAgIGNvbnN0IGxpbmVzID0gYXdhaXQgZnMucmVhZEZpbGUoaGlzdG9yeUZpbGUpXG4gICAgbGluZXMudG9TdHJpbmcoKS5zcGxpdCgnXFxuJylcbiAgICAgIC5yZXZlcnNlKClcbiAgICAgIC5zbGljZSgwLCBjb25maWcuaGlzdG9yeVNpemUpXG4gICAgICAuZmlsdGVyKGxpbmUgPT4gbGluZS50cmltKCkpXG4gICAgICAubWFwKGxpbmUgPT4gc2VydmVyLmhpc3RvcnkucHVzaChsaW5lKSlcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuaW5mbyhkZWluZGVudGBcbiAgICAgIFVuYWJsZSB0byBSRVBMIGhpc3RvcnkgZmlsZSBhdCAke2hpc3RvcnlGaWxlfS5cbiAgICAgIEEgaGlzdG9yeSBmaWxlIHdpbGwgYmUgY3JlYXRlZCBvbiBzaHV0ZG93blxuICAgIGApXG4gIH1cblxuICBhd2FpdCBhcHAuc3RhcnQoKVxuICBpZiAoIWNvbmZpZy5xdWlldCkge1xuICAgIGRpc3BsYXlVc2FnZShhcHAsIGNvbmZpZylcbiAgfVxuICBzZXJ2ZXIuc2V0UHJvbXB0KGNvbmZpZy5wcm9tcHQpXG4gIHNlcnZlci5yZXN1bWUoKVxuICBzZXJ2ZXIud3JpdGUoJycsIHsgbmFtZTogJ3JldHVybicgfSlcbiAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgIHNlcnZlci5vbmNlKCdleGl0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgYXBwLnN0b3AoKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ0Vycm9yKGVycilcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGxpbmVzID0gKHNlcnZlci5oaXN0b3J5IHx8IFtdKVxuICAgICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgICAuZmlsdGVyKGxpbmUgPT4gbGluZS50cmltKCkpXG4gICAgICAgICAgLmpvaW4oJ1xcbicpXG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShoaXN0b3J5RmlsZSwgbGluZXMpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nRXJyb3IoZXJyKVxuICAgICAgfVxuICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgIH0pXG4gIH0pXG59XG5cbmZ1bmN0aW9uIGRpc3BsYXlVc2FnZShhcHAsIGNvbmZpZywgZGV0YWlscykge1xuICBjb25zdCBtb2RlbEhhbmRsZU5hbWVzID0gT2JqZWN0LmtleXMoYXBwLm1vZGVscylcbiAgY29uc29sZS5pbmZvKGRlaW5kZW50YFxuXG4gICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgRGl0byBDb25zb2xlXG5cbiAgICBBdmFpbGFibGUgcmVmZXJlbmNlczpcbiAgICAgLSBEaXRvIGFwcDogJHtjaGFsay5jeWFuKCdhcHAnKX1cbiAgICAke1xuICAgICAgbW9kZWxIYW5kbGVOYW1lcy5sZW5ndGggPiAwXG4gICAgICAgID8gYCAtIERpdG8gbW9kZWxzOiAke1xuICAgICAgICAgIG1vZGVsSGFuZGxlTmFtZXMubWFwKG0gPT4gY2hhbGsuY3lhbihtKSkuam9pbignLCAnKVxuICAgICAgICB9YFxuICAgICAgICA6ICcnXG4gICAgfVxuICBgKVxuICBpZiAoZGV0YWlscykge1xuICAgIGNvbnNvbGUuaW5mbyhkZWluZGVudGBcbiAgICAgIEV4YW1wbGVzOlxuXG4gICAgICAke2NvbmZpZy5wcm9tcHR9IHVzZXIgPSBVc2VyLndoZXJlKHsgbGFzdE5hbWU6ICdEb2UnIH0pLmZpcnN0KClcbiAgICAgICR7Y29uZmlnLnByb21wdH0gdXNlci4kcGF0Y2goeyBmaXJzdE5hbWU6ICdKb2UnIH0pXG4gICAgICAke2NvbmZpZy5wcm9tcHR9IHVzZXIuJGNvbW1lbnRzLmluc2VydCh7IC4uLiB9KVxuICAgIGApXG4gIH1cbiAgY29uc29sZS5pbmZvKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nKVxufVxuXG4vLyBXcmFwcyB0aGUgZGVmYXVsdCBldmFsIHdpdGggYSBoYW5kbGVyIHRoYXQgcmVzb2x2ZXMgcHJvbWlzZXNcbmZ1bmN0aW9uIHdyYXBFdmFsKHsgZXZhbDogZGVmYXVsdEV2YWwgfSkge1xuICByZXR1cm4gYXN5bmMgZnVuY3Rpb24oY29kZSwgY29udGV4dCwgZmlsZSwgY2IpIHtcbiAgICByZXR1cm4gZGVmYXVsdEV2YWwuY2FsbCh0aGlzLCBjb2RlLCBjb250ZXh0LCBmaWxlLCBhc3luYyAoZXJyLCByZXN1bHQpID0+IHtcbiAgICAgIGlmIChlcnIgfHwgIShyZXN1bHQgJiYgaXNGdW5jdGlvbihyZXN1bHQudGhlbikpKSB7XG4gICAgICAgIHJldHVybiBjYihlcnIsIHJlc3VsdClcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcmVzdWx0XG4gICAgICAgIC8vIFJlcGxhY2UgYW55IHByb21pc2VzIGluIHRoZSBSRVBMIGNvbnRleHQgd2l0aCB0aGUgcmVzb2x2ZWQgcHJvbWlzZS5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gY29udGV4dCkge1xuICAgICAgICAgIGlmIChjb250ZXh0W2tleV0gPT09IHJlc3VsdCkge1xuICAgICAgICAgICAgY29udGV4dFtrZXldID0gcmVzb2x2ZWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2IobnVsbCwgcmVzb2x2ZWQpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dFcnJvcihlcnJvcilcbiAgICAgICAgY2IoKSAvLyBBcHBsaWNhdGlvbiBlcnJvcnMgYXJlIG5vdCBSRVBMIGVycm9yc1xuICAgICAgfVxuICAgIH0pXG4gIH1cbn1cblxuZnVuY3Rpb24gbG9nRXJyb3IoZXJyb3IpIHtcbiAgY29uc29sZS5pbmZvKGBcXHgxYlszMW0ke2Vycm9yfVxceDFiWzBtYClcbn1cbiJdfQ==