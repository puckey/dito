"use strict";

exports.__esModule = true;
exports.createMigration = createMigration;

var _path = _interopRequireDefault(require("path"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _chalk = _interopRequireDefault(require("chalk"));

var _schema = require("../../schema");

var _utils = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const typeToKnex = {
  number: 'double',
  object: 'json',
  array: 'json'
};
const defaultValues = {
  'now()': `knex.raw('CURRENT_TIMESTAMP')`
};

const migrationDir = _path.default.join(process.cwd(), 'migrations');

async function createMigration(app, name, ...modelNames) {
  const models = modelNames.map(modelName => {
    const modelClass = app.models[modelName];

    if (!modelClass) {
      throw new Error(`Model class with name '${modelName}' does not exist`);
    }

    return modelClass;
  });
  const tables = [];

  for (const modelClass of models) {
    collectModelTables(modelClass, app, tables);
  }

  for (const modelClass of models) {
    collectThroughTables(modelClass, app, tables);
  }

  const createTables = [];
  const dropTables = [];

  for (const {
    tableName,
    statements
  } of tables) {
    createTables.push((0, _utils.deindent)`
      .createTable('${tableName}', table => {
        ${statements.join('\n')}
      })`);
    dropTables.unshift((0, _utils.deindent)`
      .dropTableIfExists('${tableName}')`);
  }

  const getCode = tables => tables.length > 0 ? (0, _utils.deindent)`
      await knex.schema
        ${tables.join('\n')}` : '';

  const filename = `${getTimestamp()}_${name}.js`;

  const file = _path.default.join(migrationDir, filename);

  if (await _fsExtra.default.exists(file)) {
    console.info(_chalk.default.red(`Migration '${filename}' already exists.`));
    return false;
  } else {
    await _fsExtra.default.writeFile(file, (0, _utils.deindent)`
      export async function up(knex) {
        ${getCode(createTables)}
      }

      export async function down(knex) {
        ${getCode(dropTables)}
      }
    `);
    console.info(_chalk.default.cyan(`Migration '${filename}' successfully created.`));
    return true;
  }
}

async function collectModelTables(modelClass, app, tables) {
  const tableName = app.normalizeIdentifier(modelClass.tableName);
  const {
    properties,
    relations
  } = modelClass.definition;
  const statements = [];
  tables.push({
    tableName,
    statements
  });
  const uniqueComposites = {};

  for (const [name, property] of Object.entries(properties)) {
    const column = app.normalizeIdentifier(name);
    let {
      description,
      type,
      specificType,
      unsigned,
      computed,
      nullable,
      required,
      primary,
      foreign,
      unique,
      index,
      default: _default
    } = property;
    const knexType = typeToKnex[type] || type;

    if (!computed) {
      if (description) {
        statements.push(`// ${description.replace(/\s{2,}/g, ' ').trim()}`);
      }

      if ((0, _utils.isString)(unique)) {
        const composites = uniqueComposites[unique] || (uniqueComposites[unique] = []);
        composites.push(column);
        unique = false;
      }

      const statement = primary ? [`table.increments('${column}').primary()`] : specificType ? [`table.specificType('${column}', '${specificType}')`] : [`table.${knexType}('${column}')`];
      statement.push(unsigned && 'unsigned()', !primary && required && 'notNullable()', nullable && 'nullable()', unique && 'unique()', index && 'index()');

      if (_default !== undefined) {
        let value = defaultValues[_default];

        if (!value) {
          value = (0, _utils.isArray)(_default) || (0, _utils.isObject)(_default) ? JSON.stringify(_default) : _default;

          if ((0, _utils.isString)(value)) {
            value = `'${value}'`;
          }
        }

        statement.push(`defaultTo(${value})`);
      }

      if (foreign) {
        for (const relation of Object.values(relations)) {
          const {
            from,
            to,
            owner
          } = relation;
          const [fromClass, fromProperty] = (from == null ? void 0 : from.split('.')) || [];

          if (fromProperty === name) {
            if (fromClass !== modelClass.name) {
              throw Error(`Invalid relation declaration: ${relation}`);
            }

            const [toClass, toProperty] = (to == null ? void 0 : to.split('.')) || [];
            statement.push('\n', `references('${app.normalizeIdentifier(toProperty)}')`, `inTable('${app.normalizeIdentifier(toClass)}')`, !owner && `onDelete('CASCADE')`);
          }
        }
      }

      statements.push(statement.filter(str => !!str).join('.').replace(/\.\n\./g, '\n  .'));
    }
  }

  for (const composites of Object.values(uniqueComposites)) {
    statements.push(`table.unique([${composites.map(column => `'${column}'`).join(', ')}])`);
  }
}

async function collectThroughTables(modelClass, app, tables) {
  const {
    relations
  } = modelClass.definition;

  for (const relation of Object.values(relations)) {
    const {
      from,
      to,
      inverse
    } = relation;
    const relationClass = (0, _schema.getRelationClass)(relation.relation);

    if ((0, _schema.isThroughRelationClass)(relationClass) && !inverse) {
      const [fromClass, fromProperty] = (from == null ? void 0 : from.split('.')) || [];
      const [toClass, toProperty] = (to == null ? void 0 : to.split('.')) || [];
      const statements = [];
      const tableName = app.normalizeIdentifier(`${fromClass}${toClass}`);
      const fromId = app.normalizeIdentifier(`${fromClass}${(0, _utils.capitalize)(fromProperty)}`);
      const toId = app.normalizeIdentifier(`${toClass}${(0, _utils.capitalize)(toProperty)}`);
      tables.push({
        tableName,
        statements
      });
      statements.push(`table.increments('id').primary()`);
      statements.push((0, _utils.deindent)`
        table.integer('${fromId}').unsigned().index()
          .references('${app.normalizeIdentifier(fromProperty)}')\\
          .inTable('${app.normalizeIdentifier(fromClass)}')\\
          .onDelete('CASCADE')`);
      statements.push((0, _utils.deindent)`
        table.integer('${toId}').unsigned().index()
          .references('${app.normalizeIdentifier(toProperty)}')\\
          .inTable('${app.normalizeIdentifier(toClass)}')\\
          .onDelete('CASCADE')`);
    }
  }
}

function padDate(segment) {
  return segment.toString().padStart(2, '0');
}

function getTimestamp() {
  const d = new Date();
  return d.getFullYear().toString() + padDate(d.getMonth() + 1) + padDate(d.getDate()) + padDate(d.getHours()) + padDate(d.getMinutes()) + padDate(d.getSeconds());
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvZGIvY3JlYXRlTWlncmF0aW9uLmpzIl0sIm5hbWVzIjpbInR5cGVUb0tuZXgiLCJudW1iZXIiLCJvYmplY3QiLCJhcnJheSIsImRlZmF1bHRWYWx1ZXMiLCJtaWdyYXRpb25EaXIiLCJwYXRoIiwiam9pbiIsInByb2Nlc3MiLCJjd2QiLCJjcmVhdGVNaWdyYXRpb24iLCJhcHAiLCJuYW1lIiwibW9kZWxOYW1lcyIsIm1vZGVscyIsIm1hcCIsIm1vZGVsTmFtZSIsIm1vZGVsQ2xhc3MiLCJFcnJvciIsInRhYmxlcyIsImNvbGxlY3RNb2RlbFRhYmxlcyIsImNvbGxlY3RUaHJvdWdoVGFibGVzIiwiY3JlYXRlVGFibGVzIiwiZHJvcFRhYmxlcyIsInRhYmxlTmFtZSIsInN0YXRlbWVudHMiLCJwdXNoIiwidW5zaGlmdCIsImdldENvZGUiLCJsZW5ndGgiLCJmaWxlbmFtZSIsImdldFRpbWVzdGFtcCIsImZpbGUiLCJmcyIsImV4aXN0cyIsImNvbnNvbGUiLCJpbmZvIiwiY2hhbGsiLCJyZWQiLCJ3cml0ZUZpbGUiLCJjeWFuIiwibm9ybWFsaXplSWRlbnRpZmllciIsInByb3BlcnRpZXMiLCJyZWxhdGlvbnMiLCJkZWZpbml0aW9uIiwidW5pcXVlQ29tcG9zaXRlcyIsInByb3BlcnR5IiwiT2JqZWN0IiwiZW50cmllcyIsImNvbHVtbiIsImRlc2NyaXB0aW9uIiwidHlwZSIsInNwZWNpZmljVHlwZSIsInVuc2lnbmVkIiwiY29tcHV0ZWQiLCJudWxsYWJsZSIsInJlcXVpcmVkIiwicHJpbWFyeSIsImZvcmVpZ24iLCJ1bmlxdWUiLCJpbmRleCIsImRlZmF1bHQiLCJfZGVmYXVsdCIsImtuZXhUeXBlIiwicmVwbGFjZSIsInRyaW0iLCJjb21wb3NpdGVzIiwic3RhdGVtZW50IiwidW5kZWZpbmVkIiwidmFsdWUiLCJKU09OIiwic3RyaW5naWZ5IiwicmVsYXRpb24iLCJ2YWx1ZXMiLCJmcm9tIiwidG8iLCJvd25lciIsImZyb21DbGFzcyIsImZyb21Qcm9wZXJ0eSIsInNwbGl0IiwidG9DbGFzcyIsInRvUHJvcGVydHkiLCJmaWx0ZXIiLCJzdHIiLCJpbnZlcnNlIiwicmVsYXRpb25DbGFzcyIsImZyb21JZCIsInRvSWQiLCJwYWREYXRlIiwic2VnbWVudCIsInRvU3RyaW5nIiwicGFkU3RhcnQiLCJkIiwiRGF0ZSIsImdldEZ1bGxZZWFyIiwiZ2V0TW9udGgiLCJnZXREYXRlIiwiZ2V0SG91cnMiLCJnZXRNaW51dGVzIiwiZ2V0U2Vjb25kcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUlBLE1BQU1BLFVBQVUsR0FBRztBQUNqQkMsRUFBQUEsTUFBTSxFQUFFLFFBRFM7QUFFakJDLEVBQUFBLE1BQU0sRUFBRSxNQUZTO0FBR2pCQyxFQUFBQSxLQUFLLEVBQUU7QUFIVSxDQUFuQjtBQU1BLE1BQU1DLGFBQWEsR0FBRztBQUNwQixXQUFVO0FBRFUsQ0FBdEI7O0FBSUEsTUFBTUMsWUFBWSxHQUFHQyxjQUFLQyxJQUFMLENBQVVDLE9BQU8sQ0FBQ0MsR0FBUixFQUFWLEVBQXlCLFlBQXpCLENBQXJCOztBQUVPLGVBQWVDLGVBQWYsQ0FBK0JDLEdBQS9CLEVBQW9DQyxJQUFwQyxFQUEwQyxHQUFHQyxVQUE3QyxFQUF5RDtBQUM5RCxRQUFNQyxNQUFNLEdBQUdELFVBQVUsQ0FBQ0UsR0FBWCxDQUFlQyxTQUFTLElBQUk7QUFDekMsVUFBTUMsVUFBVSxHQUFHTixHQUFHLENBQUNHLE1BQUosQ0FBV0UsU0FBWCxDQUFuQjs7QUFDQSxRQUFJLENBQUNDLFVBQUwsRUFBaUI7QUFDZixZQUFNLElBQUlDLEtBQUosQ0FBVywwQkFBeUJGLFNBQVUsa0JBQTlDLENBQU47QUFDRDs7QUFDRCxXQUFPQyxVQUFQO0FBQ0QsR0FOYyxDQUFmO0FBT0EsUUFBTUUsTUFBTSxHQUFHLEVBQWY7O0FBQ0EsT0FBSyxNQUFNRixVQUFYLElBQXlCSCxNQUF6QixFQUFpQztBQUMvQk0sSUFBQUEsa0JBQWtCLENB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U0FBU1EsT0FBVCxDQUFpQkMsT0FBakIsRUFBMEI7QUFDeEIsU0FBT0EsT0FBTyxDQUFDQyxRQUFSLEdBQW1CQyxRQUFuQixDQUE0QixDQUE1QixFQUErQixHQUEvQixDQUFQO0FBQ0Q7O0FBSUQsU0FBUzVELFlBQVQsR0FBd0I7QUFDdEIsUUFBTTZELENBQUMsR0FBRyxJQUFJQyxJQUFKLEVBQVY7QUFDQSxTQUFPRCxDQUFDLENBQUNFLFdBQUYsR0FBZ0JKLFFBQWhCLEtBQ0xGLE9BQU8sQ0FBQ0ksQ0FBQyxDQUFDRyxRQUFGLEtBQWUsQ0FBaEIsQ0FERixHQUVMUCxPQUFPLENBQUNJLENBQUMsQ0FBQ0ksT0FBRixFQUFELENBRkYsR0FHTFIsT0FBTyxDQUFDSSxDQUFDLENBQUNLLFFBQUYsRUFBRCxDQUhGLEdBSUxULE9BQU8sQ0FBQ0ksQ0FBQyxDQUFDTSxVQUFGLEVBQUQsQ0FKRixHQUtMVixPQUFPLENBQUNJLENBQUMsQ0FBQ08sVUFBRixFQUFELENBTFQ7QUFNRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5pbXBvcnQgeyBnZXRSZWxhdGlvbkNsYXNzLCBpc1Rocm91Z2hSZWxhdGlvbkNsYXNzIH0gZnJvbSAnQC9zY2hlbWEnXG5pbXBvcnQge1xuICBpc09iamVjdCwgaXNBcnJheSwgaXNTdHJpbmcsIGRlaW5kZW50LCBjYXBpdGFsaXplXG59IGZyb20gJ0BkaXRvanMvdXRpbHMnXG5cbmNvbnN0IHR5cGVUb0tuZXggPSB7XG4gIG51bWJlcjogJ2RvdWJsZScsXG4gIG9iamVjdDogJ2pzb24nLFxuICBhcnJheTogJ2pzb24nXG59XG5cbmNvbnN0IGRlZmF1bHRWYWx1ZXMgPSB7XG4gICdub3coKSc6IGBrbmV4LnJhdygnQ1VSUkVOVF9USU1FU1RBTVAnKWBcbn1cblxuY29uc3QgbWlncmF0aW9uRGlyID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksICdtaWdyYXRpb25zJylcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZU1pZ3JhdGlvbihhcHAsIG5hbWUsIC4uLm1vZGVsTmFtZXMpIHtcbiAgY29uc3QgbW9kZWxzID0gbW9kZWxOYW1lcy5tYXAobW9kZWxOYW1lID0+IHtcbiAgICBjb25zdCBtb2RlbENsYXNzID0gYXBwLm1vZGVsc1ttb2RlbE5hbWVdXG4gICAgaWYgKCFtb2RlbENsYXNzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vZGVsIGNsYXNzIHdpdGggbmFtZSAnJHttb2RlbE5hbWV9JyBkb2VzIG5vdCBleGlzdGApXG4gICAgfVxuICAgIHJldHVybiBtb2RlbENsYXNzXG4gIH0pXG4gIGNvbnN0IHRhYmxlcyA9IFtdXG4gIGZvciAoY29uc3QgbW9kZWxDbGFzcyBvZiBtb2RlbHMpIHtcbiAgICBjb2xsZWN0TW9kZWxUYWJsZXMobW9kZWxDbGFzcywgYXBwLCB0YWJsZXMpXG4gIH1cbiAgZm9yIChjb25zdCBtb2RlbENsYXNzIG9mIG1vZGVscykge1xuICAgIGNvbGxlY3RUaHJvdWdoVGFibGVzKG1vZGVsQ2xhc3MsIGFwcCwgdGFibGVzKVxuICB9XG4gIGNvbnN0IGNyZWF0ZVRhYmxlcyA9IFtdXG4gIGNvbnN0IGRyb3BUYWJsZXMgPSBbXVxuICBmb3IgKGNvbnN0IHsgdGFibGVOYW1lLCBzdGF0ZW1lbnRzIH0gb2YgdGFibGVzKSB7XG4gICAgY3JlYXRlVGFibGVzLnB1c2goZGVpbmRlbnRgXG4gICAgICAuY3JlYXRlVGFibGUoJyR7dGFibGVOYW1lfScsIHRhYmxlID0+IHtcbiAgICAgICAgJHtzdGF0ZW1lbnRzLmpvaW4oJ1xcbicpfVxuICAgICAgfSlgKVxuICAgIGRyb3BUYWJsZXMudW5zaGlmdChkZWluZGVudGBcbiAgICAgIC5kcm9wVGFibGVJZkV4aXN0cygnJHt0YWJsZU5hbWV9JylgKVxuICB9XG4gIGNvbnN0IGdldENvZGUgPSB0YWJsZXMgPT4gdGFibGVzLmxlbmd0aCA+IDBcbiAgICA/IGRlaW5kZW50YFxuICAgICAgYXdhaXQga25leC5zY2hlbWFcbiAgICAgICAgJHt0YWJsZXMuam9pbignXFxuJyl9YFxuICAgIDogJydcbiAgY29uc3QgZmlsZW5hbWUgPSBgJHtnZXRUaW1lc3RhbXAoKX1fJHtuYW1lfS5qc2BcbiAgY29uc3QgZmlsZSA9IHBhdGguam9pbihtaWdyYXRpb25EaXIsIGZpbGVuYW1lKVxuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGZpbGUpKSB7XG4gICAgLy8gVGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuLCBidXQgbGV0J3MgYmUgb24gdGhlIHNhZmUgc2lkZSBoZXJlOlxuICAgIGNvbnNvbGUuaW5mbyhjaGFsay5yZWQoYE1pZ3JhdGlvbiAnJHtmaWxlbmFtZX0nIGFscmVhZHkgZXhpc3RzLmApKVxuICAgIHJldHVybiBmYWxzZVxuICB9IGVsc2Uge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlLCBkZWluZGVudGBcbiAgICAgIGV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cChrbmV4KSB7XG4gICAgICAgICR7Z2V0Q29kZShjcmVhdGVUYWJsZXMpfVxuICAgICAgfVxuXG4gICAgICBleHBvcnQgYXN5bmMgZnVuY3Rpb24gZG93bihrbmV4KSB7XG4gICAgICAgICR7Z2V0Q29kZShkcm9wVGFibGVzKX1cbiAgICAgIH1cbiAgICBgKVxuICAgIGNvbnNvbGUuaW5mbyhjaGFsay5jeWFuKGBNaWdyYXRpb24gJyR7ZmlsZW5hbWV9JyBzdWNjZXNzZnVsbHkgY3JlYXRlZC5gKSlcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RNb2RlbFRhYmxlcyhtb2RlbENsYXNzLCBhcHAsIHRhYmxlcykge1xuICBjb25zdCB0YWJsZU5hbWUgPSBhcHAubm9ybWFsaXplSWRlbnRpZmllcihtb2RlbENsYXNzLnRhYmxlTmFtZSlcbiAgY29uc3QgeyBwcm9wZXJ0aWVzLCByZWxhdGlvbnMgfSA9IG1vZGVsQ2xhc3MuZGVmaW5pdGlvblxuICBjb25zdCBzdGF0ZW1lbnRzID0gW11cbiAgdGFibGVzLnB1c2goeyB0YWJsZU5hbWUsIHN0YXRlbWVudHMgfSlcbiAgY29uc3QgdW5pcXVlQ29tcG9zaXRlcyA9IHt9XG4gIGZvciAoY29uc3QgW25hbWUsIHByb3BlcnR5XSBvZiBPYmplY3QuZW50cmllcyhwcm9wZXJ0aWVzKSkge1xuICAgIGNvbnN0IGNvbHVtbiA9IGFwcC5ub3JtYWxpemVJZGVudGlmaWVyKG5hbWUpXG4gICAgbGV0IHtcbiAgICAgIGRlc2NyaXB0aW9uLCB0eXBlLCBzcGVjaWZpY1R5cGUsIHVuc2lnbmVkLCBjb21wdXRlZCwgbnVsbGFibGUsIHJlcXVpcmVkLFxuICAgICAgcHJpbWFyeSwgZm9yZWlnbiwgdW5pcXVlLCBpbmRleCxcbiAgICAgIGRlZmF1bHQ6IF9kZWZhdWx0XG4gICAgfSA9IHByb3BlcnR5XG4gICAgY29uc3Qga25leFR5cGUgPSB0eXBlVG9LbmV4W3R5cGVdIHx8IHR5cGVcbiAgICBpZiAoIWNvbXB1dGVkKSB7XG4gICAgICBpZiAoZGVzY3JpcHRpb24pIHtcbiAgICAgICAgc3RhdGVtZW50cy5wdXNoKGAvLyAke2Rlc2NyaXB0aW9uLnJlcGxhY2UoL1xcc3syLH0vZywgJyAnKS50cmltKCl9YClcbiAgICAgIH1cbiAgICAgIGlmIChpc1N0cmluZyh1bmlxdWUpKSB7XG4gICAgICAgIC8vIFRvIGRlY2xhcmUgY29tcG9zaXRlIGZvcmVpZ24ga2V5cyBhcyB1bmlxdWUsIHlvdSBjYW4gZ2l2ZSBlYWNoXG4gICAgICAgIC8vIHByb3BlcnR5IHRoZSBzYW1lIHN0cmluZyB2YWx1ZSBpbiB0aGUgYHVuaXF1ZWAga2V5d29yZHMsIGUuZy46XG4gICAgICAgIC8vIGB1bmlxdWU6ICdjdXN0b21lcklkX25hbWUnXG4gICAgICAgIGNvbnN0IGNvbXBvc2l0ZXMgPSB1bmlxdWVDb21wb3NpdGVzW3VuaXF1ZV0gfHxcbiAgICAgICAgICAodW5pcXVlQ29tcG9zaXRlc1t1bmlxdWVdID0gW10pXG4gICAgICAgIGNvbXBvc2l0ZXMucHVzaChjb2x1bW4pXG4gICAgICAgIHVuaXF1ZSA9IGZhbHNlXG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0ZW1lbnQgPSBwcmltYXJ5XG4gICAgICAgID8gW2B0YWJsZS5pbmNyZW1lbnRzKCcke2NvbHVtbn0nKS5wcmltYXJ5KClgXVxuICAgICAgICA6IHNwZWNpZmljVHlwZVxuICAgICAgICAgID8gW2B0YWJsZS5zcGVjaWZpY1R5cGUoJyR7Y29sdW1ufScsICcke3NwZWNpZmljVHlwZX0nKWBdXG4gICAgICAgICAgOiBbYHRhYmxlLiR7a25leFR5cGV9KCcke2NvbHVtbn0nKWBdXG4gICAgICBzdGF0ZW1lbnQucHVzaChcbiAgICAgICAgdW5zaWduZWQgJiYgJ3Vuc2lnbmVkKCknLFxuICAgICAgICAhcHJpbWFyeSAmJiByZXF1aXJlZCAmJiAnbm90TnVsbGFibGUoKScsXG4gICAgICAgIG51bGxhYmxlICYmICdudWxsYWJsZSgpJyxcbiAgICAgICAgdW5pcXVlICYmICd1bmlxdWUoKScsXG4gICAgICAgIGluZGV4ICYmICdpbmRleCgpJ1xuICAgICAgKVxuICAgICAgaWYgKF9kZWZhdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGV0IHZhbHVlID0gZGVmYXVsdFZhbHVlc1tfZGVmYXVsdF1cbiAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgIHZhbHVlID0gaXNBcnJheShfZGVmYXVsdCkgfHwgaXNPYmplY3QoX2RlZmF1bHQpXG4gICAgICAgICAgICA/IEpTT04uc3RyaW5naWZ5KF9kZWZhdWx0KVxuICAgICAgICAgICAgOiBfZGVmYXVsdFxuICAgICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHZhbHVlID0gYCcke3ZhbHVlfSdgXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN0YXRlbWVudC5wdXNoKGBkZWZhdWx0VG8oJHt2YWx1ZX0pYClcbiAgICAgIH1cbiAgICAgIGlmIChmb3JlaWduKSB7XG4gICAgICAgIGZvciAoY29uc3QgcmVsYXRpb24gb2YgT2JqZWN0LnZhbHVlcyhyZWxhdGlvbnMpKSB7XG4gICAgICAgICAgLy8gVE9ETzogU3VwcG9ydCBjb21wb3NpdGUga2V5cyBmb3IgZm9yZWlnbiByZWZlcmVuY2VzOlxuICAgICAgICAgIC8vIFVzZSBgYXNBcnJheShmcm9tKWAsIGBhc0FycmF5KHRvKWBcbiAgICAgICAgICBjb25zdCB7IGZyb20sIHRvLCBvd25lciB9ID0gcmVsYXRpb25cbiAgICAgICAgICBjb25zdCBbZnJvbUNsYXNzLCBmcm9tUHJvcGVydHldID0gZnJvbT8uc3BsaXQoJy4nKSB8fCBbXVxuICAgICAgICAgIGlmIChmcm9tUHJvcGVydHkgPT09IG5hbWUpIHtcbiAgICAgICAgICAgIGlmIChmcm9tQ2xhc3MgIT09IG1vZGVsQ2xhc3MubmFtZSkge1xuICAgICAgICAgICAgICB0aHJvdyBFcnJvcihgSW52YWxpZCByZWxhdGlvbiBkZWNsYXJhdGlvbjogJHtyZWxhdGlvbn1gKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgW3RvQ2xhc3MsIHRvUHJvcGVydHldID0gdG8/LnNwbGl0KCcuJykgfHwgW11cbiAgICAgICAgICAgIHN0YXRlbWVudC5wdXNoKFxuICAgICAgICAgICAgICAnXFxuJyxcbiAgICAgICAgICAgICAgYHJlZmVyZW5jZXMoJyR7YXBwLm5vcm1hbGl6ZUlkZW50aWZpZXIodG9Qcm9wZXJ0eSl9JylgLFxuICAgICAgICAgICAgICBgaW5UYWJsZSgnJHthcHAubm9ybWFsaXplSWRlbnRpZmllcih0b0NsYXNzKX0nKWAsXG4gICAgICAgICAgICAgIC8vIE9ubHkgcmVsYXRpb25zIHRoYXQgYXJlbid0IG93bmVycyBvZiB0aGVpciBkYXRhIHNob3VsZCBjYXNjYWRlXG4gICAgICAgICAgICAgIC8vIG9uIGRlbGV0ZS5cbiAgICAgICAgICAgICAgLy8gVE9ETzogRmluZCB0aGUgcmV2ZXJzZSByZWxhdGlvbiBvZiB0aGlzIGluIHRoZSBvdGhlciBjbGFzcyBhbmRcbiAgICAgICAgICAgICAgLy8gb25seSBhZGQgYG9uRGVsZXRlKCdDQVNDQURFJylgIGlmIHRoYXQgb25lJ3MgYW4gb3duZXIuXG4gICAgICAgICAgICAgICFvd25lciAmJiBgb25EZWxldGUoJ0NBU0NBREUnKWBcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHN0YXRlbWVudHMucHVzaChzdGF0ZW1lbnQuZmlsdGVyKHN0ciA9PiAhIXN0cikuam9pbignLicpXG4gICAgICAgIC5yZXBsYWNlKC9cXC5cXG5cXC4vZywgJ1xcbiAgLicpKVxuICAgIH1cbiAgfVxuICBmb3IgKGNvbnN0IGNvbXBvc2l0ZXMgb2YgT2JqZWN0LnZhbHVlcyh1bmlxdWVDb21wb3NpdGVzKSkge1xuICAgIHN0YXRlbWVudHMucHVzaChgdGFibGUudW5pcXVlKFske1xuICAgICAgY29tcG9zaXRlcy5tYXAoY29sdW1uID0+IGAnJHtjb2x1bW59J2ApLmpvaW4oJywgJylcbiAgICB9XSlgKVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RUaHJvdWdoVGFibGVzKG1vZGVsQ2xhc3MsIGFwcCwgdGFibGVzKSB7XG4gIGNvbnN0IHsgcmVsYXRpb25zIH0gPSBtb2RlbENsYXNzLmRlZmluaXRpb25cbiAgZm9yIChjb25zdCByZWxhdGlvbiBvZiBPYmplY3QudmFsdWVzKHJlbGF0aW9ucykpIHtcbiAgICBjb25zdCB7IGZyb20sIHRvLCBpbnZlcnNlIH0gPSByZWxhdGlvblxuICAgIGNvbnN0IHJlbGF0aW9uQ2xhc3MgPSBnZXRSZWxhdGlvbkNsYXNzKHJlbGF0aW9uLnJlbGF0aW9uKVxuICAgIGlmIChpc1Rocm91Z2hSZWxhdGlvbkNsYXNzKHJlbGF0aW9uQ2xhc3MpICYmICFpbnZlcnNlKSB7XG4gICAgICAvLyBUT0RPOiBTdXBwb3J0IGNvbXBvc2l0ZSBrZXlzIGZvciBmb3JlaWduIHJlZmVyZW5jZXM6XG4gICAgICAvLyBVc2UgYGFzQXJyYXkoZnJvbSlgLCBgYXNBcnJheSh0bylgXG4gICAgICBjb25zdCBbZnJvbUNsYXNzLCBmcm9tUHJvcGVydHldID0gZnJvbT8uc3BsaXQoJy4nKSB8fCBbXVxuICAgICAgY29uc3QgW3RvQ2xhc3MsIHRvUHJvcGVydHldID0gdG8/LnNwbGl0KCcuJykgfHwgW11cbiAgICAgIGNvbnN0IHN0YXRlbWVudHMgPSBbXVxuICAgICAgLy8gU2VlIGNvbnZlcnRSZWxhdGlvbnMoKVxuICAgICAgY29uc3QgdGFibGVOYW1lID0gYXBwLm5vcm1hbGl6ZUlkZW50aWZpZXIoYCR7ZnJvbUNsYXNzfSR7dG9DbGFzc31gKVxuICAgICAgY29uc3QgZnJvbUlkID0gYXBwLm5vcm1hbGl6ZUlkZW50aWZpZXIoXG4gICAgICAgIGAke2Zyb21DbGFzc30ke2NhcGl0YWxpemUoZnJvbVByb3BlcnR5KX1gKVxuICAgICAgY29uc3QgdG9JZCA9IGFwcC5ub3JtYWxpemVJZGVudGlmaWVyKFxuICAgICAgICBgJHt0b0NsYXNzfSR7Y2FwaXRhbGl6ZSh0b1Byb3BlcnR5KX1gKVxuICAgICAgdGFibGVzLnB1c2goeyB0YWJsZU5hbWUsIHN0YXRlbWVudHMgfSlcbiAgICAgIHN0YXRlbWVudHMucHVzaChgdGFibGUuaW5jcmVtZW50cygnaWQnKS5wcmltYXJ5KClgKVxuICAgICAgc3RhdGVtZW50cy5wdXNoKGRlaW5kZW50YFxuICAgICAgICB0YWJsZS5pbnRlZ2VyKCcke2Zyb21JZH0nKS51bnNpZ25lZCgpLmluZGV4KClcbiAgICAgICAgICAucmVmZXJlbmNlcygnJHthcHAubm9ybWFsaXplSWRlbnRpZmllcihmcm9tUHJvcGVydHkpfScpXFxcXFxuICAgICAgICAgIC5pblRhYmxlKCcke2FwcC5ub3JtYWxpemVJZGVudGlmaWVyKGZyb21DbGFzcyl9JylcXFxcXG4gICAgICAgICAgLm9uRGVsZXRlKCdDQVNDQURFJylgKVxuICAgICAgc3RhdGVtZW50cy5wdXNoKGRlaW5kZW50YFxuICAgICAgICB0YWJsZS5pbnRlZ2VyKCcke3RvSWR9JykudW5zaWduZWQoKS5pbmRleCgpXG4gICAgICAgICAgLnJlZmVyZW5jZXMoJyR7YXBwLm5vcm1hbGl6ZUlkZW50aWZpZXIodG9Qcm9wZXJ0eSl9JylcXFxcXG4gICAgICAgICAgLmluVGFibGUoJyR7YXBwLm5vcm1hbGl6ZUlkZW50aWZpZXIodG9DbGFzcyl9JylcXFxcXG4gICAgICAgICAgLm9uRGVsZXRlKCdDQVNDQURFJylgKVxuICAgIH1cbiAgfVxufVxuXG4vLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIDIgcGxhY2VzIGZvciBlYWNoIG9mIHRoZSBkYXRlIHNlZ21lbnRzLlxuZnVuY3Rpb24gcGFkRGF0ZShzZWdtZW50KSB7XG4gIHJldHVybiBzZWdtZW50LnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKVxufVxuXG4vLyBHZXQgYSBkYXRlIG9iamVjdCBpbiB0aGUgY29ycmVjdCBmb3JtYXQsIHdpdGhvdXQgcmVxdWlyaW5nIGEgZnVsbCBvdXQgbGlicmFyeVxuLy8gbGlrZSBcIm1vbWVudC5qc1wiLlxuZnVuY3Rpb24gZ2V0VGltZXN0YW1wKCkge1xuICBjb25zdCBkID0gbmV3IERhdGUoKVxuICByZXR1cm4gZC5nZXRGdWxsWWVhcigpLnRvU3RyaW5nKCkgK1xuICAgIHBhZERhdGUoZC5nZXRNb250aCgpICsgMSkgK1xuICAgIHBhZERhdGUoZC5nZXREYXRlKCkpICtcbiAgICBwYWREYXRlKGQuZ2V0SG91cnMoKSkgK1xuICAgIHBhZERhdGUoZC5nZXRNaW51dGVzKCkpICtcbiAgICBwYWREYXRlKGQuZ2V0U2Vjb25kcygpKVxufVxuIl19