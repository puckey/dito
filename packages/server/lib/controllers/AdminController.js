"use strict";

exports.__esModule = true;
exports.AdminController = void 0;

var _path = _interopRequireDefault(require("path"));

var _koa = _interopRequireDefault(require("koa"));

var _koaMount = _interopRequireDefault(require("koa-mount"));

var _koaStatic = _interopRequireDefault(require("koa-static"));

var _koaWebpack = _interopRequireDefault(require("koa-webpack"));

var _koaConnectHistoryApiFallback = _interopRequireDefault(require("koa-connect-history-api-fallback"));

var _cliService = _interopRequireDefault(require("@vue/cli-service"));

var _htmlWebpackTagsPlugin = _interopRequireDefault(require("html-webpack-tags-plugin"));

var _Controller = require("./Controller");

var _errors = require("../errors");

var _utils = require("../utils");

var _utils2 = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class AdminController extends _Controller.Controller {
  constructor(app, namespace) {
    super(app, namespace);
    this.config = { ...this.app.config.admin,
      ...this.config
    };
    this.mode = this.config.mode || (this.app.config.env === 'development' ? 'development' : 'production');
  }

  getPath(name) {
    var _this$config$name;

    const str = (_this$config$name = this.config[name]) == null ? void 0 : _this$config$name.path;

    if (!str) {
      throw new _errors.ControllerError(this, `Missing admin.${name}.path configuration.`);
    }

    return _path.default.resolve(str);
  }

  getDitoObject() {
    const {
      api = {},
      settings = {}
    } = this.config;

    if (api.normalizePaths == null) {
      api.normalizePaths = this.app.config.app.normalizePaths;
    }

    return {
      base: this.url,
      api,
      settings
    };
  }

  sendDitoObject(ctx) {
    ctx.type = 'text/javascript';
    ctx.body = `window.dito = ${(0, _utils.formatJson)(this.getDitoObject(), false)}`;
  }

  middleware() {
    const authorization = this.processAuthorize(this.authorize);
    return async (ctx, next) => {
      if (/^\/dito\b/.test(ctx.url)) {
        return this.sendDitoObject(ctx);
      } else if (/\/views\b/.test(ctx.url)) {
        await this.handleAuthorization(authorization, ctx);
      }

      await next();
    };
  }

  compose() {
    this.koa = new _koa.default();
    this.koa.use(this.middleware());

    if (this.mode === 'development') {
      if (this.getPath('build')) {
        this.app.once('after:start', () => this.setupKoaWebpack());
      }
    } else {
      this.koa.use(async (ctx, next) => {
        if (!ctx.url.match(/^\/(app\.|css\/|js\/)/)) {
          ctx.url = '/';
        }

        await next();
      });
      this.koa.use((0, _koaStatic.default)(this.getPath('dist')));
    }

    return (0, _koaMount.default)(this.url, this.koa);
  }

  async setupKoaWebpack() {
    const stats = {
      all: false,
      errors: true,
      errorDetails: true
    };
    const middleware = await (0, _koaWebpack.default)({
      config: this.getWebpackConfig(),
      devMiddleware: {
        publicPath: '/',
        stats
      },
      hotClient: this.config.hotReload !== false && {
        logLevel: 'error',
        stats
      }
    });
    this.koa.use((0, _koaConnectHistoryApiFallback.default)());
    this.koa.use(middleware);
  }

  getVueConfig() {
    const development = this.mode === 'development';
    const {
      build = {},
      devtool = development ? 'source-map' : false
    } = this.config;
    return {
      runtimeCompiler: true,
      publicPath: `${this.url}/`,
      configureWebpack: {
        devtool,
        entry: [this.getPath('build')],
        resolve: {
          alias: {
            'webpack-hot-client/client': require.resolve('webpack-hot-client/client')
          }
        },
        output: {
          filename: '[name].[hash].js'
        },
        optimization: {
          splitChunks: {
            cacheGroups: {
              common: {
                name: 'common',
                test: /\/node_modules\//,
                chunks: 'all'
              },
              views: {
                name: 'views',
                test: /\/views\//,
                chunks: 'all'
              }
            }
          }
        },
        module: development ? {
          rules: [{
            test: /\.(js|css)$/,
            enforce: 'pre',
            use: [require.resolve('source-map-loader')]
          }]
        } : {},
        plugins: [new _htmlWebpackTagsPlugin.default({
          scripts: ['dito.js'],
          useHash: true,
          addHash: (path, hash) => path.replace(/\.js$/, `.${hash}.js`),
          append: false
        })],
        stats: {
          warningsFilter: /Failed to parse source map/
        }
      },
      chainWebpack: conf => {
        const {
          template = 'index.html'
        } = build;
        conf.plugin('html').tap(args => {
          args[0].template = /^[./]/.test(template) ? _path.default.resolve(template) : _path.default.join(this.getPath('build'), template);
          return args;
        });

        if (development) {
          var _jsRule$toConfig$use;

          const jsRule = conf.module.rule('js');
          const hasBabel = (_jsRule$toConfig$use = jsRule.toConfig().use) == null ? void 0 : _jsRule$toConfig$use.some(({
            loader
          }) => /\bbabel-loader\b/.test(loader));

          if (hasBabel) {
            jsRule.use('babel-loader').options({
              compact: false
            });
          }

          conf.plugins.delete('friendly-errors');
        }
      }
    };
  }

  getVuePlugins() {
    var _this$config$plugins;

    return (_this$config$plugins = this.config.plugins) == null ? void 0 : _this$config$plugins.map(definition => {
      const plugin = (0, _utils2.isString)(definition) ? {
        id: definition
      } : (0, _utils2.isObject)(definition) ? definition : {};
      const {
        id,
        apply = require(id)
      } = plugin;

      if (!id) {
        throw new _errors.ControllerError(this, `Invalid plugin definition: ${definition}`);
      }

      return {
        id,
        apply
      };
    });
  }

  getWebpackConfig() {
    const service = new _cliService.default(this.getPath('build'), {
      inlineOptions: this.getVueConfig(),
      plugins: this.getVuePlugins()
    });
    service.init(this.mode);
    return service.resolveWebpackConfig();
  }

}

exports.AdminController = AdminController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9BZG1pbkNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiQWRtaW5Db250cm9sbGVyIiwiQ29udHJvbGxlciIsImNvbnN0cnVjdG9yIiwiYXBwIiwibmFtZXNwYWNlIiwiY29uZmlnIiwiYWRtaW4iLCJtb2RlIiwiZW52IiwiZ2V0UGF0aCIsIm5hbWUiLCJzdHIiLCJwYXRoIiwiQ29udHJvbGxlckVycm9yIiwicmVzb2x2ZSIsImdldERpdG9PYmplY3QiLCJhcGkiLCJzZXR0aW5ncyIsIm5vcm1hbGl6ZVBhdGhzIiwiYmFzZSIsInVybCIsInNlbmREaXRvT2JqZWN0IiwiY3R4IiwidHlwZSIsImJvZHkiLCJtaWRkbGV3YXJlIiwiYXV0aG9yaXphdGlvbiIsInByb2Nlc3NBdXRob3JpemUiLCJhdXRob3JpemUiLCJuZXh0IiwidGVzdCIsImhhbmRsZUF1dGhvcml6YXRpb24iLCJjb21wb3NlIiwia29hIiwiS29hIiwidXNlIiwib25jZSIsInNldHVwS29hV2VicGFjayIsIm1hdGNoIiwic3RhdHMiLCJhbGwiLCJlcnJvcnMiLCJlcnJvckRldGFpbHMiLCJnZXRXZWJwYWNrQ29uZmlnIiwiZGV2TWlkZGxld2FyZSIsInB1YmxpY1BhdGgiLCJob3RDbGllbnQiLCJob3RSZWxvYWQiLCJsb2dMZXZlbCIsImdldFZ1ZUNvbmZpZyIsImRldmVsb3BtZW50IiwiYnVpbGQiLCJkZXZ0b29sIiwicnVudGltZUNvbXBpbGVyIiwiY29uZmlndXJlV2VicGFjayIsImVudHJ5IiwiYWxpYXMiLCJyZXF1aXJlIiwib3V0cHV0IiwiZmlsZW5hbWUiLCJvcHRpbWl6YXRpb24iLCJzcGxpdENodW5rcyIsImNhY2hlR3JvdXBzIiwiY29tbW9uIiwiY2h1bmtzIiwidmlld3MiLCJtb2R1bGUiLCJydWxlcyIsImVuZm9yY2UiLCJwbHVnaW5zIiwiSHRtbFdlYnBhY2tUYWdzUGx1Z2luIiwic2NyaXB0cyIsInVzZUhhc2giLCJhZGRIYXNoIiwiaGFzaCIsInJlcGxhY2UiLCJhcHBlbmQiLCJ3YXJuaW5nc0ZpbHRlciIsImNoYWluV2VicGFjayIsImNvbmYiLCJ0ZW1wbGF0ZSIsInBsdWdpbiIsInRhcCIsImFyZ3MiLCJqb2luIiwianNSdWxlIiwicnVsZSIsImhhc0JhYmVsIiwidG9Db25maWciLCJzb21lIiwibG9hZGVyIiwib3B0aW9ucyIsImNvbXBhY3QiLCJkZWxldGUiLCJnZXRWdWVQbHVnaW5zIiwibWFwIiwiZGVmaW5pdGlvbiIsImlkIiwiYXBwbHkiLCJzZXJ2aWNlIiwiVnVlU2VydmljZSIsImlubGluZU9wdGlvbnMiLCJpbml0IiwicmVzb2x2ZVdlYnBhY2tDb25maWciXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFTyxNQUFNQSxlQUFOLFNBQThCQyxzQkFBOUIsQ0FBeUM7QUFFOUNDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCO0FBQzFCLFVBQU1ELEdBQU4sRUFBV0MsU0FBWDtBQUdBLFNBQUtDLE1BQUwsR0FBYyxFQUNaLEdBQUcsS0FBS0YsR0FBTCxDQUFTRSxNQUFULENBQWdCQyxLQURQO0FBRVosU0FBRyxLQUFLRDtBQUZJLEtBQWQ7QUFPQSxTQUFLRSxJQUFMLEdBQVksS0FBS0YsTUFBTCxDQUFZRSxJQUFaLEtBQ1YsS0FBS0osR0FBTCxDQUFTRSxNQUFULENBQWdCRyxHQUFoQixLQUF3QixhQUF4QixHQUF3QyxhQUF4QyxHQUF3RCxZQUQ5QyxDQUFaO0FBR0Q7O0FBRURDLEVBQUFBLE9BQU8sQ0FBQ0MsSUFBRCxFQUFPO0FBQUE7O0FBQ1osVUFBTUMsR0FBRyx3QkFBRyxLQUFLTixNQUFMLENBQVlLLElBQVosQ0FBSCxxQkFBRyxrQkFBbUJFLElBQS9COztBQUNBLFFBQUksQ0FBQ0QsR0FBTCxFQUFVO0FBQ1IsWUFBTSxJQUFJRSx1QkFBSixDQUNKLElBREksRUFFSCxpQkFB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TyxDQUFDd0MsRUFBRDtBQUZYLFVBR0ZoQixNQUhKOztBQUlBLFVBQUksQ0FBQ2dCLEVBQUwsRUFBUztBQUNQLGNBQU0sSUFBSXBGLHVCQUFKLENBQ0osSUFESSxFQUVILDhCQUE2Qm1GLFVBQVcsRUFGckMsQ0FBTjtBQUlEOztBQUNELGFBQU87QUFBRUMsUUFBQUEsRUFBRjtBQUFNQyxRQUFBQTtBQUFOLE9BQVA7QUFDRCxLQWpCTSxDQUFQO0FBa0JEOztBQUVEdkQsRUFBQUEsZ0JBQWdCLEdBQUc7QUFDakIsVUFBTXdELE9BQU8sR0FBRyxJQUFJQyxtQkFBSixDQUFlLEtBQUszRixPQUFMLENBQWEsT0FBYixDQUFmLEVBQXNDO0FBQ3BENEYsTUFBQUEsYUFBYSxFQUFFLEtBQUtwRCxZQUFMLEVBRHFDO0FBRXBEb0IsTUFBQUEsT0FBTyxFQUFFLEtBQUt5QixhQUFMO0FBRjJDLEtBQXRDLENBQWhCO0FBSUFLLElBQUFBLE9BQU8sQ0FBQ0csSUFBUixDQUFhLEtBQUsvRixJQUFsQjtBQUNBLFdBQU80RixPQUFPLENBQUNJLG9CQUFSLEVBQVA7QUFDRDs7QUFyUDZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBLb2EgZnJvbSAna29hJ1xuaW1wb3J0IG1vdW50IGZyb20gJ2tvYS1tb3VudCdcbmltcG9ydCBzZXJ2ZSBmcm9tICdrb2Etc3RhdGljJ1xuaW1wb3J0IGtvYVdlYnBhY2sgZnJvbSAna29hLXdlYnBhY2snXG5pbXBvcnQgaGlzdG9yeUFwaUZhbGxiYWNrIGZyb20gJ2tvYS1jb25uZWN0LWhpc3RvcnktYXBpLWZhbGxiYWNrJ1xuaW1wb3J0IFZ1ZVNlcnZpY2UgZnJvbSAnQHZ1ZS9jbGktc2VydmljZSdcbmltcG9ydCBIdG1sV2VicGFja1RhZ3NQbHVnaW4gZnJvbSAnaHRtbC13ZWJwYWNrLXRhZ3MtcGx1Z2luJ1xuaW1wb3J0IHsgQ29udHJvbGxlciB9IGZyb20gJy4vQ29udHJvbGxlcidcbmltcG9ydCB7IENvbnRyb2xsZXJFcnJvciB9IGZyb20gJ0AvZXJyb3JzJ1xuaW1wb3J0IHsgZm9ybWF0SnNvbiB9IGZyb20gJ0AvdXRpbHMnXG5pbXBvcnQgeyBpc1N0cmluZywgaXNPYmplY3QgfSBmcm9tICdAZGl0b2pzL3V0aWxzJ1xuXG5leHBvcnQgY2xhc3MgQWRtaW5Db250cm9sbGVyIGV4dGVuZHMgQ29udHJvbGxlciB7XG4gIC8vIEBvdmVycmlkZVxuICBjb25zdHJ1Y3RvcihhcHAsIG5hbWVzcGFjZSkge1xuICAgIHN1cGVyKGFwcCwgbmFtZXNwYWNlKVxuICAgIC8vIE1lcmdlIGB0aGlzLmFwcC5jb25maWcuYWRtaW5gIGludG8gY29uZmlnIGFzIGRlZmF1bHQsIGJ1dCBhbGxvdyBvdmVycmlkZXNcbiAgICAvLyBvbiB0aGUgY29udHJvbGxlciBpdHNlbGY6XG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICAuLi50aGlzLmFwcC5jb25maWcuYWRtaW4sXG4gICAgICAuLi50aGlzLmNvbmZpZ1xuICAgIH1cbiAgICAvLyBJZiBubyBtb2RlIGlzIHNwZWNpZmllZCwgdXNlIGBwcm9kdWN0aW9uYCBzaW5jZSB0aGF0J3MganVzdCB0aGUgaG9zdGluZ1xuICAgIC8vIG9mIHRoZSBwcmUtYnVpbHQgYWRtaW4gZmlsZXMuIGBkZXZlbG9wbWVudGAgc2VydmVzIHRoZSBhZG1pbiBkaXJlY3RseVxuICAgIC8vIHNvdXJjZXMgd2l0aCBIUk0sIGFuZCB0aHVzIHNob3VsZCBiZSBleHBsaWNpdGVseSBhY3RpdmF0ZWQuXG4gICAgdGhpcy5tb2RlID0gdGhpcy5jb25maWcubW9kZSB8fCAoXG4gICAgICB0aGlzLmFwcC5jb25maWcuZW52ID09PSAnZGV2ZWxvcG1lbnQnID8gJ2RldmVsb3BtZW50JyA6ICdwcm9kdWN0aW9uJ1xuICAgIClcbiAgfVxuXG4gIGdldFBhdGgobmFtZSkge1xuICAgIGNvbnN0IHN0ciA9IHRoaXMuY29uZmlnW25hbWVdPy5wYXRoXG4gICAgaWYgKCFzdHIpIHtcbiAgICAgIHRocm93IG5ldyBDb250cm9sbGVyRXJyb3IoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGBNaXNzaW5nIGFkbWluLiR7bmFtZX0ucGF0aCBjb25maWd1cmF0aW9uLmBcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShzdHIpXG4gIH1cblxuICBnZXREaXRvT2JqZWN0KCkge1xuICAgIC8vIEV4cG9zZSBhcGkgY29uZmlnIGFuZCBkZWZpbml0aW9ucyB0byBicm93c2VyIHNpZGU6XG4gICAgLy8gUGFzcyBvbiB0aGUgYGNvbmZpZy5hcHAubm9ybWFsaXplUGF0aHNgIHNldHRpbmcgdG8gRGl0by5qcyBBZG1pbjpcbiAgICBjb25zdCB7XG4gICAgICBhcGkgPSB7fSxcbiAgICAgIHNldHRpbmdzID0ge31cbiAgICB9ID0gdGhpcy5jb25maWdcbiAgICBpZiAoYXBpLm5vcm1hbGl6ZVBhdGhzID09IG51bGwpIHtcbiAgICAgIGFwaS5ub3JtYWxpemVQYXRocyA9IHRoaXMuYXBwLmNvbmZpZy5hcHAubm9ybWFsaXplUGF0aHNcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGJhc2U6IHRoaXMudXJsLFxuICAgICAgYXBpLFxuICAgICAgc2V0dGluZ3NcbiAgICB9XG4gIH1cblxuICBzZW5kRGl0b09iamVjdChjdHgpIHtcbiAgICAvLyBTZW5kIGJhY2sgdGhlIGdsb2JhbCBkaXRvIG9iamVjdCBhcyBKYXZhU2NyaXB0IGNvZGUuXG4gICAgY3R4LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0J1xuICAgIGN0eC5ib2R5ID0gYHdpbmRvdy5kaXRvID0gJHtmb3JtYXRKc29uKHRoaXMuZ2V0RGl0b09iamVjdCgpLCBmYWxzZSl9YFxuICB9XG5cbiAgbWlkZGxld2FyZSgpIHtcbiAgICAvLyBTaGllbGQgYWRtaW4gdmlld3MgYWdhaW5zdCB1bmF1dGhvcml6ZWQgYWNjZXNzLlxuICAgIGNvbnN0IGF1dGhvcml6YXRpb24gPSB0aGlzLnByb2Nlc3NBdXRob3JpemUodGhpcy5hdXRob3JpemUpXG4gICAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgIGlmICgvXlxcL2RpdG9cXGIvLnRlc3QoY3R4LnVybCkpIHtcbiAgICAgICAgLy8gUmV0dXJuIHdpdGhvdXQgY2FsbGluZyBgbmV4dCgpYFxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kRGl0b09iamVjdChjdHgpXG4gICAgICB9IGVsc2UgaWYgKC9cXC92aWV3c1xcYi8udGVzdChjdHgudXJsKSkge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZUF1dGhvcml6YXRpb24oYXV0aG9yaXphdGlvbiwgY3R4KVxuICAgICAgfVxuICAgICAgYXdhaXQgbmV4dCgpXG4gICAgfVxuICB9XG5cbiAgY29tcG9zZSgpIHtcbiAgICB0aGlzLmtvYSA9IG5ldyBLb2EoKVxuICAgIHRoaXMua29hLnVzZSh0aGlzLm1pZGRsZXdhcmUoKSlcbiAgICBpZiAodGhpcy5tb2RlID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAvLyBDYWxsaW5nIGdldFBhdGgoKSB0aHJvd3MgZXhjZXB0aW9uIGlmIGFkbWluLmJ1aWxkLnBhdGggaXMgbm90IGRlZmluZWQ6XG4gICAgICBpZiAodGhpcy5nZXRQYXRoKCdidWlsZCcpKSB7XG4gICAgICAgIHRoaXMuYXBwLm9uY2UoJ2FmdGVyOnN0YXJ0JywgKCkgPT4gdGhpcy5zZXR1cEtvYVdlYnBhY2soKSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gU3RhdGljYWxseSBzZXJ2ZSB0aGUgcHJlLWJ1aWx0IGFkbWluIFNQQS4gQnV0IGluIG9yZGVyIGZvciB2dWUtcm91dGVyXG4gICAgICAvLyByb3V0ZXMgaW5zaWRlIHRoZSBTUEEgdG8gd29yaywgdXNlIGEgdGlueSByZXdyaXRpbmcgbWlkZGxld2FyZTpcbiAgICAgIHRoaXMua29hLnVzZShhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIC8vIC8vIEV4Y2x1ZGUgYXNzZXQgcmVxdWVzdHMgKGNzcywganMsIGFwcClcbiAgICAgICAgaWYgKCFjdHgudXJsLm1hdGNoKC9eXFwvKGFwcFxcLnxjc3NcXC98anNcXC8pLykpIHtcbiAgICAgICAgICBjdHgudXJsID0gJy8nXG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgbmV4dCgpXG4gICAgICB9KVxuICAgICAgdGhpcy5rb2EudXNlKHNlcnZlKHRoaXMuZ2V0UGF0aCgnZGlzdCcpKSlcbiAgICB9XG4gICAgcmV0dXJuIG1vdW50KHRoaXMudXJsLCB0aGlzLmtvYSlcbiAgfVxuXG4gIGFzeW5jIHNldHVwS29hV2VicGFjaygpIHtcbiAgICAvLyBodHRwczovL3dlYnBhY2suanMub3JnL2NvbmZpZ3VyYXRpb24vc3RhdHMvI3N0YXRzXG4gICAgY29uc3Qgc3RhdHMgPSB7XG4gICAgICBhbGw6IGZhbHNlLFxuICAgICAgZXJyb3JzOiB0cnVlLFxuICAgICAgZXJyb3JEZXRhaWxzOiB0cnVlXG4gICAgfVxuXG4gICAgY29uc3QgbWlkZGxld2FyZSA9IGF3YWl0IGtvYVdlYnBhY2soe1xuICAgICAgY29uZmlnOiB0aGlzLmdldFdlYnBhY2tDb25maWcoKSxcbiAgICAgIGRldk1pZGRsZXdhcmU6IHtcbiAgICAgICAgcHVibGljUGF0aDogJy8nLFxuICAgICAgICBzdGF0c1xuICAgICAgfSxcbiAgICAgIGhvdENsaWVudDogdGhpcy5jb25maWcuaG90UmVsb2FkICE9PSBmYWxzZSAmJiB7XG4gICAgICAgIC8vIFRoZSBvbmx5IHdheSB0byBub3QgbG9nIGBGYWlsZWQgdG8gcGFyc2Ugc291cmNlIG1hcGAgd2FybmluZ3MgaXNcbiAgICAgICAgLy8gc2FkbHkgdG8gaWdub3JlIGFsbCB3YXJuaW5nczpcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi93ZWJwYWNrLWhvdC1jbGllbnQvaXNzdWVzLzk0XG4gICAgICAgIGxvZ0xldmVsOiAnZXJyb3InLFxuICAgICAgICBzdGF0c1xuICAgICAgfVxuICAgIH0pXG4gICAgdGhpcy5rb2EudXNlKGhpc3RvcnlBcGlGYWxsYmFjaygpKVxuICAgIHRoaXMua29hLnVzZShtaWRkbGV3YXJlKVxuICB9XG5cbiAgZ2V0VnVlQ29uZmlnKCkge1xuICAgIGNvbnN0IGRldmVsb3BtZW50ID0gdGhpcy5tb2RlID09PSAnZGV2ZWxvcG1lbnQnXG4gICAgY29uc3Qge1xuICAgICAgYnVpbGQgPSB7fSxcbiAgICAgIGRldnRvb2wgPSBkZXZlbG9wbWVudCA/ICdzb3VyY2UtbWFwJyA6IGZhbHNlXG4gICAgfSA9IHRoaXMuY29uZmlnXG4gICAgcmV0dXJuIHtcbiAgICAgIHJ1bnRpbWVDb21waWxlcjogdHJ1ZSxcbiAgICAgIHB1YmxpY1BhdGg6IGAke3RoaXMudXJsfS9gLFxuICAgICAgY29uZmlndXJlV2VicGFjazoge1xuICAgICAgICBkZXZ0b29sLFxuICAgICAgICAvLyBXZSBhbHdheXMgbmVlZCB0aGUgc291cmNlIGJ1aWxkIHBhdGggYXMgZW50cnksIGV2ZW4gZm9yIHByb2R1Y3Rpb24sXG4gICAgICAgIC8vIGZvciB0aGluZ3MgbGlrZSAuYmFiZWxyYyB0byB3b3JrIHdoZW4gYnVpbGRpbmcgZm9yIGRpc3Q6XG4gICAgICAgIGVudHJ5OiBbdGhpcy5nZXRQYXRoKCdidWlsZCcpXSxcbiAgICAgICAgcmVzb2x2ZToge1xuICAgICAgICAgIGFsaWFzOiB7XG4gICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3dlYnBhY2stY29udHJpYi93ZWJwYWNrLWhvdC1jbGllbnQvcHVsbC82MlxuICAgICAgICAgICAgJ3dlYnBhY2staG90LWNsaWVudC9jbGllbnQnOlxuICAgICAgICAgICAgICByZXF1aXJlLnJlc29sdmUoJ3dlYnBhY2staG90LWNsaWVudC9jbGllbnQnKVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgb3V0cHV0OiB7XG4gICAgICAgICAgZmlsZW5hbWU6ICdbbmFtZV0uW2hhc2hdLmpzJ1xuICAgICAgICB9LFxuICAgICAgICBvcHRpbWl6YXRpb246IHtcbiAgICAgICAgICBzcGxpdENodW5rczoge1xuICAgICAgICAgICAgLy8gU3BsaXQgZGVwZW5kZW5jaWVzIGludG8gdHdvIGNodW5rcywgb25lIGZvciBhbGwgY29tbW9uIGxpYnJhcmllcyxcbiAgICAgICAgICAgIC8vIGFuZCBvbmUgZm9yIGFsbCB2aWV3cywgc28gdGhleSBjYW4gYmUgbG9hZGVkIHNlcGFyYXRlbHksIGFuZCBvbmx5XG4gICAgICAgICAgICAvLyBvbmNlIGF1dGhlbnRpY2F0aW9uIHdhcyBzdWNjZXNzZnVsLlxuICAgICAgICAgICAgY2FjaGVHcm91cHM6IHtcbiAgICAgICAgICAgICAgY29tbW9uOiB7XG4gICAgICAgICAgICAgICAgbmFtZTogJ2NvbW1vbicsXG4gICAgICAgICAgICAgICAgdGVzdDogL1xcL25vZGVfbW9kdWxlc1xcLy8sXG4gICAgICAgICAgICAgICAgY2h1bmtzOiAnYWxsJ1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB2aWV3czoge1xuICAgICAgICAgICAgICAgIG5hbWU6ICd2aWV3cycsXG4gICAgICAgICAgICAgICAgdGVzdDogL1xcL3ZpZXdzXFwvLyxcbiAgICAgICAgICAgICAgICBjaHVua3M6ICdhbGwnXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG1vZHVsZTogZGV2ZWxvcG1lbnRcbiAgICAgICAgICAvLyBQcmVzZXJ2ZSBzb3VyY2UtbWFwcyBpbiB0aGlyZCBwYXJ0eSBkZXBlbmRlbmNpZXMsIGJ1dCBkbyBub3QgbG9nXG4gICAgICAgICAgLy8gd2FybmluZ3MgYWJvdXQgZGVwZW5kZW5jaWVzIHRoYXQgZG9uJ3QgY29tZSB3aXRoIHNvdXJjZS1tYXBzLlxuICAgICAgICAgIC8vIGh0dHBzOi8vd2VicGFjay5qcy5vcmcvbG9hZGVycy9zb3VyY2UtbWFwLWxvYWRlci8jaWdub3Jpbmctd2FybmluZ3NcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0ZXN0OiAvXFwuKGpzfGNzcykkLyxcbiAgICAgICAgICAgICAgICBlbmZvcmNlOiAncHJlJyxcbiAgICAgICAgICAgICAgICAvLyBVc2UgYHJlcXVpcmUucmVzb2x2ZSgpYCBoZXJlIHRvbywgdG8gYXZvaWQgaXNzdWVzIHNpbWlsYXIgdG9cbiAgICAgICAgICAgICAgICAvLyAnd2VicGFjay1ob3QtY2xpZW50L2NsaWVudCcgYWJvdmUuXG4gICAgICAgICAgICAgICAgdXNlOiBbcmVxdWlyZS5yZXNvbHZlKCdzb3VyY2UtbWFwLWxvYWRlcicpXVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgfVxuICAgICAgICAgIDoge30sXG4gICAgICAgIHBsdWdpbnM6IFtcbiAgICAgICAgICAvLyBVc2UgYEh0bWxXZWJwYWNrVGFnc1BsdWdpbmAgcGx1Z2luIHRvIGluamVjdCBhIHNjcmlwdCB0YWcgdGhhdFxuICAgICAgICAgIC8vIGxvYWQgdGhlIGRpdG8gb2JqZWN0IGZyb20gdGhlIGNvbnRyb2xsZXIsIGluY2x1ZGluZyBgZGl0by5zZXR0aW5nc2BcbiAgICAgICAgICBuZXcgSHRtbFdlYnBhY2tUYWdzUGx1Z2luKHtcbiAgICAgICAgICAgIHNjcmlwdHM6IFsnZGl0by5qcyddLFxuICAgICAgICAgICAgdXNlSGFzaDogdHJ1ZSxcbiAgICAgICAgICAgIGFkZEhhc2g6IChwYXRoLCBoYXNoKSA9PiBwYXRoLnJlcGxhY2UoL1xcLmpzJC8sIGAuJHtoYXNofS5qc2ApLFxuICAgICAgICAgICAgYXBwZW5kOiBmYWxzZVxuICAgICAgICAgIH0pXG4gICAgICAgIF0sXG4gICAgICAgIHN0YXRzOiB7XG4gICAgICAgICAgd2FybmluZ3NGaWx0ZXI6IC9GYWlsZWQgdG8gcGFyc2Ugc291cmNlIG1hcC9cbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgY2hhaW5XZWJwYWNrOiBjb25mID0+IHtcbiAgICAgICAgLy8gQ2hhbmdlIHRoZSBsb2NhdGlvbiBvZiB0aGUgSFRNTCB0ZW1wbGF0ZTpcbiAgICAgICAgY29uc3QgeyB0ZW1wbGF0ZSA9ICdpbmRleC5odG1sJyB9ID0gYnVpbGRcbiAgICAgICAgY29uZi5wbHVnaW4oJ2h0bWwnKS50YXAoYXJncyA9PiB7XG4gICAgICAgICAgYXJnc1swXS50ZW1wbGF0ZSA9IC9eWy4vXS8udGVzdCh0ZW1wbGF0ZSlcbiAgICAgICAgICAgID8gcGF0aC5yZXNvbHZlKHRlbXBsYXRlKVxuICAgICAgICAgICAgOiBwYXRoLmpvaW4odGhpcy5nZXRQYXRoKCdidWlsZCcpLCB0ZW1wbGF0ZSlcbiAgICAgICAgICByZXR1cm4gYXJnc1xuICAgICAgICB9KVxuICAgICAgICBpZiAoZGV2ZWxvcG1lbnQpIHtcbiAgICAgICAgICAvLyBEaXNhYmxlIHRoZSAnY29tcGFjdCcgb3B0aW9uIGluIGJhYmVsLWxvYWRlciBkdXJpbmcgZGV2ZWxvcG1lbnQgdG9cbiAgICAgICAgICAvLyBwcmV2ZW50IGNvbXBsYWludHMgd2hlbiB3b3JraW5nIHdpdGggdGhlIGB5YXJuIHdhdGNoYCB2ZXJzaW9ucyBvZlxuICAgICAgICAgIC8vIGRpdG8tYWRtaW4udW1kLm1pbi5qcyBhbmQgZGl0by11aS51bWQubWluLmpzXG4gICAgICAgICAgY29uc3QganNSdWxlID0gY29uZi5tb2R1bGUucnVsZSgnanMnKVxuICAgICAgICAgIGNvbnN0IGhhc0JhYmVsID0ganNSdWxlLnRvQ29uZmlnKCkudXNlPy5zb21lKFxuICAgICAgICAgICAgKHsgbG9hZGVyIH0pID0+IC9cXGJiYWJlbC1sb2FkZXJcXGIvLnRlc3QobG9hZGVyKVxuICAgICAgICAgIClcbiAgICAgICAgICBpZiAoaGFzQmFiZWwpIHtcbiAgICAgICAgICAgIGpzUnVsZS51c2UoJ2JhYmVsLWxvYWRlcicpLm9wdGlvbnMoeyBjb21wYWN0OiBmYWxzZSB9KVxuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBNYWtlIGBzdGF0cy53YXJuaW5nc0ZpbHRlcmAgd29yaywgc2VlOlxuICAgICAgICAgIC8vIGh0dHBzOi8vZm9ydW0udnVlanMub3JnL3Qvc3BwcmVzcy13YXJuaW5ncy1pbi12dWUtY2xpLTMvNDU5MDUvNFxuICAgICAgICAgIGNvbmYucGx1Z2lucy5kZWxldGUoJ2ZyaWVuZGx5LWVycm9ycycpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXRWdWVQbHVnaW5zKCkge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5wbHVnaW5zPy5tYXAoZGVmaW5pdGlvbiA9PiB7XG4gICAgICBjb25zdCBwbHVnaW4gPSBpc1N0cmluZyhkZWZpbml0aW9uKVxuICAgICAgICA/IHsgaWQ6IGRlZmluaXRpb24gfVxuICAgICAgICA6IGlzT2JqZWN0KGRlZmluaXRpb24pXG4gICAgICAgICAgPyBkZWZpbml0aW9uXG4gICAgICAgICAgOiB7fVxuICAgICAgY29uc3Qge1xuICAgICAgICBpZCxcbiAgICAgICAgYXBwbHkgPSByZXF1aXJlKGlkKVxuICAgICAgfSA9IHBsdWdpblxuICAgICAgaWYgKCFpZCkge1xuICAgICAgICB0aHJvdyBuZXcgQ29udHJvbGxlckVycm9yKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgYEludmFsaWQgcGx1Z2luIGRlZmluaXRpb246ICR7ZGVmaW5pdGlvbn1gXG4gICAgICAgIClcbiAgICAgIH1cbiAgICAgIHJldHVybiB7IGlkLCBhcHBseSB9XG4gICAgfSlcbiAgfVxuXG4gIGdldFdlYnBhY2tDb25maWcoKSB7XG4gICAgY29uc3Qgc2VydmljZSA9IG5ldyBWdWVTZXJ2aWNlKHRoaXMuZ2V0UGF0aCgnYnVpbGQnKSwge1xuICAgICAgaW5saW5lT3B0aW9uczogdGhpcy5nZXRWdWVDb25maWcoKSxcbiAgICAgIHBsdWdpbnM6IHRoaXMuZ2V0VnVlUGx1Z2lucygpXG4gICAgfSlcbiAgICBzZXJ2aWNlLmluaXQodGhpcy5tb2RlKVxuICAgIHJldHVybiBzZXJ2aWNlLnJlc29sdmVXZWJwYWNrQ29uZmlnKClcbiAgfVxufVxuIl19