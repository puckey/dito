"use strict";

exports.__esModule = true;
exports.CollectionController = void 0;

var _Controller = require("./Controller");

var _errors = require("../errors");

var _utils = require("@ditojs/utils");

class CollectionController extends _Controller.Controller {
  constructor(app, namespace) {
    super(app, namespace);
    this.collection = this.toCoreActions({
      async find(ctx, modify) {
        const result = await this.execute(ctx, (query, trx) => {
          query.find(ctx.query, this.allowParam).modify(getModify(modify, trx));
          return this.isOneToOne ? query.first() : query;
        });
        return result || null;
      },

      async delete(ctx, modify) {
        const count = await this.execute(ctx, (query, trx) => query.ignoreScope().find(ctx.query, this.allowParam).modify(query => this.isOneToOne && query.throwIfNotFound()).modify(getModify(modify, trx)).modify(query => this.unrelate ? query.unrelate() : query.delete()));
        return {
          count
        };
      },

      async insert(ctx, modify) {
        const result = this.relate ? await this.execute(ctx, (query, trx) => query.patchDitoGraphAndFetch(ctx.request.body, {
          relate: true
        }).modify(getModify(modify, trx))) : await this.executeAndFetch('insert', ctx, modify);
        ctx.status = 201;

        if ((0, _utils.isObject)(result)) {
          ctx.set('Location', this.getUrl('collection', result.id));
        }

        return result;
      },

      async update(ctx, modify) {
        return this.executeAndFetch('update', ctx, modify);
      },

      async patch(ctx, modify) {
        return this.executeAndFetch('patch', ctx, modify);
      }

    });
    this.member = this.toCoreActions({
      async find(ctx, modify) {
        return this.execute(ctx, (query, trx) => query.findById(ctx.memberId).find(ctx.query, this.allowParam).throwIfNotFound().modify(getModify(modify, trx)));
      },

      async delete(ctx, modify) {
        const count = await this.execute(ctx, (query, trx) => query.ignoreScope().findById(ctx.memberId).find(ctx.query, this.allowParam).throwIfNotFound().modify(getModify(modify, trx)).modify(query => this.unrelate ? query.unrelate() : query.delete()));
        return {
          count
        };
      },

      async update(ctx, modify) {
        return this.executeAndFetchById('update', ctx, modify);
      },

      async patch(ctx, modify) {
        return this.executeAndFetchById('patch', ctx, modify);
      }

    });
    this.modelClass = null;
    this.isOneToOne = false;
    this.relate = false;
    this.unrelate = false;
  }

  setup(isRoot) {
    super.setup(isRoot, false);
    this.idParam = this.level ? `id${this.level}` : 'id';
    this.graph = !!this.graph;
    this.transacted = !!this.transacted;
    this.scope = this.scope || null;
    this.collection = this.setupActions('collection');
    this.member = this.isOneToOne ? {} : this.setupActions('member');
    this.idValidator = new this.modelClass();
  }

  setupAction(type, actions, name, handler, authorize, verb, path) {
    if (name in actionToVerb) {
      verb = actionToVerb[name];
      path = '';
    }

    return super.setupAction(type, actions, name, handler, authorize, verb, path);
  }

  setupAssets() {
    const {
      modelClass
    } = this;

    if (this.assets === true) {
      this.assets = modelClass.definition.assets || null;
    } else if ((0, _utils.isObject)(this.assets)) {
      this.assets = { ...modelClass.definition.assets,
        ...this.assets
      };
    } else {
      this.assets = null;
    }

    return super.setupAssets();
  }

  getPath(type, path) {
    return type === 'member' ? path ? `:${this.idParam}/${path}` : `:${this.idParam}` : path;
  }

  extendContext(ctx, object) {
    return Object.setPrototypeOf(object, ctx);
  }

  getMemberId(ctx) {
    return this.validateId(ctx.params[this.idParam]);
  }

  getContextWithMemberId(ctx, memberId = this.getMemberId(ctx)) {
    return this.extendContext(ctx, {
      memberId
    });
  }

  getCollectionIds(ctx) {
    const idProperty = this.modelClass.getIdProperty();
    const getId = (0, _utils.isArray)(idProperty) ? model => idProperty.reduce((id, key) => {
      id.push(model[key]);
      return id;
    }, []) : model => model[idProperty];
    return (0, _utils.asArray)(ctx.request.body).map(model => this.validateId(getId(model)));
  }

  getIds(ctx) {
    const {
      type
    } = ctx.action;
    return type === 'member' ? [this.getMemberId(ctx)] : type === 'collection' ? this.getCollectionIds(ctx) : [];
  }

  validateId(id) {
    const reference = this.modelClass.getReference(id);
    this.idValidator.$validate(reference, {
      coerceTypes: true,
      patch: true
    });
    const values = Object.values(reference);
    return values.length > 1 ? values : values[0];
  }

  async getMember(ctx, base = this, {
    query = {},
    modify = null,
    forUpdate = false
  } = {}) {
    return this.member.find.call(this, this.extendContext(ctx, {
      query
    }), (query, trx) => {
      this.setupQuery(query, base);
      query.modify(modify);

      if (forUpdate) {
        if (!trx) {
          throw new _errors.ControllerError(this, 'Using `forUpdate()` without a transaction is invalid');
        }

        query.forUpdate();
      }
    });
  }

  query(trx) {
    return this.setupQuery(this.modelClass.query(trx));
  }

  setupQuery(query, base = this) {
    const {
      scope
    } = base;
    const {
      allowScope,
      allowFilter
    } = this;

    const asAllowArray = value => value === false ? [] : (0, _utils.asArray)(value);

    if (allowScope !== undefined && allowScope !== true) {
      query.allowScope(...asAllowArray(allowScope), ...(0, _utils.asArray)(scope));
    }

    if (allowFilter !== undefined && allowFilter !== true) {
      query.allowFilter(...asAllowArray(allowFilter));
    }

    if (scope) {
      query.withScope(...(0, _utils.asArray)(scope));
    }

    return query;
  }

  async execute() {}

  async executeAndFetch(action, ctx, modify, body = ctx.request.body) {
    const name = `${action}${this.graph ? 'DitoGraph' : ''}AndFetch`;
    return this.execute(ctx, (query, trx) => query[name](body).modify(getModify(modify, trx)));
  }

  async executeAndFetchById(action, ctx, modify, body = ctx.request.body) {
    const name = `${action}${this.graph ? 'DitoGraph' : ''}AndFetchById`;
    return this.execute(ctx, (query, trx) => query[name](ctx.memberId, body).throwIfNotFound().modify(getModify(modify, trx)));
  }

  toCoreActions(actions) {
    for (const action of Object.values(actions)) {
      action.core = true;
    }

    actions.$core = true;
    return actions;
  }

}

exports.CollectionController = CollectionController;

function getModify(modify, trx) {
  return modify ? query => modify(query, trx) : null;
}

const actionToVerb = {
  find: 'get',
  delete: 'delete',
  insert: 'post',
  update: 'put',
  patch: 'patch'
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9Db2xsZWN0aW9uQ29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJDb2xsZWN0aW9uQ29udHJvbGxlciIsIkNvbnRyb2xsZXIiLCJjb25zdHJ1Y3RvciIsImFwcCIsIm5hbWVzcGFjZSIsImNvbGxlY3Rpb24iLCJ0b0NvcmVBY3Rpb25zIiwiZmluZCIsImN0eCIsIm1vZGlmeSIsInJlc3VsdCIsImV4ZWN1dGUiLCJxdWVyeSIsInRyeCIsImFsbG93UGFyYW0iLCJnZXRNb2RpZnkiLCJpc09uZVRvT25lIiwiZmlyc3QiLCJkZWxldGUiLCJjb3VudCIsImlnbm9yZVNjb3BlIiwidGhyb3dJZk5vdEZvdW5kIiwidW5yZWxhdGUiLCJpbnNlcnQiLCJyZWxhdGUiLCJwYXRjaERpdG9HcmFwaEFuZEZldGNoIiwicmVxdWVzdCIsImJvZHkiLCJleGVjdXRlQW5kRmV0Y2giLCJzdGF0dXMiLCJzZXQiLCJnZXRVcmwiLCJpZCIsInVwZGF0ZSIsInBhdGNoIiwibWVtYmVyIiwiZmluZEJ5SWQiLCJtZW1iZXJJZCIsImV4ZWN1dGVBbmRGZXRjaEJ5SWQiLCJtb2RlbENsYXNzIiwic2V0dXAiLCJpc1Jvb3QiLCJpZFBhcmFtIiwibGV2ZWwiLCJncmFwaCIsInRyYW5zYWN0ZWQiLCJzY29wZSIsInNldHVwQWN0aW9ucyIsImlkVmFsaWRhdG9yIiwic2V0dXBBY3Rpb24iLCJ0eXBlIiwiYWN0aW9ucyIsIm5hbWUiLCJoYW5kbGVyIiwiYXV0aG9yaXplIiwidmVyYiIsInBhdGgiLCJhY3Rpb25Ub1ZlcmIiLCJzZXR1cEFzc2V0cyIsImFzc2V0cyIsImRlZmluaXRpb24iLCJnZXRQYXRoIiwiZXh0ZW5kQ29udGV4dCIsIm9iamVjdCIsIk9iamVjdCIsInNldFByb3RvdHlwZU9mIiwiZ2V0TWVtYmVySWQiLCJ2YWxpZGF0ZUlkIiwicGFyYW1zIiwiZ2V0Q29udGV4dFdpdGhNZW1iZXJJZCIsImdldENvbGxlY3Rpb25JZHMiLCJpZFByb3BlcnR5IiwiZ2V0SWRQcm9wZXJ0eSIsImdldElkIiwibW9kZWwiLCJyZWR1Y2UiLCJrZXkiLCJwdXNoIiwibWFwIiwiZ2V0SWRzIiwiYWN0aW9uIiwicmVmZXJlbmNlIiwiZ2V0UmVmZXJlbmNlIiwiJHZhbGlkYXRlIiwiY29lcmNlVHlwZXMiLCJ2YWx1ZXMiLCJsZW5ndGgiLCJnZXRNZW1iZXIiLCJiYXNlIiwiZm9yVXBkYXRlIiwiY2FsbCIsInNldHVwUXVlcnkiLCJDb250cm9sbGVyRXJyb3IiLCJhbGxvd1Njb3BlIiwiYWxsb3dGaWx0ZXIiLCJhc0FsbG93QXJyYXkiLCJ2YWx1ZSIsInVuZGVmaW5lZCIsIndpdGhTY29wZSIsImNvcmUiLCIkY29yZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFHTyxNQUFNQSxvQkFBTixTQUFtQ0Msc0JBQW5DLENBQThDO0FBQ25EQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTUMsU0FBTixFQUFpQjtBQUMxQixVQUFNRCxHQUFOLEVBQVdDLFNBQVg7QUFEMEIsU0FxTTVCQyxVQXJNNEIsR0FxTWYsS0FBS0MsYUFBTCxDQUFtQjtBQUM5QixZQUFNQyxJQUFOLENBQVdDLEdBQVgsRUFBZ0JDLE1BQWhCLEVBQXdCO0FBQ3RCLGNBQU1DLE1BQU0sR0FBRyxNQUFNLEtBQUtDLE9BQUwsQ0FBYUgsR0FBYixFQUFrQixDQUFDSSxLQUFELEVBQVFDLEdBQVIsS0FBZ0I7QUFDckRELFVBQUFBLEtBQUssQ0FBQ0wsSUFBTixDQUFXQyxHQUFHLENBQUNJLEtBQWYsRUFBc0IsS0FBS0UsVUFBM0IsRUFBdUNMLE1BQXZDLENBQThDTSxTQUFTLENBQUNOLE1BQUQsRUFBU0ksR0FBVCxDQUF2RDtBQUNBLGlCQUFPLEtBQUtHLFVBQUwsR0FBa0JKLEtBQUssQ0FBQ0ssS0FBTixFQUFsQixHQUFrQ0wsS0FBekM7QUFDRCxTQUhvQixDQUFyQjtBQU9BLGVBQU9GLE1BQU0sSUFBSSxJQUFqQjtBQUNELE9BVjZCOztBQVk5QixZQUFNUSxNQUFOLENBQWFWLEdBQWIs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MkIsRUFBRyxjQUF2RDtBQUNBLFdBQU8sS0FBS2pDLE9BQUwsQ0FBYUgsR0FBYixFQUFrQixDQUFDSSxLQUFELEVBQVFDLEdBQVIsS0FDdkJELEtBQUssQ0FBQ3dDLElBQUQsQ0FBTCxDQUFZNUMsR0FBRyxDQUFDNkIsUUFBaEIsRUFBMEJWLElBQTFCLEVBQ0dOLGVBREgsR0FFR1osTUFGSCxDQUVVTSxTQUFTLENBQUNOLE1BQUQsRUFBU0ksR0FBVCxDQUZuQixDQURLLENBQVA7QUFLRDs7QUFFRFAsRUFBQUEsYUFBYSxDQUFDNkMsT0FBRCxFQUFVO0FBR3JCLFNBQUssTUFBTTZCLE1BQVgsSUFBcUJoQixNQUFNLENBQUNxQixNQUFQLENBQWNsQyxPQUFkLENBQXJCLEVBQTZDO0FBRzNDNkIsTUFBQUEsTUFBTSxDQUFDbUIsSUFBUCxHQUFjLElBQWQ7QUFDRDs7QUFDRGhELElBQUFBLE9BQU8sQ0FBQ2lELEtBQVIsR0FBZ0IsSUFBaEI7QUFDQSxXQUFPakQsT0FBUDtBQUNEOztBQXBNa0Q7Ozs7QUFxUnJELFNBQVNwQyxTQUFULENBQW1CTixNQUFuQixFQUEyQkksR0FBM0IsRUFBZ0M7QUFDOUIsU0FBT0osTUFBTSxHQUNURyxLQUFLLElBQUlILE1BQU0sQ0FBQ0csS0FBRCxFQUFRQyxHQUFSLENBRE4sR0FFVCxJQUZKO0FBR0Q7O0FBRUQsTUFBTTRDLFlBQVksR0FBRztBQUNuQmxELEVBQUFBLElBQUksRUFBRSxLQURhO0FBRW5CVyxFQUFBQSxNQUFNLEVBQUUsUUFGVztBQUduQkssRUFBQUEsTUFBTSxFQUFFLE1BSFc7QUFJbkJVLEVBQUFBLE1BQU0sRUFBRSxLQUpXO0FBS25CQyxFQUFBQSxLQUFLLEVBQUU7QUFMWSxDQUFyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRyb2xsZXIgfSBmcm9tICcuL0NvbnRyb2xsZXInXG5pbXBvcnQgeyBDb250cm9sbGVyRXJyb3IgfSBmcm9tICdAL2Vycm9ycydcbmltcG9ydCB7IGlzT2JqZWN0LCBpc0FycmF5LCBhc0FycmF5IH0gZnJvbSAnQGRpdG9qcy91dGlscydcblxuLy8gQWJzdHJhY3QgYmFzZSBjbGFzcyBmb3IgTW9kZWxDb250cm9sbGVyIGFuZCBSZWxhdGlvbkNvbnRyb2xsZXJcbmV4cG9ydCBjbGFzcyBDb2xsZWN0aW9uQ29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcihhcHAsIG5hbWVzcGFjZSkge1xuICAgIHN1cGVyKGFwcCwgbmFtZXNwYWNlKVxuICAgIHRoaXMubW9kZWxDbGFzcyA9IG51bGwgLy8gVG8gYmUgZGVmaW5lZCBieSBzdWItY2xhc3Nlc1xuICAgIHRoaXMuaXNPbmVUb09uZSA9IGZhbHNlXG4gICAgdGhpcy5yZWxhdGUgPSBmYWxzZVxuICAgIHRoaXMudW5yZWxhdGUgPSBmYWxzZVxuICB9XG5cbiAgc2V0dXAoaXNSb290KSB7XG4gICAgc3VwZXIuc2V0dXAoaXNSb290LCBmYWxzZSlcbiAgICB0aGlzLmlkUGFyYW0gPSB0aGlzLmxldmVsID8gYGlkJHt0aGlzLmxldmVsfWAgOiAnaWQnXG4gICAgdGhpcy5ncmFwaCA9ICEhdGhpcy5ncmFwaFxuICAgIHRoaXMudHJhbnNhY3RlZCA9ICEhdGhpcy50cmFuc2FjdGVkXG4gICAgdGhpcy5zY29wZSA9IHRoaXMuc2NvcGUgfHwgbnVsbFxuICAgIHRoaXMuY29sbGVjdGlvbiA9IHRoaXMuc2V0dXBBY3Rpb25zKCdjb2xsZWN0aW9uJylcbiAgICB0aGlzLm1lbWJlciA9IHRoaXMuaXNPbmVUb09uZSA/IHt9IDogdGhpcy5zZXR1cEFjdGlvbnMoJ21lbWJlcicpXG4gICAgLy8gQ3JlYXRlIGEgZHVtbXkgbW9kZWwgaW5zdGFuY2UgdG8gdmFsaWRhdGUgdGhlIHJlcXVlc3RlZCBpZCBhZ2FpbnN0LlxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuZXctY2FwXG4gICAgdGhpcy5pZFZhbGlkYXRvciA9IG5ldyB0aGlzLm1vZGVsQ2xhc3MoKVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIHNldHVwQWN0aW9uKHR5cGUsIGFjdGlvbnMsIG5hbWUsIGhhbmRsZXIsIGF1dGhvcml6ZSwgdmVyYiwgcGF0aCkge1xuICAgIC8vIFRoZXNlIGRlZmF1bHQgYWN0aW9ucyBoYXBwZW4gZGlyZWN0bHkgb24gdGhlIGNvbGxlY3Rpb24gLyBtZW1iZXIgcm91dGVcbiAgICAvLyBhbmQgYXJlIGRpc3Rpbmd1aXNoZWQgYnkgdGhlaXIgdmVyYnMsIG5vdCBieSBuZXN0ZWQgcGF0aHMuXG4gICAgaWYgKG5hbWUgaW4gYWN0aW9uVG9WZXJiKSB7XG4gICAgICB2ZXJiID0gYWN0aW9uVG9WZXJiW25hbWVdXG4gICAgICBwYXRoID0gJydcbiAgICB9XG4gICAgcmV0dXJuIHN1cGVyLnNldHVwQWN0aW9uKFxuICAgICAgdHlwZSwgYWN0aW9ucywgbmFtZSwgaGFuZGxlciwgYXV0aG9yaXplLCB2ZXJiLCBwYXRoXG4gICAgKVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIHNldHVwQXNzZXRzKCkge1xuICAgIGNvbnN0IHsgbW9kZWxDbGFzcyB9ID0gdGhpc1xuICAgIGlmICh0aGlzLmFzc2V0cyA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5hc3NldHMgPSBtb2RlbENsYXNzLmRlZmluaXRpb24uYXNzZXRzIHx8IG51bGxcbiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuYXNzZXRzKSkge1xuICAgICAgLy8gTWVyZ2UgaW4gdGhlIGFzc2V0cyBkZWZpbml0aW9uIGZyb20gdGhlIG1vZGVsIGludG8gdGhlIGFzc2V0cyBjb25maWcuXG4gICAgICAvLyBUaGF0IHdheSwgd2UgY2FuIHN0aWxsIHVzZSBgYWxsb3dgIGFuZCBgYXV0aG9yaXplYCB0byBjb250cm9sbCB0aGVcbiAgICAgIC8vIHVwbG9hZCBhY2Nlc3MsIHdoaWxlIGtlZXBpbmcgdGhlIGFzc2V0cyBkZWZpbml0aW9ucyBpbiBvbmUgY2VudHJhbFxuICAgICAgLy8gbG9jYXRpb24gb24gdGhlIG1vZGVsLlxuICAgICAgdGhpcy5hc3NldHMgPSB7XG4gICAgICAgIC4uLm1vZGVsQ2xhc3MuZGVmaW5pdGlvbi5hc3NldHMsXG4gICAgICAgIC4uLnRoaXMuYXNzZXRzXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXNzZXRzID0gbnVsbFxuICAgIH1cbiAgICAvLyBOb3cgY2FsbCBgc3VwZXIuc2V0dXBBc3NldHMoKWAgd2hpY2ggcGVyZm9ybXMgdGhlIHVzdWFsIGluaGVyaXRhbmNlIC9cbiAgICAvLyBhbGxvdyAvIGF1dGhvcml6ZSB0cmlja3M6XG4gICAgcmV0dXJuIHN1cGVyLnNldHVwQXNzZXRzKClcbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBnZXRQYXRoKHR5cGUsIHBhdGgpIHtcbiAgICByZXR1cm4gdHlwZSA9PT0gJ21lbWJlcidcbiAgICAgID8gcGF0aCA/IGA6JHt0aGlzLmlkUGFyYW19LyR7cGF0aH1gIDogYDoke3RoaXMuaWRQYXJhbX1gXG4gICAgICA6IHBhdGhcbiAgfVxuXG4gIGV4dGVuZENvbnRleHQoY3R4LCBvYmplY3QpIHtcbiAgICAvLyBDcmVhdGUgYSBjb3B5IG9mIGBjdHhgIHRoYXQgaW5oZXJpdHMgZnJvbSB0aGUgcmVhbCBvbmUsIGJ1dCBvdmVycmlkZXNcbiAgICAvLyBzb21lIHByb3BlcnRpZXMgd2l0aCB0aGUgb25lcyBmcm9tIHRoZSBwYXNzZWQgYG9iamVjdGAuXG4gICAgcmV0dXJuIE9iamVjdC5zZXRQcm90b3R5cGVPZihvYmplY3QsIGN0eClcbiAgfVxuXG4gIGdldE1lbWJlcklkKGN0eCkge1xuICAgIHJldHVybiB0aGlzLnZhbGlkYXRlSWQoY3R4LnBhcmFtc1t0aGlzLmlkUGFyYW1dKVxuICB9XG5cbiAgZ2V0Q29udGV4dFdpdGhNZW1iZXJJZChjdHgsIG1lbWJlcklkID0gdGhpcy5nZXRNZW1iZXJJZChjdHgpKSB7XG4gICAgcmV0dXJuIHRoaXMuZXh0ZW5kQ29udGV4dChjdHgsIHsgbWVtYmVySWQgfSlcbiAgfVxuXG4gIGdldENvbGxlY3Rpb25JZHMoY3R4KSB7XG4gICAgY29uc3QgaWRQcm9wZXJ0eSA9IHRoaXMubW9kZWxDbGFzcy5nZXRJZFByb3BlcnR5KClcbiAgICAvLyBIYW5kbGUgYm90aCBjb21wb3NpdGUga2V5cyBhbmQgbm9ybWFsIG9uZXMuXG4gICAgY29uc3QgZ2V0SWQgPSBpc0FycmF5KGlkUHJvcGVydHkpXG4gICAgICA/IG1vZGVsID0+IGlkUHJvcGVydHkucmVkdWNlKFxuICAgICAgICAoaWQsIGtleSkgPT4ge1xuICAgICAgICAgIGlkLnB1c2gobW9kZWxba2V5XSlcbiAgICAgICAgICByZXR1cm4gaWRcbiAgICAgICAgfSwgW10pXG4gICAgICA6IG1vZGVsID0+IG1vZGVsW2lkUHJvcGVydHldXG4gICAgcmV0dXJuIGFzQXJyYXkoY3R4LnJlcXVlc3QuYm9keSkubWFwKG1vZGVsID0+IHRoaXMudmFsaWRhdGVJZChnZXRJZChtb2RlbCkpKVxuICB9XG5cbiAgZ2V0SWRzKGN0eCkge1xuICAgIC8vIFJldHVybnMgdGhlIG1vZGVsIGlkcyB0aGF0IHRoaXMgcmVxdWVzdCBjb25jZXJucywgcmVhZCBmcm9tIHRoZSBwYXJhbVxuICAgIC8vIGZvciBtZW1iZXIgaWRzLCBhbmQgZnJvbSB0aGUgcGF5bG9hZCBmb3IgY29sbGVjdGlvbiBpZHM6XG4gICAgY29uc3QgeyB0eXBlIH0gPSBjdHguYWN0aW9uXG4gICAgcmV0dXJuIHR5cGUgPT09ICdtZW1iZXInID8gW3RoaXMuZ2V0TWVtYmVySWQoY3R4KV1cbiAgICAgIDogdHlwZSA9PT0gJ2NvbGxlY3Rpb24nID8gdGhpcy5nZXRDb2xsZWN0aW9uSWRzKGN0eClcbiAgICAgIDogW11cbiAgfVxuXG4gIHZhbGlkYXRlSWQoaWQpIHtcbiAgICBjb25zdCByZWZlcmVuY2UgPSB0aGlzLm1vZGVsQ2xhc3MuZ2V0UmVmZXJlbmNlKGlkKVxuICAgIC8vIFRoaXMgdmFsaWRhdGVzIGFuZCBjb2VyY2VzIGF0IHRoZSBzYW1lIHRpbWUsIHNvIGV4dHJhY3QgdGhlIGNvZXJjZWQgaWRcbiAgICAvLyBmcm9tIGByZWZlcmVuY2VgIGFnYWluIGFmdGVyd2FyZHMuXG4gICAgdGhpcy5pZFZhbGlkYXRvci4kdmFsaWRhdGUocmVmZXJlbmNlLCB7XG4gICAgICBjb2VyY2VUeXBlczogdHJ1ZSxcbiAgICAgIHBhdGNoOiB0cnVlXG4gICAgfSlcbiAgICBjb25zdCB2YWx1ZXMgPSBPYmplY3QudmFsdWVzKHJlZmVyZW5jZSlcbiAgICByZXR1cm4gdmFsdWVzLmxlbmd0aCA+IDEgPyB2YWx1ZXMgOiB2YWx1ZXNbMF1cbiAgfVxuXG4gIGFzeW5jIGdldE1lbWJlcihcbiAgICBjdHgsXG4gICAgYmFzZSA9IHRoaXMsXG4gICAgeyBxdWVyeSA9IHt9LCBtb2RpZnkgPSBudWxsLCBmb3JVcGRhdGUgPSBmYWxzZSB9ID0ge31cbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMubWVtYmVyLmZpbmQuY2FsbChcbiAgICAgIHRoaXMsXG4gICAgICAvLyBFeHRlbmQgYGN0eGAgd2l0aCBhIG5ldyBgcXVlcnlgIG9iamVjdCwgd2hpbGUgaW5oZXJpdGluZyB0aGUgcm91dGVcbiAgICAgIC8vIHBhcmFtcyBpbiBgY3R4LnBhcmFtc2AsIHNvIGZpbmluZyB0aGUgbWVtYmVyIGJ5IGlkIHN0aWxsIHdvcmtzLlxuICAgICAgdGhpcy5leHRlbmRDb250ZXh0KGN0eCwgeyBxdWVyeSB9KSxcbiAgICAgIChxdWVyeSwgdHJ4KSA9PiB7XG4gICAgICAgIHRoaXMuc2V0dXBRdWVyeShxdWVyeSwgYmFzZSlcbiAgICAgICAgcXVlcnkubW9kaWZ5KG1vZGlmeSlcbiAgICAgICAgaWYgKGZvclVwZGF0ZSkge1xuICAgICAgICAgIGlmICghdHJ4KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQ29udHJvbGxlckVycm9yKFxuICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICAnVXNpbmcgYGZvclVwZGF0ZSgpYCB3aXRob3V0IGEgdHJhbnNhY3Rpb24gaXMgaW52YWxpZCdcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgICAgcXVlcnkuZm9yVXBkYXRlKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHF1ZXJ5KHRyeCkge1xuICAgIHJldHVybiB0aGlzLnNldHVwUXVlcnkodGhpcy5tb2RlbENsYXNzLnF1ZXJ5KHRyeCkpXG4gIH1cblxuICBzZXR1cFF1ZXJ5KHF1ZXJ5LCBiYXNlID0gdGhpcykge1xuICAgIGNvbnN0IHsgc2NvcGUgfSA9IGJhc2VcbiAgICBjb25zdCB7IGFsbG93U2NvcGUsIGFsbG93RmlsdGVyIH0gPSB0aGlzXG5cbiAgICBjb25zdCBhc0FsbG93QXJyYXkgPSB2YWx1ZSA9PiB2YWx1ZSA9PT0gZmFsc2UgPyBbXSA6IGFzQXJyYXkodmFsdWUpXG5cbiAgICBpZiAoYWxsb3dTY29wZSAhPT0gdW5kZWZpbmVkICYmIGFsbG93U2NvcGUgIT09IHRydWUpIHtcbiAgICAgIHF1ZXJ5LmFsbG93U2NvcGUoXG4gICAgICAgIC4uLmFzQWxsb3dBcnJheShhbGxvd1Njb3BlKSxcbiAgICAgICAgLy8gQWxzbyBpbmNsdWRlIHRoZSBzY29wZXMgZGVmaW5lZCBieSBzY29wZSBzbyB0aGVzZSBjYW4gcGFzcyB0aHJvdWdoLlxuICAgICAgICAuLi5hc0FycmF5KHNjb3BlKVxuICAgICAgKVxuICAgIH1cbiAgICBpZiAoYWxsb3dGaWx0ZXIgIT09IHVuZGVmaW5lZCAmJiBhbGxvd0ZpbHRlciAhPT0gdHJ1ZSkge1xuICAgICAgcXVlcnkuYWxsb3dGaWx0ZXIoLi4uYXNBbGxvd0FycmF5KGFsbG93RmlsdGVyKSlcbiAgICB9XG4gICAgaWYgKHNjb3BlKSB7XG4gICAgICBxdWVyeS53aXRoU2NvcGUoLi4uYXNBcnJheShzY29wZSkpXG4gICAgfVxuICAgIHJldHVybiBxdWVyeVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZSgvKiBjdHgsIGV4ZWN1dGUocXVlcnksIHRyeCkge30gKi8pIHtcbiAgICAvLyBEb2VzIG5vdGhpbmcgaW4gYmFzZSBjbGFzcy5cbiAgICAvLyBPdmVycmlkZXMgYXJlIGluIE1vZGVsQ29udHJvbGxlciBhbmQgUmVsYXRpb25Db250cm9sbGVyLlxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUFuZEZldGNoKGFjdGlvbiwgY3R4LCBtb2RpZnksIGJvZHkgPSBjdHgucmVxdWVzdC5ib2R5KSB7XG4gICAgY29uc3QgbmFtZSA9IGAke2FjdGlvbn0ke3RoaXMuZ3JhcGggPyAnRGl0b0dyYXBoJyA6ICcnfUFuZEZldGNoYFxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGUoY3R4LCAocXVlcnksIHRyeCkgPT5cbiAgICAgIHF1ZXJ5W25hbWVdKGJvZHkpXG4gICAgICAgIC5tb2RpZnkoZ2V0TW9kaWZ5KG1vZGlmeSwgdHJ4KSlcbiAgICApXG4gIH1cblxuICBhc3luYyBleGVjdXRlQW5kRmV0Y2hCeUlkKGFjdGlvbiwgY3R4LCBtb2RpZnksIGJvZHkgPSBjdHgucmVxdWVzdC5ib2R5KSB7XG4gICAgY29uc3QgbmFtZSA9IGAke2FjdGlvbn0ke3RoaXMuZ3JhcGggPyAnRGl0b0dyYXBoJyA6ICcnfUFuZEZldGNoQnlJZGBcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlKGN0eCwgKHF1ZXJ5LCB0cngpID0+XG4gICAgICBxdWVyeVtuYW1lXShjdHgubWVtYmVySWQsIGJvZHkpXG4gICAgICAgIC50aHJvd0lmTm90Rm91bmQoKVxuICAgICAgICAubW9kaWZ5KGdldE1vZGlmeShtb2RpZnksIHRyeCkpXG4gICAgKVxuICB9XG5cbiAgdG9Db3JlQWN0aW9ucyhhY3Rpb25zKSB7XG4gICAgLy8gTWFyayBhY3Rpb24gb2JqZWN0IGFuZCBtZXRob2RzIGFzIGNvcmUsIHNvIGBDb250cm9sbGVyLnByb2Nlc3NWYWx1ZXMoKWBcbiAgICAvLyBjYW4gZmlsdGVyIGNvcnJlY3RseS5cbiAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBPYmplY3QudmFsdWVzKGFjdGlvbnMpKSB7XG4gICAgICAvLyBNYXJrIGFjdGlvbiBmdW5jdGlvbnMgYWxzbywgc28gQ29udHJvbGxlckFjdGlvbiBjYW4gdXNlIGl0IHRvIGRldGVybWluZVxuICAgICAgLy8gdmFsdWUgZm9yIGB0cmFuc2FjdGVkYC5cbiAgICAgIGFjdGlvbi5jb3JlID0gdHJ1ZVxuICAgIH1cbiAgICBhY3Rpb25zLiRjb3JlID0gdHJ1ZVxuICAgIHJldHVybiBhY3Rpb25zXG4gIH1cblxuICBjb2xsZWN0aW9uID0gdGhpcy50b0NvcmVBY3Rpb25zKHtcbiAgICBhc3luYyBmaW5kKGN0eCwgbW9kaWZ5KSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmV4ZWN1dGUoY3R4LCAocXVlcnksIHRyeCkgPT4ge1xuICAgICAgICBxdWVyeS5maW5kKGN0eC5xdWVyeSwgdGhpcy5hbGxvd1BhcmFtKS5tb2RpZnkoZ2V0TW9kaWZ5KG1vZGlmeSwgdHJ4KSlcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNPbmVUb09uZSA/IHF1ZXJ5LmZpcnN0KCkgOiBxdWVyeVxuICAgICAgfSlcbiAgICAgIC8vIFRoaXMgbWV0aG9kIGRvZXNuJ3QgYWx3YXlzIHJldHVybiBhbiBhcnJheTpcbiAgICAgIC8vIEZvciBSZWxhdGlvbkNvbnRyb2xsZXJzIHdoZXJlIGBpc09uZVRvT25lYCBpcyB0cnVlLCBpdCBjYW4gcmV0dXJuXG4gICAgICAvLyBgdW5kZWZpbmVkYC4gQ2FzdCB0byBgbnVsbGAgZm9yIHN1Y2ggY2FzZXM6XG4gICAgICByZXR1cm4gcmVzdWx0IHx8IG51bGxcbiAgICB9LFxuXG4gICAgYXN5bmMgZGVsZXRlKGN0eCwgbW9kaWZ5KSB7XG4gICAgICBjb25zdCBjb3VudCA9IGF3YWl0IHRoaXMuZXhlY3V0ZShjdHgsIChxdWVyeSwgdHJ4KSA9PiBxdWVyeVxuICAgICAgICAuaWdub3JlU2NvcGUoKVxuICAgICAgICAuZmluZChjdHgucXVlcnksIHRoaXMuYWxsb3dQYXJhbSlcbiAgICAgICAgLm1vZGlmeShxdWVyeSA9PiB0aGlzLmlzT25lVG9PbmUgJiYgcXVlcnkudGhyb3dJZk5vdEZvdW5kKCkpXG4gICAgICAgIC5tb2RpZnkoZ2V0TW9kaWZ5KG1vZGlmeSwgdHJ4KSlcbiAgICAgICAgLm1vZGlmeShxdWVyeSA9PiB0aGlzLnVucmVsYXRlID8gcXVlcnkudW5yZWxhdGUoKSA6IHF1ZXJ5LmRlbGV0ZSgpKVxuICAgICAgKVxuICAgICAgcmV0dXJuIHsgY291bnQgfVxuICAgIH0sXG5cbiAgICBhc3luYyBpbnNlcnQoY3R4LCBtb2RpZnkpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucmVsYXRlXG4gICAgICAgIC8vIFVzZSBwYXRjaERpdG9HcmFwaEFuZEZldGNoKCkgdG8gaGFuZGxlIHJlbGF0ZXMgZm9yIHVzLlxuICAgICAgICA/IGF3YWl0IHRoaXMuZXhlY3V0ZShjdHgsIChxdWVyeSwgdHJ4KSA9PiBxdWVyeVxuICAgICAgICAgIC5wYXRjaERpdG9HcmFwaEFuZEZldGNoKGN0eC5yZXF1ZXN0LmJvZHksIHsgcmVsYXRlOiB0cnVlIH0pXG4gICAgICAgICAgLm1vZGlmeShnZXRNb2RpZnkobW9kaWZ5LCB0cngpKVxuICAgICAgICApXG4gICAgICAgIDogYXdhaXQgdGhpcy5leGVjdXRlQW5kRmV0Y2goJ2luc2VydCcsIGN0eCwgbW9kaWZ5KVxuICAgICAgY3R4LnN0YXR1cyA9IDIwMVxuICAgICAgaWYgKGlzT2JqZWN0KHJlc3VsdCkpIHtcbiAgICAgICAgY3R4LnNldCgnTG9jYXRpb24nLCB0aGlzLmdldFVybCgnY29sbGVjdGlvbicsIHJlc3VsdC5pZCkpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSxcblxuICAgIGFzeW5jIHVwZGF0ZShjdHgsIG1vZGlmeSkge1xuICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZUFuZEZldGNoKCd1cGRhdGUnLCBjdHgsIG1vZGlmeSlcbiAgICB9LFxuXG4gICAgYXN5bmMgcGF0Y2goY3R4LCBtb2RpZnkpIHtcbiAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVBbmRGZXRjaCgncGF0Y2gnLCBjdHgsIG1vZGlmeSlcbiAgICB9XG4gIH0pXG5cbiAgbWVtYmVyID0gdGhpcy50b0NvcmVBY3Rpb25zKHtcbiAgICBhc3luYyBmaW5kKGN0eCwgbW9kaWZ5KSB7XG4gICAgICByZXR1cm4gdGhpcy5leGVjdXRlKGN0eCwgKHF1ZXJ5LCB0cngpID0+IHF1ZXJ5XG4gICAgICAgIC5maW5kQnlJZChjdHgubWVtYmVySWQpXG4gICAgICAgIC5maW5kKGN0eC5xdWVyeSwgdGhpcy5hbGxvd1BhcmFtKVxuICAgICAgICAudGhyb3dJZk5vdEZvdW5kKClcbiAgICAgICAgLm1vZGlmeShnZXRNb2RpZnkobW9kaWZ5LCB0cngpKVxuICAgICAgKVxuICAgIH0sXG5cbiAgICBhc3luYyBkZWxldGUoY3R4LCBtb2RpZnkpIHtcbiAgICAgIGNvbnN0IGNvdW50ID0gYXdhaXQgdGhpcy5leGVjdXRlKGN0eCwgKHF1ZXJ5LCB0cngpID0+IHF1ZXJ5XG4gICAgICAgIC5pZ25vcmVTY29wZSgpXG4gICAgICAgIC5maW5kQnlJZChjdHgubWVtYmVySWQpXG4gICAgICAgIC5maW5kKGN0eC5xdWVyeSwgdGhpcy5hbGxvd1BhcmFtKVxuICAgICAgICAudGhyb3dJZk5vdEZvdW5kKClcbiAgICAgICAgLm1vZGlmeShnZXRNb2RpZnkobW9kaWZ5LCB0cngpKVxuICAgICAgICAubW9kaWZ5KHF1ZXJ5ID0+IHRoaXMudW5yZWxhdGUgPyBxdWVyeS51bnJlbGF0ZSgpIDogcXVlcnkuZGVsZXRlKCkpXG4gICAgICApXG4gICAgICByZXR1cm4geyBjb3VudCB9XG4gICAgfSxcblxuICAgIGFzeW5jIHVwZGF0ZShjdHgsIG1vZGlmeSkge1xuICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZUFuZEZldGNoQnlJZCgndXBkYXRlJywgY3R4LCBtb2RpZnkpXG4gICAgfSxcblxuICAgIGFzeW5jIHBhdGNoKGN0eCwgbW9kaWZ5KSB7XG4gICAgICByZXR1cm4gdGhpcy5leGVjdXRlQW5kRmV0Y2hCeUlkKCdwYXRjaCcsIGN0eCwgbW9kaWZ5KVxuICAgIH1cbiAgfSlcbn1cblxuZnVuY3Rpb24gZ2V0TW9kaWZ5KG1vZGlmeSwgdHJ4KSB7XG4gIHJldHVybiBtb2RpZnlcbiAgICA/IHF1ZXJ5ID0+IG1vZGlmeShxdWVyeSwgdHJ4KVxuICAgIDogbnVsbFxufVxuXG5jb25zdCBhY3Rpb25Ub1ZlcmIgPSB7XG4gIGZpbmQ6ICdnZXQnLFxuICBkZWxldGU6ICdkZWxldGUnLFxuICBpbnNlcnQ6ICdwb3N0JyxcbiAgdXBkYXRlOiAncHV0JyxcbiAgcGF0Y2g6ICdwYXRjaCdcbn1cbiJdfQ==