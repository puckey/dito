"use strict";

exports.__esModule = true;
exports.Controller = void 0;

require("core-js/modules/esnext.weak-map.delete-all.js");

var _chalk = _interopRequireDefault(require("chalk"));

var _utils = require("../utils");

var _lib = require("../lib");

var _ControllerAction = _interopRequireDefault(require("./ControllerAction"));

var _MemberAction = _interopRequireDefault(require("./MemberAction"));

var _errors = require("../errors");

var _utils2 = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Controller {
  constructor(app, namespace) {
    this.app = app;
    this.namespace = this.namespace || namespace;
    this.logging = this.app.config.log.routes;
    this.level = 0;
  }

  initialize() {}

  setup(isRoot = true, setupActionsObject = true) {
    this._setupEmitter(this.hooks, {
      wildcard: true
    });

    this.name = this.name || this.constructor.name.match(/^(.*?)(?:Controller|)$/)[1];

    if (this.path === undefined) {
      this.path = this.app.normalizePath(this.name);
    }

    this.transacted = !!this.transacted;

    if (isRoot) {
      const {
        path,
        namespace
      } = this;
      const url = path ? `/${path}` : '';
      this.url = namespace ? `/${namespace}${url}` : url;
      this.log(`${namespace ? _chalk.default.green(`/${namespace}/`) : ''}${_chalk.default.cyan(path)}${_chalk.default.white(':')}`, this.level);

      if (setupActionsObject) {
        this.actions = this.actions || this.reflectActionsObject();
        this.actions = this.setupActions('actions');
      }

      this.assets = this.setupAssets();
    }
  }

  reflectActionsObject() {
    const {
      allow
    } = this;
    const controller = allow ? {
      allow
    } : {};

    const addAction = key => {
      const value = this[key];

      if (value != null && value.verb || value != null && value.handler) {
        controller[key] = value;
      }
    };

    const proto = Object.getPrototypeOf(this);
    Object.getOwnPropertyNames(proto).forEach(addAction);
    Object.getOwnPropertyNames(this).forEach(addAction);
    return controller;
  }

  setupRoute(verb, url, transacted, authorize, action, handlers) {
    this.log(`${_chalk.default.magenta(verb.toUpperCase())} ${_chalk.default.green(this.url)}${_chalk.default.cyan(url.slice(this.url.length))} ${_chalk.default.white(this.describeAuthorize(authorize))}`, this.level + 1);
    this.app.addRoute(verb, url, transacted, handlers, this, action);
  }

  setupActions(type) {
    const {
      values: actions,
      authorize
    } = this.processValues(this.inheritValues(type));

    for (const [name, handler] of Object.entries(actions)) {
      this.setupAction(type, actions, name, handler, authorize[name]);
    }

    return actions;
  }

  setupAction(type, actions, name, handler, authorize, verb = 'get', path = this.app.normalizePath(name)) {
    if (!(0, _utils2.isFunction)(handler)) {
      handler = setupHandlerFromObject(handler, actions);
    }

    const actionClass = type === 'member' ? _MemberAction.default : _ControllerAction.default;
    this.setupActionRoute(type, new actionClass(this, handler, type, name, verb, path, authorize));
  }

  setupActionRoute(type, action) {
    const url = this.getUrl(type, action.path);
    const {
      verb,
      transacted,
      authorize
    } = action;
    this.setupRoute(verb, url, transacted, authorize, action, [async ctx => {
      try {
        const res = await action.callAction(ctx);

        if (res !== undefined) {
          ctx.body = res;
        }
      } catch (err) {
        throw err instanceof _errors.ResponseError ? err : new _errors.WrappedError(err);
      }
    }]);
  }

  setupAssets() {
    const {
      values: assets,
      authorize
    } = this.processValues(this.inheritValues('assets'));

    for (const [dataPath, config] of Object.entries(assets || {})) {
      this.setupAssetRoute(dataPath, config, authorize[dataPath]);
    }

    return assets;
  }

  setupAssetRoute(dataPath, config, authorize) {
    const {
      storage: storageName,
      transacted,
      ...settings
    } = config;
    const storage = this.app.getStorage(storageName);

    if (!storage) {
      throw new _errors.ControllerError(this, `Unknown storage configuration: '${storageName}'`);
    }

    const tokens = (0, _utils2.parseDataPath)(dataPath);

    const getDataPath = callback => (0, _utils2.normalizeDataPath)(tokens.map(callback));

    let index = 0;
    const multipleWildcards = tokens.filter(token => token === '*').length > 1;
    const normalizedPath = getDataPath(token => token === '*' ? multipleWildcards ? `:index${++index}` : ':index' : this.app.normalizePath(token));
    const matchDataPath = new RegExp(`^${getDataPath(token => token === '*' ? '\\w+' : token)}$`);
    const url = this.getUrl('controller', `upload/${normalizedPath}`);
    const upload = storage.getUploadHandler({ ...settings,
      fileFilter: (req, file, cb) => {
        cb(null, matchDataPath.test(file.fieldname));
      }
    });
    const authorization = this.processAuthorize(authorize);
    this.setupRoute('post', url, transacted, authorize, null, [async (ctx, next) => {
      await this.handleAuthorization(authorization, ctx);
      return next();
    }, upload, async (ctx, next) => {
      const files = storage.convertStorageFiles(ctx.request.files);
      await this.app.createAssets(storage, files, 0, ctx.transaction);
      ctx.body = files;
      return next();
    }]);
  }

  compose() {}

  getPath(type, path) {
    return path;
  }

  getUrl(type, path) {
    path = this.getPath(type, path);
    return path && path !== '.' ? `${this.url}/${path}` : this.url;
  }

  inheritValues(type) {
    const parentClass = Object.getPrototypeOf(this.constructor);

    if (!inheritanceMap.has(parentClass)) {
      inheritanceMap.set(parentClass, {
        instance: new parentClass(this.app, this.namespace)
      });
    }

    const entry = inheritanceMap.get(parentClass);

    if (!entry[type]) {
      const parent = entry.instance;
      let values = parent[type];

      if (parentClass !== Controller) {
        values = parent.inheritValues(type);
      }

      entry[type] = values;
    }

    const parentValues = entry[type];
    let currentValues = this[type];

    if (currentValues && currentValues === parentValues) {
      currentValues = this[type] = {};
    }

    return (0, _utils2.isObject)(parentValues) && (0, _utils2.isObject)(currentValues) ? Object.setPrototypeOf(currentValues, parentValues) : currentValues;
  }

  processValues(values) {
    if (!values) return {};
    const mergedAllow = {};
    const mergedAuthorize = {};
    let hasOwnAllow = false;

    const excludeKey = key => ['allow', 'authorize'].includes(key);

    const handleAllow = (allow, current) => {
      if (allow) {
        allow = (0, _utils2.asArray)(allow);
        hasOwnAllow = true;
      } else if (!hasOwnAllow) {
        allow = Object.keys(current);
      }

      if (allow) {
        if (allow.includes('*')) {
          allow = (0, _utils.getAllKeys)(current);
        }

        for (const key of allow) {
          if (!excludeKey(key)) {
            mergedAllow[key] = true;
          }
        }
      }
    };

    const handleAuthorize = authorize => {
      const add = (key, value) => {
        if (key in values && !(key in mergedAuthorize) && !excludeKey(key)) {
          mergedAuthorize[key] = value;
        }
      };

      if ((0, _utils2.isObject)(authorize)) {
        for (const key in authorize) {
          add(key, authorize[key]);
        }
      } else if (authorize != null) {
        for (const key in values) {
          add(key, authorize);
        }
      }
    };

    let current = values;

    while (current !== Object.prototype && !current.hasOwnProperty('$core')) {
      handleAllow((0, _utils.getOwnProperty)(current, 'allow'), current);
      handleAuthorize((0, _utils.getOwnProperty)(current, 'authorize'));
      current = Object.getPrototypeOf(current);
    }

    if (this.allow) {
      handleAllow(this.allow, values);
    }

    if (this.authorize) {
      handleAuthorize(this.authorize);
    }

    return {
      values: (0, _utils.getAllKeys)(values).reduce((result, key) => {
        if (mergedAllow[key]) {
          result[key] = values[key];
        }

        return result;
      }, Object.create(Object.getPrototypeOf(values))),
      allow: Object.keys(mergedAllow),
      authorize: mergedAuthorize
    };
  }

  async emitHook(type, handleResult, ctx, ...args) {
    let result = handleResult ? args.shift() : undefined;

    for (const handler of this.listeners(type)) {
      if (handleResult) {
        const res = await handler.call(this, ctx, result, ...args);

        if (res !== undefined) {
          result = res;
        }
      } else {
        await handler.call(this, ctx, ...args);
      }
    }

    return result;
  }

  async getMember() {
    return null;
  }

  processAuthorize(authorize) {
    if (authorize == null) {
      return () => true;
    } else if ((0, _utils2.isBoolean)(authorize)) {
      return () => authorize;
    } else if ((0, _utils2.isFunction)(authorize)) {
      return async (ctx, member) => {
        const res = await authorize(ctx, member);
        return this.processAuthorize(res)(ctx, member);
      };
    } else if ((0, _utils2.isString)(authorize) || (0, _utils2.isArray)(authorize)) {
      return async (ctx, member) => {
        const {
          user
        } = ctx.state;

        if (!user) {
          return false;
        }

        const values = (0, _utils2.asArray)(authorize);

        if (!member && values.includes('$owner')) {
          member = await this.getMember(ctx);
        }

        return !!values.find(value => {
          var _member;

          return value === '$self' ? user.constructor === this.modelClass && (0, _utils2.equals)(user.$id(), ctx.memberId) : value === '$owner' ? (_member = member) == null ? void 0 : _member.$hasOwner == null ? void 0 : _member.$hasOwner(user) : user.$hasRole(value);
        });
      };
    } else {
      throw new _errors.ControllerError(this, `Unsupported authorize setting: '${authorize}'`);
    }
  }

  describeAuthorize(authorize) {
    return (0, _utils2.isFunction)(authorize) ? (0, _utils.describeFunction)(authorize) : (0, _utils2.isString)(authorize) ? `'${authorize}'` : (0, _utils2.isArray)(authorize) ? `[${authorize.map(value => `'${value}'`).join(', ')}]` : '';
  }

  async handleAuthorization(authorization, ctx, member) {
    const ok = await authorization(ctx, member);

    if (ok !== true) {
      throw new _errors.AuthorizationError();
    }
  }

  log(str, indent = 0) {
    if (this.logging) {
      console.info(`${'  '.repeat(indent)}${str}`);
    }
  }

}

exports.Controller = Controller;

_lib.EventEmitter.mixin(Controller.prototype);

const inheritanceMap = new WeakMap();

function setupHandlerFromObject(object, actions) {
  const {
    handler,
    action,
    authorize,
    parameters,
    returns,
    scope,
    transacted
  } = object;
  Object.setPrototypeOf(object, Object.getPrototypeOf(actions));
  handler.authorize = authorize;
  handler.transacted = transacted;

  if (action) {
    const [verb, path] = (0, _utils2.asArray)(action);
    handler.verb = verb;
    handler.path = path;
  }

  if (parameters) {
    const [_parameters, options] = parameters;
    const hasOptions = (0, _utils2.isArray)(_parameters);
    handler.parameters = hasOptions ? _parameters : parameters;

    if (hasOptions) {
      handler.options = { ...handler.options,
        parameters: options
      };
    }
  }

  if (returns) {
    const [_returns, options] = (0, _utils2.asArray)(returns);
    handler.returns = _returns;

    if (options) {
      handler.options = { ...handler.options,
        parameters: options
      };
    }
  }

  if (scope) {
    handler.scope = (0, _utils2.asArray)(scope);
  }

  return handler;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9Db250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRyb2xsZXIiLCJjb25zdHJ1Y3RvciIsImFwcCIsIm5hbWVzcGFjZSIsImxvZ2dpbmciLCJjb25maWciLCJsb2ciLCJyb3V0ZXMiLCJsZXZlbCIsImluaXRpYWxpemUiLCJzZXR1cCIsImlzUm9vdCIsInNldHVwQWN0aW9uc09iamVjdCIsIl9zZXR1cEVtaXR0ZXIiLCJob29rcyIsIndpbGRjYXJkIiwibmFtZSIsIm1hdGNoIiwicGF0aCIsInVuZGVmaW5lZCIsIm5vcm1hbGl6ZVBhdGgiLCJ0cmFuc2FjdGVkIiwidXJsIiwiY2hhbGsiLCJncmVlbiIsImN5YW4iLCJ3aGl0ZSIsImFjdGlvbnMiLCJyZWZsZWN0QWN0aW9uc09iamVjdCIsInNldHVwQWN0aW9ucyIsImFzc2V0cyIsInNldHVwQXNzZXRzIiwiYWxsb3ciLCJjb250cm9sbGVyIiwiYWRkQWN0aW9uIiwia2V5IiwidmFsdWUiLCJ2ZXJiIiwiaGFuZGxlciIsInByb3RvIiwiT2JqZWN0IiwiZ2V0UHJvdG90eXBlT2YiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZm9yRWFjaCIsInNldHVwUm91dGUiLCJhdXRob3JpemUiLCJhY3Rpb24iLCJoYW5kbGVycyIsIm1hZ2VudGEiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwibGVuZ3RoIiwiZGVzY3JpYmVBdXRob3JpemUiLCJhZGRSb3V0ZSIsInR5cGUiLCJ2YWx1ZXMiLCJwcm9jZXNzVmFsdWVzIiwiaW5oZXJpdFZhbHVlcyIsImVudHJpZXMiLCJzZXR1cEFjdGlvbiIsInNldHVwSGFuZGxlckZyb21PYmplY3QiLCJhY3Rpb25DbGFzcyIsIk1lbWJlckFjdGlvbiIsIkNvbnRyb2xsZXJBY3Rpb24iLCJzZXR1cEFjdGlvblJvdXRlIiwiZ2V0VXJsIiwiY3R4IiwicmVzIiwiY2FsbEFjdGlvbiIsImJvZHkiLCJlcnIiLCJSZXNwb25zZUVycm9yIiwiV3JhcHBlZEVycm9yIiwiZGF0YVBhdGgiLCJzZXR1cEFzc2V0Um91dGUiLCJzdG9yYWdlIiwic3RvcmFnZU5hbWUiLCJzZXR0aW5ncyIsImdldFN0b3JhZ2UiLCJDb250cm9sbGVyRXJyb3IiLCJ0b2tlbnMiLCJnZXREYXRhUGF0aCIsImNhbGxiYWNrIiwibWFwIiwiaW5kZXgiLCJtdWx0aXBsZVdpbGRjYXJkcyIsImZpbHRlciIsInRva2VuIiwibm9ybWFsaXplZFBhdGgiLCJtYXRjaERhdGFQYXRoIiwiUmVnRXhwIiwidXBsb2FkIiwiZ2V0VXBsb2FkSGFuZGxlciIsImZpbGVGaWx0ZXIiLCJyZXEiLCJmaWxlIiwiY2IiLCJ0ZXN0IiwiZmllbGRuYW1lIiwiYXV0aG9yaXphdGlvbiIsInByb2Nlc3NBdXRob3JpemUiLCJuZXh0IiwiaGFuZGxlQXV0aG9yaXphdGlvbiIsImZpbGVzIiwiY29udmVydFN0b3JhZ2VGaWxlcyIsInJlcXVlc3QiLCJjcmVhdGVBc3NldHMiLCJ0cmFuc2FjdGlvbiIsImNvbXBvc2UiLCJnZXRQYXRoIiwicGFyZW50Q2xhc3MiLCJpbmhlcml0YW5jZU1hcCIsImhhcyIsInNldCIsImluc3RhbmNlIiwiZW50cnkiLCJnZXQiLCJwYXJlbnQiLCJwYXJlbnRWYWx1ZXMiLCJjdXJyZW50VmFsdWVzIiwic2V0UHJvdG90eXBlT2YiLCJtZXJnZWRBbGxvdyIsIm1lcmdlZEF1dGhvcml6ZSIsImhhc093bkFsbG93IiwiZXhjbHVkZUtleSIsImluY2x1ZGVzIiwiaGFuZGxlQWxsb3ciLCJjdXJyZW50Iiwia2V5cyIsImhhbmRsZUF1dGhvcml6ZSIsImFkZCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwicmVkdWNlIiwicmVzdWx0IiwiY3JlYXRlIiwiZW1pdEhvb2siLCJoYW5kbGVSZXN1bHQiLCJhcmdzIiwic2hpZnQiLCJsaXN0ZW5lcnMiLCJjYWxsIiwiZ2V0TWVtYmVyIiwibWVtYmVyIiwidXNlciIsInN0YXRlIiwiZmluZCIsIm1vZGVsQ2xhc3MiLCIkaWQiLCJtZW1iZXJJZCIsIiRoYXNPd25lciIsIiRoYXNSb2xlIiwiam9pbiIsIm9rIiwiQXV0aG9yaXphdGlvbkVycm9yIiwic3RyIiwiaW5kZW50IiwiY29uc29sZSIsImluZm8iLCJyZXBlYXQiLCJFdmVudEVtaXR0ZXIiLCJtaXhpbiIsIldlYWtNYXAiLCJvYmplY3QiLCJwYXJhbWV0ZXJzIiwicmV0dXJucyIsInNjb3BlIiwiX3BhcmFtZXRlcnMiLCJvcHRpb25zIiwiaGFzT3B0aW9ucyIsIl9yZXR1cm5zIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7QUFLTyxNQUFNQSxVQUFOLENBQWlCO0FBQ3RCQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTUMsU0FBTixFQUFpQjtBQUMxQixTQUFLRCxHQUFMLEdBQVdBLEdBQVg7QUFDQSxTQUFLQyxTQUFMLEdBQWlCLEtBQUtBLFNBQUwsSUFBa0JBLFNBQW5DO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLEtBQUtGLEdBQUwsQ0FBU0csTUFBVCxDQUFnQkMsR0FBaEIsQ0FBb0JDLE1BQW5DO0FBQ0EsU0FBS0MsS0FBTCxHQUFhLENBQWI7QUFDRDs7QUFHREMsRUFBQUEsVUFBVSxHQUFHLENBQ1o7O0FBRURDLEVBQUFBLEtBQUssQ0FBQ0MsTUFBTSxHQUFHLElBQVYsRUFBZ0JDLGtCQUFrQixHQUFHLElBQXJDLEVBQTJDO0FBQzlDLFNBQUtDLGFBQUwsQ0FBbUIsS0FBS0MsS0FBeEIsRUFBK0I7QUFFN0JDLE1BQUFBLFFBQVEsRUFBRTtBQUZtQixLQUEvQjs7QUFLQSxTQUFLQyxJQUFMLEdBQVksS0FBS0EsSUFBTCxJQUNWLEtBQUtmLFdBQUwsQ0FBaUJlLElBQWpCLENBQXNCQyxLQUF0QixDQUE0Qix3QkFBNUIsRUFBc0QsQ0FBdEQsQ0FERjs7QUFFQSxRQUFJLEtBQUtDLElBQUwsS0FBY0MsU0FBbEIsRUFBNkI7QUFDM0IsV0FBS0QsSUFBTCxHQUFZLEtBQUtoQixHQUFMLENBQVNrQixhQUFULENBQXVCLEtBQUtKLElB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SUFBQUEsT0FBTyxDQUFDcEIsSUFBUixHQUFlQSxJQUFmO0FBQ0Q7O0FBRUQsTUFBSWtKLFVBQUosRUFBZ0I7QUFDZCxVQUFNLENBQUNHLFdBQUQsRUFBY0MsT0FBZCxJQUF5QkosVUFBL0I7QUFDQSxVQUFNSyxVQUFVLEdBQUcscUJBQVFGLFdBQVIsQ0FBbkI7QUFDQWpJLElBQUFBLE9BQU8sQ0FBQzhILFVBQVIsR0FBcUJLLFVBQVUsR0FBR0YsV0FBSCxHQUFpQkgsVUFBaEQ7O0FBSUEsUUFBSUssVUFBSixFQUFnQjtBQUNkbkksTUFBQUEsT0FBTyxDQUFDa0ksT0FBUixHQUFrQixFQUNoQixHQUFHbEksT0FBTyxDQUFDa0ksT0FESztBQUVoQkosUUFBQUEsVUFBVSxFQUFFSTtBQUZJLE9BQWxCO0FBSUQ7QUFDRjs7QUFFRCxNQUFJSCxPQUFKLEVBQWE7QUFDWCxVQUFNLENBQUNLLFFBQUQsRUFBV0YsT0FBWCxJQUFzQixxQkFBUUgsT0FBUixDQUE1QjtBQUNBL0gsSUFBQUEsT0FBTyxDQUFDK0gsT0FBUixHQUFrQkssUUFBbEI7O0FBSUEsUUFBSUYsT0FBSixFQUFhO0FBQ1hsSSxNQUFBQSxPQUFPLENBQUNrSSxPQUFSLEdBQWtCLEVBQ2hCLEdBQUdsSSxPQUFPLENBQUNrSSxPQURLO0FBRWhCSixRQUFBQSxVQUFVLEVBQUVJO0FBRkksT0FBbEI7QUFJRDtBQUNGOztBQUVELE1BQUlGLEtBQUosRUFBVztBQUNUaEksSUFBQUEsT0FBTyxDQUFDZ0ksS0FBUixHQUFnQixxQkFBUUEsS0FBUixDQUFoQjtBQUNEOztBQUVELFNBQU9oSSxPQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5pbXBvcnQgeyBnZXRPd25Qcm9wZXJ0eSwgZ2V0QWxsS2V5cywgZGVzY3JpYmVGdW5jdGlvbiB9IGZyb20gJ0AvdXRpbHMnXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdAL2xpYidcbmltcG9ydCBDb250cm9sbGVyQWN0aW9uIGZyb20gJy4vQ29udHJvbGxlckFjdGlvbidcbmltcG9ydCBNZW1iZXJBY3Rpb24gZnJvbSAnLi9NZW1iZXJBY3Rpb24nXG5pbXBvcnQge1xuICBSZXNwb25zZUVycm9yLCBXcmFwcGVkRXJyb3IsIENvbnRyb2xsZXJFcnJvciwgQXV0aG9yaXphdGlvbkVycm9yXG59IGZyb20gJ0AvZXJyb3JzJ1xuaW1wb3J0IHtcbiAgaXNPYmplY3QsIGlzU3RyaW5nLCBpc0FycmF5LCBpc0Jvb2xlYW4sIGlzRnVuY3Rpb24sIGFzQXJyYXksIGVxdWFscyxcbiAgcGFyc2VEYXRhUGF0aCwgbm9ybWFsaXplRGF0YVBhdGhcbn0gZnJvbSAnQGRpdG9qcy91dGlscydcblxuZXhwb3J0IGNsYXNzIENvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcihhcHAsIG5hbWVzcGFjZSkge1xuICAgIHRoaXMuYXBwID0gYXBwXG4gICAgdGhpcy5uYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZSB8fCBuYW1lc3BhY2VcbiAgICB0aGlzLmxvZ2dpbmcgPSB0aGlzLmFwcC5jb25maWcubG9nLnJvdXRlc1xuICAgIHRoaXMubGV2ZWwgPSAwXG4gIH1cblxuICAvLyBAb3ZlcnJpZGFibGVcbiAgaW5pdGlhbGl6ZSgpIHtcbiAgfVxuXG4gIHNldHVwKGlzUm9vdCA9IHRydWUsIHNldHVwQWN0aW9uc09iamVjdCA9IHRydWUpIHtcbiAgICB0aGlzLl9zZXR1cEVtaXR0ZXIodGhpcy5ob29rcywge1xuICAgICAgLy8gU3VwcG9ydCB3aWxkY2FyZCBob29rcyBvbmx5IG9uIGNvbnRyb2xsZXJzOlxuICAgICAgd2lsZGNhcmQ6IHRydWVcbiAgICB9KVxuICAgIC8vIElmIHRoZSBjbGFzcyBuYW1lIGVuZHMgaW4gJ0NvbnRyb2xsZXInLCByZW1vdmUgaXQgZnJvbSBjb250cm9sbGVyIG5hbWUuXG4gICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lIHx8XG4gICAgICB0aGlzLmNvbnN0cnVjdG9yLm5hbWUubWF0Y2goL14oLio/KSg/OkNvbnRyb2xsZXJ8KSQvKVsxXVxuICAgIGlmICh0aGlzLnBhdGggPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5wYXRoID0gdGhpcy5hcHAubm9ybWFsaXplUGF0aCh0aGlzLm5hbWUpXG4gICAgfVxuICAgIHRoaXMudHJhbnNhY3RlZCA9ICEhdGhpcy50cmFuc2FjdGVkXG4gICAgaWYgKGlzUm9vdCkge1xuICAgICAgY29uc3QgeyBwYXRoLCBuYW1lc3BhY2UgfSA9IHRoaXNcbiAgICAgIC8vIFRPRE86IFRoZSBkaXN0aW5jdGlvbiBiZXR3ZWVuICBgdXJsYCBhbmQgYHBhdGhgIGlzIGEgYml0IHRyaWNreSwgc2luY2VcbiAgICAgIC8vIHdoYXQgd2UgY2FsbCBgdXJsYCBoZXJlIGlzIGNhbGxlZCBgcGF0aGAgaW4gUm91dGVyLCBhbmQgbWF5IGNvbnRhaW5cbiAgICAgIC8vIG1hcHBlZCBwYXJhbWV0ZXJzIG9yIHdpbGRjYXJkcy4gQ29uc2lkZXIgYHBhdGhgIC8gYHJvdXRlYCBpbnN0ZWFkP1xuICAgICAgY29uc3QgdXJsID0gcGF0aCA/IGAvJHtwYXRofWAgOiAnJ1xuICAgICAgdGhpcy51cmwgPSBuYW1lc3BhY2UgPyBgLyR7bmFtZXNwYWNlfSR7dXJsfWAgOiB1cmxcbiAgICAgIHRoaXMubG9nKFxuICAgICAgICBgJHtcbiAgICAgICAgICBuYW1lc3BhY2UgPyBjaGFsay5ncmVlbihgLyR7bmFtZXNwYWNlfS9gKSA6ICcnXG4gICAgICAgIH0ke1xuICAgICAgICAgIGNoYWxrLmN5YW4ocGF0aClcbiAgICAgICAgfSR7XG4gICAgICAgICAgY2hhbGsud2hpdGUoJzonKVxuICAgICAgICB9YCxcbiAgICAgICAgdGhpcy5sZXZlbFxuICAgICAgKVxuICAgICAgaWYgKHNldHVwQWN0aW9uc09iamVjdCkge1xuICAgICAgICB0aGlzLmFjdGlvbnMgPSB0aGlzLmFjdGlvbnMgfHwgdGhpcy5yZWZsZWN0QWN0aW9uc09iamVjdCgpXG4gICAgICAgIC8vIE5vdyB0aGF0IHRoZSBpbnN0YW5jZSBmaWVsZHMgYXJlIHJlZmxlY3RlZCBpbiB0aGUgYGNvbnRyb2xsZXJgIG9iamVjdFxuICAgICAgICAvLyB3ZSBjYW4gdXNlIHRoZSBub3JtYWwgaW5oZXJpdGFuY2UgbWVjaGFuaXNtIHRocm91Z2ggYHNldHVwQWN0aW9ucygpYDpcbiAgICAgICAgdGhpcy5hY3Rpb25zID0gdGhpcy5zZXR1cEFjdGlvbnMoJ2FjdGlvbnMnKVxuICAgICAgfVxuICAgICAgdGhpcy5hc3NldHMgPSB0aGlzLnNldHVwQXNzZXRzKClcbiAgICB9XG4gIH1cblxuICByZWZsZWN0QWN0aW9uc09iamVjdCgpIHtcbiAgICAvLyBPbiBiYXNlIGNvbnRyb2xsZXJzLCB0aGUgYWN0aW9ucyBjYW4gYmUgZGVmaW5lZCBkaXJlY3RseSBpbiB0aGUgY2xhc3NcbiAgICAvLyBpbnN0ZWFkIG9mIGluc2lkZSBhbiBhY3Rpb25zIG9iamVjdCwgYXMgaXMgZG9uZSB3aXRoIG1vZGVsIGFuZCByZWxhdGlvblxuICAgIC8vIGNvbnRyb2xsZXJzLiBCdXQgaW4gb3JkZXIgdG8gdXNlIHRoZSBzYW1lIHN0cnVjdHVyZSBmb3IgaW5oZXJpdGFuY2UgYXNcbiAgICAvLyB0aGVzZSBvdGhlciBjb250cm9sbGVycywgd2UgcmVmbGVjdCB0aGVzZSBpbnN0YW5jZSBmaWVsZHMgaW4gYSBzZXBhcmF0ZVxuICAgIC8vIGBhY3Rpb25zYCBvYmplY3QuXG4gICAgY29uc3QgeyBhbGxvdyB9ID0gdGhpc1xuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBhbGxvdyA/IHsgYWxsb3cgfSA6IHt9XG5cbiAgICBjb25zdCBhZGRBY3Rpb24gPSBrZXkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW2tleV1cbiAgICAgIC8vIE5PVEU6IE9ubHkgYWRkIGluc3RhbmNlIG1ldGhvZHMgdGhhdCBoYXZlIGEgQGFjdGlvbigpIGRlY29yYXRvcixcbiAgICAgIC8vIHdoaWNoIGluIHR1cm4gc2V0cyB0aGUgYHZlcmJgIHByb3BlcnR5IG9uIHRoZSBtZXRob2QsIG9yIGFjdGlvbiBvYmplY3RzXG4gICAgICAvLyB3aGljaCBoYXZlIHRoZSBgaGFuZGxlcmAgcHJvcGVydHk6XG4gICAgICBpZiAodmFsdWU/LnZlcmIgfHwgdmFsdWU/LmhhbmRsZXIpIHtcbiAgICAgICAgY29udHJvbGxlcltrZXldID0gdmFsdWVcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gVXNlIGBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcygpYCB0byBnZXQgdGhlIGZpZWxkcywgaW4gb3JkZXIgdG9cbiAgICAvLyBub3QgYWxzbyByZWNlaXZlIHZhbHVlcyBmcm9tIHBhcmVudHMgKHRob3NlIGFyZSBmZXRjaGVkIGxhdGVyIGluXG4gICAgLy8gYGluaGVyaXRWYWx1ZXMoKWAsIHNlZSBgZ2V0UGFyZW50VmFsdWVzKClgKS5cbiAgICBjb25zdCBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKVxuICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3RvKS5mb3JFYWNoKGFkZEFjdGlvbilcbiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh0aGlzKS5mb3JFYWNoKGFkZEFjdGlvbilcbiAgICByZXR1cm4gY29udHJvbGxlclxuICB9XG5cbiAgc2V0dXBSb3V0ZSh2ZXJiLCB1cmwsIHRyYW5zYWN0ZWQsIGF1dGhvcml6ZSwgYWN0aW9uLCBoYW5kbGVycykge1xuICAgIHRoaXMubG9nKFxuICAgICAgYCR7XG4gICAgICAgIGNoYWxrLm1hZ2VudGEodmVyYi50b1VwcGVyQ2FzZSgpKVxuICAgICAgfSAke1xuICAgICAgICBjaGFsay5ncmVlbih0aGlzLnVybClcbiAgICAgIH0ke1xuICAgICAgICBjaGFsay5jeWFuKHVybC5zbGljZSh0aGlzLnVybC5sZW5ndGgpKVxuICAgICAgfSAke1xuICAgICAgICBjaGFsay53aGl0ZSh0aGlzLmRlc2NyaWJlQXV0aG9yaXplKGF1dGhvcml6ZSkpXG4gICAgICB9YCxcbiAgICAgIHRoaXMubGV2ZWwgKyAxXG4gICAgKVxuICAgIHRoaXMuYXBwLmFkZFJvdXRlKHZlcmIsIHVybCwgdHJhbnNhY3RlZCwgaGFuZGxlcnMsIHRoaXMsIGFjdGlvbilcbiAgfVxuXG4gIHNldHVwQWN0aW9ucyh0eXBlKSB7XG4gICAgY29uc3Qge1xuICAgICAgdmFsdWVzOiBhY3Rpb25zLFxuICAgICAgYXV0aG9yaXplXG4gICAgfSA9IHRoaXMucHJvY2Vzc1ZhbHVlcyh0aGlzLmluaGVyaXRWYWx1ZXModHlwZSkpXG4gICAgZm9yIChjb25zdCBbbmFtZSwgaGFuZGxlcl0gb2YgT2JqZWN0LmVudHJpZXMoYWN0aW9ucykpIHtcbiAgICAgIHRoaXMuc2V0dXBBY3Rpb24odHlwZSwgYWN0aW9ucywgbmFtZSwgaGFuZGxlciwgYXV0aG9yaXplW25hbWVdKVxuICAgIH1cbiAgICByZXR1cm4gYWN0aW9uc1xuICB9XG5cbiAgc2V0dXBBY3Rpb24oXG4gICAgdHlwZSxcbiAgICBhY3Rpb25zLFxuICAgIG5hbWUsXG4gICAgaGFuZGxlcixcbiAgICBhdXRob3JpemUsXG4gICAgLy8gVGhlc2UgdmFsdWVzIGFyZSBvbmx5IGNoYW5nZWQgd2hlbiBjYWxsZWQgZnJvbVxuICAgIC8vIGBDb2xsZWN0aW9uQ29udHJvbGxlci5zZXR1cEFjdGlvbigpYDpcbiAgICB2ZXJiID0gJ2dldCcsXG4gICAgLy8gVGhlIGRlZmF1bHQgcGF0aCBmb3IgYWN0aW9ucyBpcyB0aGUgbm9ybWFsaXplZCBuYW1lLlxuICAgIHBhdGggPSB0aGlzLmFwcC5ub3JtYWxpemVQYXRoKG5hbWUpXG4gICkge1xuICAgIGlmICghaXNGdW5jdGlvbihoYW5kbGVyKSkge1xuICAgICAgaGFuZGxlciA9IHNldHVwSGFuZGxlckZyb21PYmplY3QoaGFuZGxlciwgYWN0aW9ucylcbiAgICB9XG4gICAgLy8gQ3VzdG9tIG1lbWJlciBhY3Rpb25zIGhhdmUgdGhlaXIgb3duIGNsYXNzIHNvIHRoZXkgY2FuIGZldGNoIHRoZSBtZW1iZXJzXG4gICAgLy8gYWhlYWQgb2YgdGhlaXIgY2FsbC5cbiAgICBjb25zdCBhY3Rpb25DbGFzcyA9IHR5cGUgPT09ICdtZW1iZXInID8gTWVtYmVyQWN0aW9uIDogQ29udHJvbGxlckFjdGlvblxuICAgIHRoaXMuc2V0dXBBY3Rpb25Sb3V0ZShcbiAgICAgIHR5cGUsXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbmV3LWNhcFxuICAgICAgbmV3IGFjdGlvbkNsYXNzKHRoaXMsIGhhbmRsZXIsIHR5cGUsIG5hbWUsIHZlcmIsIHBhdGgsIGF1dGhvcml6ZSlcbiAgICApXG4gIH1cblxuICBzZXR1cEFjdGlvblJvdXRlKHR5cGUsIGFjdGlvbikge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuZ2V0VXJsKHR5cGUsIGFjdGlvbi5wYXRoKVxuICAgIGNvbnN0IHsgdmVyYiwgdHJhbnNhY3RlZCwgYXV0aG9yaXplIH0gPSBhY3Rpb25cbiAgICB0aGlzLnNldHVwUm91dGUodmVyYiwgdXJsLCB0cmFuc2FjdGVkLCBhdXRob3JpemUsIGFjdGlvbiwgW1xuICAgICAgYXN5bmMgY3R4ID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBhY3Rpb24uY2FsbEFjdGlvbihjdHgpXG4gICAgICAgICAgaWYgKHJlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjdHguYm9keSA9IHJlc1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgdGhyb3cgZXJyIGluc3RhbmNlb2YgUmVzcG9uc2VFcnJvciA/IGVyciA6IG5ldyBXcmFwcGVkRXJyb3IoZXJyKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgXSlcbiAgfVxuXG4gIHNldHVwQXNzZXRzKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHZhbHVlczogYXNzZXRzLFxuICAgICAgYXV0aG9yaXplXG4gICAgfSA9IHRoaXMucHJvY2Vzc1ZhbHVlcyh0aGlzLmluaGVyaXRWYWx1ZXMoJ2Fzc2V0cycpKVxuICAgIGZvciAoY29uc3QgW2RhdGFQYXRoLCBjb25maWddIG9mIE9iamVjdC5lbnRyaWVzKGFzc2V0cyB8fCB7fSkpIHtcbiAgICAgIHRoaXMuc2V0dXBBc3NldFJvdXRlKGRhdGFQYXRoLCBjb25maWcsIGF1dGhvcml6ZVtkYXRhUGF0aF0pXG4gICAgfVxuICAgIHJldHVybiBhc3NldHNcbiAgfVxuXG4gIHNldHVwQXNzZXRSb3V0ZShkYXRhUGF0aCwgY29uZmlnLCBhdXRob3JpemUpIHtcbiAgICBjb25zdCB7XG4gICAgICBzdG9yYWdlOiBzdG9yYWdlTmFtZSxcbiAgICAgIC8vIFRPRE86IFdoYXQgZXhhY3RseSBzaG91bGQgY29udHJvbCB0aGUgdXNlIG9mIGB0cmFuc2FjdGVkYD9cbiAgICAgIHRyYW5zYWN0ZWQsXG4gICAgICAuLi5zZXR0aW5nc1xuICAgIH0gPSBjb25maWdcbiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5hcHAuZ2V0U3RvcmFnZShzdG9yYWdlTmFtZSlcbiAgICBpZiAoIXN0b3JhZ2UpIHtcbiAgICAgIHRocm93IG5ldyBDb250cm9sbGVyRXJyb3IodGhpcyxcbiAgICAgICAgYFVua25vd24gc3RvcmFnZSBjb25maWd1cmF0aW9uOiAnJHtzdG9yYWdlTmFtZX0nYFxuICAgICAgKVxuICAgIH1cbiAgICBjb25zdCB0b2tlbnMgPSBwYXJzZURhdGFQYXRoKGRhdGFQYXRoKVxuICAgIGNvbnN0IGdldERhdGFQYXRoID0gY2FsbGJhY2sgPT4gbm9ybWFsaXplRGF0YVBhdGgodG9rZW5zLm1hcChjYWxsYmFjaykpXG5cbiAgICAvLyBSZXBsYWNlIHdpbGRjYXJkcyB3aXRoIG51bWJlcmVkIGluZGljZXMgYW5kIGNvbnZlcnQgdG8gJy8nLW5vdGF0aW9uOlxuICAgIGxldCBpbmRleCA9IDBcbiAgICBjb25zdCBtdWx0aXBsZVdpbGRjYXJkcyA9IHRva2Vucy5maWx0ZXIodG9rZW4gPT4gdG9rZW4gPT09ICcqJykubGVuZ3RoID4gMVxuICAgIGNvbnN0IG5vcm1hbGl6ZWRQYXRoID0gZ2V0RGF0YVBhdGgoXG4gICAgICB0b2tlbiA9PiB0b2tlbiA9PT0gJyonXG4gICAgICAgID8gbXVsdGlwbGVXaWxkY2FyZHNcbiAgICAgICAgICA/IGA6aW5kZXgkeysraW5kZXh9YFxuICAgICAgICAgIDogJzppbmRleCdcbiAgICAgICAgOiB0aGlzLmFwcC5ub3JtYWxpemVQYXRoKHRva2VuKVxuICAgIClcblxuICAgIC8vIENvbnZlcnQgYGRhdGFQYXRoYCB0byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiB0byBtYXRjaCBmaWVsZCBuYW1lc1xuICAgIC8vIGFnYWluc3QsIGJ1dCBjb252ZXJ0IHdpbGRjYXJkcyAoKikgdG8gbWF0Y2ggYm90aCBudW1lcmljIGlkcyBhbmQgd29yZHMsXG4gICAgLy8gZS5nLiAnY3JlYXRlJzpcbiAgICBjb25zdCBtYXRjaERhdGFQYXRoID0gbmV3IFJlZ0V4cChcbiAgICAgIGBeJHtnZXREYXRhUGF0aCh0b2tlbiA9PiB0b2tlbiA9PT0gJyonID8gJ1xcXFx3KycgOiB0b2tlbil9JGBcbiAgICApXG5cbiAgICBjb25zdCB1cmwgPSB0aGlzLmdldFVybCgnY29udHJvbGxlcicsIGB1cGxvYWQvJHtub3JtYWxpemVkUGF0aH1gKVxuICAgIGNvbnN0IHVwbG9hZCA9IHN0b3JhZ2UuZ2V0VXBsb2FkSGFuZGxlcih7XG4gICAgICAuLi5zZXR0aW5ncyxcbiAgICAgIC8vIE9ubHkgbGV0IHVwbG9hZHMgcGFzcyB0aGF0IG1hdGNoIHRoZSBub3JtYWxpemVQYXRoICsgd2lsZGNhcmRzOlxuICAgICAgZmlsZUZpbHRlcjogKHJlcSwgZmlsZSwgY2IpID0+IHtcbiAgICAgICAgY2IobnVsbCwgbWF0Y2hEYXRhUGF0aC50ZXN0KGZpbGUuZmllbGRuYW1lKSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgY29uc3QgYXV0aG9yaXphdGlvbiA9IHRoaXMucHJvY2Vzc0F1dGhvcml6ZShhdXRob3JpemUpXG4gICAgdGhpcy5zZXR1cFJvdXRlKCdwb3N0JywgdXJsLCB0cmFuc2FjdGVkLCBhdXRob3JpemUsIG51bGwsIFtcbiAgICAgIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVBdXRob3JpemF0aW9uKGF1dGhvcml6YXRpb24sIGN0eClcbiAgICAgICAgcmV0dXJuIG5leHQoKVxuICAgICAgfSxcblxuICAgICAgdXBsb2FkLFxuXG4gICAgICBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gc3RvcmFnZS5jb252ZXJ0U3RvcmFnZUZpbGVzKGN0eC5yZXF1ZXN0LmZpbGVzKVxuICAgICAgICBhd2FpdCB0aGlzLmFwcC5jcmVhdGVBc3NldHMoc3RvcmFnZSwgZmlsZXMsIDAsIGN0eC50cmFuc2FjdGlvbilcbiAgICAgICAgLy8gU2VuZCB0aGUgZmlsZSBvYmplY3RzIGJhY2sgZm9yIHRoZSB1cGxvYWQgY29tcG9uZW50IHRvIHN0b3JlIGluIHRoZVxuICAgICAgICAvLyBkYXRhLlxuICAgICAgICBjdHguYm9keSA9IGZpbGVzXG4gICAgICAgIHJldHVybiBuZXh0KClcbiAgICAgIH1cbiAgICBdKVxuICB9XG5cbiAgY29tcG9zZSgpIHtcbiAgICAvLyBUbyBiZSBvdmVycmlkZGVuIGluIHN1Yi1jbGFzc2VzLCBpZiB0aGUgY29udHJvbGxlciBuZWVkcyB0byBpbnN0YWxsXG4gICAgLy8gbWlkZGxld2FyZS4gRm9yIG5vcm1hbCByb3V0ZXMsIHVzZSBgdGhpcy5hcHAuYWRkUm91dGUoKWAgaW5zdGVhZC5cbiAgfVxuXG4gIGdldFBhdGgodHlwZSwgcGF0aCkge1xuICAgIC8vIFRvIGJlIG92ZXJyaWRkZW4gYnkgc3ViLWNsYXNzZXMuXG4gICAgcmV0dXJuIHBhdGhcbiAgfVxuXG4gIGdldFVybCh0eXBlLCBwYXRoKSB7XG4gICAgcGF0aCA9IHRoaXMuZ2V0UGF0aCh0eXBlLCBwYXRoKVxuICAgIC8vIFVzZSAnLicgYXMgdGhlIHBhdGggZm9yIHRoZSBjb250cm9sbGVyJ3MgXCJpbmRleFwiIGFjdGlvbi5cbiAgICByZXR1cm4gcGF0aCAmJiBwYXRoICE9PSAnLicgPyBgJHt0aGlzLnVybH0vJHtwYXRofWAgOiB0aGlzLnVybFxuICB9XG5cbiAgaW5oZXJpdFZhbHVlcyh0eXBlKSB7XG4gICAgLy8gR2V0cyB0aGUgY29udHJvbGxlciBjbGFzcydzIGluc3RhbmNlIGZpZWxkIGZvciBhIGdpdmVuIGFjdGlvbiB0eXBlLCBlLmcuXG4gICAgLy8gYGNvbnRyb2xsZXJgIChDb250cm9sbGVyKSwgYGNvbGxlY3Rpb25gLCBgbWVtYmVyYCAoTW9kZWxDb250cm9sbGVyLFxuICAgIC8vIFJlbGF0aW9uQ29udHJvbGxlciksIGByZWxhdGlvbmAgKFJlbGF0aW9uQ29udHJvbGxlciksIGFuZCBzZXRzIHVwIGFuXG4gICAgLy8gaW5oZXJpdGFuY2UgY2hhaW4gZm9yIGl0IHRoYXQgZ29lcyBhbGwgdGhlIHdheSB1cCB0byBpdCBiYXNlIGNsYXNzIChlLmcuXG4gICAgLy8gQ29sbGVjdGlvbkNvbnRyb2xsZXIpLCBzbyB0aGF0IHRoZSBkZWZhdWx0IGRlZmluaXRpb25zIGZvciBhbGwgaHR0cCB2ZXJic1xuICAgIC8vIGNhbiBiZSBjb3JyZWN0bHkgaW5oZXJpdGVkIGFuZCBvdmVycmlkZGVuIHdoaWxlIHVzaW5nIGBzdXBlci48YWN0aW9uPigpYC5cbiAgICBjb25zdCBwYXJlbnRDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzLmNvbnN0cnVjdG9yKVxuICAgIC8vIENyZWF0ZSBvbmUgaW5zdGFuY2Ugb2YgZWFjaCBjb250cm9sbGVyIGNsYXNzIHVwIHRoZSBjaGFpbiBpbiBvcmRlciB0b1xuICAgIC8vIGdldCB0byB0aGVpciBkZWZpbml0aW9ucyBvZiB0aGUgaW5oZXJpdGFibGUgdmFsdWVzLiBDYWNoZSBib3RoIGluc3RhbmNlXG4gICAgLy8gYW5kIHJlc29sdmVkIHZhbHVlcyBwZXIgcGFyZW50Q2xhc3MgaW4gYW4gaW5oZXJpdGFuY2VNYXAuXG4gICAgaWYgKCFpbmhlcml0YW5jZU1hcC5oYXMocGFyZW50Q2xhc3MpKSB7XG4gICAgICBpbmhlcml0YW5jZU1hcC5zZXQocGFyZW50Q2xhc3MsIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5ldy1jYXBcbiAgICAgICAgaW5zdGFuY2U6IG5ldyBwYXJlbnRDbGFzcyh0aGlzLmFwcCwgdGhpcy5uYW1lc3BhY2UpXG4gICAgICB9KVxuICAgIH1cbiAgICBjb25zdCBlbnRyeSA9IGluaGVyaXRhbmNlTWFwLmdldChwYXJlbnRDbGFzcylcbiAgICBpZiAoIWVudHJ5W3R5cGVdKSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSBlbnRyeS5pbnN0YW5jZVxuICAgICAgbGV0IHZhbHVlcyA9IHBhcmVudFt0eXBlXVxuICAgICAgaWYgKHBhcmVudENsYXNzICE9PSBDb250cm9sbGVyKSB7XG4gICAgICAgIC8vIFJlY3Vyc2l2ZWx5IHNldCB1cCBpbmhlcml0YW5jZSBjaGFpbnMuXG4gICAgICAgIHZhbHVlcyA9IHBhcmVudC5pbmhlcml0VmFsdWVzKHR5cGUpXG4gICAgICB9XG4gICAgICBlbnRyeVt0eXBlXSA9IHZhbHVlc1xuICAgIH1cbiAgICAvLyBJZiB0aGVyZSBhcmUgbm8gdmFsdWVzIGRlZmluZWQgb24gYHRoaXNgIHRoYXQgZGlmZmVyIGZyb20gdGhlIHBhcmVudCxcbiAgICAvLyBzZXQgdG8gYW4gZW1wdHkgb2JqZWN0IHNvIGluaGVyaXRhbmNlIGNhbiBiZSBzZXQgdXAgYW5kIGBwcm9jZXNzVmFsdWVzKClgXG4gICAgLy8gY2FuIHN0aWxsIGJlIGNhbGxlZC5cbiAgICAvLyBOT1RFOiBXZSBjYW4ndCBjaGVjayB3aXRoIGB0aGlzLmhhc093blByb3BlcnR5KHR5cGUpYCBiZWNhdXNlIHRoZVxuICAgIC8vIGZpZWxkIGNhbiBiZSBvbiB0aGUgY2xhc3MgcHJvdG90eXBlIGFzIHdlbGwsIGluIGNhc2Ugb2YgYWNjZXNzb3JzLlxuICAgIGNvbnN0IHBhcmVudFZhbHVlcyA9IGVudHJ5W3R5cGVdXG4gICAgbGV0IGN1cnJlbnRWYWx1ZXMgPSB0aGlzW3R5cGVdXG4gICAgaWYgKGN1cnJlbnRWYWx1ZXMgJiYgY3VycmVudFZhbHVlcyA9PT0gcGFyZW50VmFsdWVzKSB7XG4gICAgICBjdXJyZW50VmFsdWVzID0gdGhpc1t0eXBlXSA9IHt9XG4gICAgfVxuICAgIC8vIENvbWJpbmUgcGFyZW50VmFsdWVzIGFuZCBjdXJyZW50VmFsdWVzIHdpdGggY29ycmVjdCBpbmhlcml0YW5jZS5cbiAgICByZXR1cm4gaXNPYmplY3QocGFyZW50VmFsdWVzKSAmJiBpc09iamVjdChjdXJyZW50VmFsdWVzKVxuICAgICAgPyBPYmplY3Quc2V0UHJvdG90eXBlT2YoY3VycmVudFZhbHVlcywgcGFyZW50VmFsdWVzKVxuICAgICAgOiBjdXJyZW50VmFsdWVzXG4gIH1cblxuICBwcm9jZXNzVmFsdWVzKHZhbHVlcykge1xuICAgIGlmICghdmFsdWVzKSByZXR1cm4ge31cbiAgICAvLyBSZXNwZWN0IGBhbGxvd2Agc2V0dGluZ3MgYW5kIGNsZWFyIGVudHJpZXMgdGhhdCBhcmVuJ3QgYWxsb3dlZC5cbiAgICAvLyBBbHNvIGNvbGxlY3QgYW5kIGV4cGFuZCBgYXV0aG9yaXplYCBzZXR0aW5ncyBzbyB0aGF0IGluIHRoZSBlbmQsIGFuXG4gICAgLy8gYGF1dGhvcml6ZWAgb2JqZWN0IGNhbiBiZSByZXR1cm5lZCB3aXRoIHZhbGlkIHNldHRpbmdzIGZvciBhbGwgdmFsdWVzLlxuICAgIC8vXG4gICAgLy8gUnVsZXM6XG4gICAgLy8gLSBPd24gdmFsdWVzIG9uIG9iamVjdHMgdGhhdCBkb24ndCBkZWZpbmUgYW4gYGFsbG93YCBhcnJheSBhcmVcbiAgICAvLyAgIGF1dG9tYXRpY2FsbHkgYWxsb3dlZC4gSWYgYW4gYGFsbG93YCBhcnJheSBpcyBkZWZpbmVkIGFzIHdlbGwsIHRoZW5cbiAgICAvLyAgIHRoZXNlIG93biB2YWx1ZXMgbmVlZCB0byBiZSBleHBsaWNpdGx5IGxpc3RlZC5cbiAgICAvLyAtIElmIG5vIGBhbGxvd2AgYXJyYXlzIGFyZSBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGFsIGhpZXJhcmNoeSwgZWFjaFxuICAgIC8vICAgbGV2ZWwgYWxsb3dzIGl0cyBvd24gdmFsdWVzLCBhbmQgdGhlc2UgYXJlIG1lcmdlZCwgZXhjZXB0IGZvciB0aG9zZVxuICAgIC8vICAgbWFya2VkIGFzIGAkY29yZWAsIHdoaWNoIG5lZWQgdG8gYmUgZXhwbGljaXRseSBsaXN0ZWQgaW4gYGFsbG93YC5cblxuICAgIC8vIE5PVEU6IGBoYW5kbGVBbGxvdygpYCBhbmQgYGhhbmRsZUF1dGhvcml6ZSgpYCBhcmUgYXBwbGllZCBpbiBzZXF1ZW5jZSBvZlxuICAgIC8vIHRoZSBgdmFsdWVzYCBpbmhlcml0YW5jZSwgZnJvbSBzdWItY2xhc3MgdG8gYmFzZS1jbGFzcy5cblxuICAgIGNvbnN0IG1lcmdlZEFsbG93ID0ge31cbiAgICBjb25zdCBtZXJnZWRBdXRob3JpemUgPSB7fVxuICAgIGxldCBoYXNPd25BbGxvdyA9IGZhbHNlXG5cbiAgICBjb25zdCBleGNsdWRlS2V5ID0ga2V5ID0+IFsnYWxsb3cnLCAnYXV0aG9yaXplJ10uaW5jbHVkZXMoa2V5KVxuXG4gICAgY29uc3QgaGFuZGxlQWxsb3cgPSAoYWxsb3csIGN1cnJlbnQpID0+IHtcbiAgICAgIGlmIChhbGxvdykge1xuICAgICAgICBhbGxvdyA9IGFzQXJyYXkoYWxsb3cpXG4gICAgICAgIGhhc093bkFsbG93ID0gdHJ1ZVxuICAgICAgfSBlbHNlIGlmICghaGFzT3duQWxsb3cpIHtcbiAgICAgICAgLy8gT25seSBrZWVwIGFkZGluZyB0byB0aGUgbWVyZ2VkIGBhbGxvd2AgaWYgd2UgZGlkbid0IGFscmVhZHkgZW5jb3VudGVyXG4gICAgICAgIC8vIGFuIG93biBgYWxsb3dgIG9iamVjdCBmdXJ0aGVyIHVwIHRoZSBjaGFpbi5cbiAgICAgICAgYWxsb3cgPSBPYmplY3Qua2V5cyhjdXJyZW50KVxuICAgICAgfVxuICAgICAgaWYgKGFsbG93KSB7XG4gICAgICAgIGlmIChhbGxvdy5pbmNsdWRlcygnKicpKSB7XG4gICAgICAgICAgYWxsb3cgPSBnZXRBbGxLZXlzKGN1cnJlbnQpXG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgYWxsb3cpIHtcbiAgICAgICAgICBpZiAoIWV4Y2x1ZGVLZXkoa2V5KSkge1xuICAgICAgICAgICAgbWVyZ2VkQWxsb3dba2V5XSA9IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVBdXRob3JpemUgPSBhdXRob3JpemUgPT4ge1xuICAgICAgY29uc3QgYWRkID0gKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgLy8gU2luY2Ugd2UncmUgd2Fsa2luZyB1cCBpbiB0aGUgaW5oZXJpdGFuY2UgY2hhaW4sIG9ubHkgdGFrZSBvbiBhblxuICAgICAgICAvLyBhdXRob3JpemUgc2V0dGluZyBmb3IgYSBnaXZlbiBrZXkgaWYgaXQgd2Fzbid0IGFscmVhZHkgZGVmaW5lZCBiZWZvcmVcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGtleSBpbiB2YWx1ZXMgJiZcbiAgICAgICAgICAhKGtleSBpbiBtZXJnZWRBdXRob3JpemUpICYmXG4gICAgICAgICAgIWV4Y2x1ZGVLZXkoa2V5KVxuICAgICAgICApIHtcbiAgICAgICAgICBtZXJnZWRBdXRob3JpemVba2V5XSA9IHZhbHVlXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGlzT2JqZWN0KGF1dGhvcml6ZSkpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gYXV0aG9yaXplKSB7XG4gICAgICAgICAgYWRkKGtleSwgYXV0aG9yaXplW2tleV0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoYXV0aG9yaXplICE9IG51bGwpIHtcbiAgICAgICAgLy8gVGhpcyBpcyBhIHZhbHVlcy13aWRlIHNldHRpbmcuIExvb3AgdGhyb3VnaCBhbGwgdmFsdWVzLCBub3QganVzdFxuICAgICAgICAvLyBjdXJyZW50IG9uZXMsIGFuZCBhcHBseSB0byBhbnkgYWN0aW9uIHRoYXQgZG9lc24ndCBhbHJlYWR5IGhhdmUgb25lOlxuICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiB2YWx1ZXMpIHtcbiAgICAgICAgICBhZGQoa2V5LCBhdXRob3JpemUpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQcm9jZXNzIHRoZSBgYWxsb3dgIGFuZCBgYXV0aG9yaXplYCBzZXR0aW5ncyBpbiBzZXF1ZW5jZSBvZiB0aGUgYHZhbHVlc2BcbiAgICAvLyBpbmhlcml0YW5jZSwgZnJvbSBzdWItY2xhc3MgdG8gYmFzZS1jbGFzcy5cbiAgICBsZXQgY3VycmVudCA9IHZhbHVlc1xuICAgIHdoaWxlIChjdXJyZW50ICE9PSBPYmplY3QucHJvdG90eXBlICYmICFjdXJyZW50Lmhhc093blByb3BlcnR5KCckY29yZScpKSB7XG4gICAgICBoYW5kbGVBbGxvdyhnZXRPd25Qcm9wZXJ0eShjdXJyZW50LCAnYWxsb3cnKSwgY3VycmVudClcbiAgICAgIGhhbmRsZUF1dGhvcml6ZShnZXRPd25Qcm9wZXJ0eShjdXJyZW50LCAnYXV0aG9yaXplJykpXG4gICAgICBjdXJyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGN1cnJlbnQpXG4gICAgfVxuXG4gICAgLy8gQXQgdGhlIGVuZCBvZiB0aGUgY2hhaW4sIGFsc28gc3VwcG9ydCBib3RoIHNldHRpbmdzIG9uIHRoZSBjb250cm9sbGVyLVxuICAgIC8vIGxldmVsLCBhbmQgdGh1cyBhcHBsaWVkIHRvIGFsbCBhY3Rpb24gb2JqZWN0cyBpbiB0aGUgY29udHJvbGxlci5cbiAgICBpZiAodGhpcy5hbGxvdykge1xuICAgICAgaGFuZGxlQWxsb3codGhpcy5hbGxvdywgdmFsdWVzKVxuICAgIH1cbiAgICBpZiAodGhpcy5hdXRob3JpemUpIHtcbiAgICAgIGhhbmRsZUF1dGhvcml6ZSh0aGlzLmF1dGhvcml6ZSlcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgLy8gQ3JlYXRlIGEgZmlsdGVyZWQgYHZhbHVlc2Agb2JqZWN0IHRoYXQgb25seSBjb250YWlucyB0aGUgYWxsb3dlZCBmaWVsZHNcbiAgICAgIHZhbHVlczogZ2V0QWxsS2V5cyh2YWx1ZXMpLnJlZHVjZShcbiAgICAgICAgKHJlc3VsdCwga2V5KSA9PiB7XG4gICAgICAgICAgaWYgKG1lcmdlZEFsbG93W2tleV0pIHtcbiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWVzW2tleV1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgICB9LFxuICAgICAgICAvLyBDcmVhdGUgYSBuZXcgb2JqZWN0IGZvciB0aGUgZmlsdGVyZWQgYHZhbHVlc2AgdGhhdCBrZWVwcyBpbmhlcml0YW5jZVxuICAgICAgICAvLyBpbnRhY3QuIFRoaXMgaXMgcmVxdWlyZWQgYnkgYHNldHVwSGFuZGxlckZyb21PYmplY3QoKWAsIHRvIHN1cHBvcnRcbiAgICAgICAgLy8gYHN1cGVyYCBpbiBoYW5kbGVyIGZ1bmN0aW9ucy5cbiAgICAgICAgT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVzKSlcbiAgICAgICksXG4gICAgICBhbGxvdzogT2JqZWN0LmtleXMobWVyZ2VkQWxsb3cpLFxuICAgICAgYXV0aG9yaXplOiBtZXJnZWRBdXRob3JpemVcbiAgICB9XG4gIH1cblxuICBhc3luYyBlbWl0SG9vayh0eXBlLCBoYW5kbGVSZXN1bHQsIGN0eCwgLi4uYXJncykge1xuICAgIGxldCByZXN1bHQgPSBoYW5kbGVSZXN1bHQgPyBhcmdzLnNoaWZ0KCkgOiB1bmRlZmluZWRcbiAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgdGhpcy5saXN0ZW5lcnModHlwZSkpIHtcbiAgICAgIGlmIChoYW5kbGVSZXN1bHQpIHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgaGFuZGxlci5jYWxsKHRoaXMsIGN0eCwgcmVzdWx0LCAuLi5hcmdzKVxuICAgICAgICBpZiAocmVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXN1bHQgPSByZXNcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgaGFuZGxlci5jYWxsKHRoaXMsIGN0eCwgLi4uYXJncylcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgYXN5bmMgZ2V0TWVtYmVyKC8qIGN0eCwgYmFzZSA9IHRoaXMsIHBhcmFtID0geyAuLi4gfSAqLykge1xuICAgIC8vIFRoaXMgaXMgb25seSBkZWZpbmVkIGluIGBDb2xsZWN0aW9uQ29udHJvbGxlcmAsIHdoZXJlIGl0IHJlc29sdmVzIHRvIHRoZVxuICAgIC8vIG1lbWJlciByZXByZXNlbnRlZCBieSB0aGUgZ2l2ZW4gcm91dGUuXG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgYXV0aG9yaXplIGNvbmZpZyBzZXR0aW5ncyBpbnRvIGFuIGF1dGhvcml6YXRpb24gZnVuY3Rpb24gdGhhdFxuICAgKiBjYW4gYmUgcGFzc2VkIHRvIGBoYW5kbGVBdXRob3JpemF0aW9uKClgLlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW58ZnVuY3Rpb258c3RyaW5nfHN0cmluZ1tdfSBhdXRob3JpemUgdGhlIGF1dGhvcml6ZSBjb25maWdcbiAgICogc2V0dGluZ3NcbiAgICogQHJldHVybiB7ZnVuY3Rpb259IHRoZSBhdXRob3JpemF0aW9uIGZ1bmN0aW9uXG4gICAqL1xuICBwcm9jZXNzQXV0aG9yaXplKGF1dGhvcml6ZSkge1xuICAgIGlmIChhdXRob3JpemUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuICgpID0+IHRydWVcbiAgICB9IGVsc2UgaWYgKGlzQm9vbGVhbihhdXRob3JpemUpKSB7XG4gICAgICByZXR1cm4gKCkgPT4gYXV0aG9yaXplXG4gICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKGF1dGhvcml6ZSkpIHtcbiAgICAgIHJldHVybiBhc3luYyAoY3R4LCBtZW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgYXV0aG9yaXplKGN0eCwgbWVtYmVyKVxuICAgICAgICAvLyBQYXNzIHJlcyB0aHJvdWdoIGBwcm9jZXNzQXV0aG9yaXplKClgIHRvIHN1cHBvcnQgc3RyaW5ncyAmIGFycmF5cy5cbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0F1dGhvcml6ZShyZXMpKGN0eCwgbWVtYmVyKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcoYXV0aG9yaXplKSB8fCBpc0FycmF5KGF1dGhvcml6ZSkpIHtcbiAgICAgIHJldHVybiBhc3luYyAoY3R4LCBtZW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgeyB1c2VyIH0gPSBjdHguc3RhdGVcbiAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdmFsdWVzID0gYXNBcnJheShhdXRob3JpemUpXG4gICAgICAgIC8vIEZvciAnJG93bmVyJywgZmV0Y2ggYG1lbWJlcmAgbm93IGluIGNhc2UgdGhlIGFjdGlvbiBwYXJhbWV0ZXJzXG4gICAgICAgIC8vIGRpZG4ndCBhbHJlYWR5IHJlcXVlc3QgaXQ6XG4gICAgICAgIGlmICghbWVtYmVyICYmIHZhbHVlcy5pbmNsdWRlcygnJG93bmVyJykpIHtcbiAgICAgICAgICBtZW1iZXIgPSBhd2FpdCB0aGlzLmdldE1lbWJlcihjdHgpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICEhdmFsdWVzLmZpbmQoXG4gICAgICAgIC8vIFN1cHBvcnQgMyBzY2VuYXJpb3M6XG4gICAgICAgIC8vIC0gJyRzZWxmJzogVGhlIHJlcXVlc3RlZCBtZW1iZXIgaXMgY2hlY2tlZCBhZ2FpbnN0IGBjdHguc3RhdGUudXNlcmBcbiAgICAgICAgLy8gICBhbmQgdGhlIGFjdGlvbiBpcyBvbmx5IGF1dGhvcml6ZWQgaWYgaXQgbWF0Y2hlcyB0aGUgbWVtYmVyLlxuICAgICAgICAvLyAtICckb3duZXInOiBUaGUgbWVtYmVyIGlzIGFza2VkIGlmIGl0IGlzIG93bmVkIGJ5IGBjdHguc3RhdGUudXNlcmBcbiAgICAgICAgLy8gICB0aHJvdWdoIHRoZSBvcHRpb25hbCBgTW9kZWwuJGhhc093bmVyKClgIG1ldGhvZC5cbiAgICAgICAgLy8gLSBhbnkgc3RyaW5nOiAgYGN0eC5zdGF0ZS51c2VyYCBpcyBjaGVja2VkIGZvciB0aGlzIHJvbGUgdGhyb3VnaFxuICAgICAgICAvLyAgIHRoZSBvdmVycmlkYWJsZSBgVXNlck1vZGVsLmhhc1JvbGUoKWAgbWV0aG9kLlxuICAgICAgICAgIHZhbHVlID0+IHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gJyRzZWxmJ1xuICAgICAgICAgICAgICA/IHVzZXIuY29uc3RydWN0b3IgPT09IHRoaXMubW9kZWxDbGFzcyAmJlxuICAgICAgICAgICAgICBlcXVhbHModXNlci4kaWQoKSwgY3R4Lm1lbWJlcklkKVxuICAgICAgICAgICAgICA6IHZhbHVlID09PSAnJG93bmVyJ1xuICAgICAgICAgICAgICAgID8gbWVtYmVyPy4kaGFzT3duZXI/Lih1c2VyKVxuICAgICAgICAgICAgICAgIDogdXNlci4kaGFzUm9sZSh2YWx1ZSlcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IENvbnRyb2xsZXJFcnJvcih0aGlzLFxuICAgICAgICBgVW5zdXBwb3J0ZWQgYXV0aG9yaXplIHNldHRpbmc6ICcke2F1dGhvcml6ZX0nYFxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGRlc2NyaWJlQXV0aG9yaXplKGF1dGhvcml6ZSkge1xuICAgIHJldHVybiBpc0Z1bmN0aW9uKGF1dGhvcml6ZSlcbiAgICAgID8gZGVzY3JpYmVGdW5jdGlvbihhdXRob3JpemUpXG4gICAgICA6IGlzU3RyaW5nKGF1dGhvcml6ZSlcbiAgICAgICAgPyBgJyR7YXV0aG9yaXplfSdgXG4gICAgICAgIDogaXNBcnJheShhdXRob3JpemUpXG4gICAgICAgICAgPyBgWyR7YXV0aG9yaXplLm1hcCh2YWx1ZSA9PiBgJyR7dmFsdWV9J2ApLmpvaW4oJywgJyl9XWBcbiAgICAgICAgICA6ICcnXG4gIH1cblxuICBhc3luYyBoYW5kbGVBdXRob3JpemF0aW9uKGF1dGhvcml6YXRpb24sIGN0eCwgbWVtYmVyKSB7XG4gICAgY29uc3Qgb2sgPSBhd2FpdCBhdXRob3JpemF0aW9uKGN0eCwgbWVtYmVyKVxuICAgIGlmIChvayAhPT0gdHJ1ZSkge1xuICAgICAgdGhyb3cgbmV3IEF1dGhvcml6YXRpb25FcnJvcigpXG4gICAgfVxuICB9XG5cbiAgbG9nKHN0ciwgaW5kZW50ID0gMCkge1xuICAgIGlmICh0aGlzLmxvZ2dpbmcpIHtcbiAgICAgIGNvbnNvbGUuaW5mbyhgJHsnICAnLnJlcGVhdChpbmRlbnQpfSR7c3RyfWApXG4gICAgfVxuICB9XG59XG5cbkV2ZW50RW1pdHRlci5taXhpbihDb250cm9sbGVyLnByb3RvdHlwZSlcblxuY29uc3QgaW5oZXJpdGFuY2VNYXAgPSBuZXcgV2Vha01hcCgpXG5cbmZ1bmN0aW9uIHNldHVwSGFuZGxlckZyb21PYmplY3Qob2JqZWN0LCBhY3Rpb25zKSB7XG4gIGNvbnN0IHtcbiAgICBoYW5kbGVyLFxuICAgIGFjdGlvbixcbiAgICBhdXRob3JpemUsXG4gICAgcGFyYW1ldGVycyxcbiAgICByZXR1cm5zLFxuICAgIHNjb3BlLFxuICAgIHRyYW5zYWN0ZWRcbiAgfSA9IG9iamVjdFxuXG4gIC8vIEluIG9yZGVyIHRvIHN1cG9ydCBgc3VwZXJgIGNhbGxzIGluIHRoZSBgaGFuZGxlcmAgZnVuY3Rpb24gaW4gb2JqZWN0XG4gIC8vIG5vdGF0aW9uLCBkZXBsb3kgdGhpcyBjcmF6eSBKUyBzb3JjZXJ5OlxuICBPYmplY3Quc2V0UHJvdG90eXBlT2Yob2JqZWN0LCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYWN0aW9ucykpXG5cbiAgaGFuZGxlci5hdXRob3JpemUgPSBhdXRob3JpemVcbiAgaGFuZGxlci50cmFuc2FjdGVkID0gdHJhbnNhY3RlZFxuXG4gIGlmIChhY3Rpb24pIHtcbiAgICBjb25zdCBbdmVyYiwgcGF0aF0gPSBhc0FycmF5KGFjdGlvbilcbiAgICBoYW5kbGVyLnZlcmIgPSB2ZXJiXG4gICAgaGFuZGxlci5wYXRoID0gcGF0aFxuICB9XG5cbiAgaWYgKHBhcmFtZXRlcnMpIHtcbiAgICBjb25zdCBbX3BhcmFtZXRlcnMsIG9wdGlvbnNdID0gcGFyYW1ldGVyc1xuICAgIGNvbnN0IGhhc09wdGlvbnMgPSBpc0FycmF5KF9wYXJhbWV0ZXJzKVxuICAgIGhhbmRsZXIucGFyYW1ldGVycyA9IGhhc09wdGlvbnMgPyBfcGFyYW1ldGVycyA6IHBhcmFtZXRlcnNcblxuICAgIC8vIElmIHZhbGlkYXRpb24gb3B0aW9ucyBhcmUgcHJvdmlkZWQsIGV4cG9zZSB0aGVtIHRocm91Z2hcbiAgICAvLyBgaGFuZGxlci5vcHRpb25zLnBhcmFtZXRlcnNgLCBzZWUgQ29udHJvbGxlckFjdGlvblxuICAgIGlmIChoYXNPcHRpb25zKSB7XG4gICAgICBoYW5kbGVyLm9wdGlvbnMgPSB7XG4gICAgICAgIC4uLmhhbmRsZXIub3B0aW9ucyxcbiAgICAgICAgcGFyYW1ldGVyczogb3B0aW9uc1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChyZXR1cm5zKSB7XG4gICAgY29uc3QgW19yZXR1cm5zLCBvcHRpb25zXSA9IGFzQXJyYXkocmV0dXJucylcbiAgICBoYW5kbGVyLnJldHVybnMgPSBfcmV0dXJuc1xuXG4gICAgLy8gSWYgdmFsaWRhdGlvbiBvcHRpb25zIGFyZSBwcm92aWRlZCwgZXhwb3NlIHRoZW0gdGhyb3VnaFxuICAgIC8vIGBoYW5kbGVyLm9wdGlvbnMucmV0dXJuc2AsIHNlZSBDb250cm9sbGVyQWN0aW9uXG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgIGhhbmRsZXIub3B0aW9ucyA9IHtcbiAgICAgICAgLi4uaGFuZGxlci5vcHRpb25zLFxuICAgICAgICBwYXJhbWV0ZXJzOiBvcHRpb25zXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHNjb3BlKSB7XG4gICAgaGFuZGxlci5zY29wZSA9IGFzQXJyYXkoc2NvcGUpXG4gIH1cblxuICByZXR1cm4gaGFuZGxlclxufVxuIl19