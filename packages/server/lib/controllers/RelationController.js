"use strict";

exports.__esModule = true;
exports.RelationController = void 0;

var _chalk = _interopRequireDefault(require("chalk"));

var _errors = require("../errors");

var _CollectionController = require("./CollectionController");

var _utils = require("../utils");

var _utils2 = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class RelationController extends _CollectionController.CollectionController {
  constructor(parent, object, relationInstance, relationDefinition) {
    super(parent.app, null);
    this.collection = this.toCoreActions({});
    this.member = this.toCoreActions({});

    if (parent.modelClass !== relationInstance.ownerModelClass) {
      throw new _errors.ControllerError(parent, `Invalid parent controller for relation '${relationInstance.name}'.`);
    }

    this.parent = parent;
    this.object = object;
    this.relationInstance = relationInstance;
    this.relationDefinition = relationDefinition;
    this.name = relationInstance.name;
    this.modelClass = relationInstance.relatedModelClass;
    this.isOneToOne = relationInstance.isOneToOne();
    this.relate = !relationDefinition.owner;
    this.unrelate = !relationDefinition.owner;
    this.graph = parent.graph;
    this.transacted = parent.transacted;
    this.level = parent.level + 1;

    if (parent.scope) {
      this.scope = (0, _utils2.asArray)(parent.scope).filter(scope => (0, _utils.getScope)(scope).graph);
    }

    this.path = this.app.normalizePath(this.name);
    this.url = `${this.parent.url}/${this.parent.getPath('member', this.path)}`;
    this.log(`${_chalk.default.blue(this.path)}${_chalk.default.white(':')}`, this.level);

    for (const key in this.object) {
      if (!['relation', 'member', 'allow'].includes(key)) {
        this[key] = this.object[key];
      }
    }

    this.setup(false);
  }

  inheritValues(type) {
    const values = (0, _utils.setupPropertyInheritance)(this.object, type === 'collection' ? 'relation' : type, super.inheritValues(type));
    return values;
  }

  async execute(ctx, execute) {
    const id = this.parent.getMemberId(ctx);
    return this.parent.execute(ctx, async (parentQuery, trx) => {
      const model = await parentQuery.ignoreScope().findById(id).throwIfNotFound().select(...this.relationInstance.ownerProp.props);
      const query = model.$relatedQuery(this.relationInstance.name, trx);
      this.setupQuery(query);
      return execute(query, trx);
    });
  }

}

exports.RelationController = RelationController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9SZWxhdGlvbkNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiUmVsYXRpb25Db250cm9sbGVyIiwiQ29sbGVjdGlvbkNvbnRyb2xsZXIiLCJjb25zdHJ1Y3RvciIsInBhcmVudCIsIm9iamVjdCIsInJlbGF0aW9uSW5zdGFuY2UiLCJyZWxhdGlvbkRlZmluaXRpb24iLCJhcHAiLCJjb2xsZWN0aW9uIiwidG9Db3JlQWN0aW9ucyIsIm1lbWJlciIsIm1vZGVsQ2xhc3MiLCJvd25lck1vZGVsQ2xhc3MiLCJDb250cm9sbGVyRXJyb3IiLCJuYW1lIiwicmVsYXRlZE1vZGVsQ2xhc3MiLCJpc09uZVRvT25lIiwicmVsYXRlIiwib3duZXIiLCJ1bnJlbGF0ZSIsImdyYXBoIiwidHJhbnNhY3RlZCIsImxldmVsIiwic2NvcGUiLCJmaWx0ZXIiLCJwYXRoIiwibm9ybWFsaXplUGF0aCIsInVybCIsImdldFBhdGgiLCJsb2ciLCJjaGFsayIsImJsdWUiLCJ3aGl0ZSIsImtleSIsImluY2x1ZGVzIiwic2V0dXAiLCJpbmhlcml0VmFsdWVzIiwidHlwZSIsInZhbHVlcyIsImV4ZWN1dGUiLCJjdHgiLCJpZCIsImdldE1lbWJlcklkIiwicGFyZW50UXVlcnkiLCJ0cngiLCJtb2RlbCIsImlnbm9yZVNjb3BlIiwiZmluZEJ5SWQiLCJ0aHJvd0lmTm90Rm91bmQiLCJzZWxlY3QiLCJvd25lclByb3AiLCJwcm9wcyIsInF1ZXJ5IiwiJHJlbGF0ZWRRdWVyeSIsInNldHVwUXVlcnkiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFTyxNQUFNQSxrQkFBTixTQUFpQ0MsMENBQWpDLENBQXNEO0FBQzNEQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBU0MsTUFBVCxFQUFpQkMsZ0JBQWpCLEVBQW1DQyxrQkFBbkMsRUFBdUQ7QUFDaEUsVUFBTUgsTUFBTSxDQUFDSSxHQUFiLEVBQWtCLElBQWxC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LEtBQUssR0FBRyxNQUFNRixXQUFXLENBQzVCRyxXQURpQixHQUVqQkMsUUFGaUIsQ0FFUk4sRUFGUSxFQUdqQk8sZUFIaUIsR0FLakJDLE1BTGlCLENBS1YsR0FBRyxLQUFLNUMsZ0JBQUwsQ0FBc0I2QyxTQUF0QixDQUFnQ0MsS0FMekIsQ0FBcEI7QUFRQSxZQUFNQyxLQUFLLEdBQUdQLEtBQUssQ0FBQ1EsYUFBTixDQUFvQixLQUFLaEQsZ0JBQUwsQ0FBc0JTLElBQTFDLEVBQWdEOEIsR0FBaEQsQ0FBZDtBQUNBLFdBQUtVLFVBQUwsQ0FBZ0JGLEtBQWhCO0FBQ0EsYUFBT2IsT0FBTyxDQUFDYSxLQUFELEVBQVFSLEdBQVIsQ0FBZDtBQUNELEtBYkksQ0FBUDtBQWVEOztBQWxGMEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnXG5pbXBvcnQgeyBDb250cm9sbGVyRXJyb3IgfSBmcm9tICdAL2Vycm9ycydcbmltcG9ydCB7IENvbGxlY3Rpb25Db250cm9sbGVyIH0gZnJvbSAnLi9Db2xsZWN0aW9uQ29udHJvbGxlcidcbmltcG9ydCB7IHNldHVwUHJvcGVydHlJbmhlcml0YW5jZSwgZ2V0U2NvcGUgfSBmcm9tICdAL3V0aWxzJ1xuaW1wb3J0IHsgYXNBcnJheSB9IGZyb20gJ0BkaXRvanMvdXRpbHMnXG5cbmV4cG9ydCBjbGFzcyBSZWxhdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb2xsZWN0aW9uQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKHBhcmVudCwgb2JqZWN0LCByZWxhdGlvbkluc3RhbmNlLCByZWxhdGlvbkRlZmluaXRpb24pIHtcbiAgICBzdXBlcihwYXJlbnQuYXBwLCBudWxsKVxuICAgIGlmIChwYXJlbnQubW9kZWxDbGFzcyAhPT0gcmVsYXRpb25JbnN0YW5jZS5vd25lck1vZGVsQ2xhc3MpIHtcbiAgICAgIHRocm93IG5ldyBDb250cm9sbGVyRXJyb3IocGFyZW50LFxuICAgICAgICBgSW52YWxpZCBwYXJlbnQgY29udHJvbGxlciBmb3IgcmVsYXRpb24gJyR7cmVsYXRpb25JbnN0YW5jZS5uYW1lfScuYClcbiAgICB9XG4gICAgdGhpcy5wYXJlbnQgPSBwYXJlbnRcbiAgICB0aGlzLm9iamVjdCA9IG9iamVjdFxuICAgIHRoaXMucmVsYXRpb25JbnN0YW5jZSA9IHJlbGF0aW9uSW5zdGFuY2VcbiAgICB0aGlzLnJlbGF0aW9uRGVmaW5pdGlvbiA9IHJlbGF0aW9uRGVmaW5pdGlvblxuICAgIHRoaXMubmFtZSA9IHJlbGF0aW9uSW5zdGFuY2UubmFtZVxuICAgIHRoaXMubW9kZWxDbGFzcyA9IHJlbGF0aW9uSW5zdGFuY2UucmVsYXRlZE1vZGVsQ2xhc3NcbiAgICB0aGlzLmlzT25lVG9PbmUgPSByZWxhdGlvbkluc3RhbmNlLmlzT25lVG9PbmUoKVxuICAgIHRoaXMucmVsYXRlID0gIXJlbGF0aW9uRGVmaW5pdGlvbi5vd25lclxuICAgIHRoaXMudW5yZWxhdGUgPSAhcmVsYXRpb25EZWZpbml0aW9uLm93bmVyXG4gICAgLy8gSW5oZXJpdCBwYXJlbnQgdmFsdWVzOlxuICAgIHRoaXMuZ3JhcGggPSBwYXJlbnQuZ3JhcGhcbiAgICB0aGlzLnRyYW5zYWN0ZWQgPSBwYXJlbnQudHJhbnNhY3RlZFxuICAgIHRoaXMubGV2ZWwgPSBwYXJlbnQubGV2ZWwgKyAxXG4gICAgaWYgKHBhcmVudC5zY29wZSkge1xuICAgICAgLy8gSW5oZXJpdCBvbmx5IHRoZSBncmFwaCBzY29wZXMgc2luY2UgaXQncyBpbiBpdHMgbmF0dXJlIHRvIHByb3BhZ2F0ZSB0b1xuICAgICAgLy8gcmVsYXRpb25zOlxuICAgICAgdGhpcy5zY29wZSA9IGFzQXJyYXkocGFyZW50LnNjb3BlKS5maWx0ZXIoc2NvcGUgPT4gZ2V0U2NvcGUoc2NvcGUpLmdyYXBoKVxuICAgIH1cbiAgICAvLyBJbml0aWFsaXplOlxuICAgIHRoaXMucGF0aCA9IHRoaXMuYXBwLm5vcm1hbGl6ZVBhdGgodGhpcy5uYW1lKVxuICAgIHRoaXMudXJsID0gYCR7dGhpcy5wYXJlbnQudXJsfS8ke3RoaXMucGFyZW50LmdldFBhdGgoJ21lbWJlcicsIHRoaXMucGF0aCl9YFxuICAgIHRoaXMubG9nKGAke2NoYWxrLmJsdWUodGhpcy5wYXRoKX0ke2NoYWxrLndoaXRlKCc6Jyl9YCwgdGhpcy5sZXZlbClcbiAgICAvLyBDb3B5IG92ZXIgYWxsIGZpZWxkcyBpbiB0aGUgcmVsYXRpb24gb2JqZWN0IGV4Y2VwdCB0aGUgb25lcyB0aGF0IGFyZVxuICAgIC8vIGdvaW5nIHRvIGJlIGluaGVyaXRlZCBpbiBgc2V0dXAoKWAgKHJlbGF0aW9uLCBtZW1iZXIsIGFsbG93KSwgZm9yXG4gICAgLy8gc2V0dGluZ3MgbGlrZSBzY29wZSwgZXRjLlxuICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMub2JqZWN0KSB7XG4gICAgICBpZiAoIVsncmVsYXRpb24nLCAnbWVtYmVyJywgJ2FsbG93J10uaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICB0aGlzW2tleV0gPSB0aGlzLm9iamVjdFtrZXldXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2V0dXAoZmFsc2UpXG4gIH1cblxuICAvLyBAb3ZlcnJpZGVcbiAgaW5oZXJpdFZhbHVlcyh0eXBlKSB7XG4gICAgLy8gU2luY2UgUmVsYXRpb25Db250cm9sbGVyIGFyZSBtYXBwZWQgdG8gbmVzdGVkIGByZWxhdGlvbnNgIG9iamVjdHMgaW5cbiAgICAvLyBNb2RlbENvbnRyb2xsZXIgcGFyZW50cyBhbmQgYXJlIG5ldmVyIGV4dGVuZGVkIGRpcmVjdGx5IGluIHRoZSB1c2VyIGxhbmRcbiAgICAvLyBjb2RlLCBpbmhlcml0YW5jZSB3b3JrcyBkaWZmZXJlbnRseSBoZXJlIHRoYW4gb24gdGhlIG90aGVyIGNvbnRyb2xsZXJzOlxuICAgIC8vIE1vZGVsQ29udHJvbGxlciBhbHJlYWR5IHNldHMgdXAgaW5oZXJpdGFuY2UgZm9yIGl0cyBgcmVsYXRpb25zYCBvYmplY3RcbiAgICAvLyBhbmQgaXRzIGVudHJpZXMgZm9yIGVhY2ggcmVsYXRpb24gZnJvbSB3aGljaCBgb2JqZWN0YCBpcyByZXRyaWV2ZWQuXG4gICAgLy8gQnV0IHRoZSBhY3Rpb25zIHBlciByZWxhdGlvbiBzdGlsbCBuZWVkIHRvIGhhdmUgaW5oZXJpdGFuY2Ugc2V0IHVwLFxuICAgIC8vIHVzaW5nIHRoZSB2YWx1ZXMgaW4gaXRzIHBhcmVudCBjb250cm9sbGVyIGFuZCBwb3RlbnRpYWwgc3VwZXItY2xhc3NlcyxcbiAgICAvLyBmYWxsaW5nIGJhY2sgb24gdGhlIGRlZmluaXRpb25zIGluIFJlbGF0aW9uQ29udHJvbGxlciBhbmQgaXRzIGluaGVyaXRlZFxuICAgIC8vIHZhbHVlcyBmcm9tIE1vZGVsQ29udHJvbGxlci5cbiAgICBjb25zdCB2YWx1ZXMgPSBzZXR1cFByb3BlcnR5SW5oZXJpdGFuY2UoXG4gICAgICB0aGlzLm9iamVjdCxcbiAgICAgIC8vIE9uIHRoZSByZWxhdGlvbiBvYmplY3RzLCB0aGUgYGNvbGxlY3Rpb25gIGFjdGlvbnMgYXJlIHN0b3JlZCBpbiBhXG4gICAgICAvLyBgcmVsYXRpb25gIG9iamVjdCwgdG8gbWFrZSBzZW5zZSBib3RoIGZvciBvbmUtIGFuZCBtYW55LXJlbGF0aW9uczpcbiAgICAgIHR5cGUgPT09ICdjb2xsZWN0aW9uJyA/ICdyZWxhdGlvbicgOiB0eXBlLFxuICAgICAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciBSZWxhdGlvbkNvbnRyb2xsZXIncyBvdmVycmlkZSBvZiBgY29sbGVjdGlvbmBcbiAgICAgIC8vIGFuZCBgbWVtYmVyYCBvYmplY3RzLCBhbmQgdXNlIGl0IGFzIHRoZSBiYXNlIGZvciBmdXJ0aGVyIGluaGVyaXRhbmNlLlxuICAgICAgLy8gTk9URTogQ3VycmVudGx5IHRoZXkncmUgZW1wdHksIGJ1dCB0aGV5IGNvdWxkIGFsbG93IGxvY2FsIG92ZXJyaWRlcy5cbiAgICAgIHN1cGVyLmluaGVyaXRWYWx1ZXModHlwZSlcbiAgICApXG4gICAgcmV0dXJuIHZhbHVlc1xuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIGFzeW5jIGV4ZWN1dGUoY3R4LCBleGVjdXRlKSB7XG4gICAgY29uc3QgaWQgPSB0aGlzLnBhcmVudC5nZXRNZW1iZXJJZChjdHgpXG4gICAgcmV0dXJuIHRoaXMucGFyZW50LmV4ZWN1dGUoY3R4LFxuICAgICAgYXN5bmMgKHBhcmVudFF1ZXJ5LCB0cngpID0+IHtcbiAgICAgICAgY29uc3QgbW9kZWwgPSBhd2FpdCBwYXJlbnRRdWVyeVxuICAgICAgICAgIC5pZ25vcmVTY29wZSgpXG4gICAgICAgICAgLmZpbmRCeUlkKGlkKVxuICAgICAgICAgIC50aHJvd0lmTm90Rm91bmQoKVxuICAgICAgICAgIC8vIEV4cGxpY2l0bHkgb25seSBzZWxlY3QgdGhlIGZvcmVpZ24ga2V5IGlkcyBmb3IgbW9yZSBlZmZpY2llbmN5LlxuICAgICAgICAgIC5zZWxlY3QoLi4udGhpcy5yZWxhdGlvbkluc3RhbmNlLm93bmVyUHJvcC5wcm9wcylcbiAgICAgICAgLy8gVGhpcyBpcyB0aGUgc2FtZSBhcyBgTW9kZWxDb250cm9sbGVyLmV4ZWN1dGUoKWAsIGV4Y2VwdCBmb3IgdGhlIHVzZVxuICAgICAgICAvLyBvZiBgbW9kZWwuJHJlbGF0ZWRRdWVyeSgpYCBpbnN0ZWFkIG9mIGBtb2RlbENsYXNzLnF1ZXJ5KClgOlxuICAgICAgICBjb25zdCBxdWVyeSA9IG1vZGVsLiRyZWxhdGVkUXVlcnkodGhpcy5yZWxhdGlvbkluc3RhbmNlLm5hbWUsIHRyeClcbiAgICAgICAgdGhpcy5zZXR1cFF1ZXJ5KHF1ZXJ5KVxuICAgICAgICByZXR1cm4gZXhlY3V0ZShxdWVyeSwgdHJ4KVxuICAgICAgfVxuICAgIClcbiAgfVxuXG4gIGNvbGxlY3Rpb24gPSB0aGlzLnRvQ29yZUFjdGlvbnMoe1xuICB9KVxuXG4gIG1lbWJlciA9IHRoaXMudG9Db3JlQWN0aW9ucyh7XG4gIH0pXG59XG4iXX0=