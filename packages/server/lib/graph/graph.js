"use strict";

exports.__esModule = true;
exports.ensureModel = ensureModel;
exports.ensureModelArray = ensureModelArray;
exports.walkGraph = walkGraph;
exports.filterGraph = filterGraph;
exports.populateGraph = populateGraph;

require("core-js/modules/esnext.map.delete-all.js");

require("core-js/modules/esnext.map.every.js");

require("core-js/modules/esnext.map.filter.js");

require("core-js/modules/esnext.map.find.js");

require("core-js/modules/esnext.map.find-key.js");

require("core-js/modules/esnext.map.includes.js");

require("core-js/modules/esnext.map.key-of.js");

require("core-js/modules/esnext.map.map-keys.js");

require("core-js/modules/esnext.map.map-values.js");

require("core-js/modules/esnext.map.merge.js");

require("core-js/modules/esnext.map.reduce.js");

require("core-js/modules/esnext.map.some.js");

require("core-js/modules/esnext.map.update.js");

var _utils = require("@ditojs/utils");

var _query = require("../query");

var _expression = require("./expression.js");

function ensureModel(modelClass, model, options) {
  return !model ? null : model instanceof modelClass ? parseRelationsIntoModelInstances(model, model, options) : modelClass.fromJson(model, options);
}

function ensureModelArray(modelClass, data, options) {
  return data ? (0, _utils.asArray)(data).map(model => ensureModel(modelClass, model, options)) : [];
}

function parseRelationsIntoModelInstances(model, json, options = {}) {
  if (!options.cache) {
    options = { ...options,
      cache: new Map()
    };
  }

  options.cache.set(json, model);

  for (const relationName of model.constructor.getRelationNames()) {
    const jsonRelation = json[relationName];

    if (jsonRelation !== undefined) {
      const relation = model.constructor.getRelation(relationName);
      const parsedRelation = parseRelation(jsonRelation, relation, options);

      if (parsedRelation !== jsonRelation) {
        model[relation.name] = parsedRelation;
      }
    }
  }

  return model;
}

function parseRelation(json, relation, options) {
  return (0, _utils.isArray)(json) ? parseRelationArray(json, relation, options) : parseRelationObject(json, relation, options);
}

function parseRelationArray(json, relation, options) {
  const models = new Array(json.length);
  let changed = false;

  for (let i = 0, l = json.length; i < l; i++) {
    const model = parseRelationObject(json[i], relation, options);
    changed = changed || model !== json[i];
    models[i] = model;
  }

  return changed ? models : json;
}

function parseRelationObject(json, relation, options) {
  if ((0, _utils.isObject)(json)) {
    const modelClass = relation.relatedModelClass;
    let model = options.cache.get(json);

    if (model === undefined) {
      if (json instanceof modelClass) {
        model = parseRelationsIntoModelInstances(json, json, options);
      } else {
        model = modelClass.fromJson(json, options);
      }
    }

    return model;
  }

  return json;
}

function walkGraph(data, callback, path = []) {
  if ((0, _utils.isObject)(data) || (0, _utils.isArray)(data)) {
    for (const [key, value] of Object.entries(data)) {
      const dataPath = [...path, key];
      callback(value, dataPath, data, key);
      walkGraph(value, callback, dataPath);
    }
  }
}

function filterGraph(rootModelClass, modelGraph, expr) {
  expr = _query.QueryBuilder.parseRelationExpression(expr);
  const models = ensureModelArray(rootModelClass, modelGraph, {
    skipValidation: true
  });

  for (const model of models) {
    if (model) {
      const relations = model.constructor.getRelations();

      for (const key of Object.keys(model)) {
        const relation = relations[key];

        if (relation) {
          const child = expr[key];

          if (child) {
            filterGraph(relation.relatedModelClass, model[key], child);
          } else {
            delete model[key];
          }
        }
      }
    }
  }

  return modelGraph;
}

async function populateGraph(rootModelClass, graph, expr, trx) {
  expr = _query.QueryBuilder.parseRelationExpression(expr);
  const grouped = {};

  const addToGroup = (item, modelClass, isReference, modify, relation, expr) => {
    const id = item.$id();

    if (id != null) {
      const key = `${modelClass.name}_${modify}_${expr || ''}`;
      const group = grouped[key] || (grouped[key] = {
        modelClass,
        modify,
        relation,
        expr,
        targets: [],
        ids: [],
        modelsById: {}
      });
      group.targets.push({
        item,
        isReference
      });
      group.ids.push(id);
    }
  };

  for (const path of (0, _expression.collectExpressionPaths)(expr)) {
    let modelClass = rootModelClass;
    const modelClasses = [];
    let lastModify;

    for (const entry of path) {
      modelClasses.push(modelClass);
      modelClass = modelClass.getRelation(entry.relation).relatedModelClass;
      lastModify = entry.modify;
    }

    for (const model of (0, _utils.asArray)(graph)) {
      if (model) {
        let items = (0, _utils.asArray)(model);

        for (let i = 0, l = path.length; i < l; i++) {
          if (items.length === 0) break;
          const {
            relation
          } = path[i];
          const modelClass = modelClasses[i];
          items = items.reduce((items, item) => {
            item = ensureModel(modelClass, item, {
              skipValidation: true
            });
            let add = false;
            const isReference = modelClass.isReference(item);

            if (isReference) {
              add = true;
            } else {
              const value = item[relation];

              if (value != null) {
                items.push(...(0, _utils.asArray)(value));
              } else if (value === undefined) {
                add = true;
              }
            }

            if (add) {
              const modify = i > 0 ? path[i - 1].modify : null;
              const expr = (0, _expression.expressionPathToString)(path, i);
              addToGroup(item, modelClass, isReference, modify, relation, expr);
            }

            return items;
          }, []);
        }

        for (const item of items) {
          if (modelClass.isReference(item)) {
            addToGroup(item, modelClass, true, lastModify);
          }
        }
      }
    }
  }

  const groups = Object.values(grouped).filter(({
    ids
  }) => ids.length > 0);

  if (groups.length > 0) {
    await Promise.all(groups.map(async ({
      modelClass,
      modify,
      expr,
      ids,
      modelsById
    }) => {
      const query = modelClass.query(trx).findByIds(ids).modify(modify);

      if (expr) {
        query.withGraph(expr);
      }

      const models = await query;

      for (const model of models) {
        modelsById[model.$id()] = model;
      }
    }));

    for (const {
      targets,
      modelsById,
      relation
    } of groups) {
      for (const {
        item,
        isReference
      } of targets) {
        const model = modelsById[item.$id()];

        if (model) {
          if (isReference) {
            Object.assign(item, model);
          } else {
            item[relation] = model[relation];
          }
        }
      }
    }
  }

  return graph;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncmFwaC9ncmFwaC5qcyJdLCJuYW1lcyI6WyJlbnN1cmVNb2RlbCIsIm1vZGVsQ2xhc3MiLCJtb2RlbCIsIm9wdGlvbnMiLCJwYXJzZVJlbGF0aW9uc0ludG9Nb2RlbEluc3RhbmNlcyIsImZyb21Kc29uIiwiZW5zdXJlTW9kZWxBcnJheSIsImRhdGEiLCJtYXAiLCJqc29uIiwiY2FjaGUiLCJNYXAiLCJzZXQiLCJyZWxhdGlvbk5hbWUiLCJjb25zdHJ1Y3RvciIsImdldFJlbGF0aW9uTmFtZXMiLCJqc29uUmVsYXRpb24iLCJ1bmRlZmluZWQiLCJyZWxhdGlvbiIsImdldFJlbGF0aW9uIiwicGFyc2VkUmVsYXRpb24iLCJwYXJzZVJlbGF0aW9uIiwibmFtZSIsInBhcnNlUmVsYXRpb25BcnJheSIsInBhcnNlUmVsYXRpb25PYmplY3QiLCJtb2RlbHMiLCJBcnJheSIsImxlbmd0aCIsImNoYW5nZWQiLCJpIiwibCIsInJlbGF0ZWRNb2RlbENsYXNzIiwiZ2V0Iiwid2Fsa0dyYXBoIiwiY2FsbGJhY2siLCJwYXRoIiwia2V5IiwidmFsdWUiLCJPYmplY3QiLCJlbnRyaWVzIiwiZGF0YVBhdGgiLCJmaWx0ZXJHcmFwaCIsInJvb3RNb2RlbENsYXNzIiwibW9kZWxHcmFwaCIsImV4cHIiLCJRdWVyeUJ1aWxkZXIiLCJwYXJzZVJlbGF0aW9uRXhwcmVzc2lvbiIsInNraXBWYWxpZGF0aW9uIiwicmVsYXRpb25zIiwiZ2V0UmVsYXRpb25zIiwia2V5cyIsImNoaWxkIiwicG9wdWxhdGVHcmFwaCIsImdyYXBoIiwidHJ4IiwiZ3JvdXBlZCIsImFkZFRvR3JvdXAiLCJpdGVtIiwiaXNSZWZlcmVuY2UiLCJtb2RpZnkiLCJpZCIsIiRpZCIsImdyb3VwIiwidGFyZ2V0cyIsImlkcyIsIm1vZGVsc0J5SWQiLCJwdXNoIiwibW9kZWxDbGFzc2VzIiwibGFzdE1vZGlmeSIsImVudHJ5IiwiaXRlbXMiLCJyZWR1Y2UiLCJhZGQiLCJncm91cHMiLCJ2YWx1ZXMiLCJmaWx0ZXIiLCJQcm9taXNlIiwiYWxsIiwicXVlcnkiLCJmaW5kQnlJZHMiLCJ3aXRoR3JhcGgiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR08sU0FBU0EsV0FBVCxDQUFxQkMsVUFBckIsRUFBaUNDLEtBQWpDLEVBQXdDQyxPQUF4QyxFQUFpRDtBQUN0RCxTQUFPLENBQUNELEtBQUQsR0FDSCxJQURHLEdBRUhBLEtBQUssWUFBWUQsVUFBakIsR0FDRUcsZ0NBQWdDLENBQUNGLEtBQUQsRUFBUUEsS0FBUixFQUFlQyxPQUFmLENBRGxDLEdBRUVGLFVBQVUsQ0FBQ0ksUUFBWCxDQUFvQkgsS0FBcEIsRUFBMkJDLE9BQTNCLENBSk47QUFLRDs7QUFHTSxTQUFTRyxnQkFBVCxDQUEwQkwsVUFBMUIsRUFBc0NNLElBQXRDLEVBQTRDSixPQUE1QyxFQUFxRDtBQUMxRCxTQUFPSSxJQUFJLEdBQ1Asb0JBQVFBLElBQVIsRUFBY0MsR0FBZCxDQUFrQk4sS0FBSyxJQUFJRixXQUFXLENBQUNDLFVBQUQsRUFBYUMsS0FBYixFQUFvQkMsT0FBcEIsQ0FBdEMsQ0FETyxHQUVQLEVBRko7QUFHRDs7QUFFRCxTQUFTQyxnQ0FBVCxDQUEwQ0YsS0FBMUMsRUFBaURPLElBQWpELEVBQXVETixPQUFPLEdBQUcsRUFBakUsRUFBcUU7QUFDbkUsTUFBSSxDQUFDQSxPQUFPLENBQUNPLEtBQWIsRUFBb0I7QUFDbEJQLElBQUFBLE9BQU8sR0FBRyxFQUFFLEdBQUdBLE9BQUw7QUFBY08sTUFBQUEsS0FBSyxFQUFFLElBQUlDLEdBQUo7QUFBckIsS0FBVjtBQUNEOztBQUNEUixFQUFBQSxPQUFPLENBQUNPLEtBQVIsQ0FBY0UsR0FBZCxDQUFrQkgsSUFBbEIsRUFBd0JQLEtBQXhCOztBQUVBLE9BQUssTUFBTVcsWUFBWCxJQUEyQlgsS0FBSyxDQUFDWSxXQUFOLENBQWtCQyxnQkFBbEIsRUFBM0IsRUFBaUU7QUFDL0QsVUFB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O0FBQ0EsWUFBSTNELEtBQUosRUFBVztBQUNULGNBQUl3RCxXQUFKLEVBQWlCO0FBRWZwQixZQUFBQSxNQUFNLENBQUMyQyxNQUFQLENBQWN4QixJQUFkLEVBQW9CdkQsS0FBcEI7QUFDRCxXQUhELE1BR087QUFFTHVELFlBQUFBLElBQUksQ0FBQ3ZDLFFBQUQsQ0FBSixHQUFpQmhCLEtBQUssQ0FBQ2dCLFFBQUQsQ0FBdEI7QUFDRDtBQUNGO0FBQ0Y7QUFDRjtBQUNGOztBQUVELFNBQU9tQyxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc09iamVjdCwgaXNBcnJheSwgYXNBcnJheSB9IGZyb20gJ0BkaXRvanMvdXRpbHMnXG5pbXBvcnQgeyBRdWVyeUJ1aWxkZXIgfSBmcm9tICdAL3F1ZXJ5J1xuaW1wb3J0IHsgY29sbGVjdEV4cHJlc3Npb25QYXRocywgZXhwcmVzc2lvblBhdGhUb1N0cmluZyB9IGZyb20gJy4vZXhwcmVzc2lvbi5qcydcblxuLy8gU2ltaWxhciB0byBPYmplY3Rpb24ncyBwcml2YXRlIGBtb2RlbENsYXNzLmVuc3VyZU1vZGVsKG1vZGVsKWA6XG5leHBvcnQgZnVuY3Rpb24gZW5zdXJlTW9kZWwobW9kZWxDbGFzcywgbW9kZWwsIG9wdGlvbnMpIHtcbiAgcmV0dXJuICFtb2RlbFxuICAgID8gbnVsbFxuICAgIDogbW9kZWwgaW5zdGFuY2VvZiBtb2RlbENsYXNzXG4gICAgICA/IHBhcnNlUmVsYXRpb25zSW50b01vZGVsSW5zdGFuY2VzKG1vZGVsLCBtb2RlbCwgb3B0aW9ucylcbiAgICAgIDogbW9kZWxDbGFzcy5mcm9tSnNvbihtb2RlbCwgb3B0aW9ucylcbn1cblxuLy8gU2ltaWxhciB0byBPYmplY3Rpb24ncyBwcml2YXRlIGBtb2RlbENsYXNzLmVuc3VyZU1vZGVsQXJyYXkoZGF0YSlgOlxuZXhwb3J0IGZ1bmN0aW9uIGVuc3VyZU1vZGVsQXJyYXkobW9kZWxDbGFzcywgZGF0YSwgb3B0aW9ucykge1xuICByZXR1cm4gZGF0YVxuICAgID8gYXNBcnJheShkYXRhKS5tYXAobW9kZWwgPT4gZW5zdXJlTW9kZWwobW9kZWxDbGFzcywgbW9kZWwsIG9wdGlvbnMpKVxuICAgIDogW11cbn1cblxuZnVuY3Rpb24gcGFyc2VSZWxhdGlvbnNJbnRvTW9kZWxJbnN0YW5jZXMobW9kZWwsIGpzb24sIG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIW9wdGlvbnMuY2FjaGUpIHtcbiAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCBjYWNoZTogbmV3IE1hcCgpIH1cbiAgfVxuICBvcHRpb25zLmNhY2hlLnNldChqc29uLCBtb2RlbClcblxuICBmb3IgKGNvbnN0IHJlbGF0aW9uTmFtZSBvZiBtb2RlbC5jb25zdHJ1Y3Rvci5nZXRSZWxhdGlvbk5hbWVzKCkpIHtcbiAgICBjb25zdCBqc29uUmVsYXRpb24gPSBqc29uW3JlbGF0aW9uTmFtZV1cbiAgICBpZiAoanNvblJlbGF0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gbW9kZWwuY29uc3RydWN0b3IuZ2V0UmVsYXRpb24ocmVsYXRpb25OYW1lKVxuICAgICAgY29uc3QgcGFyc2VkUmVsYXRpb24gPSBwYXJzZVJlbGF0aW9uKGpzb25SZWxhdGlvbiwgcmVsYXRpb24sIG9wdGlvbnMpXG4gICAgICBpZiAocGFyc2VkUmVsYXRpb24gIT09IGpzb25SZWxhdGlvbikge1xuICAgICAgICBtb2RlbFtyZWxhdGlvbi5uYW1lXSA9IHBhcnNlZFJlbGF0aW9uXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1vZGVsXG59XG5cbmZ1bmN0aW9uIHBhcnNlUmVsYXRpb24oanNvbiwgcmVsYXRpb24sIG9wdGlvbnMpIHtcbiAgcmV0dXJuIGlzQXJyYXkoanNvbilcbiAgICA/IHBhcnNlUmVsYXRpb25BcnJheShqc29uLCByZWxhdGlvbiwgb3B0aW9ucylcbiAgICA6IHBhcnNlUmVsYXRpb25PYmplY3QoanNvbiwgcmVsYXRpb24sIG9wdGlvbnMpXG59XG5cbmZ1bmN0aW9uIHBhcnNlUmVsYXRpb25BcnJheShqc29uLCByZWxhdGlvbiwgb3B0aW9ucykge1xuICBjb25zdCBtb2RlbHMgPSBuZXcgQXJyYXkoanNvbi5sZW5ndGgpXG4gIGxldCBjaGFuZ2VkID0gZmFsc2VcbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBqc29uLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgIGNvbnN0IG1vZGVsID0gcGFyc2VSZWxhdGlvbk9iamVjdChqc29uW2ldLCByZWxhdGlvbiwgb3B0aW9ucylcbiAgICBjaGFuZ2VkID0gY2hhbmdlZCB8fCAobW9kZWwgIT09IGpzb25baV0pXG4gICAgbW9kZWxzW2ldID0gbW9kZWxcbiAgfVxuICByZXR1cm4gY2hhbmdlZCA/IG1vZGVscyA6IGpzb25cbn1cblxuZnVuY3Rpb24gcGFyc2VSZWxhdGlvbk9iamVjdChqc29uLCByZWxhdGlvbiwgb3B0aW9ucykge1xuICBpZiAoaXNPYmplY3QoanNvbikpIHtcbiAgICBjb25zdCBtb2RlbENsYXNzID0gcmVsYXRpb24ucmVsYXRlZE1vZGVsQ2xhc3NcbiAgICBsZXQgbW9kZWwgPSBvcHRpb25zLmNhY2hlLmdldChqc29uKVxuICAgIGlmIChtb2RlbCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAoanNvbiBpbnN0YW5jZW9mIG1vZGVsQ2xhc3MpIHtcbiAgICAgICAgbW9kZWwgPSBwYXJzZVJlbGF0aW9uc0ludG9Nb2RlbEluc3RhbmNlcyhqc29uLCBqc29uLCBvcHRpb25zKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbW9kZWwgPSBtb2RlbENsYXNzLmZyb21Kc29uKGpzb24sIG9wdGlvbnMpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtb2RlbFxuICB9XG4gIHJldHVybiBqc29uXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3YWxrR3JhcGgoZGF0YSwgY2FsbGJhY2ssIHBhdGggPSBbXSkge1xuICBpZiAoaXNPYmplY3QoZGF0YSkgfHwgaXNBcnJheShkYXRhKSkge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG4gICAgICBjb25zdCBkYXRhUGF0aCA9IFsuLi5wYXRoLCBrZXldXG4gICAgICBjYWxsYmFjayh2YWx1ZSwgZGF0YVBhdGgsIGRhdGEsIGtleSlcbiAgICAgIHdhbGtHcmFwaCh2YWx1ZSwgY2FsbGJhY2ssIGRhdGFQYXRoKVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyR3JhcGgocm9vdE1vZGVsQ2xhc3MsIG1vZGVsR3JhcGgsIGV4cHIpIHtcbiAgZXhwciA9IFF1ZXJ5QnVpbGRlci5wYXJzZVJlbGF0aW9uRXhwcmVzc2lvbihleHByKVxuICBjb25zdCBtb2RlbHMgPSBlbnN1cmVNb2RlbEFycmF5KHJvb3RNb2RlbENsYXNzLCBtb2RlbEdyYXBoLCB7XG4gICAgc2tpcFZhbGlkYXRpb246IHRydWVcbiAgfSlcbiAgZm9yIChjb25zdCBtb2RlbCBvZiBtb2RlbHMpIHtcbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9ucyA9IG1vZGVsLmNvbnN0cnVjdG9yLmdldFJlbGF0aW9ucygpXG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhtb2RlbCkpIHtcbiAgICAgICAgY29uc3QgcmVsYXRpb24gPSByZWxhdGlvbnNba2V5XVxuICAgICAgICBpZiAocmVsYXRpb24pIHtcbiAgICAgICAgICBjb25zdCBjaGlsZCA9IGV4cHJba2V5XVxuICAgICAgICAgIGlmIChjaGlsZCkge1xuICAgICAgICAgICAgLy8gQWxsb3dlZCByZWxhdGlvbiwga2VlcCBmaWx0ZXJpbmcgcmVjdXJzaXZlbHk6XG4gICAgICAgICAgICBmaWx0ZXJHcmFwaChcbiAgICAgICAgICAgICAgcmVsYXRpb24ucmVsYXRlZE1vZGVsQ2xhc3MsXG4gICAgICAgICAgICAgIG1vZGVsW2tleV0sXG4gICAgICAgICAgICAgIGNoaWxkXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIERpc2FsbG93ZWQgcmVsYXRpb24sIGRlbGV0ZTpcbiAgICAgICAgICAgIGRlbGV0ZSBtb2RlbFtrZXldXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBtb2RlbEdyYXBoXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwb3B1bGF0ZUdyYXBoKHJvb3RNb2RlbENsYXNzLCBncmFwaCwgZXhwciwgdHJ4KSB7XG4gIC8vIFRPRE86IE9wdGltaXplIHRoZSBzY2VuYXJpbyB3aGVyZSBhbiBpdGVtIHRoYXQgaXNuJ3QgYSBsZWFmIGlzIGFcbiAgLy8gcmVmZXJlbmNlIGFuZCBoYXMgbXVsdGlwbGUgc3ViLXBhdGhzIHRvIGJlIHBvcHVsYXRlZC4gV2UgbWF5IG5lZWQgdG9cbiAgLy8gbW92ZSBhd2F5IGZyb20gZ3JhcGggcGF0aCBoYW5kbGluZyBhbmQgZGlyZWN0bHkgcHJvY2VzcyB0aGUgZXhwcmVzc2lvblxuICAvLyB0cmVlLCBjb21wb3NpbmcgcGF0aHMgdG8gdGhlIGN1cnJlbnQgcGxhY2Ugb24gdGhlIGZseSwgYW5kIHByb2Nlc3MgZGF0YVxuICAvLyB3aXRoIGFkZFRvR3JvdXAoKS4gVGhlbiB1c2UgdGhlIHN1Yi10cmVlIGFzIGdyYXBoIGV4cHJlc3Npb24gd2hlblxuICAvLyBlbmNvdW50ZXJpbmcgcmVmZXJlbmNlcyAobmVlZHMgdG9TdHJpbmcoKSBmb3IgY2FjaGluZyBhbHNvPylcbiAgLy8gVE9ETzogQmV0dGVyIGlkZWE6IEZpcnN0IGNhY2hlIGdyb3VwcyBieSB0aGUgcGF0aCB1cCB0byB0aGVpciBsb2NhdGlvbiBpblxuICAvLyB0aGUgZ3JhcGgsIGFuZCBjb2xsZWN0IG1vZGlmeSArIGdyYXBoIGV4cHJlc3Npb25zIHRoZXJlIGZvciByZWZlcmVuY2VzXG4gIC8vIHRoYXQgYXJlIG5vdCBsZWF2ZXMuIFRoZW4gdXNlIHRoZSByZXN1bHRpbmcgbm9kZXMgdG8gY3JlYXRlIG5ldyBncm91cHMgYnlcbiAgLy8gbW9kZWwgbmFtZSAvIG1vZGlmeSAvIGdyYXBoIGV4cHJlc3Npb25zLlxuICBleHByID0gUXVlcnlCdWlsZGVyLnBhcnNlUmVsYXRpb25FeHByZXNzaW9uKGV4cHIpXG4gIC8vIENvbnZlcnQgdGhlIHJlbGF0aW9uIGV4cHJlc3Npb24gdG8gYW4gYXJyYXkgb2YgcGF0aHMsIHRoYXQgdGhlbXNlbHZlc1xuICAvLyBjb250YWluIHBhdGggZW50cmllcyB3aXRoIHJlbGF0aW9uIG5hbWVzIGFuZCBtb2RpZnkgc2V0dGluZ3MuXG5cbiAgY29uc3QgZ3JvdXBlZCA9IHt9XG4gIGNvbnN0IGFkZFRvR3JvdXAgPVxuICAgIChpdGVtLCBtb2RlbENsYXNzLCBpc1JlZmVyZW5jZSwgbW9kaWZ5LCByZWxhdGlvbiwgZXhwcikgPT4ge1xuICAgICAgY29uc3QgaWQgPSBpdGVtLiRpZCgpXG4gICAgICBpZiAoaWQgIT0gbnVsbCkge1xuICAgICAgICAvLyBHcm91cCBtb2RlbHMgYnkgbW9kZWwtbmFtZSArIG1vZGlmeSArIGV4cHIsIGZvciBmYXN0ZXIgbG9hZGluZzpcbiAgICAgICAgY29uc3Qga2V5ID0gYCR7bW9kZWxDbGFzcy5uYW1lfV8ke21vZGlmeX1fJHtleHByIHx8ICcnfWBcbiAgICAgICAgY29uc3QgZ3JvdXAgPSBncm91cGVkW2tleV0gfHwgKGdyb3VwZWRba2V5XSA9IHtcbiAgICAgICAgICBtb2RlbENsYXNzLFxuICAgICAgICAgIG1vZGlmeSxcbiAgICAgICAgICByZWxhdGlvbixcbiAgICAgICAgICBleHByLFxuICAgICAgICAgIHRhcmdldHM6IFtdLFxuICAgICAgICAgIGlkczogW10sXG4gICAgICAgICAgbW9kZWxzQnlJZDoge31cbiAgICAgICAgfSlcbiAgICAgICAgZ3JvdXAudGFyZ2V0cy5wdXNoKHsgaXRlbSwgaXNSZWZlcmVuY2UgfSlcbiAgICAgICAgLy8gQ29sbGVjdCBpZHMgdG8gYmUgbG9hZGVkIGZvciB0aGUgdGFyZ2V0cy5cbiAgICAgICAgZ3JvdXAuaWRzLnB1c2goaWQpXG4gICAgICB9XG4gICAgfVxuXG4gIGZvciAoY29uc3QgcGF0aCBvZiBjb2xsZWN0RXhwcmVzc2lvblBhdGhzKGV4cHIpKSB7XG4gICAgbGV0IG1vZGVsQ2xhc3MgPSByb290TW9kZWxDbGFzc1xuICAgIGNvbnN0IG1vZGVsQ2xhc3NlcyA9IFtdXG4gICAgbGV0IGxhc3RNb2RpZnlcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIHBhdGgpIHtcbiAgICAgIG1vZGVsQ2xhc3Nlcy5wdXNoKG1vZGVsQ2xhc3MpXG4gICAgICBtb2RlbENsYXNzID0gbW9kZWxDbGFzcy5nZXRSZWxhdGlvbihlbnRyeS5yZWxhdGlvbikucmVsYXRlZE1vZGVsQ2xhc3NcbiAgICAgIGxhc3RNb2RpZnkgPSBlbnRyeS5tb2RpZnlcbiAgICB9XG4gICAgZm9yIChjb25zdCBtb2RlbCBvZiBhc0FycmF5KGdyYXBoKSkge1xuICAgICAgaWYgKG1vZGVsKSB7XG4gICAgICAgIGxldCBpdGVtcyA9IGFzQXJyYXkobW9kZWwpXG4gICAgICAgIC8vIENvbGxlY3QgYWxsIGdyYXBoIGl0ZW1zIGRlc2NyaWJlZCBieSB0aGUgY3VycmVudCByZWxhdGlvbiBwYXRoIGluXG4gICAgICAgIC8vIG9uZSBsb29wOlxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHBhdGgubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgYnJlYWtcbiAgICAgICAgICBjb25zdCB7IHJlbGF0aW9uIH0gPSBwYXRoW2ldXG4gICAgICAgICAgY29uc3QgbW9kZWxDbGFzcyA9IG1vZGVsQ2xhc3Nlc1tpXVxuICAgICAgICAgIGl0ZW1zID0gaXRlbXMucmVkdWNlKChpdGVtcywgaXRlbSkgPT4ge1xuICAgICAgICAgICAgaXRlbSA9IGVuc3VyZU1vZGVsKG1vZGVsQ2xhc3MsIGl0ZW0sIHsgc2tpcFZhbGlkYXRpb246IHRydWUgfSlcbiAgICAgICAgICAgIGxldCBhZGQgPSBmYWxzZVxuICAgICAgICAgICAgY29uc3QgaXNSZWZlcmVuY2UgPSBtb2RlbENsYXNzLmlzUmVmZXJlbmNlKGl0ZW0pXG4gICAgICAgICAgICBpZiAoaXNSZWZlcmVuY2UpIHtcbiAgICAgICAgICAgICAgLy8gRGV0ZWN0ZWQgYSByZWZlcmVuY2UgaXRlbSB0aGF0IGlzbid0IGEgbGVhZjogV2UgbmVlZCB0b1xuICAgICAgICAgICAgICAvLyBlYWdlci1sb2FkIHRoZSByZXN0IG9mIHRoZSBwYXRoLCBhbmQgcmVzcGVjdCBtb2RpZnkgc2V0dGluZ3MuXG4gICAgICAgICAgICAgIGFkZCA9IHRydWVcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXRlbVtyZWxhdGlvbl1cbiAgICAgICAgICAgICAgLy8gQWRkIHRoZSBtb2RlbHMgb2YgdGhpcyByZWxhdGlvbiB0byBpdGVtcywgc28gdGhleSBjYW4gYmVcbiAgICAgICAgICAgICAgLy8gZmlsdGVyZWQgZnVydGhlciBpbiB0aGUgbmV4dCBpdGVyYXRpb24gb2YgdGhpcyBsb29wLlxuICAgICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goLi4uYXNBcnJheSh2YWx1ZSkpXG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBmdWxsIHJlbGF0aW9uIGlzIG1pc3NpbmcgdHJ5IGVhZ2VyLWxvYWRpbmcgaXQuXG4gICAgICAgICAgICAgICAgLy8gTk9URTogVmFsdWVzIG9mIGBudWxsYCBhcmUgcmVzcGVjdGVkIGhlcmUsIG5vdCBsb2FkZWQgYWdhaW4uXG4gICAgICAgICAgICAgICAgYWRkID0gdHJ1ZVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWRkKSB7XG4gICAgICAgICAgICAgIC8vIGBwYXRoW2ldLm1vZGlmeWAgaXMgdGhlIGN1cnJlbnQgcmVsYXRpb24ncyBtb2RpZnkgZXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgLy8gZ2V0IHRoZSBwYXJlbnQgb25lIGZvciBgbW9kZWxDbGFzc2A6XG4gICAgICAgICAgICAgIGNvbnN0IG1vZGlmeSA9IGkgPiAwID8gcGF0aFtpIC0gMV0ubW9kaWZ5IDogbnVsbFxuICAgICAgICAgICAgICBjb25zdCBleHByID0gZXhwcmVzc2lvblBhdGhUb1N0cmluZyhwYXRoLCBpKVxuICAgICAgICAgICAgICBhZGRUb0dyb3VwKGl0ZW0sIG1vZGVsQ2xhc3MsIGlzUmVmZXJlbmNlLCBtb2RpZnksIHJlbGF0aW9uLCBleHByKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGl0ZW1zXG4gICAgICAgICAgfSwgW10pXG4gICAgICAgIH1cbiAgICAgICAgLy8gQWRkIGFsbCBlbmNvdW50ZXJlZCBsZWFmLXJlZmVyZW5jZXMgdG8gZ3JvdXBzIHRvIGJlIGxvYWRlZC5cbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICAgICAgLy8gT25seSBsb2FkIGxlYWZzIHRoYXQgYXJlIHJlZmVyZW5jZXMuXG4gICAgICAgICAgaWYgKG1vZGVsQ2xhc3MuaXNSZWZlcmVuY2UoaXRlbSkpIHtcbiAgICAgICAgICAgIGFkZFRvR3JvdXAoaXRlbSwgbW9kZWxDbGFzcywgdHJ1ZSwgbGFzdE1vZGlmeSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBncm91cHMgPSBPYmplY3QudmFsdWVzKGdyb3VwZWQpLmZpbHRlcigoeyBpZHMgfSkgPT4gaWRzLmxlbmd0aCA+IDApXG4gIGlmIChncm91cHMubGVuZ3RoID4gMCkge1xuICAgIC8vIExvYWQgYWxsIGZvdW5kIG1vZGVscyBieSBpZHMgYXN5bmNocm9ub3VzbHksIHdpdGhpbiBwcm92aWRlZCB0cmFuc2FjdGlvbi5cbiAgICAvLyBOT1RFOiBVc2luZyB0aGUgc2FtZSB0cmFuc2FjdGlvbiBtZWFucyB0aGF0IGFsbCBpbnZvbHZlZCB0YWJsZXMgbmVlZCB0b1xuICAgIC8vIGJlIGluIHRoZSBzYW1lIGRhdGFiYXNlLlxuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgZ3JvdXBzLm1hcChhc3luYyAoeyBtb2RlbENsYXNzLCBtb2RpZnksIGV4cHIsIGlkcywgbW9kZWxzQnlJZCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gbW9kZWxDbGFzcy5xdWVyeSh0cngpLmZpbmRCeUlkcyhpZHMpLm1vZGlmeShtb2RpZnkpXG4gICAgICAgIGlmIChleHByKSB7XG4gICAgICAgICAgLy8gVE9ETzogTWFrZSBhbGdvcml0aG0gY29uZmlndXJhYmxlIHRocm91Z2ggb3B0aW9ucy5cbiAgICAgICAgICBxdWVyeS53aXRoR3JhcGgoZXhwcilcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtb2RlbHMgPSBhd2FpdCBxdWVyeVxuICAgICAgICAvLyBGaWxsIHRoZSBncm91cC5tb2RlbHNCeUlkIGxvb2t1cDpcbiAgICAgICAgZm9yIChjb25zdCBtb2RlbCBvZiBtb2RlbHMpIHtcbiAgICAgICAgICBtb2RlbHNCeUlkW21vZGVsLiRpZCgpXSA9IG1vZGVsXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuXG4gICAgLy8gRmluYWxseSBwb3B1bGF0ZSB0aGUgdGFyZ2V0cyB3aXRoIHRoZSBsb2FkZWQgbW9kZWxzLlxuICAgIGZvciAoY29uc3QgeyB0YXJnZXRzLCBtb2RlbHNCeUlkLCByZWxhdGlvbiB9IG9mIGdyb3Vwcykge1xuICAgICAgZm9yIChjb25zdCB7IGl0ZW0sIGlzUmVmZXJlbmNlIH0gb2YgdGFyZ2V0cykge1xuICAgICAgICBjb25zdCBtb2RlbCA9IG1vZGVsc0J5SWRbaXRlbS4kaWQoKV1cbiAgICAgICAgaWYgKG1vZGVsKSB7XG4gICAgICAgICAgaWYgKGlzUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICAvLyBDb3B5IG92ZXIgdGhlIGZ1bGwgaXRlbS5cbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oaXRlbSwgbW9kZWwpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIEp1c3QgY29weSB0aGUgZWFnZXItbG9hZGVkIHJlbGF0aW9uLlxuICAgICAgICAgICAgaXRlbVtyZWxhdGlvbl0gPSBtb2RlbFtyZWxhdGlvbl1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZ3JhcGhcbn1cbiJdfQ==