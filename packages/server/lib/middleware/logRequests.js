"use strict";

exports.__esModule = true;
exports.logRequests = logRequests;

var _bytes = _interopRequireDefault(require("bytes"));

var _chalk = _interopRequireDefault(require("chalk"));

var _passthroughCounter = _interopRequireDefault(require("passthrough-counter"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function logRequests({
  ignoreUrls
} = {}) {
  return async (ctx, next) => {
    if (ignoreUrls && ctx.req.url.match(ignoreUrls)) {
      return next();
    }

    const start = Date.now();
    logRequest(ctx);

    try {
      await next();
    } catch (err) {
      logResponse({
        ctx,
        start,
        err
      });
      throw err;
    }

    const {
      body,
      response: {
        length
      }
    } = ctx;
    let counter;

    if (length === null && body != null && body.readable) {
      ctx.body = body.pipe(counter = new _passthroughCounter.default()).on('error', ctx.onerror);
    }

    const {
      res
    } = ctx;
    const onfinish = done.bind(null, 'finish');
    const onclose = done.bind(null, 'close');
    res.once('finish', onfinish);
    res.once('close', onclose);

    function done() {
      res.removeListener('finish', onfinish);
      res.removeListener('close', onclose);
      logResponse({
        ctx,
        start,
        length: counter ? counter.length : length
      });
    }
  };
}

function logRequest(ctx) {
  var _ctx$logger;

  const logger = (_ctx$logger = ctx.logger) == null ? void 0 : _ctx$logger.child({
    name: 'http'
  });

  if (logger != null && logger.isLevelEnabled('trace')) {
    logger.trace({
      req: ctx.req
    }, `${_chalk.default.gray('<--')} ${_chalk.default.bold(ctx.method)} ${_chalk.default.gray(ctx.originalUrl)}`);
  }
}

function logResponse({
  ctx,
  start,
  length,
  err
}) {
  var _ctx$logger2;

  const logger = (_ctx$logger2 = ctx.logger) == null ? void 0 : _ctx$logger2.child({
    name: 'http'
  });
  const level = err ? 'warn' : 'info';

  if (logger != null && logger.isLevelEnabled(level)) {
    const status = err ? err.status || 500 : ctx.status || 404;
    const statusRange = status / 100 | 0;
    const statusColor = colorCodes[statusRange] || colorCodes[0];
    const formattedLength = [204, 205, 304].includes(status) ? '' : length == null ? '-' : (0, _bytes.default)(length).toLowerCase();
    const formattedTime = formatTime(start);
    logger[level]({
      req: ctx.req,
      res: ctx.res
    }, `${_chalk.default.bold(ctx.method)} ${_chalk.default.gray(ctx.originalUrl)} ${_chalk.default[statusColor](status)} ${_chalk.default.gray(formattedTime)} ${_chalk.default.gray(formattedLength)}`);
  }
}

function formatTime(start) {
  const delta = Date.now() - start;
  return delta < 10000 ? delta + 'ms' : Math.round(delta / 1000) + 's';
}

const colorCodes = {
  7: 'magenta',
  5: 'red',
  4: 'yellow',
  3: 'cyan',
  2: 'green',
  1: 'green',
  0: 'yellow'
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2xvZ1JlcXVlc3RzLmpzIl0sIm5hbWVzIjpbImxvZ1JlcXVlc3RzIiwiaWdub3JlVXJscyIsImN0eCIsIm5leHQiLCJyZXEiLCJ1cmwiLCJtYXRjaCIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsImxvZ1JlcXVlc3QiLCJlcnIiLCJsb2dSZXNwb25zZSIsImJvZHkiLCJyZXNwb25zZSIsImxlbmd0aCIsImNvdW50ZXIiLCJyZWFkYWJsZSIsInBpcGUiLCJDb3VudGVyIiwib24iLCJvbmVycm9yIiwicmVzIiwib25maW5pc2giLCJkb25lIiwiYmluZCIsIm9uY2xvc2UiLCJvbmNlIiwicmVtb3ZlTGlzdGVuZXIiLCJsb2dnZXIiLCJjaGlsZCIsIm5hbWUiLCJpc0xldmVsRW5hYmxlZCIsInRyYWNlIiwiY2hhbGsiLCJncmF5IiwiYm9sZCIsIm1ldGhvZCIsIm9yaWdpbmFsVXJsIiwibGV2ZWwiLCJzdGF0dXMiLCJzdGF0dXNSYW5nZSIsInN0YXR1c0NvbG9yIiwiY29sb3JDb2RlcyIsImZvcm1hdHRlZExlbmd0aCIsImluY2x1ZGVzIiwidG9Mb3dlckNhc2UiLCJmb3JtYXR0ZWRUaW1lIiwiZm9ybWF0VGltZSIsImRlbHRhIiwiTWF0aCIsInJvdW5kIl0sIm1hcHBpbmdzIjoiOzs7OztBQUdBOztBQUNBOztBQUNBOzs7O0FBRU8sU0FBU0EsV0FBVCxDQUFxQjtBQUFFQyxFQUFBQTtBQUFGLElBQWlCLEVBQXRDLEVBQTBDO0FBQy9DLFNBQU8sT0FBT0MsR0FBUCxFQUFZQyxJQUFaLEtBQXFCO0FBQzFCLFFBQUlGLFVBQVUsSUFBSUMsR0FBRyxDQUFDRSxHQUFKLENBQVFDLEdBQVIsQ0FBWUMsS0FBWixDQUFrQkwsVUFBbEIsQ0FBbEIsRUFBaUQ7QUFDL0MsYUFBT0UsSUFBSSxFQUFYO0FBQ0Q7O0FBRUQsVUFBTUksS0FBSyxHQUFHQyxJQUFJLENBQUNDLEdBQUwsRUFBZDtBQUVBQyxJQUFBQSxVQUFVLENBQUNSLEdBQUQsQ0FBVjs7QUFFQSxRQUFJO0FBQ0YsWUFBTUMsSUFBSSxFQUFWO0FBQ0QsS0FGRCxDQUVFLE9BQU9RLEdBQVAsRUFBWTtBQUNaQyxNQUFBQSxXQUFXLENBQUM7QUFBRVYsUUFBQUEsR0FBRjtBQUFPSyxRQUFBQSxLQUFQO0FBQWNJLFFBQUFBO0FBQWQsT0FBRCxDQUFYO0FBQ0EsWUFBTUEsR0FBTjtBQUNEOztBQUtELFVBQU07QUFDSkUsTUFBQUEsSUFESTtBQUVKQyxNQUFBQSxRQUFRLEVBQUU7QUFBRUMsUUFBQUE7QUFBRjtBQUZOLFFBR0ZiLEdBSEo7QUFLQSxRQUFJYyxPQUFKOztBQUNBLFFBQUlELE1BQU0sS0FBSyxJQUFYLElBQW1CRixJQUFuQixZQUFtQkEsSUFBSSxDQUFFSSxRQUE3QixFQUF1QztBQUNyQ2YsTUFBQUEsR0FBRyxDQUFDVyxJQUFKLEdBQVdBLElBQUksQ0FBQ0ssSUFBTCxDQUFXRixPQUFPLEdBQUcsSUFBSUcsMkJBQUosRUFBckIsRUFBcUNDLEVBQXJDLENBQXdDLE9BQXhDLEVBQWlEbEIsR0FBRyxDQUFDbUIsT0FBckQsQ0FBWDtBQUNEOztBQUdELFVBQU07QUFBRUMsTUFBQUE7QUFBRixRQUFVcEIsR0FBaEI7QUFFQSxVQUFNcUIsUUFBUSxHQUFHQyxJQUFJLENBQUNDLElBQUwsQ0FBVSxJQUFWLEVBQWdCLFFBQWhCLENBQWpCO0FBQ0EsVUFBTUMsT0FBTyxHQUFHRixJQUFJLENBQUNDLElBQUwsQ0FBVSxJQUFWLEVBQWdCLE9BQWhCLENBQWhCO0FBRUFILElBQUFBLEdBQUcsQ0FBQ0ssSUFBSixDQUFTLFFBQVQsRUFBbUJKLFFBQW5CO0FBQ0FELElBQUFBLEdBQUcsQ0FBQ0ssSUFBSixDQUFTLE9BQVQsRUFBa0JELE9BQWxCOztBQUVBLGFBQVNGLElBQVQsR0FBZ0I7QUFDZEYsTUFBQUEsR0FBRyxDQUFDTSxjQUFKLENBQW1CLFFBQW5CLEVBQTZCTCxRQUE3QjtBQUNBRCxNQUFBQSxHQUFHLENBQUNNLGNBQUosQ0FBbUIsT0FBbkIsRUFBNEJGLE9BQTVCO0FBQ0FkLE1BQUFBLFdBQVcsQ0FBQztBQUFFVixRQUFBQSxHQUFGO0FBQU9LLFFBQUFBLEtBQVA7QUFBY1EsUUFBQUEsTUFBTSxFQUFFQyxPQUFPLEdBQUdBLE9BQU8sQ0FBQ0QsTUFBWCxHQUFvQkE7QUFBakQsT0FBRCxDQUFYO0FBQ0Q7QUFDRixHQTNDRDtBQTRDRDs7QUFFRCxTQUFTTCxVQUFULENBQW9CUixHQUFwQixFQUF5QjtBQUFBOztBQUN2QixRQUFNMkIsTUFBTSxrQkFBRzNCLEdBQUcsQ0FBQzJCLE1BQVAscUJBQUcsWUFBWUMsS0FBWixDQUFrQjtBQUFFQyxJQUFBQSxJQUFJLEVBQUU7QUFBUixHQUFsQixDQUFmOztBQUNBLE1BQUlGLE1BQUosWUFBSUEsTUFBTSxDQUFFRyxjQUFSLENBQXVCLE9BQXZCLENBQUosRUFBcUM7QUFDbkNILElBQUFBLE1BQU0sQ0FBQ0ksS0FBUCxDQUNFO0FBQUU3QixNQUFBQSxHQUFHLEVBQUVGLEdBQUcsQ0FBQ0U7QUFBWCxLQURGLEVBRUcsR0FDQzhCLGVBQU1DLElBQU4sQ0FBVyxLQUFYLENBQ0QsSUFDQ0QsZUFBTUUsSUFBTixDQUFXbEMsR0FBRyxDQUFDbUMsTUFBZixDQUNELElBQ0NILGVBQU1DLElBQU4sQ0FBV2pDLEdBQUcsQ0FBQ29DLFdBQWYsQ0FDRCxFQVJIO0FBVUQ7QUFDRjs7QUFFRCxTQUFTMUIsV0FBVCxDQUFxQjtBQUFFVixFQUFBQSxHQUFGO0FBQU9LLEVBQUFBLEtBQVA7QUFBY1EsRUFBQUEsTUFBZDtBQUFzQkosRUFBQUE7QUFBdEIsQ0FBckIsRUFBa0Q7QUFBQTs7QUFDaEQsUUFBTWtCLE1BQU0sbUJBQUczQixHQUFHLENBQUMyQixNQUFQLHFCQUFHLGFBQVlDLEtBQVosQ0FBa0I7QUFBRUMsSUFBQUEsSUFBSSxFQUFFO0FBQVIsR0FBbEIsQ0FBZjtBQUNBLFFBQU1RLEtBQUssR0FBRzVCLEdBQUcsR0FBRyxNQUFILEdBQVksTUFBN0I7O0FBQ0EsTUFBSWtCLE1BQUosWUFBSUEsTUFBTSxDQUFFRyxjQUFSLENBQXVCTyxLQUF2QixDQUFKLEVBQW1DO0FBRWpDLFVBQU1DLE1BQU0sR0FBRzdCLEdBQUcsR0FDZEEsR0FBRyxDQUFDNkIsTUFBSixJQUFjLEdBREEsR0FFZHRDLEdBQUcsQ0FBQ3NDLE1BQUosSUFBYyxHQUZsQjtBQUtBLFVBQU1DLFdBQVcsR0FBSUQsTUFBTSxHQUFHLEdBQVYsR0FBaUIsQ0FBckM7QUFDQSxVQUFNRSxXQUFXLEdBQUdDLFVBQVUsQ0FBQ0YsV0FBRCxDQUFWLElBQTJCRSxVQUFVLENBQUMsQ0FBRCxDQUF6RDtBQUdBLFVBQU1DLGVBQWUsR0FBRyxDQUFDLEdBQUQsRUFBTSxHQUFOLEVBQVcsR0FBWCxFQUFnQkMsUUFBaEIsQ0FBeUJMLE1BQXpCLElBQ3BCLEVBRG9CLEdBRXBCekIsTUFBTSxJQUFJLElBQVYsR0FDRSxHQURGLEdBRUUsb0JBQU1BLE1BQU4sRUFBYytCLFdBQWQsRUFKTjtBQU1BLFVBQU1DLGFBQWEsR0FBR0MsVUFBVSxDQUFDekMsS0FBRCxDQUFoQztBQUVBc0IsSUFBQUEsTUFBTSxDQUFDVSxLQUFELENBQU4sQ0FDRTtBQUFFbkMsTUFBQUEsR0FBRyxFQUFFRixHQUFHLENBQUNFLEdBQVg7QUFBZ0JrQixNQUFBQSxHQUFHLEVBQUVwQixHQUFHLENBQUNvQjtBQUF6QixLQURGLEVBRUcsR0FDQ1ksZUFBTUUsSUFBTixDQUFXbEMsR0FBRyxDQUFDbUMsTUFBZixDQUNELElBQ0NILGVBQU1DLElBQU4sQ0FBV2pDLEdBQUcsQ0FBQ29DLFdBQWYsQ0FDRCxJQUNDSixlQUFNUSxXQUFOLEVBQW1CRixNQUFuQixDQUNELElBQ0NOLGVBQU1DLElBQU4sQ0FBV1ksYUFBWCxDQUNELElBQ0NiLGVBQU1DLElBQU4sQ0FBV1MsZUFBWCxDQUNELEVBWkg7QUFjRDtBQUNGOztBQUVELFNBQVNJLFVBQVQsQ0FBb0J6QyxLQUFwQixFQUEyQjtBQUN6QixRQUFNMEMsS0FBSyxHQUFHekMsSUFBSSxDQUFDQyxHQUFMLEtBQWFGLEtBQTNCO0FBQ0EsU0FBTzBDLEtBQUssR0FBRyxLQUFSLEdBQWdCQSxLQUFLLEdBQUcsSUFBeEIsR0FBK0JDLElBQUksQ0FBQ0MsS0FBTCxDQUFXRixLQUFLLEdBQUcsSUFBbkIsSUFBMkIsR0FBakU7QUFDRDs7QUFFRCxNQUFNTixVQUFVLEdBQUc7QUFDakIsS0FBRyxTQURjO0FBRWpCLEtBQUcsS0FGYztBQUdqQixLQUFHLFFBSGM7QUFJakIsS0FBRyxNQUpjO0FBS2pCLEtBQUcsT0FMYztBQU1qQixLQUFHLE9BTmM7QUFPakIsS0FBRztBQVBjLENBQW5CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pZGRsZXdhcmUgaW5zcGlyZWQgYnkgJ2tvYS1sb2dnZXInLiBBZGFwdGVkIGFuZCBleHRlbmRlZCB0byBvdXIgbmVlZHMuXG4gKi9cbmltcG9ydCBieXRlcyBmcm9tICdieXRlcydcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsaydcbmltcG9ydCBDb3VudGVyIGZyb20gJ3Bhc3N0aHJvdWdoLWNvdW50ZXInXG5cbmV4cG9ydCBmdW5jdGlvbiBsb2dSZXF1ZXN0cyh7IGlnbm9yZVVybHMgfSA9IHt9KSB7XG4gIHJldHVybiBhc3luYyAoY3R4LCBuZXh0KSA9PiB7XG4gICAgaWYgKGlnbm9yZVVybHMgJiYgY3R4LnJlcS51cmwubWF0Y2goaWdub3JlVXJscykpIHtcbiAgICAgIHJldHVybiBuZXh0KClcbiAgICB9XG4gICAgLy8gcmVxdWVzdFxuICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKVxuXG4gICAgbG9nUmVxdWVzdChjdHgpXG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgbmV4dCgpXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dSZXNwb25zZSh7IGN0eCwgc3RhcnQsIGVyciB9KVxuICAgICAgdGhyb3cgZXJyXG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHRoZSBsZW5ndGggb2YgYSBzdHJlYW1pbmcgcmVzcG9uc2UgYnkgaW50ZXJjZXB0aW5nIHRoZSBzdHJlYW1cbiAgICAvLyB3aXRoIGEgY291bnRlci4gT25seSBuZWNlc3NhcnkgaWYgYSBjb250ZW50LWxlbmd0aCBoZWFkZXIgaXMgY3VycmVudGx5XG4gICAgLy8gbm90IHNldC5cbiAgICBjb25zdCB7XG4gICAgICBib2R5LFxuICAgICAgcmVzcG9uc2U6IHsgbGVuZ3RoIH1cbiAgICB9ID0gY3R4XG5cbiAgICBsZXQgY291bnRlclxuICAgIGlmIChsZW5ndGggPT09IG51bGwgJiYgYm9keT8ucmVhZGFibGUpIHtcbiAgICAgIGN0eC5ib2R5ID0gYm9keS5waXBlKChjb3VudGVyID0gbmV3IENvdW50ZXIoKSkpLm9uKCdlcnJvcicsIGN0eC5vbmVycm9yKVxuICAgIH1cblxuICAgIC8vIExvZyB3aGVuIHRoZSByZXNwb25zZSBpcyBmaW5pc2hlZCBvciBjbG9zZWQsIHdoaWNoZXZlciBoYXBwZW5zIGZpcnN0LlxuICAgIGNvbnN0IHsgcmVzIH0gPSBjdHhcblxuICAgIGNvbnN0IG9uZmluaXNoID0gZG9uZS5iaW5kKG51bGwsICdmaW5pc2gnKVxuICAgIGNvbnN0IG9uY2xvc2UgPSBkb25lLmJpbmQobnVsbCwgJ2Nsb3NlJylcblxuICAgIHJlcy5vbmNlKCdmaW5pc2gnLCBvbmZpbmlzaClcbiAgICByZXMub25jZSgnY2xvc2UnLCBvbmNsb3NlKVxuXG4gICAgZnVuY3Rpb24gZG9uZSgpIHtcbiAgICAgIHJlcy5yZW1vdmVMaXN0ZW5lcignZmluaXNoJywgb25maW5pc2gpXG4gICAgICByZXMucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSlcbiAgICAgIGxvZ1Jlc3BvbnNlKHsgY3R4LCBzdGFydCwgbGVuZ3RoOiBjb3VudGVyID8gY291bnRlci5sZW5ndGggOiBsZW5ndGggfSlcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gbG9nUmVxdWVzdChjdHgpIHtcbiAgY29uc3QgbG9nZ2VyID0gY3R4LmxvZ2dlcj8uY2hpbGQoeyBuYW1lOiAnaHR0cCcgfSlcbiAgaWYgKGxvZ2dlcj8uaXNMZXZlbEVuYWJsZWQoJ3RyYWNlJykpIHtcbiAgICBsb2dnZXIudHJhY2UoXG4gICAgICB7IHJlcTogY3R4LnJlcSB9LFxuICAgICAgYCR7XG4gICAgICAgIGNoYWxrLmdyYXkoJzwtLScpXG4gICAgICB9ICR7XG4gICAgICAgIGNoYWxrLmJvbGQoY3R4Lm1ldGhvZClcbiAgICAgIH0gJHtcbiAgICAgICAgY2hhbGsuZ3JheShjdHgub3JpZ2luYWxVcmwpXG4gICAgICB9YFxuICAgIClcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2dSZXNwb25zZSh7IGN0eCwgc3RhcnQsIGxlbmd0aCwgZXJyIH0pIHtcbiAgY29uc3QgbG9nZ2VyID0gY3R4LmxvZ2dlcj8uY2hpbGQoeyBuYW1lOiAnaHR0cCcgfSlcbiAgY29uc3QgbGV2ZWwgPSBlcnIgPyAnd2FybicgOiAnaW5mbydcbiAgaWYgKGxvZ2dlcj8uaXNMZXZlbEVuYWJsZWQobGV2ZWwpKSB7XG4gIC8vIEdldCB0aGUgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlXG4gICAgY29uc3Qgc3RhdHVzID0gZXJyXG4gICAgICA/IGVyci5zdGF0dXMgfHwgNTAwXG4gICAgICA6IGN0eC5zdGF0dXMgfHwgNDA0XG5cbiAgICAvLyBTZXQgdGhlIGNvbG9yIG9mIHRoZSBzdGF0dXMgY29kZTtcbiAgICBjb25zdCBzdGF0dXNSYW5nZSA9IChzdGF0dXMgLyAxMDApIHwgMFxuICAgIGNvbnN0IHN0YXR1c0NvbG9yID0gY29sb3JDb2Rlc1tzdGF0dXNSYW5nZV0gfHwgY29sb3JDb2Rlc1swXVxuXG4gICAgLy8gR2V0IHRoZSBodW1hbiByZWFkYWJsZSByZXNwb25zZSBsZW5ndGhcbiAgICBjb25zdCBmb3JtYXR0ZWRMZW5ndGggPSBbMjA0LCAyMDUsIDMwNF0uaW5jbHVkZXMoc3RhdHVzKVxuICAgICAgPyAnJ1xuICAgICAgOiBsZW5ndGggPT0gbnVsbFxuICAgICAgICA/ICctJ1xuICAgICAgICA6IGJ5dGVzKGxlbmd0aCkudG9Mb3dlckNhc2UoKVxuXG4gICAgY29uc3QgZm9ybWF0dGVkVGltZSA9IGZvcm1hdFRpbWUoc3RhcnQpXG5cbiAgICBsb2dnZXJbbGV2ZWxdKFxuICAgICAgeyByZXE6IGN0eC5yZXEsIHJlczogY3R4LnJlcyB9LFxuICAgICAgYCR7XG4gICAgICAgIGNoYWxrLmJvbGQoY3R4Lm1ldGhvZClcbiAgICAgIH0gJHtcbiAgICAgICAgY2hhbGsuZ3JheShjdHgub3JpZ2luYWxVcmwpXG4gICAgICB9ICR7XG4gICAgICAgIGNoYWxrW3N0YXR1c0NvbG9yXShzdGF0dXMpXG4gICAgICB9ICR7XG4gICAgICAgIGNoYWxrLmdyYXkoZm9ybWF0dGVkVGltZSlcbiAgICAgIH0gJHtcbiAgICAgICAgY2hhbGsuZ3JheShmb3JtYXR0ZWRMZW5ndGgpXG4gICAgICB9YFxuICAgIClcbiAgfVxufVxuXG5mdW5jdGlvbiBmb3JtYXRUaW1lKHN0YXJ0KSB7XG4gIGNvbnN0IGRlbHRhID0gRGF0ZS5ub3coKSAtIHN0YXJ0XG4gIHJldHVybiBkZWx0YSA8IDEwMDAwID8gZGVsdGEgKyAnbXMnIDogTWF0aC5yb3VuZChkZWx0YSAvIDEwMDApICsgJ3MnXG59XG5cbmNvbnN0IGNvbG9yQ29kZXMgPSB7XG4gIDc6ICdtYWdlbnRhJyxcbiAgNTogJ3JlZCcsXG4gIDQ6ICd5ZWxsb3cnLFxuICAzOiAnY3lhbicsXG4gIDI6ICdncmVlbicsXG4gIDE6ICdncmVlbicsXG4gIDA6ICd5ZWxsb3cnXG59XG4iXX0=