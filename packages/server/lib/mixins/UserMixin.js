"use strict";

exports.__esModule = true;
exports.UserMixin = void 0;

var _bcryptjs = _interopRequireDefault(require("bcryptjs"));

var _koaPassport = _interopRequireDefault(require("koa-passport"));

var _passportLocal = require("passport-local");

var _errors = require("../errors");

var _utils = require("@ditojs/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const UserMixin = (0, _utils.mixin)(Model => {
  var _class, _temp;

  return _temp = _class = class extends Model {
    static get properties() {
      const {
        usernameProperty,
        passwordProperty
      } = this.definition.options;
      return {
        [usernameProperty]: {
          type: 'string',
          required: true
        },
        [passwordProperty]: {
          type: 'string',
          computed: true
        },
        hash: {
          type: 'string',
          hidden: true
        },
        lastLogin: {
          type: 'timestamp',
          nullable: true
        }
      };
    }

    get password() {
      return undefined;
    }

    set password(password) {
      this.hash = _bcryptjs.default.hashSync(password, _bcryptjs.default.genSaltSync(10));
    }

    async $verifyPassword(password) {
      return _bcryptjs.default.compare(password, this.hash);
    }

    $hasRole(...roles) {
      var _this$roles;

      return ((_this$roles = this.roles) == null ? void 0 : _this$roles.find(role => roles.includes(role))) || false;
    }

    $hasOwner(owner) {
      return this.$is(owner);
    }

    $isLoggedIn(ctx) {
      return this.$is(ctx.state.user);
    }

    static initialize() {
      super.initialize();
      userClasses[this.name] = this;
      const {
        usernameProperty,
        passwordProperty
      } = this.definition.options;

      _koaPassport.default.use(this.name, new _passportLocal.Strategy({
        usernameField: usernameProperty,
        passwordField: passwordProperty,
        passReqToCallback: true
      }, async (req, username, password, done) => {
        try {
          const user = await this.sessionQuery(req.ctx.transaction).findOne(usernameProperty, username);
          const res = user && (await user.$verifyPassword(password)) ? user : null;
          done(null, res);
        } catch (err) {
          done(err);
        }
      }));
    }

    static async login(ctx, options) {
      return new Promise((resolve, reject) => {
        _koaPassport.default.authenticate(this.name, async (err, user, message, status) => {
          if (err) {
            reject(err);
          } else if (user) {
            try {
              await ctx.login(user, options);
              resolve(user);
            } catch (err) {
              reject(err);
            }
          } else {
            reject(new _errors.AuthenticationError(message || 'Password or username is incorrect', status));
          }
        })(ctx);
      });
    }

    static sessionQuery(trx) {
      return this.query(trx).withScope(...(0, _utils.asArray)(this.definition.options.sessionScope));
    }

  }, _class.options = {
    usernameProperty: 'username',
    passwordProperty: 'password',
    sessionScope: undefined
  }, _temp;
});
exports.UserMixin = UserMixin;
const userClasses = {};

_koaPassport.default.serializeUser((req, user, done) => {
  const modelName = user == null ? void 0 : user.constructor.name;
  const identifier = modelName && userClasses[modelName] ? `${modelName}-${user.id}` : null;
  done(null, identifier);
});

_koaPassport.default.deserializeUser(async (req, identifier, done) => {
  const [modelName, userId] = identifier.split('-');
  const userClass = userClasses[modelName];

  try {
    const user = userClass ? await userClass.sessionQuery(req.ctx.transaction).findById(userId) : null;
    done(null, user);
  } catch (err) {
    done(err);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbnMvVXNlck1peGluLmpzIl0sIm5hbWVzIjpbIlVzZXJNaXhpbiIsIk1vZGVsIiwicHJvcGVydGllcyIsInVzZXJuYW1lUHJvcGVydHkiLCJwYXNzd29yZFByb3BlcnR5IiwiZGVmaW5pdGlvbiIsIm9wdGlvbnMiLCJ0eXBlIiwicmVxdWlyZWQiLCJjb21wdXRlZCIsImhhc2giLCJoaWRkZW4iLCJsYXN0TG9naW4iLCJudWxsYWJsZSIsInBhc3N3b3JkIiwidW5kZWZpbmVkIiwiYmNyeXB0IiwiaGFzaFN5bmMiLCJnZW5TYWx0U3luYyIsIiR2ZXJpZnlQYXNzd29yZCIsImNvbXBhcmUiLCIkaGFzUm9sZSIsInJvbGVzIiwiZmluZCIsInJvbGUiLCJpbmNsdWRlcyIsIiRoYXNPd25lciIsIm93bmVyIiwiJGlzIiwiJGlzTG9nZ2VkSW4iLCJjdHgiLCJzdGF0ZSIsInVzZXIiLCJpbml0aWFsaXplIiwidXNlckNsYXNzZXMiLCJuYW1lIiwicGFzc3BvcnQiLCJ1c2UiLCJMb2NhbFN0cmF0ZWd5IiwidXNlcm5hbWVGaWVsZCIsInBhc3N3b3JkRmllbGQiLCJwYXNzUmVxVG9DYWxsYmFjayIsInJlcSIsInVzZXJuYW1lIiwiZG9uZSIsInNlc3Npb25RdWVyeSIsInRyYW5zYWN0aW9uIiwiZmluZE9uZSIsInJlcyIsImVyciIsImxvZ2luIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJhdXRoZW50aWNhdGUiLCJtZXNzYWdlIiwic3RhdHVzIiwiQXV0aGVudGljYXRpb25FcnJvciIsInRyeCIsInF1ZXJ5Iiwid2l0aFNjb3BlIiwic2Vzc2lvblNjb3BlIiwic2VyaWFsaXplVXNlciIsIm1vZGVsTmFtZSIsImNvbnN0cnVjdG9yIiwiaWRlbnRpZmllciIsImlkIiwiZGVzZXJpYWxpemVVc2VyIiwidXNlcklkIiwic3BsaXQiLCJ1c2VyQ2xhc3MiLCJmaW5kQnlJZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7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Y3J5cHQgZnJvbSAnYmNyeXB0anMnXG5pbXBvcnQgcGFzc3BvcnQgZnJvbSAna29hLXBhc3Nwb3J0J1xuaW1wb3J0IHsgU3RyYXRlZ3kgYXMgTG9jYWxTdHJhdGVneSB9IGZyb20gJ3Bhc3Nwb3J0LWxvY2FsJ1xuaW1wb3J0IHsgQXV0aGVudGljYXRpb25FcnJvciB9IGZyb20gJ0AvZXJyb3JzJ1xuaW1wb3J0IHsgbWl4aW4sIGFzQXJyYXkgfSBmcm9tICdAZGl0b2pzL3V0aWxzJ1xuXG5leHBvcnQgY29uc3QgVXNlck1peGluID0gbWl4aW4oTW9kZWwgPT4gY2xhc3MgZXh0ZW5kcyBNb2RlbCB7XG4gIHN0YXRpYyBvcHRpb25zID0ge1xuICAgIHVzZXJuYW1lUHJvcGVydHk6ICd1c2VybmFtZScsXG4gICAgcGFzc3dvcmRQcm9wZXJ0eTogJ3Bhc3N3b3JkJyxcbiAgICAvLyBUaGlzIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBzcGVjaWZ5IChlYWdlcikgc2NvcGVzIHRvIGJlIGFwcGxpZWQgd2hlblxuICAgIC8vIHRoZSB1c2VyIGlzIGRlc2VyaWFsaXplZCBmcm9tIHRoZSBzZXNzaW9uLlxuICAgIHNlc3Npb25TY29wZTogdW5kZWZpbmVkXG4gIH1cblxuICBzdGF0aWMgZ2V0IHByb3BlcnRpZXMoKSB7XG4gICAgY29uc3Qge1xuICAgICAgdXNlcm5hbWVQcm9wZXJ0eSxcbiAgICAgIHBhc3N3b3JkUHJvcGVydHlcbiAgICB9ID0gdGhpcy5kZWZpbml0aW9uLm9wdGlvbnNcbiAgICByZXR1cm4ge1xuICAgICAgW3VzZXJuYW1lUHJvcGVydHldOiB7XG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgfSxcblxuICAgICAgLy8gYHBhc3N3b3JkYCBpc24ndCBzdG9yZWQsIGJ1dCB0aGlzIGlzIHJlcXVpcmVkIGZvciB2YWxpZGF0aW9uOlxuICAgICAgW3Bhc3N3b3JkUHJvcGVydHldOiB7XG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBjb21wdXRlZDogdHJ1ZVxuICAgICAgfSxcblxuICAgICAgaGFzaDoge1xuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgaGlkZGVuOiB0cnVlXG4gICAgICB9LFxuXG4gICAgICBsYXN0TG9naW46IHtcbiAgICAgICAgdHlwZTogJ3RpbWVzdGFtcCcsXG4gICAgICAgIG51bGxhYmxlOiB0cnVlXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IHBhc3N3b3JkKCkge1xuICAgIC8vIE5pY2UgdHJ5IDspXG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG5cbiAgc2V0IHBhc3N3b3JkKHBhc3N3b3JkKSB7XG4gICAgdGhpcy5oYXNoID0gYmNyeXB0Lmhhc2hTeW5jKHBhc3N3b3JkLCBiY3J5cHQuZ2VuU2FsdFN5bmMoMTApKVxuICB9XG5cbiAgYXN5bmMgJHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCB0aGlzLmhhc2gpXG4gIH1cblxuICAkaGFzUm9sZSguLi5yb2xlcykge1xuICAgIC8vIFN1cHBvcnQgYW4gb3B0aW9uYWwgYHJvbGVzYCBhcnJheSBvbiB0aGUgbW9kZWwgdGhhdCBjYW4gY29udGFpbiByb2xlcy5cbiAgICByZXR1cm4gdGhpcy5yb2xlcz8uZmluZChyb2xlID0+IHJvbGVzLmluY2x1ZGVzKHJvbGUpKSB8fCBmYWxzZVxuICB9XG5cbiAgJGhhc093bmVyKG93bmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuJGlzKG93bmVyKVxuICB9XG5cbiAgJGlzTG9nZ2VkSW4oY3R4KSB7XG4gICAgcmV0dXJuIHRoaXMuJGlzKGN0eC5zdGF0ZS51c2VyKVxuICB9XG5cbiAgc3RhdGljIGluaXRpYWxpemUoKSB7XG4gICAgc3VwZXIuaW5pdGlhbGl6ZSgpXG4gICAgdXNlckNsYXNzZXNbdGhpcy5uYW1lXSA9IHRoaXNcbiAgICBjb25zdCB7XG4gICAgICB1c2VybmFtZVByb3BlcnR5LFxuICAgICAgcGFzc3dvcmRQcm9wZXJ0eVxuICAgIH0gPSB0aGlzLmRlZmluaXRpb24ub3B0aW9uc1xuICAgIHBhc3Nwb3J0LnVzZSh0aGlzLm5hbWUsXG4gICAgICBuZXcgTG9jYWxTdHJhdGVneShcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJuYW1lRmllbGQ6IHVzZXJuYW1lUHJvcGVydHksXG4gICAgICAgICAgcGFzc3dvcmRGaWVsZDogcGFzc3dvcmRQcm9wZXJ0eSxcbiAgICAgICAgICAvLyBXZWUgbmVlZCB0aGUgYHJlcWAgb2JqZWN0LCBzbyB3ZSBjYW4gZ2V0IHRoZSBhY3RpdmUgZGF0YWJhc2VcbiAgICAgICAgICAvLyB0cmFuc2FjdGlvbiB0aHJvdWdoIGByZXEuY3R4LnRyYW5zYWN0aW9uYDpcbiAgICAgICAgICBwYXNzUmVxVG9DYWxsYmFjazogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBhc3luYyAocmVxLCB1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuc2Vzc2lvblF1ZXJ5KHJlcS5jdHgudHJhbnNhY3Rpb24pXG4gICAgICAgICAgICAgIC5maW5kT25lKHVzZXJuYW1lUHJvcGVydHksIHVzZXJuYW1lKVxuICAgICAgICAgICAgY29uc3QgcmVzID0gdXNlciAmJiBhd2FpdCB1c2VyLiR2ZXJpZnlQYXNzd29yZChwYXNzd29yZClcbiAgICAgICAgICAgICAgPyB1c2VyXG4gICAgICAgICAgICAgIDogbnVsbFxuICAgICAgICAgICAgZG9uZShudWxsLCByZXMpXG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBkb25lKGVycilcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApXG4gIH1cblxuICBzdGF0aWMgYXN5bmMgbG9naW4oY3R4LCBvcHRpb25zKSB7XG4gICAgLy8gVW5mb3J0dW5hdGVseSBrb2EtcGFzc3BvcnQgaXNuJ3QgcHJvbWlzaWZpZWQgeWV0LCBzbyBkbyBzb21lIHdyYXBwaW5nOlxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBVc2UgYSBjdXN0b20gY2FsbGJhY2sgdG8gaGFuZGxlIGF1dGhlbnRpY2F0aW9uLCBzZWU6XG4gICAgICAvLyBodHRwOi8vd3d3LnBhc3Nwb3J0anMub3JnL2RvY3MvZG93bmxvYWRzL2h0bWwvI2N1c3RvbS1jYWxsYmFja1xuICAgICAgcGFzc3BvcnQuYXV0aGVudGljYXRlKHRoaXMubmFtZSwgYXN5bmMgKGVyciwgdXNlciwgbWVzc2FnZSwgc3RhdHVzKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9IGVsc2UgaWYgKHVzZXIpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgY3R4LmxvZ2luKHVzZXIsIG9wdGlvbnMpXG4gICAgICAgICAgICByZXNvbHZlKHVzZXIpXG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QobmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoXG4gICAgICAgICAgICBtZXNzYWdlIHx8ICdQYXNzd29yZCBvciB1c2VybmFtZSBpcyBpbmNvcnJlY3QnLCBzdGF0dXMpKVxuICAgICAgICB9XG4gICAgICB9KShjdHgpXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBzZXNzaW9uUXVlcnkodHJ4KSB7XG4gICAgcmV0dXJuIHRoaXMucXVlcnkodHJ4KS53aXRoU2NvcGUoXG4gICAgICAuLi5hc0FycmF5KHRoaXMuZGVmaW5pdGlvbi5vcHRpb25zLnNlc3Npb25TY29wZSlcbiAgICApXG4gIH1cbn0pXG5cbmNvbnN0IHVzZXJDbGFzc2VzID0ge31cblxuLy8gTk9URTogV2UgY2FuJ3QgdXNlIHRvQ2FsbGJhY2soKSBoZXJlIHNpbmNlIHBhc3Nwb3J0IGNoZWNrcyBmdW5jdGlvbiBhcml0eSB0b1xuLy8gZGV0ZXJtaW5lIHNlcXVlbmNlIG9mIGFyZ3VtZW50cyByZWNlaXZlZCwgYW5kIGByZXFgIHdvdWxkIG5vdCBiZSBpbmNsdWRlZDpcbnBhc3Nwb3J0LnNlcmlhbGl6ZVVzZXIoKHJlcSwgdXNlciwgZG9uZSkgPT4ge1xuICAvLyBUbyBzdXBwb3J0IG11bHRpcGxlIHVzZXIgbW9kZWwgY2xhc3NlcywgdXNlIGJvdGggdGhlIG1vZGVsIGNsYXNzIG5hbWUgYW5kXG4gIC8vIGlkIGFzIGlkZW50aWZpZXIuXG4gIGNvbnN0IG1vZGVsTmFtZSA9IHVzZXI/LmNvbnN0cnVjdG9yLm5hbWVcbiAgY29uc3QgaWRlbnRpZmllciA9IG1vZGVsTmFtZSAmJiB1c2VyQ2xhc3Nlc1ttb2RlbE5hbWVdXG4gICAgPyBgJHttb2RlbE5hbWV9LSR7dXNlci5pZH1gXG4gICAgOiBudWxsXG4gIGRvbmUobnVsbCwgaWRlbnRpZmllcilcbn0pXG5cbnBhc3Nwb3J0LmRlc2VyaWFsaXplVXNlcihhc3luYyAocmVxLCBpZGVudGlmaWVyLCBkb25lKSA9PiB7XG4gIGNvbnN0IFttb2RlbE5hbWUsIHVzZXJJZF0gPSBpZGVudGlmaWVyLnNwbGl0KCctJylcbiAgY29uc3QgdXNlckNsYXNzID0gdXNlckNsYXNzZXNbbW9kZWxOYW1lXVxuICB0cnkge1xuICAgIGNvbnN0IHVzZXIgPSB1c2VyQ2xhc3NcbiAgICAgID8gYXdhaXQgdXNlckNsYXNzLnNlc3Npb25RdWVyeShyZXEuY3R4LnRyYW5zYWN0aW9uKS5maW5kQnlJZCh1c2VySWQpXG4gICAgICA6IG51bGxcbiAgICBkb25lKG51bGwsIHVzZXIpXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGRvbmUoZXJyKVxuICB9XG59KVxuIl19