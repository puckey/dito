"use strict";

exports.__esModule = true;
exports.convertSchema = convertSchema;
exports.expandProperties = expandProperties;
exports.expandSchemaShorthand = expandSchemaShorthand;

var _utils = require("@ditojs/utils");

function convertSchema(schema, options = {}) {
  if ((0, _utils.isString)(schema)) {
    schema = {
      type: schema
    };
  } else if ((0, _utils.isArray)(schema)) {
    schema = schema.map(entry => convertSchema(entry, options));
  }

  if ((0, _utils.isObject)(schema)) {
    const {
      type
    } = schema;
    const {
      required,
      ...rest
    } = schema;
    schema = rest;

    if ((0, _utils.isString)(type)) {
      const jsonType = jsonTypes[type];

      if (jsonType) {
        schema.type = jsonType;

        if (jsonType === 'object') {
          let setAdditionalProperties = false;

          if (schema.properties) {
            const {
              properties,
              required
            } = expandProperties(schema.properties, options);
            schema.properties = properties;

            if (required.length > 0) {
              schema.required = required;
            }

            setAdditionalProperties = true;
          }

          if (schema.patternProperties) {
            const {
              properties
            } = expandProperties(schema.patternProperties, options);
            schema.patternProperties = properties;
            setAdditionalProperties = true;
          }

          if (setAdditionalProperties) {
            if (!('additionalProperties' in schema)) {
              schema.additionalProperties = false;
            }
          }
        } else if (jsonType === 'array') {
          const {
            items
          } = schema;

          if (items) {
            schema.items = convertSchema(items, options);
          }
        }
      } else if (['date', 'datetime', 'timestamp'].includes(type)) {
        schema.type = ['string', 'object'];
        schema = addFormat(schema, 'date-time');
      } else {
        if (options.useInstanceOf) {
          schema.type = 'object';
          schema.instanceof = type;
        } else {
          delete schema.type;
          schema.$ref = type;

          if (schema.nullable) {
            delete schema.nullable;
            schema = {
              oneOf: [{
                type: 'null'
              }, schema]
            };
          }
        }
      }
    } else {
      const expanded = expandSchemaShorthand(schema);
      schema = expanded !== schema ? convertSchema(expanded, options) : expanded;

      for (const key of ['allOf', 'anyOf', 'oneOf', 'not']) {
        if (key in schema) {
          schema[key] = convertSchema(schema[key], options);
        }
      }
    }

    if (required) {
      schema = addFormat(schema, 'required');
    }

    if (excludeDefaults[schema.default]) {
      delete schema.default;
    }

    if (schema.nullable && schema.enum && !schema.enum.includes(null)) {
      schema.enum.push(null);
    }
  }

  return schema;
}

function expandProperties(schemaProperties, options) {
  const properties = {};
  const required = [];

  for (let [key, property] of Object.entries(schemaProperties)) {
    var _property;

    property = expandSchemaShorthand(property);
    properties[key] = convertSchema(property, options);

    if ((_property = property) != null && _property.required) {
      required.push(key);
    }
  }

  return {
    properties,
    required
  };
}

function expandSchemaShorthand(schema) {
  if ((0, _utils.isString)(schema)) {
    schema = {
      type: schema
    };
  } else if ((0, _utils.isArray)(schema)) {
    schema = {
      type: 'array',
      items: schema.length > 1 ? schema : schema[0],
      default: []
    };
  } else if ((0, _utils.isObject)(schema) && !((0, _utils.isString)(schema.type) || (0, _utils.isString)(schema.$ref) || (0, _utils.isArray)(schema.allOf) || (0, _utils.isArray)(schema.anyOf) || (0, _utils.isArray)(schema.oneOf) || (0, _utils.isObject)(schema.not))) {
    const properties = {};
    const rest = {};

    for (const [key, value] of Object.entries(schema)) {
      if ((0, _utils.isObject)(value) || (0, _utils.isString)(value) || (0, _utils.isArray)(value)) {
        properties[key] = value;
      } else {
        rest[key] = value;
      }
    }

    schema = {
      type: 'object',
      properties,
      ...rest
    };
  }

  return schema;
}

function addFormat(schema, newFormat) {
  let {
    allOf,
    format,
    ...rest
  } = schema;

  if (format || allOf) {
    allOf || (allOf = []);

    if (!allOf.find(({
      format
    }) => format === newFormat)) {
      allOf.push({
        format
      }, {
        format: newFormat
      });
      schema = { ...rest,
        allOf
      };
    }
  } else {
    schema.format = newFormat;
  }

  return schema;
}

const jsonTypes = {
  string: 'string',
  text: 'string',
  number: 'number',
  integer: 'integer',
  boolean: 'boolean',
  object: 'object',
  array: 'array'
};
const excludeDefaults = {
  'now()': true
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvcHJvcGVydGllcy5qcyJdLCJuYW1lcyI6WyJjb252ZXJ0U2NoZW1hIiwic2NoZW1hIiwib3B0aW9ucyIsInR5cGUiLCJtYXAiLCJlbnRyeSIsInJlcXVpcmVkIiwicmVzdCIsImpzb25UeXBlIiwianNvblR5cGVzIiwic2V0QWRkaXRpb25hbFByb3BlcnRpZXMiLCJwcm9wZXJ0aWVzIiwiZXhwYW5kUHJvcGVydGllcyIsImxlbmd0aCIsInBhdHRlcm5Qcm9wZXJ0aWVzIiwiYWRkaXRpb25hbFByb3BlcnRpZXMiLCJpdGVtcyIsImluY2x1ZGVzIiwiYWRkRm9ybWF0IiwidXNlSW5zdGFuY2VPZiIsImluc3RhbmNlb2YiLCIkcmVmIiwibnVsbGFibGUiLCJvbmVPZiIsImV4cGFuZGVkIiwiZXhwYW5kU2NoZW1hU2hvcnRoYW5kIiwia2V5IiwiZXhjbHVkZURlZmF1bHRzIiwiZGVmYXVsdCIsImVudW0iLCJwdXNoIiwic2NoZW1hUHJvcGVydGllcyIsInByb3BlcnR5IiwiT2JqZWN0IiwiZW50cmllcyIsImFsbE9mIiwiYW55T2YiLCJub3QiLCJ2YWx1ZSIsIm5ld0Zvcm1hdCIsImZvcm1hdCIsImZpbmQiLCJzdHJpbmciLCJ0ZXh0IiwibnVtYmVyIiwiaW50ZWdlciIsImJvb2xlYW4iLCJvYmplY3QiLCJhcnJheSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVPLFNBQVNBLGFBQVQsQ0FBdUJDLE1BQXZCLEVBQStCQyxPQUFPLEdBQUcsRUFBekMsRUFBNkM7QUFDbEQsTUFBSSxxQkFBU0QsTUFBVCxDQUFKLEVBQXNCO0FBR3BCQSxJQUFBQSxNQUFNLEdBQUc7QUFBRUUsTUFBQUEsSUFBSSxFQUFFRjtBQUFSLEtBQVQ7QUFDRCxHQUpELE1BSU8sSUFBSSxvQkFBUUEsTUFBUixDQUFKLEVBQXFCO0FBRTFCQSxJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0csR0FBUCxDQUFXQyxLQUFLLElBQUlMLGFBQWEsQ0FBQ0ssS0FB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QUFNLEVBQUVEO0FBQVYsT0FBdkI7QUFDQXRDLE1BQUFBLE1BQU0sR0FBRyxFQUFFLEdBQUdNLElBQUw7QUFBVzRCLFFBQUFBO0FBQVgsT0FBVDtBQUNEO0FBQ0YsR0FORCxNQU1PO0FBQ0xsQyxJQUFBQSxNQUFNLENBQUN1QyxNQUFQLEdBQWdCRCxTQUFoQjtBQUNEOztBQUNELFNBQU90QyxNQUFQO0FBQ0Q7O0FBS0QsTUFBTVEsU0FBUyxHQUFHO0FBQ2hCaUMsRUFBQUEsTUFBTSxFQUFFLFFBRFE7QUFFaEJDLEVBQUFBLElBQUksRUFBRSxRQUZVO0FBR2hCQyxFQUFBQSxNQUFNLEVBQUUsUUFIUTtBQUloQkMsRUFBQUEsT0FBTyxFQUFFLFNBSk87QUFLaEJDLEVBQUFBLE9BQU8sRUFBRSxTQUxPO0FBTWhCQyxFQUFBQSxNQUFNLEVBQUUsUUFOUTtBQU9oQkMsRUFBQUEsS0FBSyxFQUFFO0FBUFMsQ0FBbEI7QUFVQSxNQUFNckIsZUFBZSxHQUFHO0FBQ3RCLFdBQVM7QUFEYSxDQUF4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzT2JqZWN0LCBpc0FycmF5LCBpc1N0cmluZyB9IGZyb20gJ0BkaXRvanMvdXRpbHMnXG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0U2NoZW1hKHNjaGVtYSwgb3B0aW9ucyA9IHt9KSB7XG4gIGlmIChpc1N0cmluZyhzY2hlbWEpKSB7XG4gICAgLy8gVE9ETzogQ29uc2lkZXIgcmVtb3Zpbmcgc3RyaW5nIHNob3J0LWhhbmRcbiAgICAvLyBOZXN0ZWQgc2hvcnRoYW5kIGV4cGFuc2lvblxuICAgIHNjaGVtYSA9IHsgdHlwZTogc2NoZW1hIH1cbiAgfSBlbHNlIGlmIChpc0FycmF5KHNjaGVtYSkpIHtcbiAgICAvLyBOZWVkZWQgZm9yIGFsbE9mLCBhbnlPZiwgb25lT2YsIG5vdCwgaXRlbXM6XG4gICAgc2NoZW1hID0gc2NoZW1hLm1hcChlbnRyeSA9PiBjb252ZXJ0U2NoZW1hKGVudHJ5LCBvcHRpb25zKSlcbiAgfVxuICBpZiAoaXNPYmplY3Qoc2NoZW1hKSkge1xuICAgIGNvbnN0IHsgdHlwZSB9ID0gc2NoZW1hXG4gICAgLy8gQ3JlYXRlIGEgc2hhbGxvdyBjbG9uZSBzbyB3ZSBjYW4gbW9kaWZ5IGFuZCByZXR1cm4sIGV4Y2x1ZGluZyBvdXJcbiAgICAvLyBgcmVxdWlyZWRgIGJvb2xlYW4gd2hpY2ggd2lsbCBnZXQgY29udmVydGVkIHRvIGEgZm9ybWF0IGZ1cnRoZXIgZG93biwgYW5kXG4gICAgLy8gdG8gSlNPTiBzY2hlbWEncyBgcmVxdWlyZWRgIGFycmF5IHRocm91Z2ggYGV4cGFuZFByb3BlcnRpZXMoKWA6XG4gICAgY29uc3QgeyByZXF1aXJlZCwgLi4ucmVzdCB9ID0gc2NoZW1hXG4gICAgc2NoZW1hID0gcmVzdFxuICAgIGlmIChpc1N0cmluZyh0eXBlKSkge1xuICAgICAgLy8gQ29udmVydCBzY2hlbWEgcHJvcGVydHkgbm90YXRpb24gdG8gSlNPTiBzY2hlbWFcbiAgICAgIGNvbnN0IGpzb25UeXBlID0ganNvblR5cGVzW3R5cGVdXG4gICAgICBpZiAoanNvblR5cGUpIHtcbiAgICAgICAgc2NoZW1hLnR5cGUgPSBqc29uVHlwZVxuICAgICAgICBpZiAoanNvblR5cGUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgbGV0IHNldEFkZGl0aW9uYWxQcm9wZXJ0aWVzID0gZmFsc2VcbiAgICAgICAgICBpZiAoc2NoZW1hLnByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcHJvcGVydGllcywgcmVxdWlyZWQgfSA9IGV4cGFuZFByb3BlcnRpZXMoXG4gICAgICAgICAgICAgIHNjaGVtYS5wcm9wZXJ0aWVzLFxuICAgICAgICAgICAgICBvcHRpb25zXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBzY2hlbWEucHJvcGVydGllcyA9IHByb3BlcnRpZXNcbiAgICAgICAgICAgIGlmIChyZXF1aXJlZC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgIHNjaGVtYS5yZXF1aXJlZCA9IHJlcXVpcmVkXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZXRBZGRpdGlvbmFsUHJvcGVydGllcyA9IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHNjaGVtYS5wYXR0ZXJuUHJvcGVydGllcykge1xuICAgICAgICAgICAgY29uc3QgeyBwcm9wZXJ0aWVzIH0gPSBleHBhbmRQcm9wZXJ0aWVzKFxuICAgICAgICAgICAgICBzY2hlbWEucGF0dGVyblByb3BlcnRpZXMsXG4gICAgICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHNjaGVtYS5wYXR0ZXJuUHJvcGVydGllcyA9IHByb3BlcnRpZXNcbiAgICAgICAgICAgIHNldEFkZGl0aW9uYWxQcm9wZXJ0aWVzID0gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoc2V0QWRkaXRpb25hbFByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIC8vIEludmVydCB0aGUgbG9naWMgb2YgYGFkZGl0aW9uYWxQcm9wZXJ0aWVzYCBzbyB0aGF0IGl0IG5lZWRzIHRvIGJlXG4gICAgICAgICAgICAvLyBleHBsaWNpdGVseSBzZXQgdG8gYHRydWVgOlxuICAgICAgICAgICAgaWYgKCEoJ2FkZGl0aW9uYWxQcm9wZXJ0aWVzJyBpbiBzY2hlbWEpKSB7XG4gICAgICAgICAgICAgIHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcyA9IGZhbHNlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGpzb25UeXBlID09PSAnYXJyYXknKSB7XG4gICAgICAgICAgY29uc3QgeyBpdGVtcyB9ID0gc2NoZW1hXG4gICAgICAgICAgaWYgKGl0ZW1zKSB7XG4gICAgICAgICAgICBzY2hlbWEuaXRlbXMgPSBjb252ZXJ0U2NoZW1hKGl0ZW1zLCBvcHRpb25zKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChbJ2RhdGUnLCAnZGF0ZXRpbWUnLCAndGltZXN0YW1wJ10uaW5jbHVkZXModHlwZSkpIHtcbiAgICAgICAgLy8gRGF0ZSBwcm9wZXJ0aWVzIGNhbiBiZSBzdWJtaXR0ZWQgYm90aCBhcyBhIHN0cmluZyBvciBhIERhdGUgb2JqZWN0LlxuICAgICAgICAvLyBQcm92aWRlIHZhbGlkYXRpb24gdGhyb3VnaCBkYXRlLXRpbWUgZm9ybWF0LCB3aGljaCBpbiBBanYgYXBwZWFyc1xuICAgICAgICAvLyB0byBoYW5kbGUgYm90aCB0eXBlcyBjb3JyZWN0bHkuXG4gICAgICAgIHNjaGVtYS50eXBlID0gWydzdHJpbmcnLCAnb2JqZWN0J11cbiAgICAgICAgc2NoZW1hID0gYWRkRm9ybWF0KHNjaGVtYSwgJ2RhdGUtdGltZScpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBBIHJlZmVyZW5jZSB0byBhbm90aGVyIG1vZGVsIGFzIG5lc3RlZCBKU09OIGRhdGEsIHVzZSAkcmVmIG9yXG4gICAgICAgIC8vIGluc3RhbmNlb2YgaW5zdGVhZCBvZiB0eXBlLCBiYXNlZCBvbiB0aGUgcGFzc2VkIG9wdGlvbjpcbiAgICAgICAgaWYgKG9wdGlvbnMudXNlSW5zdGFuY2VPZikge1xuICAgICAgICAgIHNjaGVtYS50eXBlID0gJ29iamVjdCdcbiAgICAgICAgICBzY2hlbWEuaW5zdGFuY2VvZiA9IHR5cGVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBNb3ZlIGB0eXBlYCB0byBgJHJlZmAsIGJ1dCBzdGlsbCBrZWVwIG90aGVyIHByb3BlcnRpZXMgZm9yIG5vdyxcbiAgICAgICAgICAvLyB0byBzdXBwb3J0IGBudWxsYWJsZWAuXG4gICAgICAgICAgZGVsZXRlIHNjaGVtYS50eXBlXG4gICAgICAgICAgLy8gVE9ETzogQ29uc2lkZXIgbW92aW5nIHRvIGBtb2RlbGAga2V5d29yZCBpbnN0ZWFkIHRoYXQgd291bGQgc3VwcG9ydFxuICAgICAgICAgIC8vIG1vZGVsIHZhbGlkYXRpb24gYW5kIHN0aWxsIGNvdWxkIGJlIGNvbWJpbmVkIHdpdGggb3RoZXIga2V5d29yZHMuXG4gICAgICAgICAgc2NoZW1hLiRyZWYgPSB0eXBlXG4gICAgICAgICAgLy8gYCRyZWZgIGRvZXNuJ3QgcGxheSB3aXRoIGBudWxsYWJsZWAsIHNvIGNvbnZlcnQgdG8gYG9uZU9mYFxuICAgICAgICAgIGlmIChzY2hlbWEubnVsbGFibGUpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBzY2hlbWEubnVsbGFibGVcbiAgICAgICAgICAgIHNjaGVtYSA9IHtcbiAgICAgICAgICAgICAgb25lT2Y6IFtcbiAgICAgICAgICAgICAgICB7IHR5cGU6ICdudWxsJyB9LFxuICAgICAgICAgICAgICAgIHNjaGVtYVxuICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoaXMgaXMgYSByb290IHByb3BlcnRpZXMgc2NoZW1hIG9yIG5lc3RlZCBvYmplY3Qgd2l0aG91dCB0eXBlIHRoYXRcbiAgICAgIC8vIG1heSBuZWVkIGV4cGFuZGluZy5cbiAgICAgIGNvbnN0IGV4cGFuZGVkID0gZXhwYW5kU2NoZW1hU2hvcnRoYW5kKHNjaGVtYSlcbiAgICAgIHNjaGVtYSA9IGV4cGFuZGVkICE9PSBzY2hlbWFcbiAgICAgICAgLy8gT25seSBjYWxsIGNvbnZlcnRTY2hlbWEoKSBpZiBpdCBhY3R1YWxseSBjaGFuZ2VkLi4uXG4gICAgICAgID8gY29udmVydFNjaGVtYShleHBhbmRlZCwgb3B0aW9ucylcbiAgICAgICAgOiBleHBhbmRlZFxuICAgICAgLy8gSGFuZGxlIG5lc3RlZCBhbGxPZiwgYW55T2YsIG9uZU9mLCBub3QgcHJvcGVydGllc1xuICAgICAgZm9yIChjb25zdCBrZXkgb2YgWydhbGxPZicsICdhbnlPZicsICdvbmVPZicsICdub3QnXSkge1xuICAgICAgICBpZiAoa2V5IGluIHNjaGVtYSkge1xuICAgICAgICAgIHNjaGVtYVtrZXldID0gY29udmVydFNjaGVtYShzY2hlbWFba2V5XSwgb3B0aW9ucylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAocmVxdWlyZWQpIHtcbiAgICAgIC8vIE91ciAncmVxdWlyZWQnIGlzIG5vdCB0aGUgc2FtZSBhcyBKU09OIFNjaGVtYSdzOiBVc2UgdGhlICdyZXF1aXJlZCdcbiAgICAgIC8vIGZvcm1hdCBpbnN0ZWFkIHRoYXQgb25seSB2YWxpZGF0ZXMgaWYgdGhlIHJlcXVpcmVkIHZhbHVlIGlzIG5vdFxuICAgICAgLy8gZW1wdHksIG1lYW5pbmcgbmVpdGhlciBudWxsaXNoIG5vciBhbiBlbXB0eSBzdHJpbmcuXG4gICAgICBzY2hlbWEgPSBhZGRGb3JtYXQoc2NoZW1hLCAncmVxdWlyZWQnKVxuICAgIH1cbiAgICBpZiAoZXhjbHVkZURlZmF1bHRzW3NjaGVtYS5kZWZhdWx0XSkge1xuICAgICAgZGVsZXRlIHNjaGVtYS5kZWZhdWx0XG4gICAgfVxuICAgIC8vIE1ha2UgbnVsbGFibGUgd29yayB3aXRoIGVudW0sIHNlZSB0aGUgaXNzdWUgZm9yIG1vcmUgZGV0YWlsczpcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYWp2LXZhbGlkYXRvci9hanYvaXNzdWVzLzE0NzFcbiAgICBpZiAoc2NoZW1hLm51bGxhYmxlICYmIHNjaGVtYS5lbnVtICYmICFzY2hlbWEuZW51bS5pbmNsdWRlcyhudWxsKSkge1xuICAgICAgc2NoZW1hLmVudW0ucHVzaChudWxsKVxuICAgIH1cbiAgfVxuICByZXR1cm4gc2NoZW1hXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRQcm9wZXJ0aWVzKHNjaGVtYVByb3BlcnRpZXMsIG9wdGlvbnMpIHtcbiAgY29uc3QgcHJvcGVydGllcyA9IHt9XG4gIGNvbnN0IHJlcXVpcmVkID0gW11cbiAgZm9yIChsZXQgW2tleSwgcHJvcGVydHldIG9mIE9iamVjdC5lbnRyaWVzKHNjaGVtYVByb3BlcnRpZXMpKSB7XG4gICAgcHJvcGVydHkgPSBleHBhbmRTY2hlbWFTaG9ydGhhbmQocHJvcGVydHkpXG4gICAgcHJvcGVydGllc1trZXldID0gY29udmVydFNjaGVtYShwcm9wZXJ0eSwgb3B0aW9ucylcbiAgICBpZiAocHJvcGVydHk/LnJlcXVpcmVkKSB7XG4gICAgICByZXF1aXJlZC5wdXNoKGtleSlcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHsgcHJvcGVydGllcywgcmVxdWlyZWQgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kU2NoZW1hU2hvcnRoYW5kKHNjaGVtYSkge1xuICAvLyBUT0RPOiBDb25zaWRlciByZW1vdmluZyBhbGwgc2hvcnQtaGFuZCBzY2hlbWEgZXhwYW5zaW9uLlxuICBpZiAoaXNTdHJpbmcoc2NoZW1hKSkge1xuICAgIHNjaGVtYSA9IHtcbiAgICAgIHR5cGU6IHNjaGVtYVxuICAgIH1cbiAgfSBlbHNlIGlmIChpc0FycmF5KHNjaGVtYSkpIHtcbiAgICBzY2hlbWEgPSB7XG4gICAgICB0eXBlOiAnYXJyYXknLFxuICAgICAgaXRlbXM6IHNjaGVtYS5sZW5ndGggPiAxID8gc2NoZW1hIDogc2NoZW1hWzBdLFxuICAgICAgLy8gVGhlIGFycmF5IHNob3J0LWZvcm1zIHNldHMgYW4gZW1wdHkgYXJyYXkgYXMgdGhlIGRlZmF1bHQuXG4gICAgICBkZWZhdWx0OiBbXVxuICAgIH1cbiAgfSBlbHNlIGlmIChcbiAgICAvLyBFeHBhbmQgb2JqZWN0cyB0byBgdHlwZTogJ29iamVjdCdgLi4uXG4gICAgaXNPYmplY3Qoc2NoZW1hKSAmJlxuICAgICEoXG4gICAgICAvLyAuLi5idXQgb25seSBpZiB0aGV5IGRvbid0IGRlZmluZSBhbnkgb2YgdGhlc2UgcHJvcGVydGllczpcbiAgICAgIGlzU3RyaW5nKHNjaGVtYS50eXBlKSB8fFxuICAgICAgaXNTdHJpbmcoc2NoZW1hLiRyZWYpIHx8XG4gICAgICBpc0FycmF5KHNjaGVtYS5hbGxPZikgfHxcbiAgICAgIGlzQXJyYXkoc2NoZW1hLmFueU9mKSB8fFxuICAgICAgaXNBcnJheShzY2hlbWEub25lT2YpIHx8XG4gICAgICBpc09iamVjdChzY2hlbWEubm90KVxuICAgIClcbiAgKSB7XG4gICAgLy8gU2VwYXJhdGUgb2JqZWN0IHNob3J0LWhhbmQgaW50byBwcm9wZXJ0eSBkZWZpbml0aW9ucyBhbmQgb3RoZXIgZmllbGRzLlxuICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fVxuICAgIGNvbnN0IHJlc3QgPSB7fVxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNjaGVtYSkpIHtcbiAgICAgIC8vIFByb3BlcnR5IGRlZmluaXRpb25zIGFyZSBlaXRoZXIgb2JqZWN0cyBvciBzdHJpbmcgLyBhcnJheSBzaG9ydC1oYW5kczpcbiAgICAgIGlmIChpc09iamVjdCh2YWx1ZSkgfHwgaXNTdHJpbmcodmFsdWUpIHx8IGlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIHByb3BlcnRpZXNba2V5XSA9IHZhbHVlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN0W2tleV0gPSB2YWx1ZVxuICAgICAgfVxuICAgIH1cbiAgICBzY2hlbWEgPSB7XG4gICAgICB0eXBlOiAnb2JqZWN0JyxcbiAgICAgIHByb3BlcnRpZXMsXG4gICAgICAuLi5yZXN0XG4gICAgfVxuICB9XG4gIHJldHVybiBzY2hlbWFcbn1cblxuZnVuY3Rpb24gYWRkRm9ybWF0KHNjaGVtYSwgbmV3Rm9ybWF0KSB7XG4gIC8vIFN1cHBvcnQgbXVsdGlwbGUgYGZvcm1hdGAga2V5d29yZHMgdGhyb3VnaCBgYWxsT2ZgOlxuICBsZXQgeyBhbGxPZiwgZm9ybWF0LCAuLi5yZXN0IH0gPSBzY2hlbWFcbiAgaWYgKGZvcm1hdCB8fCBhbGxPZikge1xuICAgIGFsbE9mIHx8PSBbXVxuICAgIGlmICghYWxsT2YuZmluZCgoeyBmb3JtYXQgfSkgPT4gZm9ybWF0ID09PSBuZXdGb3JtYXQpKSB7XG4gICAgICBhbGxPZi5wdXNoKHsgZm9ybWF0IH0sIHsgZm9ybWF0OiBuZXdGb3JtYXQgfSlcbiAgICAgIHNjaGVtYSA9IHsgLi4ucmVzdCwgYWxsT2YgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBzY2hlbWEuZm9ybWF0ID0gbmV3Rm9ybWF0XG4gIH1cbiAgcmV0dXJuIHNjaGVtYVxufVxuXG4vLyBUYWJsZSB0byB0cmFuc2xhdGUgc2NoZW1hIHR5cGVzIHRvIEpTT04gc2NoZW1hIHR5cGVzLiBPdGhlciB0eXBlcyBhcmUgYWxsb3dlZFxuLy8gYWxzbywgZS5nLiAnZGF0ZScsICdkYXRldGltZScsICd0aW1lc3RhbXAnLCBidXQgdGhleSBuZWVkIHNwZWNpYWwgdHJlYXRtZW50LlxuLy8gQW55dGhpbmcgbm90IHJlY29nbml6ZWQgYXMgYSB0eXBlIGlzIHVzZWQgYXMgYSAkcmVmIGluc3RlYWQuXG5jb25zdCBqc29uVHlwZXMgPSB7XG4gIHN0cmluZzogJ3N0cmluZycsXG4gIHRleHQ6ICdzdHJpbmcnLFxuICBudW1iZXI6ICdudW1iZXInLFxuICBpbnRlZ2VyOiAnaW50ZWdlcicsXG4gIGJvb2xlYW46ICdib29sZWFuJyxcbiAgb2JqZWN0OiAnb2JqZWN0JyxcbiAgYXJyYXk6ICdhcnJheSdcbn1cblxuY29uc3QgZXhjbHVkZURlZmF1bHRzID0ge1xuICAnbm93KCknOiB0cnVlXG59XG4iXX0=