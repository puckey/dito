"use strict";

exports.__esModule = true;
exports.getRelationClass = getRelationClass;
exports.isThroughRelationClass = isThroughRelationClass;
exports.convertRelation = convertRelation;
exports.convertRelations = convertRelations;
exports.addRelationSchemas = addRelationSchemas;

var _objection = require("objection");

var _errors = require("../errors");

var _utils = require("@ditojs/utils");

const relationLookup = {
  belongsTo: _objection.BelongsToOneRelation,
  hasOne: _objection.HasOneRelation,
  hasOneThrough: _objection.HasOneThroughRelation,
  hasMany: _objection.HasManyRelation,
  manyToMany: _objection.ManyToManyRelation
};
const relationClasses = {
  BelongsToOneRelation: _objection.BelongsToOneRelation,
  HasOneRelation: _objection.HasOneRelation,
  HasOneThroughRelation: _objection.HasOneThroughRelation,
  HasManyRelation: _objection.HasManyRelation,
  ManyToManyRelation: _objection.ManyToManyRelation
};
const throughRelationClasses = {
  ManyToManyRelation: _objection.ManyToManyRelation,
  HasOneThroughRelation: _objection.HasOneThroughRelation
};

class ModelReference {
  constructor(reference, models, allowUnknown = false) {
    this.modelName = null;
    this.modelClass = null;
    this.propertyNames = [];

    for (const ref of (0, _utils.asArray)(reference)) {
      const [modelName, propertyName] = (ref == null ? void 0 : ref.split('.')) || [];
      const modelClass = models[modelName];

      if (!modelClass && !allowUnknown) {
        throw new _errors.RelationError(`Unknown model reference: ${ref}`);
      }

      if (!this.modelName) {
        this.modelName = modelName;
        this.modelClass = modelClass;
      } else if (this.modelName !== modelName) {
        throw new _errors.RelationError(`Composite keys need to be defined on the same table: ${ref}`);
      }

      this.propertyNames.push(propertyName);
    }
  }

  asValue(properties) {
    return properties.length > 1 ? properties : properties[0];
  }

  toValue() {
    return this.asValue(this.propertyNames.map(propName => `${this.modelName}.${propName}`));
  }

  toString() {
    const value = this.toValue();
    return (0, _utils.isArray)(value) ? `[${value.join(', ')}]` : value;
  }

  buildThrough(toRef, inverse) {
    const fromName = this.modelName;
    const fromProperties = this.propertyNames;
    const toName = toRef.modelName;
    const toProperties = toRef.propertyNames;

    if (fromProperties.length !== toProperties.length) {
      throw new _errors.RelationError('Unable to create through join for ' + `composite keys from '${this}' to '${toRef}'`);
    }

    const from = [];
    const to = [];

    for (let i = 0; i < fromProperties.length; i++) {
      const fromProperty = fromProperties[i];
      const toProperty = toProperties[i];

      if (fromProperty && toProperty) {
        const throughName = `${fromName}${toName}`;
        const throughFrom = this.getThroughProperty(fromName, fromProperty);
        const throughTo = this.getThroughProperty(toName, toProperty);
        from.push(`${throughName}.${throughFrom}`);
        to.push(`${throughName}.${throughTo}`);
      } else {
        throw new _errors.RelationError(`Unable to create through join from '${this}' to '${to}'`);
      }
    }

    return {
      from: this.asValue(inverse ? to : from),
      to: this.asValue(inverse ? from : to)
    };
  }

  getThroughProperty(name, property) {
    return `${name[0].toLowerCase()}${name.slice(1)}${(0, _utils.capitalize)(property)}`;
  }

}

function getRelationClass(relation) {
  return (0, _utils.isString)(relation) ? relationLookup[(0, _utils.camelize)(relation)] || relationClasses[relation] : _objection.Relation.isPrototypeOf(relation) ? relation : null;
}

function isThroughRelationClass(relationClass) {
  return throughRelationClasses[relationClass.name];
}

function convertRelation(schema, models) {
  let {
    relation,
    from,
    to,
    through,
    inverse,
    modify,
    scope,
    join,
    filter,
    nullable,
    owner,
    ...rest
  } = schema || {};
  const relationClass = getRelationClass(relation);

  if (!relationClass) {
    throw new _errors.RelationError(`Unrecognized relation: ${relation}`);
  } else if (join && !(0, _utils.isString)(relation)) {
    return schema;
  } else {
    from = new ModelReference(from, models, false);
    to = new ModelReference(to, models, false);

    if (isThroughRelationClass(relationClass)) {
      if (!through) {
        through = inverse ? to.buildThrough(from, true) : from.buildThrough(to, false);
      } else if (through.from && through.to) {
        const throughFrom = new ModelReference(through.from, models, true);
        const throughTo = new ModelReference(through.to, models, true);

        if (throughFrom.modelClass || throughTo.modelClass) {
          if (throughFrom.modelClass === throughTo.modelClass) {
            through.modelClass = throughTo.modelClass;
            through.from = throughFrom.toValue();
            through.to = throughTo.toValue();
          } else {
            throw new _errors.RelationError('Both sides of the `through` definition ' + 'need to be on the same join model');
          }
        } else {}
      } else {
        throw new _errors.RelationError('The relation needs a `through.from` and ' + '`through.to` definition');
      }
    } else if (through) {
      throw new _errors.RelationError('Unsupported through join definition');
    }

    modify = modify || filter;

    if ((0, _utils.isObject)(modify)) {
      modify = query => query.find(modify);
    }

    if (scope) {
      const origModify = modify;

      modify = query => {
        query.applyScope(scope);

        if (origModify) {
          query.modify(origModify);
        }
      };
    }

    return {
      relation: relationClass,
      modelClass: to.modelClass,
      join: {
        from: from.toValue(),
        to: to.toValue(),
        ...(through && {
          through
        })
      },
      ...(modify && {
        modify
      }),
      ...rest
    };
  }
}

function convertRelations(ownerModelClass, relations, models) {
  const converted = {};

  for (const [name, relation] of Object.entries(relations)) {
    try {
      converted[name] = convertRelation(relation, models);
    } catch (err) {
      throw new _errors.RelationError(`${ownerModelClass.name}.relations.${name}: ${err.message || err}`);
    }
  }

  return converted;
}

function addRelationSchemas(modelClass, properties) {
  for (const relationInstance of Object.values(modelClass.getRelations())) {
    const {
      name,
      ownerModelClass,
      relatedModelClass
    } = relationInstance;
    const relationDefinition = ownerModelClass.definition.relations[name];
    const isOneToOne = relationInstance.isOneToOne();
    const {
      owner
    } = relationDefinition;
    const $ref = relatedModelClass.name;
    const anyOf = [];

    if (isOneToOne) {
      anyOf.push({
        type: 'null'
      });
    }

    if (!owner) {
      anyOf.push({
        relate: $ref
      });
    }

    anyOf.push({
      $ref
    });
    const items = anyOf.length > 1 ? {
      anyOf
    } : anyOf[0];
    properties[name] = isOneToOne ? items : {
      type: 'array',
      items
    };
  }

  return properties;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvcmVsYXRpb25zLmpzIl0sIm5hbWVzIjpbInJlbGF0aW9uTG9va3VwIiwiYmVsb25nc1RvIiwiQmVsb25nc1RvT25lUmVsYXRpb24iLCJoYXNPbmUiLCJIYXNPbmVSZWxhdGlvbiIsImhhc09uZVRocm91Z2giLCJIYXNPbmVUaHJvdWdoUmVsYXRpb24iLCJoYXNNYW55IiwiSGFzTWFueVJlbGF0aW9uIiwibWFueVRvTWFueSIsIk1hbnlUb01hbnlSZWxhdGlvbiIsInJlbGF0aW9uQ2xhc3NlcyIsInRocm91Z2hSZWxhdGlvbkNsYXNzZXMiLCJNb2RlbFJlZmVyZW5jZSIsImNvbnN0cnVjdG9yIiwicmVmZXJlbmNlIiwibW9kZWxzIiwiYWxsb3dVbmtub3duIiwibW9kZWxOYW1lIiwibW9kZWxDbGFzcyIsInByb3BlcnR5TmFtZXMiLCJyZWYiLCJwcm9wZXJ0eU5hbWUiLCJzcGxpdCIsIlJlbGF0aW9uRXJyb3IiLCJwdXNoIiwiYXNWYWx1ZSIsInByb3BlcnRpZXMiLCJsZW5ndGgiLCJ0b1ZhbHVlIiwibWFwIiwicHJvcE5hbWUiLCJ0b1N0cmluZyIsInZhbHVlIiwiam9pbiIsImJ1aWxkVGhyb3VnaCIsInRvUmVmIiwiaW52ZXJzZSIsImZyb21OYW1lIiwiZnJvbVByb3BlcnRpZXMiLCJ0b05hbWUiLCJ0b1Byb3BlcnRpZXMiLCJmcm9tIiwidG8iLCJpIiwiZnJvbVByb3BlcnR5IiwidG9Qcm9wZXJ0eSIsInRocm91Z2hOYW1lIiwidGhyb3VnaEZyb20iLCJnZXRUaHJvdWdoUHJvcGVydHkiLCJ0aHJvdWdoVG8iLCJuYW1lIiwicHJvcGVydHkiLCJ0b0xvd2VyQ2FzZSIsInNsaWNlIiwiZ2V0UmVsYXRpb25DbGFzcyIsInJlbGF0aW9uIiwiUmVsYXRpb24iLCJpc1Byb3RvdHlwZU9mIiwiaXNUaHJvdWdoUmVsYXRpb25DbGFzcyIsInJlbGF0aW9uQ2xhc3MiLCJjb252ZXJ0UmVsYXRpb24iLCJzY2hlbWEiLCJ0aHJvdWdoIiwibW9kaWZ5Iiwic2NvcGUiLCJmaWx0ZXIiLCJudWxsYWJsZSIsIm93bmVyIiwicmVzdCIsInF1ZXJ5IiwiZmluZCIsIm9yaWdNb2RpZnkiLCJhcHBseVNjb3BlIiwiY29udmVydFJlbGF0aW9ucyIsIm93bmVyTW9kZWxDbGFzcyIsInJlbGF0aW9ucyIsImNvbnZlcnRlZCIsIk9iamVjdCIsImVudHJpZXMiLCJlcnIiLCJtZXNzYWdlIiwiYWRkUmVsYXRpb25TY2hlbWFzIiwicmVsYXRpb25JbnN0YW5jZSIsInZhbHVlcyIsImdldFJlbGF0aW9ucyIsInJlbGF0ZWRNb2RlbENsYXNzIiwicmVsYXRpb25EZWZpbml0aW9uIiwiZGVmaW5pdGlvbiIsImlzT25lVG9PbmUiLCIkcmVmIiwiYW55T2YiLCJ0eXBlIiwicmVsYXRlIiwiaXRlbXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQVFBOztBQUNBOztBQUlBLE1BQU1BLGNBQWMsR0FBRztBQUVyQkMsRUFBQUEsU0FBUyxFQUFFQywrQkFGVTtBQUdyQkMsRUFBQUEsTUFBTSxFQUFFQyx5QkFIYTtBQUlyQkMsRUFBQUEsYUFBYSxFQUFFQyxnQ0FKTTtBQU1yQkMsRUFBQUEsT0FBTyxFQUFFQywwQkFOWTtBQU9yQkMsRUFBQUEsVUFBVSxFQUFFQztBQVBTLENBQXZCO0FBVUEsTUFBTUMsZUFBZSxHQUFHO0FBQ3RCVCxFQUFBQSxvQkFBb0IsRUFBcEJBLCtCQURzQjtBQUV0QkUsRUFBQUEsY0FBYyxFQUFkQSx5QkFGc0I7QUFHdEJFLEVBQUFBLHFCQUFxQixFQUFyQkEsZ0NBSHNCO0FBSXRCRSxFQUFBQSxlQUFlLEVBQWZBLDBCQUpzQjtBQUt0QkUsRUFBQUEsa0JBQWtCLEVBQWxCQTtBQUxzQixDQUF4QjtBQVFBLE1BQU1FLHNCQUFzQixHQUFHO0FBQzdCRixFQUFBQSxrQkFBa0IsRUFBbEJBLDZCQUQ2QjtBQUU3QkosRUFBQUEscUJBQXFCLEVBQXJCQTtBQUY2QixDQUEvQjs7QUFLQSxNQUFNTyxjQUFOLENBQXFCO0FBQ25CQyxFQUFBQSxXQUFX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S0FBSyxDQUFDLENBQUQsQ0FGVDtBQUdBaEUsSUFBQUEsVUFBVSxDQUFDd0IsSUFBRCxDQUFWLEdBQW1Cc0MsVUFBVSxHQUN6QkssS0FEeUIsR0FFekI7QUFDQUYsTUFBQUEsSUFBSSxFQUFFLE9BRE47QUFFQUUsTUFBQUE7QUFGQSxLQUZKO0FBTUQ7O0FBQ0QsU0FBT25FLFVBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJlbGF0aW9uLFxuICBCZWxvbmdzVG9PbmVSZWxhdGlvbixcbiAgSGFzT25lUmVsYXRpb24sXG4gIEhhc09uZVRocm91Z2hSZWxhdGlvbixcbiAgSGFzTWFueVJlbGF0aW9uLFxuICBNYW55VG9NYW55UmVsYXRpb25cbn0gZnJvbSAnb2JqZWN0aW9uJ1xuaW1wb3J0IHsgUmVsYXRpb25FcnJvciB9IGZyb20gJ0AvZXJyb3JzJ1xuaW1wb3J0IHtcbiAgaXNPYmplY3QsIGlzQXJyYXksIGlzU3RyaW5nLCBhc0FycmF5LCBjYXBpdGFsaXplLCBjYW1lbGl6ZVxufSBmcm9tICdAZGl0b2pzL3V0aWxzJ1xuXG5jb25zdCByZWxhdGlvbkxvb2t1cCA9IHtcbiAgLy8gb25lOlxuICBiZWxvbmdzVG86IEJlbG9uZ3NUb09uZVJlbGF0aW9uLFxuICBoYXNPbmU6IEhhc09uZVJlbGF0aW9uLFxuICBoYXNPbmVUaHJvdWdoOiBIYXNPbmVUaHJvdWdoUmVsYXRpb24sXG4gIC8vIG1hbnk6XG4gIGhhc01hbnk6IEhhc01hbnlSZWxhdGlvbixcbiAgbWFueVRvTWFueTogTWFueVRvTWFueVJlbGF0aW9uXG59XG5cbmNvbnN0IHJlbGF0aW9uQ2xhc3NlcyA9IHtcbiAgQmVsb25nc1RvT25lUmVsYXRpb24sXG4gIEhhc09uZVJlbGF0aW9uLFxuICBIYXNPbmVUaHJvdWdoUmVsYXRpb24sXG4gIEhhc01hbnlSZWxhdGlvbixcbiAgTWFueVRvTWFueVJlbGF0aW9uXG59XG5cbmNvbnN0IHRocm91Z2hSZWxhdGlvbkNsYXNzZXMgPSB7XG4gIE1hbnlUb01hbnlSZWxhdGlvbixcbiAgSGFzT25lVGhyb3VnaFJlbGF0aW9uXG59XG5cbmNsYXNzIE1vZGVsUmVmZXJlbmNlIHtcbiAgY29uc3RydWN0b3IocmVmZXJlbmNlLCBtb2RlbHMsIGFsbG93VW5rbm93biA9IGZhbHNlKSB7XG4gICAgdGhpcy5tb2RlbE5hbWUgPSBudWxsXG4gICAgdGhpcy5tb2RlbENsYXNzID0gbnVsbFxuICAgIHRoaXMucHJvcGVydHlOYW1lcyA9IFtdXG4gICAgLy8gUGFyc2UgYW5kIHZhbGlkYXRlIG1vZGVsIGtleSByZWZlcmVuY2VzXG4gICAgZm9yIChjb25zdCByZWYgb2YgYXNBcnJheShyZWZlcmVuY2UpKSB7XG4gICAgICBjb25zdCBbbW9kZWxOYW1lLCBwcm9wZXJ0eU5hbWVdID0gcmVmPy5zcGxpdCgnLicpIHx8IFtdXG4gICAgICBjb25zdCBtb2RlbENsYXNzID0gbW9kZWxzW21vZGVsTmFtZV1cbiAgICAgIGlmICghbW9kZWxDbGFzcyAmJiAhYWxsb3dVbmtub3duKSB7XG4gICAgICAgIHRocm93IG5ldyBSZWxhdGlvbkVycm9yKFxuICAgICAgICAgIGBVbmtub3duIG1vZGVsIHJlZmVyZW5jZTogJHtyZWZ9YClcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5tb2RlbE5hbWUpIHtcbiAgICAgICAgdGhpcy5tb2RlbE5hbWUgPSBtb2RlbE5hbWVcbiAgICAgICAgdGhpcy5tb2RlbENsYXNzID0gbW9kZWxDbGFzc1xuICAgICAgfSBlbHNlIGlmICh0aGlzLm1vZGVsTmFtZSAhPT0gbW9kZWxOYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBSZWxhdGlvbkVycm9yKFxuICAgICAgICAgIGBDb21wb3NpdGUga2V5cyBuZWVkIHRvIGJlIGRlZmluZWQgb24gdGhlIHNhbWUgdGFibGU6ICR7cmVmfWApXG4gICAgICB9XG4gICAgICB0aGlzLnByb3BlcnR5TmFtZXMucHVzaChwcm9wZXJ0eU5hbWUpXG4gICAgfVxuICB9XG5cbiAgYXNWYWx1ZShwcm9wZXJ0aWVzKSB7XG4gICAgLy8gVW5wYWNrIHRoZSByZWZlcmVuY2UgYXJyYXkgaWYgaXQgZG9lc24ndCBjb250YWluIG11bHRpcGxlIHByb3BlcnRpZXMuXG4gICAgcmV0dXJuIHByb3BlcnRpZXMubGVuZ3RoID4gMSA/IHByb3BlcnRpZXMgOiBwcm9wZXJ0aWVzWzBdXG4gIH1cblxuICB0b1ZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLmFzVmFsdWUoXG4gICAgICB0aGlzLnByb3BlcnR5TmFtZXMubWFwKFxuICAgICAgICBwcm9wTmFtZSA9PiBgJHt0aGlzLm1vZGVsTmFtZX0uJHtwcm9wTmFtZX1gXG4gICAgICApXG4gICAgKVxuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLnRvVmFsdWUoKVxuICAgIHJldHVybiBpc0FycmF5KHZhbHVlKSA/IGBbJHt2YWx1ZS5qb2luKCcsICcpfV1gIDogdmFsdWVcbiAgfVxuXG4gIGJ1aWxkVGhyb3VnaCh0b1JlZiwgaW52ZXJzZSkge1xuICAgIC8vIEF1dG8tZ2VuZXJhdGUgdGhlIGB0aHJvdWdoYCBzZXR0aW5nIGJhc2VkIG9uIHNpbXBsZSBjb252ZW50aW9uczpcbiAgICAvLyAtIFRoZSBjYW1lbGl6ZWQgdGhyb3VnaCB0YWJsZSBpcyBjYWxsZWQ6IGAke2Zyb21OYW1lfSR7dG9OYW1lfWBcbiAgICAvLyAtIFRoZSBgdGhyb3VnaC5mcm9tYCBwcm9wZXJ0eSBpcyBjYWxsZWQ6XG4gICAgLy8gICBgJHtmcm9tTW9kZWxOYW1lKSR7Y2FwaXRhbGl6ZShmcm9tUHJvcCl9YFxuICAgIC8vIC0gVGhlIGB0aHJvdWdoLnRvYCBwcm9wZXJ0eSBpcyBjYWxsZWQ6XG4gICAgLy8gICBgJHt0b01vZGVsTmFtZSkke2NhcGl0YWxpemUodG9Qcm9wKX1gXG4gICAgLy8gTk9URTogRHVlIHRvIHRoZSB1c2Ugb2Yga25leFNuYWtlQ2FzZU1hcHBlcnMoKSwgdGhlcmUgaXMgbm8gbmVlZCB0b1xuICAgIC8vIGdlbmVyYXRlIGFjdHVhbCB0YWJsZS1uYW1lcyBoZXJlLlxuICAgIGNvbnN0IGZyb21OYW1lID0gdGhpcy5tb2RlbE5hbWVcbiAgICBjb25zdCBmcm9tUHJvcGVydGllcyA9IHRoaXMucHJvcGVydHlOYW1lc1xuICAgIGNvbnN0IHRvTmFtZSA9IHRvUmVmLm1vZGVsTmFtZVxuICAgIGNvbnN0IHRvUHJvcGVydGllcyA9IHRvUmVmLnByb3BlcnR5TmFtZXNcbiAgICBpZiAoZnJvbVByb3BlcnRpZXMubGVuZ3RoICE9PSB0b1Byb3BlcnRpZXMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgUmVsYXRpb25FcnJvcignVW5hYmxlIHRvIGNyZWF0ZSB0aHJvdWdoIGpvaW4gZm9yICcgK1xuICAgICAgICBgY29tcG9zaXRlIGtleXMgZnJvbSAnJHt0aGlzfScgdG8gJyR7dG9SZWZ9J2ApXG4gICAgfVxuICAgIGNvbnN0IGZyb20gPSBbXVxuICAgIGNvbnN0IHRvID0gW11cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyb21Qcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBmcm9tUHJvcGVydHkgPSBmcm9tUHJvcGVydGllc1tpXVxuICAgICAgY29uc3QgdG9Qcm9wZXJ0eSA9IHRvUHJvcGVydGllc1tpXVxuICAgICAgaWYgKGZyb21Qcm9wZXJ0eSAmJiB0b1Byb3BlcnR5KSB7XG4gICAgICAgIGNvbnN0IHRocm91Z2hOYW1lID0gYCR7ZnJvbU5hbWV9JHt0b05hbWV9YFxuICAgICAgICBjb25zdCB0aHJvdWdoRnJvbSA9IHRoaXMuZ2V0VGhyb3VnaFByb3BlcnR5KGZyb21OYW1lLCBmcm9tUHJvcGVydHkpXG4gICAgICAgIGNvbnN0IHRocm91Z2hUbyA9IHRoaXMuZ2V0VGhyb3VnaFByb3BlcnR5KHRvTmFtZSwgdG9Qcm9wZXJ0eSlcbiAgICAgICAgZnJvbS5wdXNoKGAke3Rocm91Z2hOYW1lfS4ke3Rocm91Z2hGcm9tfWApXG4gICAgICAgIHRvLnB1c2goYCR7dGhyb3VnaE5hbWV9LiR7dGhyb3VnaFRvfWApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgUmVsYXRpb25FcnJvcihcbiAgICAgICAgICBgVW5hYmxlIHRvIGNyZWF0ZSB0aHJvdWdoIGpvaW4gZnJvbSAnJHt0aGlzfScgdG8gJyR7dG99J2ApXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBmcm9tOiB0aGlzLmFzVmFsdWUoaW52ZXJzZSA/IHRvIDogZnJvbSksXG4gICAgICB0bzogdGhpcy5hc1ZhbHVlKGludmVyc2UgPyBmcm9tIDogdG8pXG4gICAgfVxuICB9XG5cbiAgZ2V0VGhyb3VnaFByb3BlcnR5KG5hbWUsIHByb3BlcnR5KSB7XG4gICAgcmV0dXJuIGAke25hbWVbMF0udG9Mb3dlckNhc2UoKX0ke25hbWUuc2xpY2UoMSl9JHtjYXBpdGFsaXplKHByb3BlcnR5KX1gXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlbGF0aW9uQ2xhc3MocmVsYXRpb24pIHtcbiAgcmV0dXJuIGlzU3RyaW5nKHJlbGF0aW9uKVxuICAgID8gcmVsYXRpb25Mb29rdXBbY2FtZWxpemUocmVsYXRpb24pXSB8fCByZWxhdGlvbkNsYXNzZXNbcmVsYXRpb25dXG4gICAgOiBSZWxhdGlvbi5pc1Byb3RvdHlwZU9mKHJlbGF0aW9uKVxuICAgICAgPyByZWxhdGlvblxuICAgICAgOiBudWxsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1Rocm91Z2hSZWxhdGlvbkNsYXNzKHJlbGF0aW9uQ2xhc3MpIHtcbiAgcmV0dXJuIHRocm91Z2hSZWxhdGlvbkNsYXNzZXNbcmVsYXRpb25DbGFzcy5uYW1lXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydFJlbGF0aW9uKHNjaGVtYSwgbW9kZWxzKSB7XG4gIGxldCB7XG4gICAgcmVsYXRpb24sXG4gICAgLy8gRGl0by5qcy1zdHlsZSByZWxhdGlvbiBkZXNjcmlwdGlvbjpcbiAgICBmcm9tLCB0bywgdGhyb3VnaCwgaW52ZXJzZSwgbW9kaWZ5LCBzY29wZSxcbiAgICAvLyBPYmplY3Rpb24uanMtc3R5bGUgcmVsYXRpb24gZGVzY3JpcHRpb24gKGBtb2RpZnlgIGlzIHNoYXJlZClcbiAgICBqb2luLCBmaWx0ZXIsXG4gICAgLy8gUGx1Y2sgRGl0by5qcy1yZWxhdGVkIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgbm90IGVuZCB1cCBpbiBgcmVzdGA6XG4gICAgbnVsbGFibGUsIG93bmVyLFxuICAgIC4uLnJlc3RcbiAgfSA9IHNjaGVtYSB8fCB7fVxuICBjb25zdCByZWxhdGlvbkNsYXNzID0gZ2V0UmVsYXRpb25DbGFzcyhyZWxhdGlvbilcbiAgaWYgKCFyZWxhdGlvbkNsYXNzKSB7XG4gICAgdGhyb3cgbmV3IFJlbGF0aW9uRXJyb3IoYFVucmVjb2duaXplZCByZWxhdGlvbjogJHtyZWxhdGlvbn1gKVxuICB9IGVsc2UgaWYgKGpvaW4gJiYgIWlzU3RyaW5nKHJlbGF0aW9uKSkge1xuICAgIC8vIE9yaWdpbmFsIE9iamVjdGlvbi5qcy1zdHlsZSByZWxhdGlvbiwganVzdCBwYXNzIHRocm91Z2hcbiAgICByZXR1cm4gc2NoZW1hXG4gIH0gZWxzZSB7XG4gICAgLy8gRGl0by5qcy1zdHlsZSByZWxhdGlvbiwgZS5nLjpcbiAgICAvLyB7XG4gICAgLy8gICByZWxhdGlvbjogJ2hhc01hbnknLFxuICAgIC8vICAgZnJvbTogJ0Zyb21Nb2RlbC5wcmltYXJ5S2V5UHJvcGVydHlOYW1lJyxcbiAgICAvLyAgIHRvOiAnVG9Nb2RlbC5mb3JlaWduS2V5UHJvcGVydHlOYW1lJyxcbiAgICAvLyAgIHNjb3BlOiAnbGF0ZXN0J1xuICAgIC8vIH1cbiAgICBmcm9tID0gbmV3IE1vZGVsUmVmZXJlbmNlKGZyb20sIG1vZGVscywgZmFsc2UpXG4gICAgdG8gPSBuZXcgTW9kZWxSZWZlcmVuY2UodG8sIG1vZGVscywgZmFsc2UpXG4gICAgaWYgKGlzVGhyb3VnaFJlbGF0aW9uQ2xhc3MocmVsYXRpb25DbGFzcykpIHtcbiAgICAgIGlmICghdGhyb3VnaCkge1xuICAgICAgICAvLyBBdXRvLWdlbmVyYXRlIHRoZSB0aHJvdWdoIHNldHRpbmdzLCBzZWUgYnVpbGRUaHJvdWdoKCk6XG4gICAgICAgIHRocm91Z2ggPSBpbnZlcnNlXG4gICAgICAgICAgPyB0by5idWlsZFRocm91Z2goZnJvbSwgdHJ1ZSlcbiAgICAgICAgICA6IGZyb20uYnVpbGRUaHJvdWdoKHRvLCBmYWxzZSlcbiAgICAgIH0gZWxzZSBpZiAodGhyb3VnaC5mcm9tICYmIHRocm91Z2gudG8pIHtcbiAgICAgICAgLy8gYHRocm91Z2guZnJvbWAgYW5kIGB0aHJvdWdoLnRvYCBuZWVkIHNwZWNpYWwgcHJvY2Vzc2luZywgd2hlcmUgdGhleVxuICAgICAgICAvLyBjYW4gZWl0aGVyIGJlIG1vZGVsIHJlZmVyZW5jZXMgb3IgdGFibGUgcmVmZXJlbmNlcywgYW5kIGlmIHRoZXlcbiAgICAgICAgLy8gcmVmZXJlbmNlIG1vZGVscywgdGhleSBzaG91bGQgYmUgY29udmVydGVkIHRvIHRhYmxlIHJlZmVyZW5jZXMgYW5kXG4gICAgICAgIC8vIHRoZSBtb2RlbCBzaG91bGQgYmUgZXh0cmFjdGVkIGF1dG9tYXRpY2FsbHkuXG4gICAgICAgIGNvbnN0IHRocm91Z2hGcm9tID0gbmV3IE1vZGVsUmVmZXJlbmNlKHRocm91Z2guZnJvbSwgbW9kZWxzLCB0cnVlKVxuICAgICAgICBjb25zdCB0aHJvdWdoVG8gPSBuZXcgTW9kZWxSZWZlcmVuY2UodGhyb3VnaC50bywgbW9kZWxzLCB0cnVlKVxuICAgICAgICBpZiAodGhyb3VnaEZyb20ubW9kZWxDbGFzcyB8fCB0aHJvdWdoVG8ubW9kZWxDbGFzcykge1xuICAgICAgICAgIGlmICh0aHJvdWdoRnJvbS5tb2RlbENsYXNzID09PSB0aHJvdWdoVG8ubW9kZWxDbGFzcykge1xuICAgICAgICAgICAgdGhyb3VnaC5tb2RlbENsYXNzID0gdGhyb3VnaFRvLm1vZGVsQ2xhc3NcbiAgICAgICAgICAgIHRocm91Z2guZnJvbSA9IHRocm91Z2hGcm9tLnRvVmFsdWUoKVxuICAgICAgICAgICAgdGhyb3VnaC50byA9IHRocm91Z2hUby50b1ZhbHVlKClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFJlbGF0aW9uRXJyb3IoJ0JvdGggc2lkZXMgb2YgdGhlIGB0aHJvdWdoYCBkZWZpbml0aW9uICcgK1xuICAgICAgICAgICAgICAnbmVlZCB0byBiZSBvbiB0aGUgc2FtZSBqb2luIG1vZGVsJylcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gQXNzdW1lIHRoZSByZWZlcmVuY2VzIGFyZSB0byBhIGpvaW4gdGFibGUsIGFuZCB1c2UgdGhlIHNldHRpbmdzXG4gICAgICAgICAgLy8gdW5tb2RpZmllZC5cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFJlbGF0aW9uRXJyb3IoJ1RoZSByZWxhdGlvbiBuZWVkcyBhIGB0aHJvdWdoLmZyb21gIGFuZCAnICtcbiAgICAgICAgICAnYHRocm91Z2gudG9gIGRlZmluaXRpb24nKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhyb3VnaCkge1xuICAgICAgdGhyb3cgbmV3IFJlbGF0aW9uRXJyb3IoJ1Vuc3VwcG9ydGVkIHRocm91Z2ggam9pbiBkZWZpbml0aW9uJylcbiAgICB9XG4gICAgLy8gQ29tYmluZSBgbW9kaWZ5YCBhbmQgYGZpbHRlcmAuIFNldHRpbmcgYm90aCB0b2dldGhlciBpcyBub3Qgc3VwcG9ydGVkLlxuICAgIG1vZGlmeSA9IG1vZGlmeSB8fCBmaWx0ZXJcbiAgICBpZiAoaXNPYmplY3QobW9kaWZ5KSkge1xuICAgICAgLy8gQ29udmVydCBhIGZpbmQtZmlsdGVyIG9iamVjdCB0byBhIGZpbHRlciBmdW5jdGlvbiwgc2FtZSBhcyBpbiB0aGVcbiAgICAgIC8vIGhhbmRsaW5nIG9mIGRlZmluaXRpb24uc2NvcGVzLCBzZWUgTW9kZWwuanNcbiAgICAgIG1vZGlmeSA9IHF1ZXJ5ID0+IHF1ZXJ5LmZpbmQobW9kaWZ5KVxuICAgIH1cbiAgICBpZiAoc2NvcGUpIHtcbiAgICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RpZnkgZnVuY3Rpb24gdGhhdCBtZXJnZXMgc2NvcGUgYW5kIG1vZGlmeSB0aGVtOlxuICAgICAgY29uc3Qgb3JpZ01vZGlmeSA9IG1vZGlmeVxuICAgICAgbW9kaWZ5ID0gcXVlcnkgPT4ge1xuICAgICAgICBxdWVyeS5hcHBseVNjb3BlKHNjb3BlKVxuICAgICAgICBpZiAob3JpZ01vZGlmeSkge1xuICAgICAgICAgIHF1ZXJ5Lm1vZGlmeShvcmlnTW9kaWZ5KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICByZWxhdGlvbjogcmVsYXRpb25DbGFzcyxcbiAgICAgIG1vZGVsQ2xhc3M6IHRvLm1vZGVsQ2xhc3MsXG4gICAgICBqb2luOiB7XG4gICAgICAgIGZyb206IGZyb20udG9WYWx1ZSgpLFxuICAgICAgICB0bzogdG8udG9WYWx1ZSgpLFxuICAgICAgICAuLi4odGhyb3VnaCAmJiB7IHRocm91Z2ggfSlcbiAgICAgIH0sXG4gICAgICAuLi4obW9kaWZ5ICYmIHsgbW9kaWZ5IH0pLFxuICAgICAgLi4ucmVzdFxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29udmVydFJlbGF0aW9ucyhvd25lck1vZGVsQ2xhc3MsIHJlbGF0aW9ucywgbW9kZWxzKSB7XG4gIGNvbnN0IGNvbnZlcnRlZCA9IHt9XG4gIGZvciAoY29uc3QgW25hbWUsIHJlbGF0aW9uXSBvZiBPYmplY3QuZW50cmllcyhyZWxhdGlvbnMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnZlcnRlZFtuYW1lXSA9IGNvbnZlcnRSZWxhdGlvbihyZWxhdGlvbiwgbW9kZWxzKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IFJlbGF0aW9uRXJyb3IoXG4gICAgICAgIGAke293bmVyTW9kZWxDbGFzcy5uYW1lfS5yZWxhdGlvbnMuJHtuYW1lfTogJHsoZXJyLm1lc3NhZ2UgfHwgZXJyKX1gKVxuICAgIH1cbiAgfVxuICByZXR1cm4gY29udmVydGVkXG59XG5cbi8qKlxuICogQWRkcyBKU09OIHNjaGVtYSBwcm9wZXJ0aWVzIGZvciBlYWNoIG9mIHRoZSBtb2RlbENsYXNzJyByZWxhdGlvbnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhZGRSZWxhdGlvblNjaGVtYXMobW9kZWxDbGFzcywgcHJvcGVydGllcykge1xuICBmb3IgKGNvbnN0IHJlbGF0aW9uSW5zdGFuY2Ugb2YgT2JqZWN0LnZhbHVlcyhtb2RlbENsYXNzLmdldFJlbGF0aW9ucygpKSkge1xuICAgIGNvbnN0IHsgbmFtZSwgb3duZXJNb2RlbENsYXNzLCByZWxhdGVkTW9kZWxDbGFzcyB9ID0gcmVsYXRpb25JbnN0YW5jZVxuICAgIGNvbnN0IHJlbGF0aW9uRGVmaW5pdGlvbiA9IG93bmVyTW9kZWxDbGFzcy5kZWZpbml0aW9uLnJlbGF0aW9uc1tuYW1lXVxuICAgIGNvbnN0IGlzT25lVG9PbmUgPSByZWxhdGlvbkluc3RhbmNlLmlzT25lVG9PbmUoKVxuICAgIGNvbnN0IHsgb3duZXIgfSA9IHJlbGF0aW9uRGVmaW5pdGlvblxuICAgIGNvbnN0ICRyZWYgPSByZWxhdGVkTW9kZWxDbGFzcy5uYW1lXG4gICAgY29uc3QgYW55T2YgPSBbXVxuICAgIGlmIChpc09uZVRvT25lKSB7XG4gICAgICAvLyBBbGxvdyBudWxsLXZhbHVlIG9uIG9uZS10by1vbmUgcmVsYXRpb25zXG4gICAgICBhbnlPZi5wdXNoKHtcbiAgICAgICAgdHlwZTogJ251bGwnXG4gICAgICB9KVxuICAgIH1cbiAgICBpZiAoIW93bmVyKSB7XG4gICAgICAvLyBBbGxvdyByZWZlcmVuY2Ugb2JqZWN0cyBmb3IgcmVsYXRpb25zIHRoYXQgZG9uJ3Qgb3duIHRoZWlyIGRhdGEuXG4gICAgICBhbnlPZi5wdXNoKHtcbiAgICAgICAgcmVsYXRlOiAkcmVmXG4gICAgICB9KVxuICAgIH1cbiAgICAvLyBGaW5hbGx5IHRoZSBtb2RlbCBpdHNlbGZcbiAgICBhbnlPZi5wdXNoKHsgJHJlZiB9KVxuICAgIGNvbnN0IGl0ZW1zID0gYW55T2YubGVuZ3RoID4gMVxuICAgICAgPyB7IGFueU9mIH1cbiAgICAgIDogYW55T2ZbMF1cbiAgICBwcm9wZXJ0aWVzW25hbWVdID0gaXNPbmVUb09uZVxuICAgICAgPyBpdGVtc1xuICAgICAgOiB7XG4gICAgICAgIHR5cGU6ICdhcnJheScsXG4gICAgICAgIGl0ZW1zXG4gICAgICB9XG4gIH1cbiAgcmV0dXJuIHByb3BlcnRpZXNcbn1cbiJdfQ==