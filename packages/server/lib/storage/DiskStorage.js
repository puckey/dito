"use strict";

exports.__esModule = true;
exports.DiskStorage = void 0;

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _multer = _interopRequireDefault(require("@koa/multer"));

var _Storage = require("./Storage");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class DiskStorage extends _Storage.Storage {
  constructor(app, config) {
    super(app, config);

    if (!this.path) {
      throw new Error(`Missing configuration (path) for storage ${this.name}`);
    }

    this.storage = _multer.default.diskStorage({
      destination: (req, storageFile, cb) => {
        storageFile.key = this.getUniqueKey(storageFile.originalname);

        const dir = this._getPath(this._getNestedFolder(storageFile.key));

        _fsExtra.default.ensureDir(dir).then(() => cb(null, dir)).catch(cb);
      },
      filename: (req, storageFile, cb) => {
        cb(null, storageFile.key);
      }
    });
  }

  _getFilePath(file) {
    return this._getPath(this._getNestedFolder(file.key), file.key);
  }

  _getFileUrl(file) {
    return this._getUrl(this._getNestedFolder(file.key, true), file.key);
  }

  async _addFile(file, buffer) {
    const filePath = this._getFilePath(file);

    const dir = _path.default.dirname(filePath);

    await _fsExtra.default.ensureDir(dir);
    await _fsExtra.default.writeFile(filePath, buffer);
    return file;
  }

  async _removeFile(file) {
    const filePath = this._getFilePath(file);

    await _fsExtra.default.unlink(filePath);

    const removeIfEmpty = async dir => {
      if ((await _fsExtra.default.readdir(dir)).length === 0) {
        try {
          await _fsExtra.default.rmdir(dir);
        } catch (err) {
          if (err.code !== 'ENOENT') {
            throw err;
          }
        }
      }
    };

    const dir = _path.default.dirname(filePath);

    const parentDir = _path.default.dirname(dir);

    await removeIfEmpty(dir);
    await removeIfEmpty(parentDir);
  }

  async _readFile(file) {
    return _fsExtra.default.readFile(this._getFilePath(file));
  }

  async _listKeys() {
    const readDir = (...parts) => _fsExtra.default.readdir(this._getPath(...parts), {
      withFileTypes: true
    });

    const files = [];
    const list1 = await readDir();
    await Promise.all(list1.map(async level1 => {
      if (level1.isDirectory() && level1.name.length === 1) {
        const list2 = await readDir(level1.name);
        await Promise.all(list2.map(async level2 => {
          if (level2.isDirectory() && level2.name.length === 1) {
            const nestedFolder = this._getPath(level1.name, level2.name);

            for (const file of await _fsExtra.default.readdir(nestedFolder)) {
              if (!file.startsWith('.')) {
                files.push(file);
              }
            }
          }
        }));
      }
    }));
    return files;
  }

  _getNestedFolder(key, posix = false) {
    return (posix ? _path.default.posix : _path.default).join(key[0], key[1]);
  }

}

exports.DiskStorage = DiskStorage;
DiskStorage.type = 'disk';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yYWdlL0Rpc2tTdG9yYWdlLmpzIl0sIm5hbWVzIjpbIkRpc2tTdG9yYWdlIiwiU3RvcmFnZSIsImNvbnN0cnVjdG9yIiwiYXBwIiwiY29uZmlnIiwicGF0aCIsIkVycm9yIiwibmFtZSIsInN0b3JhZ2UiLCJtdWx0ZXIiLCJkaXNrU3RvcmFnZSIsImRlc3RpbmF0aW9uIiwicmVxIiwic3RvcmFnZUZpbGUiLCJjYiIsImtleSIsImdldFVuaXF1ZUtleSIsIm9yaWdpbmFsbmFtZSIsImRpciIsIl9nZXRQYXRoIiwiX2dldE5lc3RlZEZvbGRlciIsImZzIiwiZW5zdXJlRGlyIiwidGhlbiIsImNhdGNoIiwiZmlsZW5hbWUiLCJfZ2V0RmlsZVBhdGgiLCJmaWxlIiwiX2dldEZpbGVVcmwiLCJfZ2V0VXJsIiwiX2FkZEZpbGUiLCJidWZmZXIiLCJmaWxlUGF0aCIsImRpcm5hbWUiLCJ3cml0ZUZpbGUiLCJfcmVtb3ZlRmlsZSIsInVubGluayIsInJlbW92ZUlmRW1wdHkiLCJyZWFkZGlyIiwibGVuZ3RoIiwicm1kaXIiLCJlcnIiLCJjb2RlIiwicGFyZW50RGlyIiwiX3JlYWRGaWxlIiwicmVhZEZpbGUiLCJfbGlzdEtleXMiLCJyZWFkRGlyIiwicGFydHMiLCJ3aXRoRmlsZVR5cGVzIiwiZmlsZXMiLCJsaXN0MSIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJsZXZlbDEiLCJpc0RpcmVjdG9yeSIsImxpc3QyIiwibGV2ZWwyIiwibmVzdGVkRm9sZGVyIiwic3RhcnRzV2l0aCIsInB1c2giLCJwb3NpeCIsImpvaW4iLCJ0eXBlIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRU8sTUFBTUEsV0FBTixTQUEwQkMsZ0JBQTFCLENBQWtDO0FBR3ZDQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBTUMsTUFBTixFQUFjO0FBQ3ZCLFVBQU1ELEdBQU4sRUFBV0MsTUFBWDs7QUFDQSxRQUFJLENBQUMsS0FBS0Ms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LElBQU4sQ0FBV2xDLElBQVg7QUFDRDtBQUNGO0FBQ0Y7QUFDRixTQVRELENBREksQ0FBTjtBQVlEO0FBQ0YsS0FoQkQsQ0FESSxDQUFOO0FBbUJBLFdBQU91QixLQUFQO0FBQ0Q7O0FBRUQ5QixFQUFBQSxnQkFBZ0IsQ0FBQ0wsR0FBRCxFQUFNK0MsS0FBSyxHQUFHLEtBQWQsRUFBcUI7QUFHbkMsV0FBTyxDQUFDQSxLQUFLLEdBQUd6RCxjQUFLeUQsS0FBUixHQUFnQnpELGFBQXRCLEVBQTRCMEQsSUFBNUIsQ0FBaUNoRCxHQUFHLENBQUMsQ0FBRCxDQUFwQyxFQUF5Q0EsR0FBRyxDQUFDLENBQUQsQ0FBNUMsQ0FBUDtBQUNEOztBQTNHc0M7OztBQUE1QmYsVyxDQUNKZ0UsSSxHQUFPLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IG11bHRlciBmcm9tICdAa29hL211bHRlcidcbmltcG9ydCB7IFN0b3JhZ2UgfSBmcm9tICcuL1N0b3JhZ2UnXG5cbmV4cG9ydCBjbGFzcyBEaXNrU3RvcmFnZSBleHRlbmRzIFN0b3JhZ2Uge1xuICBzdGF0aWMgdHlwZSA9ICdkaXNrJ1xuXG4gIGNvbnN0cnVjdG9yKGFwcCwgY29uZmlnKSB7XG4gICAgc3VwZXIoYXBwLCBjb25maWcpXG4gICAgaWYgKCF0aGlzLnBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjb25maWd1cmF0aW9uIChwYXRoKSBmb3Igc3RvcmFnZSAke3RoaXMubmFtZX1gKVxuICAgIH1cblxuICAgIHRoaXMuc3RvcmFnZSA9IG11bHRlci5kaXNrU3RvcmFnZSh7XG4gICAgICBkZXN0aW5hdGlvbjogKHJlcSwgc3RvcmFnZUZpbGUsIGNiKSA9PiB7XG4gICAgICAgIC8vIEFkZCBgc3RvcmFnZUZpbGUua2V5YCBwcm9wZXJ0eSB0byBpbnRlcm5hbCBzdG9yYWdlIGZpbGUgb2JqZWN0LlxuICAgICAgICBzdG9yYWdlRmlsZS5rZXkgPSB0aGlzLmdldFVuaXF1ZUtleShzdG9yYWdlRmlsZS5vcmlnaW5hbG5hbWUpXG4gICAgICAgIGNvbnN0IGRpciA9IHRoaXMuX2dldFBhdGgodGhpcy5fZ2V0TmVzdGVkRm9sZGVyKHN0b3JhZ2VGaWxlLmtleSkpXG4gICAgICAgIGZzLmVuc3VyZURpcihkaXIpXG4gICAgICAgICAgLnRoZW4oKCkgPT4gY2IobnVsbCwgZGlyKSlcbiAgICAgICAgICAuY2F0Y2goY2IpXG4gICAgICB9LFxuXG4gICAgICBmaWxlbmFtZTogKHJlcSwgc3RvcmFnZUZpbGUsIGNiKSA9PiB7XG4gICAgICAgIC8vIFVzZSBhZGRlZCBgc3RvcmFnZUZpbGUua2V5YCBwcm9wZXJ0eSBmb3IgbXVsdGVyJ3MgYGZpbGVuYW1lYCBhbHNvLlxuICAgICAgICBjYihudWxsLCBzdG9yYWdlRmlsZS5rZXkpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBfZ2V0RmlsZVBhdGgoZmlsZSkge1xuICAgIHJldHVybiB0aGlzLl9nZXRQYXRoKHRoaXMuX2dldE5lc3RlZEZvbGRlcihmaWxlLmtleSksIGZpbGUua2V5KVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIF9nZXRGaWxlVXJsKGZpbGUpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0VXJsKHRoaXMuX2dldE5lc3RlZEZvbGRlcihmaWxlLmtleSwgdHJ1ZSksIGZpbGUua2V5KVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIGFzeW5jIF9hZGRGaWxlKGZpbGUsIGJ1ZmZlcikge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5fZ2V0RmlsZVBhdGgoZmlsZSlcbiAgICBjb25zdCBkaXIgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpXG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKGRpcilcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZVBhdGgsIGJ1ZmZlcilcbiAgICByZXR1cm4gZmlsZVxuICB9XG5cbiAgLy8gQG92ZXJyaWRlXG4gIGFzeW5jIF9yZW1vdmVGaWxlKGZpbGUpIHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuX2dldEZpbGVQYXRoKGZpbGUpXG4gICAgYXdhaXQgZnMudW5saW5rKGZpbGVQYXRoKVxuICAgIGNvbnN0IHJlbW92ZUlmRW1wdHkgPSBhc3luYyBkaXIgPT4ge1xuICAgICAgaWYgKChhd2FpdCBmcy5yZWFkZGlyKGRpcikpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGZzLnJtZGlyKGRpcilcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgLy8gVGhlIGRpcmVjdG9yeSBtYXkgYWxyZWFkeSBoYXZlIGJlZW4gZGVsZXRlZCBieSBhbm90aGVyIGFzeW5jIGNhbGwsXG4gICAgICAgICAgLy8gZmFpbCBzaWxlbnRseSBoZXJlIGluIHRoaXMgY2FzZS5cbiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8gQ2xlYW4gdXAgbmVzdGVkIGZvbGRlcnMgY3JlYXRlZCB3aXRoIGZpcnN0IHR3byBjaGFycyBvZiBgZmlsZS5rZXlgIGFsc286XG4gICAgY29uc3QgZGlyID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKVxuICAgIGNvbnN0IHBhcmVudERpciA9IHBhdGguZGlybmFtZShkaXIpXG4gICAgYXdhaXQgcmVtb3ZlSWZFbXB0eShkaXIpXG4gICAgYXdhaXQgcmVtb3ZlSWZFbXB0eShwYXJlbnREaXIpXG4gIH1cblxuICAvLyBAb3ZlcnJpZGVcbiAgYXN5bmMgX3JlYWRGaWxlKGZpbGUpIHtcbiAgICByZXR1cm4gZnMucmVhZEZpbGUodGhpcy5fZ2V0RmlsZVBhdGgoZmlsZSkpXG4gIH1cblxuICAvLyBAb3ZlcnJpZGVcbiAgYXN5bmMgX2xpc3RLZXlzKCkge1xuICAgIGNvbnN0IHJlYWREaXIgPSAoLi4ucGFydHMpID0+XG4gICAgICBmcy5yZWFkZGlyKHRoaXMuX2dldFBhdGgoLi4ucGFydHMpLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSlcblxuICAgIGNvbnN0IGZpbGVzID0gW11cbiAgICBjb25zdCBsaXN0MSA9IGF3YWl0IHJlYWREaXIoKVxuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgbGlzdDEubWFwKGFzeW5jIGxldmVsMSA9PiB7XG4gICAgICAgIGlmIChsZXZlbDEuaXNEaXJlY3RvcnkoKSAmJiBsZXZlbDEubmFtZS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICBjb25zdCBsaXN0MiA9IGF3YWl0IHJlYWREaXIobGV2ZWwxLm5hbWUpXG4gICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICBsaXN0Mi5tYXAoYXN5bmMgbGV2ZWwyID0+IHtcbiAgICAgICAgICAgICAgaWYgKGxldmVsMi5pc0RpcmVjdG9yeSgpICYmIGxldmVsMi5uYW1lLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5lc3RlZEZvbGRlciA9IHRoaXMuX2dldFBhdGgobGV2ZWwxLm5hbWUsIGxldmVsMi5uYW1lKVxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBhd2FpdCBmcy5yZWFkZGlyKG5lc3RlZEZvbGRlcikpIHtcbiAgICAgICAgICAgICAgICAgIGlmICghZmlsZS5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZXMucHVzaChmaWxlKVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuICAgIHJldHVybiBmaWxlc1xuICB9XG5cbiAgX2dldE5lc3RlZEZvbGRlcihrZXksIHBvc2l4ID0gZmFsc2UpIHtcbiAgICAvLyBTdG9yZSBmaWxlcyBpbiBuZXN0ZWQgZm9sZGVycyBjcmVhdGVkIHdpdGggdGhlIGZpcnN0IHR3byBjaGFycyBvZiB0aGVcbiAgICAvLyBrZXksIGZvciBmYXN0ZXIgYWNjZXNzICYgbWFuYWdlbWVudCB3aXRoIGxhcmdlIGFtb3VudHMgb2YgZmlsZXMuXG4gICAgcmV0dXJuIChwb3NpeCA/IHBhdGgucG9zaXggOiBwYXRoKS5qb2luKGtleVswXSwga2V5WzFdKVxuICB9XG59XG4iXX0=