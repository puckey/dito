"use strict";

exports.__esModule = true;
exports.S3Storage = void 0;

var _awsSdk = _interopRequireDefault(require("aws-sdk"));

var _multerS = _interopRequireDefault(require("multer-s3"));

var _fileType = _interopRequireDefault(require("file-type"));

var _isSvg = _interopRequireDefault(require("is-svg"));

var _Storage = require("./Storage");

var _stream = require("stream");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class S3Storage extends _Storage.Storage {
  constructor(app, config) {
    super(app, config);
    const {
      name,
      s3,
      acl,
      bucket,
      ...options
    } = config;
    this.s3 = new _awsSdk.default.S3(s3);
    this.acl = acl;
    this.bucket = bucket;
    this.storage = (0, _multerS.default)({
      s3: this.s3,
      acl,
      bucket,
      ...options,
      key: (req, file, cb) => {
        cb(null, this.getUniqueKey(file.originalname));
      },
      contentType: (req, file, cb) => {
        const {
          mimetype,
          stream
        } = file;

        if (mimetype) {
          cb(null, mimetype);
        } else {
          let data = null;

          const done = type => {
            const outStream = new _stream.PassThrough();
            outStream.write(data);
            stream.pipe(outStream);
            cb(null, type, outStream);
          };

          const onData = chunk => {
            if (!data) {
              var _FileType$fromBuffer;

              const type = (_FileType$fromBuffer = _fileType.default.fromBuffer(chunk)) == null ? void 0 : _FileType$fromBuffer.mime;

              if (type) {
                stream.off('data', onData);
                done(type);
              } else {
                stream.once('end', () => {
                  var _FileType$fromBuffer2;

                  const type = ((_FileType$fromBuffer2 = _fileType.default.fromBuffer(data)) == null ? void 0 : _FileType$fromBuffer2.mime) || ((0, _isSvg.default)(data) ? 'image/svg+xml' : 'application/octet-stream');
                  done(type);
                });
              }
            }

            data = data ? Buffer.concat([data, chunk]) : chunk;
          };

          stream.on('data', onData);
        }
      },
      metadata: (req, file, cb) => {
        const {
          width,
          height
        } = file;

        if (width != null || height != null) {
          cb(null, {
            width: `${width}`,
            height: `${height}`
          });
        } else {
          cb(null, {});
        }
      }
    });
  }

  _getFilePath(_file) {
    return undefined;
  }

  _getFileUrl(file) {
    var _this$_getUrl;

    return (_this$_getUrl = this._getUrl(file.key)) != null ? _this$_getUrl : file.url;
  }

  async _addFile(file, buffer) {
    const data = await this.s3.upload({
      Bucket: this.bucket,
      ACL: this.acl,
      Key: file.key,
      ContentType: file.type,
      Body: buffer
    }).promise();
    return { ...file,
      location: data.Location
    };
  }

  async _removeFile(file) {
    await this.s3.deleteObject({
      Bucket: this.bucket,
      Key: file.key
    }).promise();
  }

  async _readFile(file) {
    const {
      ContentType: type,
      Body: data
    } = await this.s3.getObject({
      Bucket: this.bucket,
      Key: file.key
    }).promise();
    const buffer = Buffer.isBuffer(data) ? data : Buffer.from(data);
    buffer.type = type;
    return buffer;
  }

  async _listKeys() {
    const files = [];
    const params = {
      Bucket: this.bucket
    };
    let result;

    do {
      result = await this.s3.listObjectsV2(params).promise();

      for (const {
        Key: key
      } of result.Contents) {
        files.push(key);
      }

      params.ContinuationToken = result.NextContinuationToken;
    } while (result.IsTruncated);

    return files;
  }

}

exports.S3Storage = S3Storage;
S3Storage.type = 's3';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdG9yYWdlL1MzU3RvcmFnZS5qcyJdLCJuYW1lcyI6WyJTM1N0b3JhZ2UiLCJTdG9yYWdlIiwiY29uc3RydWN0b3IiLCJhcHAiLCJjb25maWciLCJuYW1lIiwiczMiLCJhY2wiLCJidWNrZXQiLCJvcHRpb25zIiwiYXdzIiwiUzMiLCJzdG9yYWdlIiwia2V5IiwicmVxIiwiZmlsZSIsImNiIiwiZ2V0VW5pcXVlS2V5Iiwib3JpZ2luYWxuYW1lIiwiY29udGVudFR5cGUiLCJtaW1ldHlwZSIsInN0cmVhbSIsImRhdGEiLCJkb25lIiwidHlwZSIsIm91dFN0cmVhbSIsIlBhc3NUaHJvdWdoIiwid3JpdGUiLCJwaXBlIiwib25EYXRhIiwiY2h1bmsiLCJGaWxlVHlwZSIsImZyb21CdWZmZXIiLCJtaW1lIiwib2ZmIiwib25jZSIsIkJ1ZmZlciIsImNvbmNhdCIsIm9uIiwibWV0YWRhdGEiLCJ3aWR0aCIsImhlaWdodCIsIl9nZXRGaWxlUGF0aCIsIl9maWxlIiwidW5kZWZpbmVkIiwiX2dldEZpbGVVcmwiLCJfZ2V0VXJsIiwidXJsIiwiX2FkZEZpbGUiLCJidWZmZXIiLCJ1cGxvYWQiLCJCdWNrZXQiLCJBQ0wiLCJLZXkiLCJDb250ZW50VHlwZSIsIkJvZHkiLCJwcm9taXNlIiwibG9jYXRpb24iLCJMb2NhdGlvbiIsIl9yZW1vdmVGaWxlIiwiZGVsZXRlT2JqZWN0IiwiX3JlYWRGaWxlIiwiZ2V0T2JqZWN0IiwiaXNCdWZmZXIiLCJmcm9tIiwiX2xpc3RLZXlzIiwiZmlsZXMiLCJwYXJhbXMiLCJyZXN1bHQiLCJsaXN0T2JqZWN0c1YyIiwiQ29udGVudHMiLCJwdXNoIiwiQ29udGludWF0aW9uVG9rZW4iLCJOZXh0Q29udGludWF0aW9uVG9rZW4iLCJJc1RydW5jYXRlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVPLE1BQU1BLFNBQU4sU0FBd0JDLGdCQUF4QixDQUFnQztB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Q0FBQ0ssaUJBQVAsR0FBMkJKLE1BQU0sQ0FBQ0sscUJBQWxDO0FBQ0QsS0FQRCxRQU9TTCxNQUFNLENBQUNNLFdBUGhCOztBQVFBLFdBQU9SLEtBQVA7QUFDRDs7QUFySm9DOzs7QUFBMUJsRSxTLENBQ0p3QixJLEdBQU8sSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhd3MgZnJvbSAnYXdzLXNkaydcbmltcG9ydCBtdWx0ZXJTMyBmcm9tICdtdWx0ZXItczMnXG5pbXBvcnQgRmlsZVR5cGUgZnJvbSAnZmlsZS10eXBlJ1xuaW1wb3J0IGlzU3ZnIGZyb20gJ2lzLXN2ZydcbmltcG9ydCB7IFN0b3JhZ2UgfSBmcm9tICcuL1N0b3JhZ2UnXG5pbXBvcnQgeyBQYXNzVGhyb3VnaCB9IGZyb20gJ3N0cmVhbSdcblxuZXhwb3J0IGNsYXNzIFMzU3RvcmFnZSBleHRlbmRzIFN0b3JhZ2Uge1xuICBzdGF0aWMgdHlwZSA9ICdzMydcblxuICBjb25zdHJ1Y3RvcihhcHAsIGNvbmZpZykge1xuICAgIHN1cGVyKGFwcCwgY29uZmlnKVxuICAgIGNvbnN0IHtcbiAgICAgIG5hbWUsXG4gICAgICBzMyxcbiAgICAgIGFjbCxcbiAgICAgIGJ1Y2tldCxcbiAgICAgIC4uLm9wdGlvbnNcbiAgICB9ID0gY29uZmlnXG4gICAgdGhpcy5zMyA9IG5ldyBhd3MuUzMoczMpXG4gICAgdGhpcy5hY2wgPSBhY2xcbiAgICB0aGlzLmJ1Y2tldCA9IGJ1Y2tldFxuXG4gICAgdGhpcy5zdG9yYWdlID0gbXVsdGVyUzMoe1xuICAgICAgczM6IHRoaXMuczMsXG4gICAgICBhY2wsXG4gICAgICBidWNrZXQsXG4gICAgICAuLi5vcHRpb25zLFxuXG4gICAgICBrZXk6IChyZXEsIGZpbGUsIGNiKSA9PiB7XG4gICAgICAgIGNiKG51bGwsIHRoaXMuZ2V0VW5pcXVlS2V5KGZpbGUub3JpZ2luYWxuYW1lKSlcbiAgICAgIH0sXG5cbiAgICAgIGNvbnRlbnRUeXBlOiAocmVxLCBmaWxlLCBjYikgPT4ge1xuICAgICAgICBjb25zdCB7IG1pbWV0eXBlLCBzdHJlYW0gfSA9IGZpbGVcbiAgICAgICAgaWYgKG1pbWV0eXBlKSB7XG4gICAgICAgICAgLy8gMS4gVHJ1c3QgZmlsZS5taW1ldHlwZSBpZiBwcm92aWRlZC5cbiAgICAgICAgICBjYihudWxsLCBtaW1ldHlwZSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsZXQgZGF0YSA9IG51bGxcblxuICAgICAgICAgIGNvbnN0IGRvbmUgPSB0eXBlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG91dFN0cmVhbSA9IG5ldyBQYXNzVGhyb3VnaCgpXG4gICAgICAgICAgICBvdXRTdHJlYW0ud3JpdGUoZGF0YSlcbiAgICAgICAgICAgIHN0cmVhbS5waXBlKG91dFN0cmVhbSlcbiAgICAgICAgICAgIGNiKG51bGwsIHR5cGUsIG91dFN0cmVhbSlcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBvbkRhdGEgPSBjaHVuayA9PiB7XG4gICAgICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICAgICAgLy8gMi4gVHJ5IHJlYWRpbmcgdGhlIG1pbWV0eXBlIGZyb20gdGhlIGZpcnN0IGNodW5rLlxuICAgICAgICAgICAgICBjb25zdCB0eXBlID0gRmlsZVR5cGUuZnJvbUJ1ZmZlcihjaHVuayk/Lm1pbWVcbiAgICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBzdHJlYW0ub2ZmKCdkYXRhJywgb25EYXRhKVxuICAgICAgICAgICAgICAgIGRvbmUodHlwZSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyAzLiBJZiB0aGF0IGZhaWxzLCBrZWVwIGNvbGxlY3RpbmcgYWxsIGNodW5rcyBhbmQgZGV0ZXJtaW5lXG4gICAgICAgICAgICAgICAgLy8gICAgdGhlIG1pbWV0eXBlIHVzaW5nIHRoZSBmdWxsIGRhdGEuXG4gICAgICAgICAgICAgICAgc3RyZWFtLm9uY2UoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSAoXG4gICAgICAgICAgICAgICAgICAgIEZpbGVUeXBlLmZyb21CdWZmZXIoZGF0YSk/Lm1pbWUgfHxcbiAgICAgICAgICAgICAgICAgICAgKGlzU3ZnKGRhdGEpID8gJ2ltYWdlL3N2Zyt4bWwnIDogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICBkb25lKHR5cGUpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGF0YSA9IGRhdGEgPyBCdWZmZXIuY29uY2F0KFtkYXRhLCBjaHVua10pIDogY2h1bmtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLCBvbkRhdGEpXG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIG1ldGFkYXRhOiAocmVxLCBmaWxlLCBjYikgPT4ge1xuICAgICAgICAvLyBTdG9yZSB0aGUgZGV0ZXJtaW5lZCB3aWR0aCBhbmQgaGVpZ2h0IGFzIG1ldGEtZGF0YSBvbiB0aGUgczMgb2JqZWN0XG4gICAgICAgIC8vIGFzIHdlbGwuIFlvdSBuZXZlciBrbm93LCBpdCBtYXkgYmVjb21lIHVzZWZ1bCA6KVxuICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGZpbGVcbiAgICAgICAgaWYgKHdpZHRoICE9IG51bGwgfHwgaGVpZ2h0ICE9IG51bGwpIHtcbiAgICAgICAgICBjYihudWxsLCB7XG4gICAgICAgICAgICB3aWR0aDogYCR7d2lkdGh9YCxcbiAgICAgICAgICAgIGhlaWdodDogYCR7aGVpZ2h0fWBcbiAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNiKG51bGwsIHt9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBfZ2V0RmlsZVBhdGgoX2ZpbGUpIHtcbiAgICAvLyBUaGVyZSBpcyBubyBcImxvY2FsXCIgZmlsZS1wYXRoIHRvIGZpbGVzIG9uIFMzLlxuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBfZ2V0RmlsZVVybChmaWxlKSB7XG4gICAgcmV0dXJuIHRoaXMuX2dldFVybChmaWxlLmtleSkgPz8gZmlsZS51cmxcbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBhc3luYyBfYWRkRmlsZShmaWxlLCBidWZmZXIpIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5zMy51cGxvYWQoe1xuICAgICAgQnVja2V0OiB0aGlzLmJ1Y2tldCxcbiAgICAgIEFDTDogdGhpcy5hY2wsXG4gICAgICBLZXk6IGZpbGUua2V5LFxuICAgICAgQ29udGVudFR5cGU6IGZpbGUudHlwZSxcbiAgICAgIEJvZHk6IGJ1ZmZlclxuICAgIH0pLnByb21pc2UoKVxuICAgIC8vIFwiQ29udmVydFwiIGBmaWxlYCB0byBzb21ldGhpbmcgbG9va2luZyBtb3JlIGxpa2UgYSBTMyBgc3RvcmFnZUZpbGVgLlxuICAgIC8vIEZvciBub3csIG9ubHkgdGhlIGBsb2NhdGlvbmAgcHJvcGVydHkgaXMgb2YgaW50ZXJlc3Q6XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmZpbGUsXG4gICAgICBsb2NhdGlvbjogZGF0YS5Mb2NhdGlvblxuICAgIH1cbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBhc3luYyBfcmVtb3ZlRmlsZShmaWxlKSB7XG4gICAgYXdhaXQgdGhpcy5zMy5kZWxldGVPYmplY3Qoe1xuICAgICAgQnVja2V0OiB0aGlzLmJ1Y2tldCxcbiAgICAgIEtleTogZmlsZS5rZXlcbiAgICB9KS5wcm9taXNlKClcbiAgICAvLyBUT0RPOiBDaGVjayBmb3IgZXJyb3JzIGFuZCB0aHJvdz9cbiAgfVxuXG4gIC8vIEBvdmVycmlkZVxuICBhc3luYyBfcmVhZEZpbGUoZmlsZSkge1xuICAgIGNvbnN0IHtcbiAgICAgIENvbnRlbnRUeXBlOiB0eXBlLFxuICAgICAgQm9keTogZGF0YVxuICAgIH0gPSBhd2FpdCB0aGlzLnMzLmdldE9iamVjdCh7XG4gICAgICBCdWNrZXQ6IHRoaXMuYnVja2V0LFxuICAgICAgS2V5OiBmaWxlLmtleVxuICAgIH0pLnByb21pc2UoKVxuICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5pc0J1ZmZlcihkYXRhKSA/IGRhdGEgOiBCdWZmZXIuZnJvbShkYXRhKVxuICAgIC8vIFNlZSBgQXNzZXRGaWxlLmRhdGFgIHNldHRlcjpcbiAgICBidWZmZXIudHlwZSA9IHR5cGVcbiAgICByZXR1cm4gYnVmZmVyXG4gIH1cblxuICAvLyBAb3ZlcnJpZGVcbiAgYXN5bmMgX2xpc3RLZXlzKCkge1xuICAgIGNvbnN0IGZpbGVzID0gW11cbiAgICBjb25zdCBwYXJhbXMgPSB7IEJ1Y2tldDogdGhpcy5idWNrZXQgfVxuICAgIGxldCByZXN1bHRcbiAgICBkbyB7XG4gICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLnMzLmxpc3RPYmplY3RzVjIocGFyYW1zKS5wcm9taXNlKClcbiAgICAgIGZvciAoY29uc3QgeyBLZXk6IGtleSB9IG9mIHJlc3VsdC5Db250ZW50cykge1xuICAgICAgICBmaWxlcy5wdXNoKGtleSlcbiAgICAgIH1cbiAgICAgIC8vIENvbnRpbnVlIGl0IGlmIHJlc3VsdHMgYXJlIHRydW5jYXRlZC5cbiAgICAgIHBhcmFtcy5Db250aW51YXRpb25Ub2tlbiA9IHJlc3VsdC5OZXh0Q29udGludWF0aW9uVG9rZW5cbiAgICB9IHdoaWxlIChyZXN1bHQuSXNUcnVuY2F0ZWQpXG4gICAgcmV0dXJuIGZpbGVzXG4gIH1cbn1cbiJdfQ==